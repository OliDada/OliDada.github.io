name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
        
    - name: Create config.js
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "Creating config.js with API key..."
        echo "API Key length: ${#GEMINI_API_KEY}"
        
        cat > config.js << 'CONFIGEOF'
// Generated by GitHub Actions
window.CONFIG = {
  GEMINI_API_KEY: 'PLACEHOLDER_API_KEY',
  DEPLOY_VERSION: 'PLACEHOLDER_DATE',
  BUILD_ID: 'PLACEHOLDER_BUILD'
};
CONFIGEOF
        
        # Replace placeholders with actual values
        sed -i "s/PLACEHOLDER_API_KEY/${GEMINI_API_KEY}/g" config.js
        sed -i "s/PLACEHOLDER_DATE/$(date +"%Y-%m-%d %H:%M:%S UTC")/g" config.js
        sed -i "s/PLACEHOLDER_BUILD/$(echo $GITHUB_SHA | head -c 8)/g" config.js
        
        echo "=== FINAL CONFIG.JS ==="
        cat config.js
        echo "======================="
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
