(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();var fr=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return s=>{for(var i=s.length,n=new Uint8Array((i-(s[i-1]=="=")-(s[i-2]=="="))*3/4|0),a=0,r=0;a<i;){var l=e[s.charCodeAt(a++)],o=e[s.charCodeAt(a++)],d=e[s.charCodeAt(a++)],h=e[s.charCodeAt(a++)];n[r++]=l<<2|o>>4,n[r++]=o<<4|d>>2,n[r++]=d<<6|h}return n}})(),gr={version:"3001.0.19"};function ct(e,t,s){return t>s?ct(e,s,t):Math.min(Math.max(e,t),s)}var te=class Ae{r=255;g=255;b=255;constructor(t,s,i){this.r=ct(t,0,255),this.g=ct(s,0,255),this.b=ct(i,0,255)}static fromArray(t){return new Ae(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new Ae(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!s)throw new Error("Invalid hex color format");return new Ae(parseInt(s[1],16),parseInt(s[2],16),parseInt(s[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,s,i){if(s==0)return new Ae(255*i,255*i,255*i);let n=(h,c,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<1/6?h+(c-h)*6*u:u<1/2?c:u<2/3?h+(c-h)*(2/3-u)*6:h),a=i<.5?i*(1+s):i+s-i*s,r=2*i-a,l=n(r,a,t+1/3),o=n(r,a,t),d=n(r,a,t-1/3);return new Ae(Math.round(l*255),Math.round(o*255),Math.round(d*255))}static RED=new Ae(255,0,0);static GREEN=new Ae(0,255,0);static BLUE=new Ae(0,0,255);static YELLOW=new Ae(255,255,0);static MAGENTA=new Ae(255,0,255);static CYAN=new Ae(0,255,255);static WHITE=new Ae(255,255,255);static BLACK=new Ae(0,0,0);clone(){return new Ae(this.r,this.g,this.b)}lighten(t){return new Ae(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new Ae(255-this.r,255-this.g,255-this.b)}mult(t){return new Ae(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,s){return new Ae(ze(this.r,t.r,s),ze(this.g,t.g,s),ze(this.b,t.b,s))}toHSL(){let t=this.r/255,s=this.g/255,i=this.b/255,n=Math.max(t,s,i),a=Math.min(t,s,i),r=(n+a)/2,l=r,o=r;if(n==a)r=l=0;else{let d=n-a;switch(l=o>.5?d/(2-n-a):d/(n+a),n){case t:r=(s-i)/d+(s<i?6:0);break;case s:r=(i-t)/d+2;break;case i:r=(t-s)/d+4;break}r/=6}return[r,l,o]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function ae(...e){if(e.length===0)return new te(255,255,255);if(e.length===1){if(e[0]instanceof te)return e[0].clone();if(typeof e[0]=="string")return te.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return te.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof te)return e[0].clone()}else if(e.length===3||e.length===4)return new te(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var mr=(e,t,s)=>te.fromHSL(e,t,s);function Pe(e){return e*Math.PI/180}function Rt(e){return e*180/Math.PI}function ze(e,t,s){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*s;if(e instanceof B&&t instanceof B||e instanceof te&&t instanceof te)return e.lerp(t,s);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function dt(e,t,s,i,n){return i+(e-t)/(s-t)*(n-i)}function yr(e,t,s,i,n){return ct(dt(e,t,s,i,n),i,n)}var B=class Me{x=0;y=0;constructor(t=0,s=t){this.x=t,this.y=s}static fromAngle(t){let s=Pe(t);return new Me(Math.cos(s),Math.sin(s))}static fromArray(t){return new Me(t[0],t[1])}static ZERO=new Me(0,0);static ONE=new Me(1,1);static LEFT=new Me(-1,0);static RIGHT=new Me(1,0);static UP=new Me(0,-1);static DOWN=new Me(0,1);clone(){return new Me(this.x,this.y)}add(...t){let s=T(...t);return new Me(this.x+s.x,this.y+s.y)}sub(...t){let s=T(...t);return new Me(this.x-s.x,this.y-s.y)}scale(...t){let s=T(...t);return new Me(this.x*s.x,this.y*s.y)}dist(...t){let s=T(...t);return this.sub(s).len()}sdist(...t){let s=T(...t);return this.sub(s).slen()}static sdist(t,s){let i=t.x-s.x,n=t.y-s.y;return i*i+n*n}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new Me(0):this.scale(1/t)}normal(){return new Me(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,s){return t.x*s.x+t.y*s.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,s){return t.x*s.y-t.y*s.x}angle(...t){let s=T(...t);return Rt(Math.atan2(this.y-s.y,this.x-s.x))}angleBetween(...t){let s=T(...t);return Rt(Math.atan2(this.cross(s),this.dot(s)))}lerp(t,s){return new Me(ze(this.x,t.x,s),ze(this.y,t.y,s))}slerp(t,s){let i=this.dot(t),n=this.cross(t),a=Math.atan2(n,i);return this.scale(Math.sin((1-s)*a)).add(t.scale(Math.sin(s*a))).scale(1/n)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new Me(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new ge(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function T(...e){if(e.length===1){if(e[0]instanceof B)return new B(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new B(...e[0])}return new B(...e)}var be=class Is{x=0;y=0;w=1;h=1;constructor(t,s,i,n){this.x=t,this.y=s,this.w=i,this.h=n}scale(t){return new Is(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new B(this.x,this.y)}clone(){return new Is(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function Se(e,t,s,i){return new be(e,t,s,i)}var Wn=class Vt{a;b;c;d;constructor(t,s,i,n){this.a=t,this.b=s,this.c=i,this.d=n}mul(t){return new Vt(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return T(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new Vt(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new Vt(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,s=this.det,i=t+Math.sqrt(t*t-s),n=t-Math.sqrt(t*t-s);return[i,n]}eigenvectors(t,s){return this.c!=0?[[t-this.d,this.c],[s-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,s-this.a]]:Math.abs(this.transform(T(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let s=Math.cos(t),i=Math.sin(t);return new Vt(s,i,-i,s)}static scale(t,s){return new Vt(t,0,0,s)}},on=class ln{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(t,s,i,n,a,r,l,o,d){this.m11=t,this.m12=s,this.m13=i,this.m21=n,this.m22=a,this.m23=r,this.m31=l,this.m32=o,this.m33=d}static fromMat2(t){return new ln(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new Wn(this.m11,this.m12,this.m21,this.m22)}mul(t){return new ln(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let s=Math.cos(t),i=Math.sin(t),n=this.m11,a=this.m12;return this.m11=s*this.m11+i*this.m21,this.m12=s*this.m12+i*this.m22,this.m21=s*this.m21-i*n,this.m22=s*this.m22-i*a,this}scale(t,s){return this.m11*=t,this.m12*=t,this.m21*=s,this.m22*=s,this}get inverse(){let t=this.det;return new ln((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new ln(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},ht=class mt{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(t){t&&(this.m=t)}static translate(t){return new mt([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new mt([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=Pe(-t);let s=Math.cos(t),i=Math.sin(t);return new mt([1,0,0,0,0,s,-i,0,0,i,s,0,0,0,0,1])}static rotateY(t){t=Pe(-t);let s=Math.cos(t),i=Math.sin(t);return new mt([s,0,i,0,0,1,0,0,-i,0,s,0,0,0,0,1])}static rotateZ(t){t=Pe(-t);let s=Math.cos(t),i=Math.sin(t);return new mt([s,-i,0,0,i,s,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=Pe(-t);let s=Math.cos(t),i=Math.sin(t),n=this.m[0],a=this.m[1],r=this.m[4],l=this.m[5];return this.m[0]=n*s+a*i,this.m[1]=-n*i+a*s,this.m[4]=r*s+l*i,this.m[5]=-r*i+l*s,this}mult(t){let s=[];for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[i*4+n]=this.m[0+n]*t.m[i*4+0]+this.m[4+n]*t.m[i*4+1]+this.m[8+n]*t.m[i*4+2]+this.m[12+n]*t.m[i*4+3];return new mt(s)}multVec2(t){return new B(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new B(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],s=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new B(s,t/s)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],s=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new B(t/s,s)}else return new B(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return Rt(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return Rt(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new B(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new B(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new B(0,0)}invert(){let t=[],s=this.m[10]*this.m[15]-this.m[14]*this.m[11],i=this.m[9]*this.m[15]-this.m[13]*this.m[11],n=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],r=this.m[8]*this.m[14]-this.m[12]*this.m[10],l=this.m[8]*this.m[13]-this.m[12]*this.m[9],o=this.m[6]*this.m[15]-this.m[14]*this.m[7],d=this.m[5]*this.m[15]-this.m[13]*this.m[7],h=this.m[5]*this.m[14]-this.m[13]*this.m[6],c=this.m[4]*this.m[15]-this.m[12]*this.m[7],u=this.m[4]*this.m[14]-this.m[12]*this.m[6],m=this.m[5]*this.m[15]-this.m[13]*this.m[7],f=this.m[4]*this.m[13]-this.m[12]*this.m[5],w=this.m[6]*this.m[11]-this.m[10]*this.m[7],p=this.m[5]*this.m[11]-this.m[9]*this.m[7],g=this.m[5]*this.m[10]-this.m[9]*this.m[6],x=this.m[4]*this.m[11]-this.m[8]*this.m[7],P=this.m[4]*this.m[10]-this.m[8]*this.m[6],H=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*s-this.m[6]*i+this.m[7]*n,t[4]=-(this.m[4]*s-this.m[6]*a+this.m[7]*r),t[8]=this.m[4]*i-this.m[5]*a+this.m[7]*l,t[12]=-(this.m[4]*n-this.m[5]*r+this.m[6]*l),t[1]=-(this.m[1]*s-this.m[2]*i+this.m[3]*n),t[5]=this.m[0]*s-this.m[2]*a+this.m[3]*r,t[9]=-(this.m[0]*i-this.m[1]*a+this.m[3]*l),t[13]=this.m[0]*n-this.m[1]*r+this.m[2]*l,t[2]=this.m[1]*o-this.m[2]*d+this.m[3]*h,t[6]=-(this.m[0]*o-this.m[2]*c+this.m[3]*u),t[10]=this.m[0]*m-this.m[1]*c+this.m[3]*f,t[14]=-(this.m[0]*h-this.m[1]*u+this.m[2]*f),t[3]=-(this.m[1]*w-this.m[2]*p+this.m[3]*g),t[7]=this.m[0]*w-this.m[2]*x+this.m[3]*P,t[11]=-(this.m[0]*p-this.m[1]*x+this.m[3]*H),t[15]=this.m[0]*g-this.m[1]*P+this.m[2]*H;let C=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let A=0;A<4;A++)for(let b=0;b<4;b++)t[A*4+b]*=1/C;return new mt(t)}clone(){return new mt([...this.m])}toString(){return this.m.toString()}};function Ki(e,t,s,i=n=>-Math.cos(n)){return e+(i(s)+1)/2*(t-e)}var wr=1103515245,vr=12345,Ai=2147483648,Xi=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(wr*this.seed+vr)%Ai,this.seed/Ai}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new B(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new te(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof B)return this.genVec2(T(0,0),e[0]);if(e[0]instanceof te)return this.genColor(ae(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof B&&e[1]instanceof B)return this.genVec2(e[0],e[1]);if(e[0]instanceof te&&e[1]instanceof te)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},Ds=new Xi(Date.now());function br(e){return e!=null&&(Ds.seed=e),Ds.seed}function Ee(...e){return Ds.genAny(...e)}function Wi(...e){return Math.floor(Ee(...e.length>0?e:[2]))}function xr(e){return Ee()<=e}function Yi(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function Ar(e,t){return e.length<=t?e.slice():Yi(e.slice()).slice(0,t)}function Sr(e){return e[Wi(e.length)]}function Vi(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function Pr(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let s=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(s===0)return null;let i=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/s,n=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/s;return i<0||i>1||n<0||n>1?null:i}function Zs(e,t){let s=Pr(e,t);return s?T(e.p1.x+s*(e.p2.x-e.p1.x),e.p1.y+s*(e.p2.y-e.p1.y)):null}function _s(e,t){let s=t.p2.sub(t.p1),i=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY;if(s.x!=0){let a=(e.pos.x-t.p1.x)/s.x,r=(e.pos.x+e.width-t.p1.x)/s.x;i=Math.max(i,Math.min(a,r)),n=Math.min(n,Math.max(a,r))}if(s.y!=0){let a=(e.pos.y-t.p1.y)/s.y,r=(e.pos.y+e.height-t.p1.y)/s.y;i=Math.max(i,Math.min(a,r)),n=Math.min(n,Math.max(a,r))}return n>=i&&n>=0&&i<=1}function es(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function Qi(e,t){let s=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),i=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return T(s,i).sdist(t.center)<=t.radius*t.radius}function $i(e,t){return Ji(t,new Ne(e.points()))}function ks(e,t){let s=t.sub(e.p1),i=e.p2.sub(e.p1);if(Math.abs(s.cross(i))>Number.EPSILON)return!1;let n=s.dot(i)/i.dot(i);return n>=0&&n<=1}function An(e,t){let s=e.p2.sub(e.p1),i=s.dot(s),n=e.p1.sub(t.center),a=2*s.dot(n),r=n.dot(n)-t.radius*t.radius,l=a*a-4*i*r;if(i<=Number.EPSILON||l<0)return!1;if(l==0){let o=-a/(2*i);if(o>=0&&o<=1)return!0}else{let o=(-a+Math.sqrt(l))/(2*i),d=(-a-Math.sqrt(l))/(2*i);if(o>=0&&o<=1||d>=0&&d<=1)return!0}return ts(t,e.p1)}function ei(e,t){if(Ct(t,e.p1)||Ct(t,e.p2))return!0;for(let s=0;s<t.pts.length;s++){let i=t.pts[s],n=t.pts[(s+1)%t.pts.length];if(Zs(e,new Xe(i,n)))return!0}return!1}function ts(e,t){return e.center.sdist(t)<e.radius*e.radius}function Cr(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function ns(e,t){let s=t.pts[t.pts.length-1];for(let i of t.pts){if(An(new Xe(s,i),e))return!0;s=i}return ts(e,t.pts[0])?!0:Ct(t,e.center)}function Ji(e,t){for(let s=0;s<e.pts.length;s++)if(ei(new Xe(e.pts[s],e.pts[(s+1)%e.pts.length]),t))return!0;return!!(e.pts.some(s=>Ct(t,s))||t.pts.some(s=>Ct(e,s)))}function Ct(e,t){let s=!1,i=e.pts;for(let n=0,a=i.length-1;n<i.length;a=n++)i[n].y>t.y!=i[a].y>t.y&&t.x<(i[a].x-i[n].x)*(t.y-i[n].y)/(i[a].y-i[n].y)+i[n].x&&(s=!s);return s}function ti(e,t){t=t.sub(e.center);let s=Pe(e.angle),i=Math.cos(s),n=Math.sin(s),a=t.x*i+t.y*n,r=-t.x*n+t.y*i;return a*a/(e.radiusX*e.radiusX)+r*r/(e.radiusY*e.radiusY)<1}function Yn(e,t){let s=t.center.sub(e.center),i=Pe(e.angle),n=Math.cos(i),a=Math.sin(i),r=s.x*n+s.y*a,l=-s.x*a+s.y*n;return ti(new wt(T(),e.radiusX+t.radius,e.radiusY+t.radius,0),T(r,l))}function Zi(e,t){let s=e.toMat2().inverse;return t=new Xe(s.transform(t.p1.sub(e.center)),s.transform(t.p2.sub(e.center))),An(t,new Ke(T(),1))}function Mr(e,t){if(e.radiusX===e.radiusY)return Yn(t,new Ke(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Yn(e,new Ke(t.center,t.radiusX));let s=new on(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),i=new on(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),n=e.center.x,a=e.center.y,r=t.center.x,l=t.center.y,o=Pe(e.angle),d=Pe(t.angle),h=new on(Math.cos(o),-Math.sin(o),n,Math.sin(o),Math.cos(o),a,0,0,1),c=new on(Math.cos(d),-Math.sin(d),r,Math.sin(d),Math.cos(d),l,0,0,1),u=h.inverse,m=c.inverse,f=u.transpose.mul(s).mul(u),w=m.transpose.mul(i).mul(m),p=f.m11,g=f.m12,x=f.m13,P=f.m21,H=f.m22,C=f.m23,A=f.m31,b=f.m32,E=f.m33,M=w.m11,D=w.m12,O=w.m13,N=w.m21,W=w.m22,U=w.m23,k=w.m31,V=w.m32,z=w.m33,ne=p*H*E-p*C*b-g*P*E+g*C*A+x*P*b-x*H*A,Y=(p*H*z-p*C*V-p*b*U+p*E*W-g*P*z+g*C*k+g*A*U-g*E*N+x*P*V-x*H*k-x*A*W+x*b*N+P*b*O-P*E*D-H*A*O+H*E*M+C*A*D-C*b*M)/ne,_=(p*W*z-p*U*V-g*N*z+g*U*k+x*N*V-x*W*k-P*D*z+P*O*V+H*M*z-H*O*k-C*M*V+C*D*k+A*D*U-A*O*W-b*M*U+b*O*N+E*M*W-E*D*N)/ne,me=(M*W*z-M*U*V-D*N*z+D*U*k+O*N*V-O*W*k)/ne;if(Y>=0){let X=-3*_+Y**2,ke=3*Y*me+_*Y**2-4*_**2,vt=-27*me**2+18*me*Y*_+Y**2*_**2-4*Y**3*me-4*_**3;return!(X>0&&ke<0&&vt>0)}else{let X=-3*_+Y**2,ke=-27*me**2+18*me*Y*_+Y**2*_**2-4*Y**3*me-4*_**3;return!(X>0&&ke>0)}}function _i(e,t){return ni(e,new Ne(t.points()))}function ni(e,t){let s=e.toMat2().inverse;return t=new Ne(t.pts.map(i=>s.transform(i.sub(e.center)))),ns(new Ke(T(),1),t)}function Er(e,t){return e.x===t.x&&e.y===t.y}function Tr(e,t){return t instanceof B?Er(t,e.pt):t instanceof Ke?ts(t,e.pt):t instanceof Xe?ks(t,e.pt):t instanceof ge?es(t,e.pt):t instanceof Ne?Ct(t,e.pt):t instanceof wt?ti(t,e.pt):!1}function Ir(e,t){return t instanceof B?ks(e,t):t instanceof Ke?An(e,t):t instanceof Xe?Zs(e,t)!=null:t instanceof ge?_s(t,e):t instanceof Ne?ei(e,t):t instanceof wt?Zi(t,e):!1}function Dr(e,t){return t instanceof B?ts(e,t):t instanceof Ke?Cr(e,t):t instanceof Xe?An(t,e):t instanceof ge?Qi(t,e):t instanceof Ne?ns(e,t):t instanceof wt?Yn(t,e):!1}function Br(e,t){return t instanceof B?es(e,t):t instanceof Ke?Qi(e,t):t instanceof Xe?_s(e,t):t instanceof ge?Vi(e,t):t instanceof Ne?$i(e,t):t instanceof wt?_i(t,e):!1}function Hr(e,t){return t instanceof B?Ct(e,t):t instanceof Ke?ns(t,e):t instanceof Xe?ei(t,e):t instanceof ge?$i(t,e):t instanceof Ne?Ji(t,e):t instanceof wt?ni(t,e):!1}function qr(e,t){return t instanceof B?ti(e,t):t instanceof Ke?Yn(e,t):t instanceof Xe?Zi(e,t):t instanceof ge?_i(e,t):t instanceof Ne?ni(e,t):t instanceof wt?Mr(t,e):!1}function ki(e,t,s){let i=e,n=s.p1,a=s.p2,r=t,l=a.sub(n),o=r.cross(l);if(Math.abs(o)<Number.EPSILON)return null;let d=n.sub(i),h=d.cross(l)/o;if(h<=0||h>=1)return null;let c=d.cross(r)/o;if(c<=0||c>=1)return null;let u=l.normal().unit();return t.dot(u)>0&&(u.x*=-1,u.y*=-1),{point:i.add(r.scale(h)),normal:u,fraction:h}}function Rr(e,t,s){let i=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,a;if(e.x!=0){let r=(s.pos.x-e.x)/t.x,l=(s.pos.x+s.width-e.x)/t.x;a=T(-Math.sign(t.x),0),i=Math.max(i,Math.min(r,l)),n=Math.min(n,Math.max(r,l))}if(e.y!=0){let r=(s.pos.y-e.y)/t.y,l=(s.pos.y+s.height-e.y)/t.y;Math.min(r,l)>i&&(a=T(0,-Math.sign(t.y))),i=Math.max(i,Math.min(r,l)),n=Math.min(n,Math.max(r,l))}return n>=i&&i>=0&&i<=1?{point:e.add(t.scale(i)),normal:a,fraction:i}:null}function ea(e,t,s){let i=e,n=s.center,a=t,r=a.dot(a),l=i.sub(n),o=2*a.dot(l),d=l.dot(l)-s.radius*s.radius,h=o*o-4*r*d;if(r<=Number.EPSILON||h<0)return null;if(h==0){let c=-o/(2*r);if(c>=0&&c<=1){let u=i.add(a.scale(c));return{point:u,normal:u.sub(n),fraction:c}}}else{let c=(-o+Math.sqrt(h))/(2*r),u=(-o-Math.sqrt(h))/(2*r),m=null;if(c>=0&&c<=1&&(m=c),u>=0&&u<=1&&(m=Math.min(u,m??u)),m!=null){let f=i.add(a.scale(m));return{point:f,normal:f.sub(n).unit(),fraction:m}}}return null}function Fr(e,t,s){let i=s.pts,n=null,a=i[i.length-1];for(let r=0;r<i.length;r++){let l=i[r],o=ki(e,t,new Xe(a,l));o&&(!n||n.fraction>o.fraction)&&(n=o),a=l}return n}function Or(e,t,s){let i=s.toMat2(),n=i.inverse,a=n.transform(e.sub(s.center)),r=n.transform(t),l=ea(a,r,new Ke(T(),1));if(l){let o=Wn.rotation(Pe(-s.angle)),d=Wn.scale(s.radiusX,s.radiusY).transform(l.point),h=i.transform(l.point).add(s.center),c=h.dist(e)/t.len();return{point:h,normal:o.transform(T(s.radiusY**2*d.x,s.radiusX**2*d.y)).unit(),fraction:c}}return l}function jr(e,t,s,i=64){let n=e,a=t.len(),r=t.scale(1/a),l=0,o=T(Math.floor(e.x),Math.floor(e.y)),d=T(r.x>0?1:-1,r.y>0?1:-1),h=T(Math.abs(1/r.x),Math.abs(1/r.y)),c=T(d.x>0?o.x+1-e.x:e.x-o.x,d.y>0?o.y+1-e.y:e.y-o.y),u=T(h.x<1/0?h.x*c.x:1/0,h.y<1/0?h.y*c.y:1/0),m=-1;for(;l<=i;){let f=s(o);if(f===!0)return{point:n.add(r.scale(l)),normal:T(m===0?-d.x:0,m===1?-d.y:0),fraction:l/a,gridPos:o};if(f)return f;u.x<u.y?(o.x+=d.x,l=u.x,u.x+=h.x,m=0):(o.y+=d.y,l=u.y,u.y+=h.y,m=1)}return null}var Nr=class Bs{pt;constructor(t){this.pt=t.clone()}transform(t){return new Bs(t.multVec2(this.pt))}bbox(){return new ge(this.pt,0,0)}area(){return 0}clone(){return new Bs(this.pt)}collides(t){return Tr(this,t)}contains(t){return this.pt.eq(t)}raycast(t,s){return null}random(){return this.pt.clone()}},Xe=class Hs{p1;p2;constructor(t,s){this.p1=t.clone(),this.p2=s.clone()}transform(t){return new Hs(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return ge.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Hs(this.p1,this.p2)}collides(t){return Ir(this,t)}contains(t){return this.collides(t)}raycast(t,s){return ki(t,s,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(Ee(1)))}},ge=class qs{pos;width;height;constructor(t,s,i){this.pos=t.clone(),this.width=s,this.height=i}static fromPoints(t,s){return new qs(t.clone(),s.x-t.x,s.y-t.y)}center(){return new B(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new Ne(this.points().map(s=>t.multVec2(s)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new qs(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let s=this.pos,i=this.pos.add(this.width,this.height),n=Math.max(s.x-t.x,0,t.x-i.x),a=Math.max(s.y-t.y,0,t.y-i.y);return n*n+a*a}collides(t){return Br(this,t)}contains(t){return this.collides(t)}raycast(t,s){return Rr(t,s,this)}random(){return this.pos.add(Ee(this.width),Ee(this.height))}},Ke=class ta{center;radius;constructor(t,s){this.center=t.clone(),this.radius=s}transform(t){return new wt(this.center,this.radius,this.radius).transform(t)}bbox(){return ge.fromPoints(this.center.sub(T(this.radius)),this.center.add(T(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new ta(this.center,this.radius)}collides(t){return Dr(this,t)}contains(t){return this.collides(t)}raycast(t,s){return ea(t,s,this)}random(){return this.center.add(B.fromAngle(Ee(360)).scale(Ee(this.radius)))}},wt=class Qt{center;radiusX;radiusY;angle;constructor(t,s,i,n=0){this.center=t.clone(),this.radiusX=s,this.radiusY=i,this.angle=n}static fromMat2(t){let s=t.inverse,i=s.transpose.mul(s),[n,a]=i.eigenvalues,[r,l]=i.eigenvectors(n,a),[o,d]=[1/Math.sqrt(n),1/Math.sqrt(a)];return o>d?new Qt(T(),o,d,Rt(Math.atan2(-r[1],r[0]))):new Qt(T(),d,o,Rt(Math.atan2(-l[1],l[0])))}toMat2(){let t=Pe(this.angle),s=Math.cos(t),i=Math.sin(t);return new Wn(s*this.radiusX,-i*this.radiusY,i*this.radiusX,s*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new Qt(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let s=this.toMat2(),i=t.getRotation(),n=t.getScale();s=on.fromMat2(s).scale(n.x,n.y).rotate(i).toMat2();let a=Qt.fromMat2(s);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return ge.fromPoints(this.center.sub(T(this.radiusX,this.radiusY)),this.center.add(T(this.radiusX,this.radiusY)));{let t=Pe(this.angle),s=Math.cos(t),i=Math.sin(t),n=this.radiusX*s,a=this.radiusX*i,r=this.radiusY*i,l=this.radiusY*s,o=Math.sqrt(n*n+r*r),d=Math.sqrt(a*a+l*l);return ge.fromPoints(this.center.sub(T(o,d)),this.center.add(T(o,d)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new Qt(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return qr(this,t)}contains(t){t=t.sub(this.center);let s=Pe(this.angle),i=Math.cos(s),n=Math.sin(s),a=t.x*i+t.y*n,r=-t.x*n+t.y*i;return a*a/(this.radiusX*this.radiusX)+r*r/(this.radiusY*this.radiusY)<1}raycast(t,s){return Or(t,s,this)}random(){return this.center}};function Lr(e,t,s,i){let n=t.sub(e),a=i.sub(s),r=n.cross(a);return r<1e-5&&r>-1e-5||(r=s.sub(e).cross(a)/r,r<0||r>1)?null:e.add(n.scale(r))}var Ne=class dn{pts;constructor(t){if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new dn(this.pts.map(s=>t.multVec2(s)))}bbox(){let t=T(Number.MAX_VALUE),s=T(-Number.MAX_VALUE);for(let i of this.pts)t.x=Math.min(t.x,i.x),s.x=Math.max(s.x,i.x),t.y=Math.min(t.y,i.y),s.y=Math.max(s.y,i.y);return ge.fromPoints(t,s)}area(){let t=0,s=this.pts.length;for(let i=0;i<s;i++){let n=this.pts[i],a=this.pts[(i+1)%s];t+=n.x*a.y*.5,t-=a.x*n.y*.5}return Math.abs(t)}clone(){return new dn(this.pts.map(t=>t.clone()))}collides(t){return Hr(this,t)}contains(t){return this.collides(t)}raycast(t,s){return Fr(t,s,this)}random(){return T()}cut(t,s){new Xe(t,s);let i=[],n=[],a=s.sub(t),r=this.pts[this.pts.length-1],l=r.sub(t),o=a.cross(l)>0;return this.pts.forEach(d=>{l=d.sub(t);let h=a.cross(l)>0;if(o!=h){let c=Lr(r,d,t,s);i.push(c),n.push(c),o=h}(h?i:n).push(d),r=d}),[i.length?new dn(i):null,n.length?new dn(n):null]}};function Ur(e,t,s,i){let n=i*i,a=1-i,r=a*a;return e.scale(r).add(t.scale(2*a*i)).add(s.scale(n))}function Gr(e,t,s,i){let n=1-i;return t.sub(e).scale(2*n).add(s.sub(t).scale(2*i))}function zr(e,t,s,i){return s.sub(t.scale(2)).add(e).scale(2)}function si(e,t,s,i,n){let a=n*n,r=a*n,l=1-n,o=l*l,d=o*l;return e.scale(d).add(t.scale(3*o*n)).add(s.scale(3*l*a)).add(i.scale(r))}function Kr(e,t,s,i,n){let a=n*n,r=1-n,l=r*r;return t.sub(e).scale(3*l).add(s.sub(t).scale(6*r*n)).add(i.sub(s).scale(3*a))}function Xr(e,t,s,i,n){let a=1-n;return s.sub(t.scale(2)).add(e).scale(6*a).add(i.sub(s.scale(2)).add(t).scale(6*n))}function Wr(e,t,s,i,n){let a=.5*(((-n+2)*n-1)*n),r=.5*((3*n-5)*n*n+2),l=.5*(((-3*n+4)*n+1)*n),o=.5*((n-1)*n*n);return e.scale(a).add(t.scale(r)).add(s.scale(l)).add(i.scale(o))}function Yr(e,t,s,i,n){let a=.5*((-3*n+4)*n-1),r=.5*((9*n-10)*n),l=.5*((-9*n+8)*n+1),o=.5*((3*n-2)*n);return e.scale(a).add(t.scale(r)).add(s.scale(l)).add(i.scale(o))}function Vr(e){let t=na(e),s=t(1);return i=>{let n=i*s,a=t(n,!0);return e(a)}}function na(e,t=10,s=10){let i=[0],n=[0],a=1/(t-1)/s,r=0,l=e(0),o=0;for(let d=1;d<t;d++){for(let h=0;h<s;h++){o+=a;let c=e(o),u=c.dist(l);r+=u,l=c}i[d]=r,n[d]=o}return n[t-1]=1,(d,h=!1)=>{if(h){let c=d;if(c<=0)return 0;if(c>=r)return 1;let u=0;for(;i[u+1]<c;)u++;let m=n[u],f=n[u+1],w=i[u],p=i[u+1],g=(c-w)/(p-w);return m+(f-m)*g}else{if(d<=0)return 0;if(d>=1)return i[t-1];let c=0;for(;n[c+1]<d;)c++;let u=n[c],m=n[c+1],f=i[c],w=i[c+1],p=(d-u)/(m-u);return f+(w-f)*p}}}function Sn(e,t,s,i){let n=2*e+t-2*i+s,a=-3*e+3*i-2*t-s,r=t,l=e;return o=>{let d=o*o,h=d*o;return n*h+a*d+r*o+l}}function sa(e,t,s,i,n,a=Sn){let r=a(t.x,(1-n)*(s.x-e.x),(1-n)*(i.x-t.x),s.x),l=a(t.y,(1-n)*(s.y-e.y),(1-n)*(i.y-t.y),s.y);return o=>new B(r(o),l(o))}function Vn(e,t,s,i,n=Sn){return sa(e,t,s,i,.5,n)}function Qr(e,t,s,i,n=Sn){return Vn(i.add(e.sub(t).scale(6)),e,i,e.add(i.sub(s).scale(6)),n)}function $r(e,t,s,i,n,a,r,l=Sn){let o=l(t.x,.5*(1-n)*(1+r)*(1+a)*(t.x-e.x)+.5*(1-n)*(1-r)*(1-a)*(s.x-t.x),.5*(1-n)*(1+r)*(1-a)*(s.x-t.x)+.5*(1-n)*(1-r)*(1+a)*(i.x-s.x),s.x),d=l(t.y,.5*(1-n)*(1+r)*(1+a)*(t.y-e.y)+.5*(1-n)*(1-r)*(1-a)*(s.y-t.y),.5*(1-n)*(1+r)*(1-a)*(s.y-t.y)+.5*(1-n)*(1-r)*(1+a)*(i.y-s.y),s.y);return h=>new B(o(h),d(h))}function Jr(e,t,s,i){let n=2*e+t-2*i+s,a=-3*e+3*i-2*t+s,r=t;return l=>{let o=l*l;return 3*n*o+2*a*l+r}}function sn(e){return 0<=e&&e<=1}function ms(e,t){return Math.abs(e-t)<=Number.EPSILON}function an(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Zr(e,t,s,i){let n=3*e-6*t+3*s,a=-3*e+3*t,r=e,l=-e+3*t-3*s+i;if(ms(l,0)){if(ms(n,0))return ms(a,0)?[]:[-r/a].filter(sn);let p=Math.sqrt(a*a-4*n*r),g=2*n;return[(p-a)/g,(-a-p)/g].filter(sn)}n/=l,a/=l,r/=l;let o=(3*a-n*n)/3,d=o/3,h=(2*n*n*n-9*n*a+27*r)/27,c=h/2,u=c*c+d*d*d;if(u<0){let p=-o/3,g=p*p*p,x=Math.sqrt(g),P=-h/(2*x),H=P<-1?-1:P>1?1:P,C=Math.acos(H),A=2*an(x),b=A*Math.cos(C/3)-n/3,E=A*Math.cos((C+2*Math.PI)/3)-n/3,M=A*Math.cos((C+4*Math.PI)/3)-n/3;return[b,E,M].filter(sn)}if(u===0){let p=c<0?an(-c):-an(c),g=2*p-n/3,x=-p-n/3;return[g,x].filter(sn)}let m=Math.sqrt(u),f=an(m-c),w=an(m+c);return[f-w-n/3].filter(sn)}function _r(e,t,s,i,n){let a=Zr(e.x-n,t.x-n,s.x-n,i.x-n);return a.length>0?si(e,t,s,i,a[0]).y:NaN}function kr(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return s=>{if(s<=0||e.length==1||s<=e[0].x)return e[0].y;for(let i=0;i<t;i++)if(e[i].x>=s)return dt(s,e[i-1].x,e[i].x,e[i-1].y,e[i].y);return e[e.length-1].y}}function eo(e,t){return s=>_r(T(0,0),e,t,T(1,1),s)}function to(e,t="jump-end"){let s=1/e,i=t=="jump-start"||t=="jump-both",n=t=="jump-end"||t=="jump-both",a=1/(e+(n?1:0)),r=i?a:0;return l=>{let o=Math.floor(l/s);return r+o*a}}function no(e,t){let s=Number.MAX_VALUE,i={normal:T(0),distance:0};for(let n of[e,t])for(let a=0;a<n.pts.length;a++){let r=n.pts[a],l=n.pts[(a+1)%n.pts.length].sub(r).normal().unit(),o=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let m=0;m<e.pts.length;m++){let f=e.pts[m].dot(l);o=Math.min(o,f),d=Math.max(d,f)}let h=Number.MAX_VALUE,c=-Number.MAX_VALUE;for(let m=0;m<t.pts.length;m++){let f=t.pts[m].dot(l);h=Math.min(h,f),c=Math.max(c,f)}let u=Math.min(d,c)-Math.max(o,h);if(u<0)return null;if(u<Math.abs(s)){let m=c-o,f=h-d;s=Math.abs(m)<Math.abs(f)?m:f,i.normal=l,i.distance=s}}return i}function ia(e,t,s){return(t.x-e.x)*(s.y-e.y)-(t.y-e.y)*(s.x-e.x)>=0}function so(e){let t=0,s=e[e.length-1];for(let i=0;i<e.length;i++)t+=(e[i].x-s.x)*(e[i].y+s.y),s=e[i];return t<0}function ys(e,t,s,i){let n=i.x-s.x,a=i.y-s.y,r=n*(e.y-s.y)-a*(e.x-s.x),l=n*(t.y-s.y)-a*(t.x-s.x);return r*l>=0}function io(e,t,s,i){return ys(e,t,s,i)&&ys(e,s,t,i)&&ys(e,i,t,s)}function ao(e,t,s,i){for(let n of e)if(n!==t&&n!==s&&n!==i&&io(n,t,s,i))return!0;return!1}function ro(e,t,s,i){return ia(e,t,s)&&!ao(i,e,t,s)}function aa(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],s=[],i=0;for(let c=0;c<e.length;c++){let u=e[i],m=e[c];(m.x<u.x||m.x==u.x&&m.y<u.y)&&(i=i),t[c]=c+1,s[c]=c-1}t[t.length-1]=0,s[0]=s.length-1,so(e)||([t,s]=[s,t]);let n=[];for(let c=0;c<e.length;++c)ia(e[s[c]],e[c],e[t[c]])||n.push(e[c]);let a=[],r=e.length,l=1,o=0,d,h;for(;r>3;){d=t[l],h=s[l];let c=e[h],u=e[l],m=e[d];if(ro(c,u,m,n))a.push([c,u,m]),t[h]=d,s[d]=h,n.splice(n.indexOf(u),1),--r,o=0;else if(++o>r)return[];l=d}return d=t[l],h=s[l],a.push([e[h],e[l],e[d]]),a}function oo(e){if(e.length<3)return!1;let t=e.length-2,s=e.length-1,i=0,n=e[s].sub(e[t]),a=e[i].sub(e[s]),r=n.cross(a);for(;i+1<e.length;)if(t=s,s=i,i++,n=e[s].sub(e[t]),a=e[i].sub(e[s]),n.cross(a)*r<0)return!1;return!0}var ra=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ss="topleft",lo="monospace",Qn="monospace",Rs="linear",ii=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],uo=ii.reduce((e,t)=>e+t.size,0),oa=2048,co=oa*4*uo,ho=oa*6,po=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,fo=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Fs=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Os=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,go=new Set(["id","require"]),mo=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),Si=200,yo=640,wo=65536,la=Symbol.for("kaplay.cancel"),da=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},Lt=class ua{paused=!1;cancel;constructor(t){this.cancel=t}static join(t){let s=new ua(()=>t.forEach(i=>i.cancel()));return Object.defineProperty(s,"paused",{get:()=>t[0].paused,set:i=>t.forEach(n=>n.paused=i)}),s.paused=!1,s}static replace(t,s){return t.cancel=()=>s.cancel(),s.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>s.paused,set:i=>s.paused=i}),t}},Oe=class{cancellers=new WeakMap;handlers=new da;add(e){function t(...n){if(!i.paused)return e(...n)}let s=this.handlers.pushd(t),i=new Lt(s);return this.cancellers.set(t,s),i}addOnce(e){let t=this.add((...s)=>{t.cancel(),e(...s)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let s=t(...e),i;s===la&&(i=this.cancellers.get(t))&&i()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},yn=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new Oe),this.handlers[e].add(t)}onOnce(e,t){let s=this.on(e,(...i)=>{s.cancel(),t(...i)});return s}next(e){return new Promise(t=>{this.onOnce(e,(...s)=>t(s[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},vo=e=>e[0]instanceof te,bo=e=>e[0]instanceof B,xo=e=>typeof e[0]=="number",ca=class{_items;_compareFn;constructor(e=(t,s)=>t<s){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function Ao(e){let t=window.atob(e),s=t.length,i=new Uint8Array(s);for(let n=0;n<s;n++)i[n]=t.charCodeAt(n);return i.buffer}function So(e){return Ao(e.split(",")[1])}function ai(e,t){let s=document.createElement("a");s.href=t,s.download=e,s.click()}function ha(e,t){ai(e,"data:text/plain;charset=utf-8,"+t)}function Po(e,t){ha(e,JSON.stringify(t))}function Pi(e,t){let s=URL.createObjectURL(t);ai(e,s),URL.revokeObjectURL(s)}var pa=e=>e.match(/^data:\w+\/\w+;base64,.+/),Co=e=>e.split(".").slice(0,-1).join(".");function ri(e,t){if(e===t)return!0;let s=typeof e,i=typeof t;if(s!==i)return!1;if(s==="object"&&i==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let n=Object.keys(e),a=Object.keys(t);if(n.length!==a.length)return!1;for(let r of n){let l=e[r],o=t[r];if(!ri(l,o))return!1}return!0}return!1}var Ci=new Set,Mo=e=>e instanceof Error?e.message:String(e);function Eo(e){Ci.has(e)||(Ci.add(e),console.warn(e))}function kt(e,t){Eo(`${e} is deprecated. Use ${t} instead.`)}function js(e,t){return Number(e.toFixed(t))}function ye(e,t){return(...s)=>{let i=s.length;if(i===e.length)return e(...s);if(i===t.length)return t(...s)}}var To=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function Io(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],s=0,i=0;for(;s<e.length;){if(i+=Do(s+i,e),jo(e[s+i])&&i++,Ro(e[s+i])&&i++,Fo(e[s+i])&&i++,No(e[s+i])){i++;continue}t.push(e.substring(s,s+i)),s+=i,i=0}return t}function Do(e,t){let s=t[e];if(!Bo(s)||e===t.length-1)return 1;let i=s+t[e+1],n=t.substring(e+2,e+5);return Mi(i)&&Mi(n)?4:Ho(i)&&Oo(n)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:qo(n)?4:2}function Bo(e){return e&&Ut(e[0].charCodeAt(0),55296,56319)}function Mi(e){return Ut(oi(e),127462,127487)}function Ho(e){return Ut(oi(e),127988,127988)}function qo(e){return Ut(oi(e),127995,127999)}function Ro(e){return typeof e=="string"&&Ut(e.charCodeAt(0),65024,65039)}function Fo(e){return typeof e=="string"&&Ut(e.charCodeAt(0),8400,8447)}function Oo(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&Ut(t,917504,917631)}function jo(e){return typeof e=="string"&&To.includes(e.charCodeAt(0))}function No(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function oi(e){let t=e.charCodeAt(0)-55296,s=e.charCodeAt(1)-56320;return(t<<10)+s+65536}function Ut(e,t,s){return e>=t&&e<=s}var Ve=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,at=(e,t)=>Array.isArray(t)?t.some(s=>e.has(s)):e.has(t),Bn=(e,t,s)=>{e.has(t)?e.get(t)?.push(s):e.set(t,[s])},Lo=(()=>{let e=0;return()=>e++})(),Uo={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function fa(){let e=y.globalOpt.pixelDensity??1,t=y.globalOpt.width,s=y.globalOpt.height,i=y.gfx.ggl.gl.drawingBufferWidth,n=y.gfx.ggl.gl.drawingBufferHeight,a=i/e,r=n/e,l=0,o=0,d=a,h=r;if(y.globalOpt.letterbox){if(!t||!s)throw new Error("Letterboxing requires width and height defined.");let c=a/r,u=t/s;if(c>u){let m=r*u;l=(a-m)/2,d=m}else{let m=a/u;h=m,o=(r-m)/2}}if(y.globalOpt.stretch&&(!y.globalOpt.width||!y.globalOpt.height))throw new Error("Stretching requires width and height defined.");y.gfx.viewport={x:l,y:o,width:d,height:h,scale:(y.gfx.viewport.width+y.gfx.viewport.height)/(y.gfx.width+y.gfx.height)}}function Go(e){return new B(e.x*y.gfx.viewport.width/y.gfx.width,e.y*y.gfx.viewport.height/y.gfx.height)}function gt(e){return new B((e.x-y.gfx.viewport.x)*y.gfx.width/y.gfx.viewport.width,(e.y-y.gfx.viewport.y)*y.gfx.height/y.gfx.viewport.height)}var zo=()=>Ht.lastInputDevice,Ko=()=>{let e=Ht.buttons;for(let t in e){let s=e[t].keyboard&&[e[t].keyboard].flat(),i=e[t].keyboardCode&&[e[t].keyboardCode].flat(),n=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();s&&s.forEach(r=>{Bn(Ht.buttonsByKey,r,t)}),i&&i.forEach(r=>{Bn(Ht.buttonsByKeyCode,r,t)}),n&&n.forEach(r=>{Bn(Ht.buttonsByGamepad,r,t)}),a&&a.forEach(r=>{Bn(Ht.buttonsByMouse,r,t)})}},pn=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},Xo=class{buttonState=new pn;stickState=new Map},Wo=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,s)=>t+s)/this.dts.length)),this.dts=[])}},Ht,Ei=Uo,Yo=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new Wo,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new B(0),mouseDeltaPos:new B(0),keyState:new pn,mouseState:new pn,mergedGamepadState:new Xo,gamepadStates:new Map,lastInputDevice:null,buttonState:new pn,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new yn}},Vo=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=Yo(e);Ht=t,Ko();function s(){return t.dt*t.timeScale}function i(){return t.fixedDt*t.timeScale}function n(){return t.restDt*t.timeScale}function a(){return t.isHidden}function r(){return t.time}function l(){return t.fpsCounter.fps}function o(){return t.numFrames}function d(){return t.canvas.toDataURL()}function h(v){t.canvas.style.cursor=v}function c(){return t.canvas.style.cursor}function u(v){if(v)try{let I=t.canvas.requestPointerLock();I?.catch&&I.catch(q=>console.error(q))}catch(I){console.error(I)}else document.exitPointerLock()}function m(){return!!document.pointerLockElement}function f(v){v.requestFullscreen?v.requestFullscreen():v.webkitRequestFullscreen&&v.webkitRequestFullscreen()}function w(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function p(v=!0){v?f(t.canvas):w()}function g(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function x(){t.stopped=!0;let v=Object.entries(Ue),I=Object.entries(fs),q=Object.entries(Dn);for(let[j,ie]of v)t.canvas.removeEventListener(j,ie);for(let[j,ie]of I)document.removeEventListener(j,ie);for(let[j,ie]of q)window.removeEventListener(j,ie);xi.disconnect()}function P(v,I){t.loopID!==null&&cancelAnimationFrame(t.loopID);let q=0,j=0,ie=ve=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(ie);return}let Ye=ve/1e3,Wt=Math.min(Ye-t.realTime,.25),ft=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Ye,j+=Wt,j>ft){if(!t.skipTime){for(q+=j,t.dt=t.fixedDt,t.restDt=0;q>t.fixedDt;)q-=t.fixedDt,q<t.fixedDt&&(t.restDt=q),v();t.restDt=q,t.dt=j,t.time+=s(),t.fpsCounter.tick(t.dt)}j=0,t.skipTime=!1,t.numFrames++,I(dr,ur)}t.loopID=requestAnimationFrame(ie)};ie(0)}function H(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function C(){return t.mousePos.clone()}function A(){return t.mouseDeltaPos.clone()}function b(v="left"){return t.mouseState.pressed.has(v)}function E(v="left"){return t.mouseState.down.has(v)}function M(v="left"){return t.mouseState.released.has(v)}function D(){return t.isMouseMoved}function O(v){return v===void 0?t.keyState.pressed.size>0:at(t.keyState.pressed,v)}function N(v){return v===void 0?t.keyState.pressedRepeat.size>0:at(t.keyState.pressedRepeat,v)}function W(v){return v===void 0?t.keyState.down.size>0:at(t.keyState.down,v)}function U(v){return v===void 0?t.keyState.released.size>0:at(t.keyState.released,v)}function k(v){return v===void 0?t.mergedGamepadState.buttonState.pressed.size>0:at(t.mergedGamepadState.buttonState.pressed,v)}function V(v){return v===void 0?t.mergedGamepadState.buttonState.down.size>0:at(t.mergedGamepadState.buttonState.down,v)}function z(v){return v===void 0?t.mergedGamepadState.buttonState.released.size>0:at(t.mergedGamepadState.buttonState.released,v)}function ne(v){return v===void 0?t.buttonState.pressed.size>0:at(t.buttonState.pressed,v)}function Y(v){return v===void 0?t.buttonState.down.size>0:at(t.buttonState.down,v)}function _(v){return v===void 0?t.buttonState.released.size>0:at(t.buttonState.released,v)}function me(v){return t.buttons?.[v]}function X(v,I){t.buttons[v]={...t.buttons[v],...I}}function ke(v){t.buttonState.press(v),t.events.trigger("buttonPress",v)}function vt(v){t.buttonState.release(v),t.events.trigger("buttonRelease",v)}function zt(v){return t.events.on("resize",v)}let Kt=ye(v=>t.events.on("keyDown",v),(v,I)=>t.events.on("keyDown",q=>Ve(v,q)&&I(q))),It=ye(v=>t.events.on("keyPress",I=>v(I)),(v,I)=>t.events.on("keyPress",q=>Ve(v,q)&&I(q))),ls=ye(v=>t.events.on("keyPressRepeat",v),(v,I)=>t.events.on("keyPressRepeat",q=>Ve(v,q)&&I(q))),ds=ye(v=>t.events.on("keyRelease",v),(v,I)=>t.events.on("keyRelease",q=>Ve(v,q)&&I(q))),Xt=ye(v=>t.events.on("mouseDown",I=>v(I)),(v,I)=>t.events.on("mouseDown",q=>Ve(v,q)&&I(q))),st=ye(v=>t.events.on("mousePress",I=>v(I)),(v,I)=>t.events.on("mousePress",q=>Ve(v,q)&&I(q))),Mn=ye(v=>t.events.on("mouseRelease",I=>v(I)),(v,I)=>t.events.on("mouseRelease",q=>q===v&&I(q)));function G(v){return t.events.on("mouseMove",()=>v(C(),A()))}function $(v){return t.events.on("charInput",v)}function ee(v){return t.events.on("touchStart",v)}function fe(v){return t.events.on("touchMove",v)}function Ce(v){return t.events.on("touchEnd",v)}function se(v){return t.events.on("scroll",v)}function Re(v){return t.events.on("hide",v)}function bt(v){return t.events.on("show",v)}let us=ye(v=>t.events.on("gamepadButtonPress",(I,q)=>v(I,q)),(v,I)=>t.events.on("gamepadButtonPress",(q,j)=>Ve(v,q)&&I(q,j))),cs=ye(v=>t.events.on("gamepadButtonDown",(I,q)=>v(I,q)),(v,I)=>t.events.on("gamepadButtonDown",(q,j)=>Ve(v,q)&&I(q,j))),hs=ye(v=>t.events.on("gamepadButtonRelease",(I,q)=>v(I,q)),(v,I)=>t.events.on("gamepadButtonRelease",(q,j)=>Ve(v,q)&&I(q,j)));function ps(v,I){return t.events.on("gamepadStick",(q,j,ie)=>q===v&&I(j,ie))}function En(v){t.events.on("gamepadConnect",v)}function it(v){t.events.on("gamepadDisconnect",v)}function xt(v){return t.mergedGamepadState.stickState.get(v)||new B(0)}function Tn(){return[...t.charInputted]}function Le(){return[...t.gamepads]}let nn=ye(v=>t.events.on("buttonPress",I=>v(I)),(v,I)=>t.events.on("buttonPress",q=>Ve(v,q)&&I(q))),pt=ye(v=>t.events.on("buttonDown",I=>v(I)),(v,I)=>t.events.on("buttonDown",q=>Ve(v,q)&&I(q))),In=ye(v=>t.events.on("buttonRelease",I=>v(I)),(v,I)=>t.events.on("buttonRelease",q=>Ve(v,q)&&I(q)));function dr(){t.events.trigger("input"),t.keyState.down.forEach(v=>t.events.trigger("keyDown",v)),t.mouseState.down.forEach(v=>t.events.trigger("mouseDown",v)),t.buttonState.down.forEach(v=>{t.events.trigger("buttonDown",v)}),hr()}function ur(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((v,I)=>{t.mergedGamepadState.stickState.set(I,new B(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new B(0),t.gamepadStates.forEach(v=>{v.buttonState.update(),v.stickState.forEach((I,q)=>{v.stickState.set(q,new B(0))})})}function yi(v){let I={index:v.index,isPressed:q=>t.gamepadStates.get(v.index)?.buttonState.pressed.has(q)||!1,isDown:q=>t.gamepadStates.get(v.index)?.buttonState.down.has(q)||!1,isReleased:q=>t.gamepadStates.get(v.index)?.buttonState.released.has(q)||!1,getStick:q=>t.gamepadStates.get(v.index)?.stickState.get(q)||T()};return t.gamepads.push(I),t.gamepadStates.set(v.index,{buttonState:new pn,stickState:new Map([["left",new B(0)],["right",new B(0)]])}),I}function cr(v){t.gamepads=t.gamepads.filter(I=>I.index!==v.index),t.gamepadStates.delete(v.index)}function hr(){for(let v of navigator.getGamepads())v&&!t.gamepadStates.has(v.index)&&yi(v);for(let v of t.gamepads){let I=navigator.getGamepads()[v.index];if(!I)continue;let q=(e.gamepads??{})[I.id]||Ei[I.id]||Ei.default,j=t.gamepadStates.get(v.index);if(j){for(let ie=0;ie<I.buttons.length;ie++){let ve=q.buttons[ie],Ye=I.buttons[ie],Wt=t.buttonsByGamepad.has(ve);if(Ye.pressed){if(j.buttonState.down.has(ve)){t.events.trigger("gamepadButtonDown",ve,v);continue}t.lastInputDevice="gamepad",Wt&&t.buttonsByGamepad.get(ve)?.forEach(ft=>{t.buttonState.press(ft),t.events.trigger("buttonPress",ft)}),t.mergedGamepadState.buttonState.press(ve),j.buttonState.press(ve),t.events.trigger("gamepadButtonPress",ve,v)}else j.buttonState.down.has(ve)&&(Wt&&t.buttonsByGamepad.get(ve)?.forEach(ft=>{t.buttonState.release(ft),t.events.trigger("buttonRelease",ft)}),t.mergedGamepadState.buttonState.release(ve),j.buttonState.release(ve),t.events.trigger("gamepadButtonRelease",ve,v))}for(let ie in q.sticks){let ve=q.sticks[ie];if(!ve)continue;let Ye=new B(I.axes[ve.x],I.axes[ve.y]);j.stickState.set(ie,Ye),t.mergedGamepadState.stickState.set(ie,Ye),t.events.trigger("gamepadStick",ie,Ye,v)}}}}let Ue={},fs={},Dn={},wi=e.pixelDensity||1;Ue.mousemove=v=>{let I=gt(new B(v.offsetX,v.offsetY)),q=new B(v.movementX,v.movementY);if(g()){let j=t.canvas.width/wi,ie=t.canvas.height/wi,ve=window.innerWidth,Ye=window.innerHeight,Wt=ve/Ye,ft=j/ie;if(Wt>ft){let Dt=Ye/ie,gs=(ve-j*Dt)/2;I.x=dt(v.offsetX-gs,0,j*Dt,0,j),I.y=dt(v.offsetY,0,ie*Dt,0,ie)}else{let Dt=ve/j,gs=(Ye-ie*Dt)/2;I.x=dt(v.offsetX,0,j*Dt,0,j),I.y=dt(v.offsetY-gs,0,ie*Dt,0,ie)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=I,t.mouseDeltaPos=q,t.events.trigger("mouseMove")})};let vi=["left","middle","right","back","forward"];Ue.mousedown=v=>{t.events.onOnce("input",()=>{let I=vi[v.button];I&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(I)&&t.buttonsByMouse.get(I)?.forEach(q=>{t.buttonState.press(q),t.events.trigger("buttonPress",q)}),t.mouseState.press(I),t.events.trigger("mousePress",I))})},Ue.mouseup=v=>{t.events.onOnce("input",()=>{let I=vi[v.button];I&&(t.buttonsByMouse.has(I)&&t.buttonsByMouse.get(I)?.forEach(q=>{t.buttonState.release(q),t.events.trigger("buttonRelease",q)}),t.mouseState.release(I),t.events.trigger("mouseRelease",I))})};let pr=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),bi={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};Ue.keydown=v=>{pr.has(v.key)&&v.preventDefault(),t.events.onOnce("input",()=>{let I=bi[v.key]||v.key.toLowerCase(),q=v.code;if(I===void 0)throw new Error(`Unknown key: ${v.key}`);I.length===1?(t.events.trigger("charInput",I),t.charInputted.push(I)):I==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),v.repeat?(t.keyState.pressRepeat(I),t.events.trigger("keyPressRepeat",I)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(I)&&t.buttonsByKey.get(I)?.forEach(j=>{t.buttonState.press(j),t.events.trigger("buttonPress",j)}),t.buttonsByKeyCode.has(q)&&t.buttonsByKeyCode.get(q)?.forEach(j=>{t.buttonState.press(j),t.events.trigger("buttonPress",j)}),t.keyState.press(I),t.events.trigger("keyPressRepeat",I),t.events.trigger("keyPress",I))})},Ue.keyup=v=>{t.events.onOnce("input",()=>{let I=bi[v.key]||v.key.toLowerCase(),q=v.code;t.buttonsByKey.has(I)&&t.buttonsByKey.get(I)?.forEach(j=>{t.buttonState.release(j),t.events.trigger("buttonRelease",j)}),t.buttonsByKeyCode.has(q)&&t.buttonsByKeyCode.get(q)?.forEach(j=>{t.buttonState.release(j),t.events.trigger("buttonRelease",j)}),t.keyState.release(I),t.events.trigger("keyRelease",I)})},Ue.touchstart=v=>{v.preventDefault(),t.events.onOnce("input",()=>{let I=[...v.changedTouches],q=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=gt(new B(I[0].clientX-q.x,I[0].clientY-q.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(j=>{t.buttonState.press(j),t.events.trigger("buttonPress",j)}),t.mouseState.press("left"),t.events.trigger("mousePress","left")),I.forEach(j=>{t.events.trigger("touchStart",gt(new B(j.clientX-q.x,j.clientY-q.y)),j)})})},Ue.touchmove=v=>{v.preventDefault(),t.events.onOnce("input",()=>{let I=[...v.changedTouches],q=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let j=t.mousePos;t.mousePos=gt(new B(I[0].clientX-q.x,I[0].clientY-q.y)),t.mouseDeltaPos=t.mousePos.sub(j),t.events.trigger("mouseMove")}I.forEach(j=>{t.events.trigger("touchMove",gt(new B(j.clientX-q.x,j.clientY-q.y)),j)})})},Ue.touchend=v=>{t.events.onOnce("input",()=>{let I=[...v.changedTouches],q=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=gt(new B(I[0].clientX-q.x,I[0].clientY-q.y)),t.mouseDeltaPos=new B(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(j=>{t.buttonState.release(j),t.events.trigger("buttonRelease",j)}),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),I.forEach(j=>{t.events.trigger("touchEnd",gt(new B(j.clientX-q.x,j.clientY-q.y)),j)})})},Ue.touchcancel=v=>{t.events.onOnce("input",()=>{let I=[...v.changedTouches],q=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=gt(new B(I[0].clientX-q.x,I[0].clientY-q.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),I.forEach(j=>{t.events.trigger("touchEnd",gt(new B(j.clientX-q.x,j.clientY-q.y)),j)})})},Ue.wheel=v=>{v.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new B(v.deltaX,v.deltaY))})},Ue.contextmenu=v=>v.preventDefault(),fs.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},Dn.gamepadconnected=v=>{let I=yi(v.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",I)})},Dn.gamepaddisconnected=v=>{let I=Le().filter(q=>q.index===v.gamepad.index)[0];cr(v.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",I)})};for(let[v,I]of Object.entries(Ue))t.canvas.addEventListener(v,I);for(let[v,I]of Object.entries(fs))document.addEventListener(v,I);for(let[v,I]of Object.entries(Dn))window.addEventListener(v,I);let xi=new ResizeObserver(v=>{for(let I of v)if(I.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return xi.observe(t.canvas),{state:t,dt:s,fixedDt:i,restDt:n,time:r,run:P,canvas:t.canvas,fps:l,numFrames:o,quit:x,isHidden:a,setFullscreen:p,isFullscreen:g,setCursor:h,screenshot:d,getGamepads:Le,getCursor:c,setCursorLocked:u,isCursorLocked:m,isTouchscreen:H,mousePos:C,mouseDeltaPos:A,isKeyDown:W,isKeyPressed:O,isKeyPressedRepeat:N,isKeyReleased:U,isMouseDown:E,isMousePressed:b,isMouseReleased:M,isMouseMoved:D,isGamepadButtonPressed:k,isGamepadButtonDown:V,isGamepadButtonReleased:z,getGamepadStick:xt,isButtonPressed:ne,isButtonDown:Y,isButtonReleased:_,setButton:X,getButton:me,pressButton:ke,releaseButton:vt,charInputted:Tn,onResize:zt,onKeyDown:Kt,onKeyPress:It,onKeyPressRepeat:ls,onKeyRelease:ds,onMouseDown:Xt,onMousePress:st,onMouseRelease:Mn,onMouseMove:G,onCharInput:$,onTouchStart:ee,onTouchMove:fe,onTouchEnd:Ce,onScroll:se,onHide:Re,onShow:bt,onGamepadButtonDown:cs,onGamepadButtonPress:us,onGamepadButtonRelease:hs,onGamepadStick:ps,onGamepadConnect:En,onGamepadDisconnect:it,onButtonPress:nn,onButtonDown:pt,onButtonRelease:In,getLastInputDeviceType:zo,events:t.events}};function Te(){return y.app.dt()}function Ns(){return y.app.fixedDt()}function Ls(){return y.app.restDt()}var Qo=new B(-1,-1),$o=new B(0,-1),Jo=new B(1,-1),Zo=new B(-1,0),_o=new B(0,0),ko=new B(1,0),el=new B(-1,1),tl=new B(0,1),nl=new B(1,1);function en(e){switch(e){case"topleft":return Qo;case"top":return $o;case"topright":return Jo;case"left":return Zo;case"center":return _o;case"right":return ko;case"botleft":return el;case"bot":return tl;case"botright":return nl;default:return e}}function sl(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function il(e){return e.createBuffer(1,1,44100)}var Hn=2.5949095,Ti=1.70158+1,Ii=2*Math.PI/3,Di=2*Math.PI/4.5,Gn={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>Ti*e*e*e-1.70158*e*e,easeOutBack:e=>1+Ti*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((Hn+1)*2*e-Hn)/2:(Math.pow(2*e-2,2)*((Hn+1)*(e*2-2)+Hn)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*Ii),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*Ii)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Di))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Di)/2+1,easeInBounce:e=>1-Gn.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Gn.easeOutBounce(1-2*e))/2:(1+Gn.easeOutBounce(2*e-1))/2},wn=Gn;function al(e,t,s){let i=[],n=t;for(i.push(n);n!==e;){if(n=s.get(n),n==null)return null;i.push(n)}return i.reverse()}function rl(e,t,s){let i=new ca((r,l)=>r.cost<l.cost);i.insert({cost:0,node:t});let n=new Map;n.set(t,t);let a=new Map;for(a.set(t,0);i.length!==0;){let r=i.remove()?.node;if(r===s)break;let l=e.getNeighbours(r);for(let o of l){let d=(a.get(r)||0)+e.getCost(r,o)+e.getHeuristic(o,s);(!a.has(o)||d<a.get(o))&&(a.set(o,d),i.insert({cost:d,node:o}),n.set(o,r))}}return al(t,s,n)}var ol=class{a;b;polygon;constructor(e,t,s){this.a=e,this.b=t,this.polygon=new WeakRef(s)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},ll=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,s=0,i=0;for(let n of this._edges){n.polygon=new WeakRef(this);let a=n.a.x*n.b.y-n.a.y*n.b.x;t+=(n.a.x+n.b.x)*a,s+=(n.a.y+n.b.y)*a,i+=a}i/=2,this._centroid=T(t/(6*i),s/(6*i))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let s of this.edges)s.b.y>e.y!=s.a.y>e.y&&e.x<(s.a.x-s.b.x)*(e.y-s.b.y)/(s.a.y-s.b.y)+s.b.x&&(t=!t);return t}},dl=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let s=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[s]}_findCommonEdge(e,t){for(let s of e.edges){let i=this._findEdge(s.b,s.a);if(i&&i.polygon.deref().id===t.id)return i}return null}addPolygon(e){let t=new ll(this._polygons.length),s=e.map((i,n)=>new ol(i,e[(n+1)%e.length],t));t.edges=s,this._polygons.push(t);for(let i of t.edges)this._addEdge(i);return t}addRect(e,t){let s=this._addPoint(e),i=this._addPoint(e.add(t.x,0)),n=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([s,i,n,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let s of this._polygons[e].edges){let i=this._findEdge(s.b,s.a);if(i){let n=i.polygon.deref();n&&t.push(n.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let s=this._polygons[e],i=this._polygons[t],n=s.centroid.x-i.centroid.x,a=s.centroid.y-i.centroid.y;return Math.sqrt(n*n+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:rl(this,e,t)}getWaypointPath(e,t,s){let i=s?.type||"centroids",n=this._getLocation(e),a=this._getLocation(t);if(n===void 0||a===void 0)return[];let r=this.getPath(n.id,a.id);if(!r)return[];if(i==="edges"){let l=[];for(let o=1;o<r.length;o++){let d=this._polygons[r[o-1]],h=this._polygons[r[o]],c=this._findCommonEdge(d,h);l.push(c.middle.add(h.centroid.sub(c.middle).unit().scale(4)))}return[e,...l,t]}else return[e,...r.slice(1,-1).map(l=>this._polygons[l].centroid),t]}};function fn(e){let t=new ht;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function ul(e){return new B(e.x/Be()*2-1,-e.y/qe()*2+1)}function un(e,t,s,i,n,a=1){i=Pe(i%360),n=Pe(n%360),n<=i&&(n+=Math.PI*2);let r=[],l=Math.ceil((n-i)/Pe(8)*a),o=(n-i)/l,d=T(Math.cos(i),Math.sin(i)),h=T(Math.cos(o),Math.sin(o));for(let c=0;c<=l;c++)r.push(e.add(t*d.x,s*d.y)),d=T(d.x*h.x-d.y*h.y,d.x*h.y+d.y*h.x);return r}function cl(...e){let t=ae(...e),s=e[3]??1;y.gfx.bgColor=t,y.gfx.bgAlpha=s,y.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,s)}function hl(){return y.gfx.bgColor?.clone?.()??null}function xe(...e){if(e[0]===void 0)return;let t=T(...e);t.x===0&&t.y===0||y.gfx.transform.translate(t)}function Qe(){y.gfx.transformStack.push(y.gfx.transform.clone())}function pl(e){y.gfx.transform=e.clone()}function vn(...e){if(e[0]===void 0)return;let t=T(...e);t.x===1&&t.y===1||y.gfx.transform.scale(t)}function Zt(e){e&&y.gfx.transform.rotate(e)}function Ge(){y.gfx.transformStack.length>0&&(y.gfx.transform=y.gfx.transformStack.pop())}function $e(){y.gfx.renderer.flush()}function Be(){return y.gfx.width}function qe(){return y.gfx.height}function ga(){return(y.gfx.viewport.width+y.gfx.viewport.height)/(y.gfx.width+y.gfx.height)}function $n(){return T(Be()/2,qe()/2)}var fl=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,s,i){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=s,this.textures=[Pt.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=i;let n=this.canvas.getContext("2d");if(!n)throw new Error("Failed to get 2d context");this.c2d=n}addSingle(e){let t=Pt.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new be(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,s=e.height+this.padding*2;if(t>this.canvas.width||s>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+s>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(Pt.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let i=this.textures[this.textures.length-1],n=new B(this.x+this.padding,this.y+this.padding);return this.x+=t,s>this.curHeight&&(this.curHeight=s),e instanceof ImageData?this.c2d.putImageData(e,n.x,n.y):this.c2d.drawImage(e,n.x,n.y),i.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:n,size:new B(e.width,e.height),texture:i}),this.lastTextureId++,[i,new be(n.x/this.canvas.width,n.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Ze(e){return typeof e!="string"||pa(e)?e:y.assets.urlPrefix+e}var _e=class ma{loaded=!1;data=null;error=null;onLoadEvents=new Oe;onErrorEvents=new Oe;onFinishEvents=new Oe;constructor(t){t.then(s=>{this.loaded=!0,this.data=s,this.onLoadEvents.trigger(s)}).catch(s=>{if(this.error=s,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(s);else throw s}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let s=new ma(Promise.resolve(t));return s.data=t,s.loaded=!0,s}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},Yt=class{assets=new Map;lastUID=0;add(e,t){let s=e??this.lastUID+++"",i=new _e(t);return this.assets.set(s,i),i}addLoaded(e,t){let s=e??this.lastUID+++"",i=_e.loaded(t);return this.assets.set(s,i),i}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function li(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function is(e){return li(e).then(t=>t.json())}function gl(e){return li(e).then(t=>t.text())}function ml(e){return li(e).then(t=>t.arrayBuffer())}function yl(e){return e!==void 0&&(y.assets.urlPrefix=e),y.assets.urlPrefix}function wl(e,t){return y.assets.custom.add(e,is(Ze(t)))}function as(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((s,i)=>{t.onload=()=>s(t),t.onerror=()=>i(new Error(`Failed to load image from "${e}"`))})}function Ft(){let e=[y.assets.sprites,y.assets.sounds,y.assets.shaders,y.assets.fonts,y.assets.bitmapFonts,y.assets.custom];return e.reduce((t,s)=>t+s.progress(),0)/e.length}function ya(){return[y.assets.sprites,y.assets.sounds,y.assets.shaders,y.assets.fonts,y.assets.bitmapFonts,y.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function vl(e){return y.assets.custom.get(e)??null}function Us(e){return y.assets.custom.add(null,e)}var bl=(e,t)=>({urlPrefix:"",sprites:new Yt,fonts:new Yt,bitmapFonts:new Yt,sounds:new Yt,shaders:new Yt,custom:new Yt,music:{},packer:new fl(e,2048,2048,t),loaded:!1}),xl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",Mt=class cn{tex;frames=[new be(0,0,1,1)];anims={};slice9=null;constructor(t,s,i={},n=null){this.tex=t,s&&(this.frames=s),this.anims=i,this.slice9=n}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,s={}){return typeof t=="string"?cn.fromURL(t,s):Promise.resolve(cn.fromImage(t,s))}static fromImage(t,s={}){let[i,n]=s.singular?y.assets.packer.addSingle(t):y.assets.packer.add(t),a=s.frames?s.frames.map(r=>new be(n.x+r.x*n.w,n.y+r.y*n.h,r.w*n.w,r.h*n.h)):va(s.sliceX||1,s.sliceY||1,n.x,n.y,n.w,n.h);return new cn(i,a,s.anims,s.slice9)}static fromURL(t,s={}){return as(t).then(i=>cn.fromImage(i,s))}};function zn(e){if(typeof e=="string"){let t=wa(e);if(t)return t;if(Ft()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof Mt)return _e.loaded(e);if(e instanceof _e)return e;throw new Error(`Invalid sprite: ${e}`)}}function wa(e){return y.assets.sprites.get(e)??null}function gn(e,t,s={sliceX:1,sliceY:1,anims:{}}){return t=Ze(t),Array.isArray(t)?t.some(i=>typeof i=="string")?y.assets.sprites.add(e,Promise.all(t.map(i=>typeof i=="string"?as(i):Promise.resolve(i))).then(i=>Bi(i,s))):y.assets.sprites.addLoaded(e,Bi(t,s)):typeof t=="string"?y.assets.sprites.add(e,Mt.from(t,s)):y.assets.sprites.addLoaded(e,Mt.fromImage(t,s))}function va(e=1,t=1,s=0,i=0,n=1,a=1){let r=[],l=n/e,o=a/t;for(let d=0;d<t;d++)for(let h=0;h<e;h++)r.push(new be(s+h*l,i+d*o,l,o));return r}function Bi(e,t={}){let s=document.createElement("canvas"),i=e[0].width,n=e[0].height;s.width=i*e.length,s.height=n;let a=s.getContext("2d");if(!a)throw new Error("Failed to create canvas context");e.forEach((l,o)=>{l instanceof ImageData?a.putImageData(l,o*i,0):a.drawImage(l,o*i,0)});let r=a.getImageData(0,0,e.length*i,n);return Mt.fromImage(r,{...t,sliceX:e.length,sliceY:1})}function Al(e="bean"){return gn(e,xl)}function Sl(e,t,s){t=Ze(t),s=Ze(s),typeof t=="string"&&!s&&(s=Co(t)+".json");let i=typeof s=="string"?is(s):Promise.resolve(s);return y.assets.sprites.add(e,i.then(n=>{let a=n.meta.size,r=n.frames.map(o=>new be(o.frame.x/a.w,o.frame.y/a.h,o.frame.w/a.w,o.frame.h/a.h)),l={};for(let o of n.meta.frameTags)o.from===o.to?l[o.name]=o.from:l[o.name]={from:o.from,to:o.to,speed:10,loop:!0,pingpong:o.direction==="pingpong"};return Mt.from(t,{frames:r,anims:l})}))}var Kn=class{fontface;filter=Rs;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??Rs,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:ae(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function ba(e){if(!e)return ba(y.globalOpt.font??lo);if(typeof e=="string"){let t=Aa(e),s=xa(e);if(t)return t.data??t;if(s)return s.data??s;if(document.fonts.check(`64px ${e}`))return e;if(Ft()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof _e)return e.data?e.data:e;return e}function xa(e){return y.assets.fonts.get(e)??null}function Pl(e,t,s={}){let i=Ze(t),n=new FontFace(e,typeof t=="string"?`url(${i})`:i);return document.fonts.add(n),y.assets.fonts.add(e,n.load().catch(a=>{throw new Error(`Failed to load font from "${i}": ${a}`)}).then(a=>new Kn(a,s)))}function Cl(e,t,s,i){let n=e.width/t,a={},r=i.split("").entries();for(let[l,o]of r)a[o]=new be(l%n*t,Math.floor(l/n)*s,t,s);return{tex:e,map:a,size:s}}function Aa(e){return y.assets.bitmapFonts.get(e)??null}function Ml(e,t,s,i,n={}){let a=Ze(t);return y.assets.bitmapFonts.add(e,as(a).then(r=>Cl(Pt.fromImage(y.gfx.ggl,r,n),s,i,n.chars??ra)))}function El(e,t){return t=Ze(t),y.assets.sprites.add(e,new Promise(async s=>{let i=typeof t=="string"?await is(t):t,n=await Promise.all(i.frames.map(as)),a=document.createElement("canvas");a.width=i.width,a.height=i.height*i.frames.length;let r=a.getContext("2d");if(!r)throw new Error("Failed to create canvas context");n.forEach((o,d)=>{r.drawImage(o,0,d*i.height)});let l=await gn(null,a,{sliceY:i.frames.length,anims:i.anims});s(l)}))}var Tl=class{ctx;glProgram;constructor(e,t,s,i){this.ctx=e,e.onDestroy(()=>this.free());let n=e.gl,a=n.createShader(n.VERTEX_SHADER),r=n.createShader(n.FRAGMENT_SHADER);if(!a||!r)throw new Error("Failed to create shader");n.shaderSource(a,t),n.shaderSource(r,s),n.compileShader(a),n.compileShader(r);let l=n.createProgram();if(this.glProgram=l,n.attachShader(l,a),n.attachShader(l,r),i.forEach((o,d)=>n.bindAttribLocation(l,d,o)),n.linkProgram(l),!n.getProgramParameter(l,n.LINK_STATUS)){let o=n.getShaderInfoLog(a);if(o)throw new Error("VERTEX SHADER "+o);let d=n.getShaderInfoLog(r);if(d)throw new Error("FRAGMENT SHADER "+d)}n.deleteShader(a),n.deleteShader(r)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let s in e){let i=e[s],n=t.getUniformLocation(this.glProgram,s);if(typeof i=="number")t.uniform1f(n,i);else if(i instanceof ht)t.uniformMatrix4fv(n,!1,new Float32Array(i.m));else if(i instanceof te)t.uniform3f(n,i.r,i.g,i.b);else if(i instanceof B)t.uniform2f(n,i.x,i.y);else if(Array.isArray(i))i[0],xo(i)?t.uniform1fv(n,i):bo(i)?t.uniform2fv(n,i.map(a=>[a.x,a.y]).flat()):vo(i)&&t.uniform3fv(n,i.map(a=>[a.r,a.g,a.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function di(e,t=Fs,s=Os){let i=po.replace("{{user}}",t??Fs),n=fo.replace("{{user}}",s??Os);try{return new Tl(e,i,n,ii.map(a=>a.name))}catch(a){let r=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,l=Mo(a).match(r);if(!l?.groups)throw a;let o=Number(l.groups.line)-14,d=l.groups.msg.trim(),h=l.groups.type.toLowerCase();throw new Error(`${h} shader line ${o}: ${d}`)}}function Il(e){if(!e)return y.gfx.defShader;if(typeof e=="string"){let t=Sa(e);if(t)return t.data??t;if(Ft()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof _e)return e.data?e.data:e;return e}function Sa(e){return y.assets.shaders.get(e)??null}function Dl(e,t,s){return y.assets.shaders.addLoaded(e,di(y.gfx.ggl,t,s))}function Bl(e,t,s){t=Ze(t),s=Ze(s);let i=a=>a?gl(a):Promise.resolve(null),n=Promise.all([i(t),i(s)]).then(([a,r])=>di(y.gfx.ggl,a,r));return y.assets.shaders.add(e,n)}var bn=class Xn{buf;constructor(t){this.buf=t}static fromArrayBuffer(t){return new Promise((s,i)=>y.audio.ctx.decodeAudioData(t,s,i)).then(s=>new Xn(s))}static fromURL(t){return pa(t)?Xn.fromArrayBuffer(So(t)):ml(t).then(s=>Xn.fromArrayBuffer(s))}};function Hl(e){if(typeof e=="string"){let t=Pa(e);if(t)return t;if(Ft()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof bn)return _e.loaded(e);if(e instanceof _e)return e;throw new Error(`Invalid sound: ${e}`)}}function Pa(e){return y.assets.sounds.get(e)??null}function ql(e,t){return t=Ze(t),y.assets.sounds.add(e,typeof t=="string"?bn.fromURL(t):bn.fromArrayBuffer(t))}function Rl(e,t){let s=Ze(t),i=new Audio(s);return i.preload="auto",y.assets.music[e]=s}function Ca(e,t){return e=Ze(e),Us(typeof t=="string"?new Promise((s,i)=>{is(t).then(n=>{Ca(e,n).then(s).catch(i)})}):Mt.from(e).then(s=>{let i={};for(let n in t){let a=t[n],r=s.frames[0],l=2048*r.w,o=2048*r.h,d=a.frames?a.frames.map(c=>new be(r.x+(a.x+c.x)/l*r.w,r.y+(a.y+c.y)/o*r.h,c.w/l*r.w,c.h/o*r.h)):va(a.sliceX||1,a.sliceY||1,r.x+a.x/l*r.w,r.y+a.y/o*r.h,a.width/l*r.w,a.height/o*r.h),h=new Mt(s.tex,d,a.anims);y.assets.sprites.addLoaded(n,h),i[n]=h}return i}))}function Et(e,t,s=!1,i,n,a={}){let r=i??y.gfx.defTex,l=n??y.gfx.defShader,o=Il(l);if(!o||o instanceof _e)return;let d=y.gfx.fixed||s?y.gfx.transform:y.game.cam.transform.mult(y.gfx.transform),h=[];for(let c of e){let u=ul(d.multVec2(c.pos));h.push(u.x,u.y,c.uv.x,c.uv.y,c.color.r/255,c.color.g/255,c.color.b/255,c.opacity)}y.gfx.renderer.push(y.gfx.ggl.gl.TRIANGLES,h,t,o,r,a)}function St(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(Qe(),xe(e.pos),vn(e.scale),Zt(e.angle),xe(e.offset),e.fill!==!1){let s=e.color??te.WHITE,i=e.pts.map((a,r)=>({pos:new B(a.x,a.y),uv:e.uv?e.uv[r]:new B(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(s):s,opacity:e.opacity??1})),n;e.triangulate?n=aa(e.pts).map(a=>a.map(r=>e.pts.indexOf(r))).flat():n=[...Array(t-2).keys()].map(a=>[0,a+1,a+2]).flat(),Et(i,e.indices??n,e.fixed,e.uv?e.tex:y.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&ui({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),Ge()}}function Ma(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,s=e.end??360,i=en(e.anchor??"center").scale(new B(-e.radiusX,-e.radiusY)),n=un(i,e.radiusX,e.radiusY,t,s,e.resolution);n.unshift(i);let a=Object.assign({},e,{pts:n,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(n.length-1).fill(e.gradient[1])]}:{}});if(s-t>=360&&e.outline){e.fill!==!1&&St(Object.assign({},a,{outline:null})),St(Object.assign({},a,{pts:n.slice(1),fill:!1}));return}St(a)}function tn(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&Ma(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function hn(e){let{p1:t,p2:s}=e;if(!t||!s)throw new Error('drawLine() requires properties "p1" and "p2".');let i=e.width||1,n=s.sub(t).unit().normal().scale(i*.5),a=[t.sub(n),t.add(n),s.add(n),s.sub(n)].map(r=>({pos:new B(r.x,r.y),uv:new B(0),color:e.color??te.WHITE,opacity:e.opacity??1}));Et(a,[0,1,3,1,2,3],e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function Fl(e){let t=e.pts,s=[],i=(e.width||1)*.5,n=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||T(0,0),r;n?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),o=r.normal().scale(-i/l),d,h=t[0];if(!n)switch(e.cap){case"square":{let f=r.scale(-i/l);s.push(h.add(f).add(o)),s.push(h.add(f).sub(o));break}case"round":{let f=Math.max(i,10),w=Math.PI/f,p=o.scale(-1),g=Math.cos(w),x=Math.sin(w);for(let P=0;P<f;P++)s.push(h),s.push(h.sub(p)),p=T(p.x*g-p.y*x,p.x*x+p.y*g)}}for(let f=1;f<t.length;f++){if(h===t[f]||h.eq(t[f]))continue;d=h,h=t[f];let w=h.sub(d),p=w.len(),g=w.normal().scale(-i/p),x=r.cross(w);if(Math.abs(x)/(l*p)<.05){s.push(d.add(o)),s.push(d.sub(o)),r.dot(w)<0&&(s.push(d.sub(o)),s.push(d.add(o))),r=w,l=p,o=g;continue}let P=g.sub(o).cross(w)/x,H=o.add(r.scale(P));x>0?(s.push(d.add(H)),s.push(d.sub(o)),s.push(d.add(H)),s.push(d.sub(g))):(s.push(d.add(o)),s.push(d.sub(H)),s.push(d.add(g)),s.push(d.sub(H))),r=w,l=p,o=g}if(!n)switch(s.push(h.add(o)),s.push(h.sub(o)),e.cap){case"square":{let f=r.scale(i/l);s.push(h.add(f).add(o)),s.push(h.add(f).sub(o));break}case"round":{let f=Math.max(i,10),w=Math.PI/f,p=o.scale(1),g=Math.cos(w),x=Math.sin(w);for(let P=0;P<f;P++)p=T(p.x*g-p.y*x,p.x*x+p.y*g),s.push(h),s.push(h.sub(p))}}if(s.length<4)return;let c=s.map(f=>({pos:a.add(f),uv:T(),color:e.color||te.WHITE,opacity:e.opacity??1})),u=[],m=0;for(let f=0;f<s.length-2;f+=2)u[m++]=f+1,u[m++]=f,u[m++]=f+2,u[m++]=f+2,u[m++]=f+3,u[m++]=f+1;n&&(u[m++]=s.length-1,u[m++]=s.length-2,u[m++]=0,u[m++]=0,u[m++]=1,u[m++]=s.length-1),Et(c,u,e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function Ol(e){let t=e.pts,s=[],i=(e.width||1)*.5,n=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||T(0,0),r;n?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),o=r.normal().scale(-i/l),d,h=t[0];if(!n)switch(e.cap){case"square":{let f=r.scale(-i/l);s.push(h.add(f).add(o)),s.push(h.add(f).sub(o));break}case"round":{let f=Math.max(i,10),w=Math.PI/f,p=o.scale(-1),g=Math.cos(w),x=Math.sin(w);for(let P=0;P<f;P++)s.push(h),s.push(h.sub(p)),p=T(p.x*g-p.y*x,p.x*x+p.y*g)}}for(let f=1;f<t.length;f++){if(h===t[f]||h.eq(t[f]))continue;d=h,h=t[f];let w=h.sub(d),p=w.len(),g=w.normal().scale(-i/p),x=r.cross(w);if(Math.abs(x)/(l*p)<.05){s.push(d.add(o)),s.push(d.sub(o)),r.dot(w)<0&&(s.push(d.sub(o)),s.push(d.add(o))),r=w,l=p,o=g;continue}let P=g.sub(o).cross(w)/x,H=o.add(r.scale(P));if(x>0){let C=d.add(H),A=Math.max(i,10),b=Pe(o.angleBetween(g)/A),E=o,M=Math.cos(b),D=Math.sin(b);for(let O=0;O<A;O++)s.push(C),s.push(d.sub(E)),E=T(E.x*M-E.y*D,E.x*D+E.y*M)}else{let C=d.sub(H),A=Math.max(i,10),b=Pe(o.angleBetween(g)/A),E=o,M=Math.cos(b),D=Math.sin(b);for(let O=0;O<A;O++)s.push(d.add(E)),s.push(C),E=T(E.x*M-E.y*D,E.x*D+E.y*M)}r=w,l=p,o=g}if(!n)switch(s.push(h.add(o)),s.push(h.sub(o)),e.cap){case"square":{let f=r.scale(i/l);s.push(h.add(f).add(o)),s.push(h.add(f).sub(o));break}case"round":{let f=Math.max(i,10),w=Math.PI/f,p=o.scale(1),g=Math.cos(w),x=Math.sin(w);for(let P=0;P<f;P++)p=T(p.x*g-p.y*x,p.x*x+p.y*g),s.push(h),s.push(h.sub(p))}}if(s.length<4)return;let c=s.map(f=>({pos:a.add(f),uv:T(),color:e.color||te.WHITE,opacity:e.opacity??1})),u=[],m=0;for(let f=0;f<s.length-2;f+=2)u[m++]=f+1,u[m++]=f,u[m++]=f+2,u[m++]=f+2,u[m++]=f+3,u[m++]=f+1;n&&(u[m++]=s.length-1,u[m++]=s.length-2,u[m++]=0,u[m++]=0,u[m++]=1,u[m++]=s.length-1),Et(c,u,e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function jl(e){let t=e.pts,s=[],i=(e.width||1)*.5,n=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||T(0,0),r;n?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),o=r.normal().scale(-i/l),d,h=t[0];if(!n)switch(e.cap){case"square":{let f=r.scale(-i/l);s.push(h.add(f).add(o)),s.push(h.add(f).sub(o));break}case"round":{let f=Math.max(i,10),w=Math.PI/f,p=o.scale(-1),g=Math.cos(w),x=Math.sin(w);for(let P=0;P<f;P++)s.push(h),s.push(h.sub(p)),p=T(p.x*g-p.y*x,p.x*x+p.y*g)}}for(let f=1;f<t.length;f++){if(h===t[f]||h.eq(t[f]))continue;d=h,h=t[f];let w=h.sub(d),p=w.len(),g=w.normal().scale(-i/p),x=r.cross(w);if(Math.abs(x)/(l*p)<.05){s.push(d.add(o)),s.push(d.sub(o)),r.dot(w)<0&&(s.push(d.sub(o)),s.push(d.add(o))),r=w,l=p,o=g;continue}let P=g.sub(o).cross(w)/x,H=o.add(r.scale(P));s.push(d.add(H)),s.push(d.sub(H)),r=w,l=p,o=g}if(!n)switch(s.push(h.add(o)),s.push(h.sub(o)),e.cap){case"square":{let f=r.scale(i/l);s.push(h.add(f).add(o)),s.push(h.add(f).sub(o));break}case"round":{let f=Math.max(i,10),w=Math.PI/f,p=o.scale(1),g=Math.cos(w),x=Math.sin(w);for(let P=0;P<f;P++)p=T(p.x*g-p.y*x,p.x*x+p.y*g),s.push(h),s.push(h.sub(p))}}if(s.length<4)return;let c=s.map(f=>({pos:a.add(f),uv:T(),color:e.color||te.WHITE,opacity:e.opacity??1})),u=[],m=0;for(let f=0;f<s.length-2;f+=2)u[m++]=f+1,u[m++]=f,u[m++]=f+2,u[m++]=f+2,u[m++]=f+3,u[m++]=f+1;n&&(u[m++]=s.length-1,u[m++]=s.length-2,u[m++]=0,u[m++]=0,u[m++]=1,u[m++]=s.length-1),Et(c,u,e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function ui(e){let t=e.pts,s=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return Fl(e);case"round":return Ol(e);case"miter":return jl(e)}if(e.radius&&t.length>=3){hn(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let i=1;i<t.length-2;i++){let n=t[i],a=t[i+1];hn(Object.assign({},e,{p1:n,p2:a}))}hn(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let i=0;i<t.length-1;i++)hn(Object.assign({},e,{p1:t[i],p2:t[i+1]})),e.join!=="none"&&tn(Object.assign({},e,{pos:t[i],radius:s/2}))}}function Ea(e,t){let s=t.segments??16,i=[];for(let n=0;n<=s;n++)i.push(e(n/s));ui({pts:i,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function Nl(e){Ea(t=>si(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var Pt=class Ta{ctx;src=null;glTex;width;height;constructor(t,s,i,n={}){this.ctx=t;let a=t.gl,r=t.gl.createTexture();if(!r)throw new Error("Failed to create texture");this.glTex=r,t.onDestroy(()=>this.free()),this.width=s,this.height=i;let l={linear:a.LINEAR,nearest:a.NEAREST}[n.filter??t.opts.texFilter??"nearest"],o={repeat:a.REPEAT,clampToEdge:a.CLAMP_TO_EDGE}[n.wrap??"clampToEdge"];this.bind(),s&&i&&a.texImage2D(a.TEXTURE_2D,0,a.RGBA,s,i,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,o),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,o),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,s,i={}){let n=new Ta(t,s.width,s.height,i);return n.update(s),n.src=s,n}update(t,s=0,i=0){let n=this.ctx.gl;this.bind(),n.texSubImage2D(n.TEXTURE_2D,0,s,i,n.RGBA,n.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},Jn=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,s,i={}){this.ctx=e;let n=e.gl;e.onDestroy(()=>this.free()),this.tex=new Pt(e,t,s,i);let a=n.createFramebuffer(),r=n.createRenderbuffer();if(!a||!r)throw new Error("Failed to create framebuffer");this.glFramebuffer=a,this.glRenderbuffer=r,this.bind(),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,t,s),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.tex.glTex,0),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let s=this.width*4,i=new Uint8Array(s);for(let n=0;n<(this.height/2|0);n++){let a=n*s,r=(this.height-n-1)*s;i.set(t.subarray(a,a+s)),t.copyWithin(a,r,r+s),t.set(i,r)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},Ll=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,s,i){let n=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((r,l)=>r+l.size,0),this.maxVertices=s,this.maxIndices=i;let a=n.createBuffer();if(!a)throw new Error("Failed to create vertex buffer");this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),n.bufferData(n.ARRAY_BUFFER,s*4,n.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=n.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),n.bufferData(n.ELEMENT_ARRAY_BUFFER,i*4,n.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,s,i,n=null,a={}){(e!==this.curPrimitive||n!==this.curTex||i!==this.curShader||!ri(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+s.length>this.maxIndices)&&this.flush();let r=this.vqueue.length/this.stride;for(let l of t)this.vqueue.push(l);for(let l of s)this.iqueue.push(l+r);this.curPrimitive=e,this.curShader=i,this.curTex=n,this.curUniform=a}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function Bt(e){let t=[],s=a=>{t.push(a),e(a)},i=()=>{t.pop(),e(n()??null)},n=()=>t[t.length-1];return[s,i,n]}function Ul(e,t={}){let s=[];function i(C){s.push(C)}function n(){s.forEach(A=>A());let C=e.getExtension("WEBGL_lose_context");C&&C.loseContext()}let a=null;function r(C){if(ri(C,a))return;a=C;let A=C.reduce((b,E)=>b+E.size,0);C.reduce((b,E,M)=>(e.vertexAttribPointer(M,E.size,e.FLOAT,!1,A*4,b),e.enableVertexAttribArray(M),b+E.size*4),0)}let[l,o]=Bt(C=>e.bindTexture(e.TEXTURE_2D,C)),[d,h]=Bt(C=>e.bindBuffer(e.ARRAY_BUFFER,C)),[c,u]=Bt(C=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,C)),[m,f]=Bt(C=>e.bindFramebuffer(e.FRAMEBUFFER,C)),[w,p]=Bt(C=>e.bindRenderbuffer(e.RENDERBUFFER,C)),[g,x]=Bt(C=>{if(!C)return;let{x:A,y:b,w:E,h:M}=C;e.viewport(A,b,E,M)}),[P,H]=Bt(C=>e.useProgram(C));return g({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:i,destroy:n,pushTexture2D:l,popTexture2D:o,pushArrayBuffer:d,popArrayBuffer:h,pushElementArrayBuffer:c,popElementArrayBuffer:u,pushFramebuffer:m,popFramebuffer:f,pushRenderbuffer:w,popRenderbuffer:p,pushViewport:g,popViewport:x,pushProgram:P,popProgram:H,setVertexFormat:r}}var ws={};function Hi(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(T(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function Gs(e){let t={},s="",i=[],n=String(e),a=r=>{i.length>0&&(t[s.length]=i.slice()),s+=r};for(;n!=="";){if(n[0]==="\\"){if(n.length===1)throw new Error("Styled text error: \\ at end of string");a(n[1]),n=n.slice(2);continue}if(n[0]==="["){let r=/^\[(\/)?(\w+?)\]/.exec(n);if(!r){a(n[0]),n=n.slice(1);continue}let[l,o,d]=r;if(o!==void 0){let h=i.pop();if(h!==d)throw h!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${h}], got [/${d}]`):new Error(`Styled text error: stray end tag [/${d}]`)}else i.push(d);n=n.slice(l.length);continue}a(n[0]),n=n.slice(1)}if(i.length>0)throw new Error(`Styled text error: unclosed tags ${i}`);return{charStyleMap:t,text:s}}function Ot(e){if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=ba(e.font);if(!e.text||e.text===""||t instanceof _e||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:s,text:i}=Gs(e.text+""),n=Io(i);if(t instanceof Kn||typeof t=="string"){let P=t instanceof Kn?t.fontface.family:t,H=t instanceof Kn?{outline:t.outline,filter:t.filter}:{outline:null,filter:Rs},C=ws[P]??{font:{tex:new Pt(y.gfx.ggl,2048,2048,{filter:H.filter}),map:{},size:64},cursor:new B(0),maxHeight:0,outline:H.outline};ws[P]||(ws[P]=C),t=C.font;for(let A of n)if(!C.font.map[A]){let b=y.fontCacheC2d;if(!b)throw new Error("fontCacheC2d is not defined.");if(!y.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");b.clearRect(0,0,y.fontCacheCanvas.width,y.fontCacheCanvas.height),b.font=`${t.size}px ${P}`,b.textBaseline="top",b.textAlign="left",b.fillStyle="#ffffff";let E=b.measureText(A),M=Math.ceil(E.width);if(!M)continue;let D=Math.ceil(Math.abs(E.actualBoundingBoxAscent))+Math.ceil(Math.abs(E.actualBoundingBoxDescent));C.outline&&C.outline.width&&C.outline.color&&(b.lineJoin="round",b.lineWidth=C.outline.width*2,b.strokeStyle=C.outline.color.toHex(),b.strokeText(A,C.outline.width,C.outline.width),M+=C.outline.width*2,D+=C.outline.width*3),b.fillText(A,C.outline?.width??0,C.outline?.width??0);let O=b.getImageData(0,0,M,D);if(C.cursor.x+M>2048&&(C.cursor.x=0,C.cursor.y+=C.maxHeight,C.maxHeight=0,C.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(O,C.cursor.x,C.cursor.y),t.map[A]=new be(C.cursor.x,C.cursor.y,M,D),C.cursor.x+=M+1,C.maxHeight=Math.max(C.maxHeight,D)}}let a=e.size||t.size,r=T(e.scale??1).scale(a/t.size),l=e.lineSpacing??0,o=e.letterSpacing??0,d=0,h=0,c=0,u=[],m=[],f=0,w=null,p=0,g;for(;f<n.length;){let P=n[f];if(P===`
`)c+=a+l,u.push({width:d-o,chars:m}),w=null,p=0,d=0,m=[],g=void 0;else{let H=t.map[P];if(H){let C=H.w*r.x;e.width&&d+C>e.width&&(c+=a+l,w!=null&&(f-=m.length-w,P=n[f],H=t.map[P],C=H.w*r.x,m=m.slice(0,w-1),d=p),w=null,p=0,u.push({width:d-o,chars:m}),d=g??0,m=[]),m.push({tex:t.tex,width:H.w,height:H.h,quad:new be(H.x/t.tex.width,H.y/t.tex.height,H.w/t.tex.width,H.h/t.tex.height),ch:P,pos:new B(d,c),opacity:e.opacity??1,color:e.color??te.WHITE,scale:T(r),angle:0}),P===" "&&(w=m.length,p=d),e.indentAll&&g===void 0&&/\S/.test(P)&&(g=d),d+=C,h=Math.max(h,d),d+=o}}f++}u.push({width:d-o,chars:m}),c+=a,e.width&&(h=e.width);let x=[];for(let P=0;P<u.length;P++){let H=(h-u[P].width)*sl(e.align??"left");for(let C of u[P].chars){let A=t.map[C.ch],b=x.length+P;if(C.pos=C.pos.add(H,0).add(A.w*r.x*.5,A.h*r.y*.5),e.transform){let E=typeof e.transform=="function"?e.transform(b,C.ch):e.transform;E&&Hi(C,E)}if(s[b]){let E=s[b];for(let M of E){let D=e.styles?.[M],O=typeof D=="function"?D(b,C.ch):D;O&&Hi(C,O)}}x.push(C)}}return{width:h,height:c,chars:x,opt:e,renderedText:i}}function xn(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,s=e.height,i=en(e.anchor||ss).scale(new B(t,s).scale(-.5)),n=e.quad||new be(0,0,1,1),a=e.color||ae(255,255,255),r=e.opacity??1,l=e.tex?.1/e.tex.width:0,o=e.tex?.1/e.tex.height:0,d=n.x+l,h=n.y+o,c=n.w-l*2,u=n.h-o*2;Qe(),xe(e.pos),Zt(e.angle),vn(e.scale),xe(i),Et([{pos:new B(-t/2,s/2),uv:new B(e.flipX?d+c:d,e.flipY?h:h+u),color:a,opacity:r},{pos:new B(-t/2,-s/2),uv:new B(e.flipX?d+c:d,e.flipY?h+u:h),color:a,opacity:r},{pos:new B(t/2,-s/2),uv:new B(e.flipX?d:d+c,e.flipY?h+u:h),color:a,opacity:r},{pos:new B(t/2,s/2),uv:new B(e.flipX?d:d+c,e.flipY?h:h+u),color:a,opacity:r}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),Ge()}function jt(e){Qe(),xe(e.opt.pos),Zt(e.opt.angle),xe(en(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{xn({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),Ge()}function Je(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,s=e.height,i=en(e.anchor||ss).add(1,1).scale(new B(t,s).scale(-.5)),n=[new B(0,0),new B(t,0),new B(t,s),new B(0,s)];if(e.radius){let a=Math.min(t,s)/2,r=Array.isArray(e.radius)?e.radius.map(l=>Math.min(a,l)):new Array(4).fill(Math.min(a,e.radius));n=[new B(r[0],0),...r[1]?un(new B(t-r[1],r[1]),r[1],r[1],270,360):[T(t,0)],...r[2]?un(new B(t-r[2],s-r[2]),r[2],r[2],0,90):[T(t,s)],...r[3]?un(new B(r[3],s-r[3]),r[3],r[3],90,180):[T(0,s)],...r[0]?un(new B(r[0],r[0]),r[0],r[0],180,270):[]]}St(Object.assign({},e,{offset:i,pts:n,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function At(e){$e();let t=y.gfx.width,s=y.gfx.height;y.gfx.width=y.gfx.viewport.width,y.gfx.height=y.gfx.viewport.height,e(),$e(),y.gfx.width=t,y.gfx.height=s}function qi(e,t){At(()=>{let s=T(8);Qe(),xe(e);let i=Ot({text:t,font:Qn,size:16,pos:s,color:ae(255,255,255),fixed:!0}),n=i.width+s.x*2,a=i.height+s.x*2;e.x+n>=Be()&&xe(T(-n,0)),e.y+a>=qe()&&xe(T(0,-a)),Je({width:n,height:a,color:ae(0,0,0),radius:4,opacity:.8,fixed:!0}),jt(i),Ge()})}function Ia(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return St(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Gl(){if(y.debug.inspect){let e=null;for(let t of y.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(y.game.root.drawInspect(),e){let t=[],s=e.inspect();for(let i in s)s[i]?t.push(`${s[i]}`):t.push(`${i}`);qi(Go(y.k.mousePos()),t.join(`
`))}qi(T(8),`FPS: ${y.debug.fps()}`)}y.debug.paused&&At(()=>{Qe(),xe(Be(),0),xe(-8,8);let e=32;Je({width:e,height:e,anchor:"topright",color:ae(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)Je({width:4,height:e*.6,anchor:"center",pos:T(-e/3*t,e*.5),color:ae(255,255,255),radius:2,fixed:!0});Ge()}),y.debug.timeScale!==1&&At(()=>{Qe(),xe(Be(),qe()),xe(-8,-8);let e=8,t=Ot({text:y.debug.timeScale.toFixed(1),font:Qn,size:16,color:ae(255,255,255),pos:T(-e),anchor:"botright",fixed:!0});Je({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:ae(0,0,0),opacity:.8,radius:4,fixed:!0});for(let s=0;s<2;s++){let i=y.debug.timeScale<1;Ia({p1:T(-t.width-e*(i?2:3.5),-e),p2:T(-t.width-e*(i?2:3.5),-e-t.height),p3:T(-t.width-e*(i?3.5:2),-e-t.height/2),pos:T(-s*e*1+(i?-e*.5:0),0),color:ae(255,255,255),fixed:!0})}jt(t),Ge()}),y.debug.curRecording&&At(()=>{Qe(),xe(0,qe()),xe(24,-24),tn({radius:12,color:ae(255,0,0),opacity:Ki(0,1,y.app.time()*4),fixed:!0}),Ge()}),y.debug.showLog&&y.game.logs.length>0&&At(()=>{Qe(),xe(0,qe()),xe(8,-8);let e=8,t=[];for(let i of y.game.logs){let n="",a=i.msg instanceof Error?"error":"info";n+=`[time]${i.time.toFixed(2)}[/time]`,n+=" ",n+=`[${a}]${zs(i.msg)}[/${a}]`,t.push(n)}y.game.logs=y.game.logs.filter(i=>y.app.time()-i.time<(y.globalOpt.logTime||4));let s=Ot({text:t.join(`
`),font:Qn,pos:T(e,-e),anchor:"botleft",size:16,width:Be()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:ae(127,127,127)},info:{color:ae(255,255,255)},error:{color:ae(255,0,127)}}});Je({width:s.width+e*2,height:s.height+e*2,anchor:"botleft",color:ae(0,0,0),radius:4,opacity:.8,fixed:!0}),jt(s),Ge()})}function zs(e,t=!1,s=new Set){if(s.has(e))return"<recursive>";var i="",n;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(i=["[",e.map(a=>zs(a,!0,s.union(new Set([e])))).join(", "),"]"].join(""),e=i),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(i+=e.constructor.name+" "),i+=["{",(n=Object.getOwnPropertyNames(e).map(a=>`${/^\w+$/.test(a)?a:JSON.stringify(a)}: ${zs(e[a],!0,s.union(new Set([e])))}`).join(", "))?` ${n} `:"","}"].join(""),e=i),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function zl(){let e=y.game.cam,t=B.fromAngle(Ee(0,360)).scale(e.shake);e.shake=ze(e.shake,0,5*Te()),e.transform=new ht().translate($n()).scale(e.scale).rotate(e.angle).translate((e.pos??$n()).scale(-1).add(t)),y.game.root.draw(),$e()}function Kl(){let e=Ft();y.game.events.numListeners("loading")>0?y.game.events.trigger("loading",e):At(()=>{let t=Be()/2,s=24,i=T(Be()/2,qe()/2).sub(T(t/2,s/2));Je({pos:T(0),width:Be(),height:qe(),color:ae(0,0,0)}),Je({pos:i,width:t,height:s,fill:!1,outline:{width:4}}),Je({pos:i,width:t*e,height:s})})}function Da(e,t,s){let i=y.gfx.ggl.gl;$e(),i.clear(i.STENCIL_BUFFER_BIT),i.enable(i.STENCIL_TEST),i.stencilFunc(i.NEVER,1,255),i.stencilOp(i.REPLACE,i.REPLACE,i.REPLACE),t(),$e(),i.stencilFunc(s,1,255),i.stencilOp(i.KEEP,i.KEEP,i.KEEP),e(),$e(),i.disable(i.STENCIL_TEST)}function Xl(e,t){let s=y.gfx.ggl.gl;Da(e,t,s.EQUAL)}function Zn(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new be(0,0,1,1),s=e.tex.width*t.w,i=e.tex.height*t.h,n=new B(1);if(e.tiled){let a=en(e.anchor||ss);(e.pos?.x||0)-(a.x+1)*.5*(e.width||s),(e.pos?.y||0)-(a.y+1)*.5*(e.height||i);let r=(e.width||s)/s,l=(e.height||i)/i,o=Math.floor(r),d=Math.floor(l),h=r-o,c=l-d,u=(o+h?1:0)*(d+c?1:0),m=new Array(u*6),f=new Array(u*4),w=0,p=(g,x,P,H,C)=>{m[w*6+0]=w*4+0,m[w*6+1]=w*4+1,m[w*6+2]=w*4+3,m[w*6+3]=w*4+1,m[w*6+4]=w*4+2,m[w*6+5]=w*4+3,f[w*4+0]={pos:new B(g-a.x,x-a.y),uv:new B(C.x,C.y),color:e.color||te.WHITE,opacity:e.opacity||1},f[w*4+1]={pos:new B(g+P-a.x,x-a.y),uv:new B(C.x+C.w,C.y),color:e.color||te.WHITE,opacity:e.opacity||1},f[w*4+2]={pos:new B(g+P-a.x,x+H-a.y),uv:new B(C.x+C.w,C.y+C.h),color:e.color||te.WHITE,opacity:e.opacity||1},f[w*4+3]={pos:new B(g-a.x,x+H-a.y),uv:new B(C.x,C.y+C.h),color:e.color||te.WHITE,opacity:e.opacity||1},w++};for(let g=0;g<d;g++){for(let x=0;x<o;x++)p(x*s,g*i,s,i,t);h&&p(o*s,g*i,s*h,i,new be(t.x,t.y,t.w*h,t.h))}if(c){for(let g=0;g<o;g++)p(g*s,d*i,s,i*c,new be(t.x,t.y,t.w,t.h*c));h&&p(o*s,d*i,s*h,i*c,new be(t.x,t.y,t.w*h,t.h*c))}Et(f,m,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(n.x=e.width/s,n.y=e.height/i):e.width?(n.x=e.width/s,n.y=n.x):e.height&&(n.y=e.height/i,n.x=n.y),xn(Object.assign({},e,{scale:n.scale(e.scale||new B(1)),tex:e.tex,quad:t,width:s,height:i}))}function Wl(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=zn(e.sprite);if(!t||!t.data)return;let s=t.data.frames[e.frame??0];if(!s)throw new Error(`Frame not found: ${e.frame??0}`);Zn(Object.assign({},e,{tex:t.data.tex,quad:s.scale(e.quad??new be(0,0,1,1))}))}function Yl(e,t){let s=y.gfx.ggl.gl;Da(e,t,s.NOTEQUAL)}function Ri(e){jt(Ot(e))}var Vl=(e,t)=>{let s=di(t,Fs,Os),i=e.pixelDensity??1,n=e.scale??1,{gl:a}=t,r=Pt.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),l=e.width&&e.height?new Jn(t,e.width*i*n,e.height*i*n):new Jn(t,a.drawingBufferWidth,a.drawingBufferHeight),o=null,d=1;e.background&&(typeof e.background=="string"?o=ae(e.background):(o=ae(...e.background),d=e.background[3]??1),a.clearColor(o.r/255,o.g/255,o.b/255,d??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let h=new Ll(t,ii,co,ho),c=Pt.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:s,defTex:r,frameBuffer:l,postShader:null,postShaderUniform:null,renderer:h,transform:new ht,transformStack:[],bgTex:c,bgColor:o,bgAlpha:d,width:e.width??a.drawingBufferWidth/i/n,height:e.height??a.drawingBufferHeight/i/n,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}};function qt(e){return e.fixed?!0:e.parent?qt(e.parent):!1}function Nt(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Ql(e,t={}){return{id:"circle",radius:e,draw(){tn(Object.assign(Nt(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new ge(new B(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Ba(...e){return{id:"color",color:ae(...e),inspect(){return`color: ${this.color.toString()}`}}}function $l(e){return{add(){this.canvas=e}}}function Jl(e=1){let t,s=0,i=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){i||(s+=Te(),this.opacity=dt(s,0,e,0,t),s>=e&&(this.opacity=t,i=!0))}}}function Zl(e="intersect"){return{id:"mask",mask:e}}function Ha(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,s=y.k.easings.linear){return y.game.root.tween(0,this.opacity,t,i=>this.opacity=i,s)},fadeOut(t=1,s=y.k.easings.linear){return y.game.root.tween(this.opacity,0,t,i=>this.opacity=i,s)},inspect(){return`opacity: ${js(this.opacity,1)}`}}}function _l(e=1,t=ae(0,0,0),s=1,i="miter",n=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:s,join:i,miterLimit:n,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var kl=class{pos=T(0);vel=T(0);acc=T(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function ed(e,t){let s=t.lifetime,i=[],n=e.colors||[te.WHITE],a=e.opacities||[1],r=e.quads||[new be(0,0,1,1)],l=e.scales||[1],o=e.lifeTime,d=t.direction,h=t.spread,c=e.speed||[0,0],u=e.angle||[0,0],m=e.angularVelocity||[0,0],f=e.acceleration||[T(0),T(0)],w=e.damping||[0,0],p=[],g=new Array(e.max),x=0,P=0;for(let A=0;A<e.max;A++){p[A*6+0]=A*4+0,p[A*6+1]=A*4+1,p[A*6+2]=A*4+3,p[A*6+3]=A*4+1,p[A*6+4]=A*4+2,p[A*6+5]=A*4+3;for(let b=0;b<4;b++)g[A*4+b]={pos:new B(0,0),uv:new B(0,0),color:ae(255,255,255),opacity:1};i[A]=new kl}let H=new Oe;function C(A=0){for(;A<e.max;){if(i[A].gc)return A;A++}return null}return{id:"particles",emit(A){let b=0;for(let E=0;E<A;E++){if(b=C(b),b==null)return;let M=Ee(d-h,d+h),D=B.fromAngle(M).scale(Ee(c[0],c[1])),O=Ee(u[0],u[1]),N=Ee(m[0],m[1]),W=T(Ee(f[0].x,f[1].x),Ee(f[0].y,f[1].y)),U=Ee(w[0],w[1]),k=o?Ee(o[0],o[1]):null,V=t.shape?t.shape.random():T(),z=i[b];z.lt=k,z.pos=V,z.vel=D,z.acc=W,z.angle=O,z.angularVelocity=N,z.damping=U,z.angularVelocity=N,z.gc=!1}x+=A},update(){if(s!==void 0&&s<=0)return;let A=Te();for(let b of i)if(!b.gc){if(b.t+=A,b.lt&&b.t>=b.lt){b.gc=!0,x--;continue}b.vel=b.vel.add(b.acc.scale(A)).scale(1-b.damping*A),b.pos=b.pos.add(b.vel.scale(A)),b.angle+=b.angularVelocity*A}for(s!==void 0&&(s-=A,s<=0&&H.trigger()),P+=A;x<e.max&&t.rate&&P>t.rate;)this.emit(1),x++,P-=t.rate},draw(){if(!(s!==void 0&&s<=0)){for(let A=0;A<i.length;A++){let b=i[A];if(b.gc)continue;let E=b.progress,M=Math.floor(b.progress*n.length),D=M<n.length-1?ze(n[M],n[M+1],dt(E,M/n.length,(M+1)/n.length,0,1)):n[M],O=Math.floor(b.progress*a.length),N=O<a.length-1?ze(a[O],a[O+1],dt(E,O/a.length,(O+1)/a.length,0,1)):a[O],W=Math.floor(b.progress*r.length),U=r[W],k=Math.floor(b.progress*l.length),V=l[k],z=Math.cos(b.angle*Math.PI/180),ne=Math.sin(b.angle*Math.PI/180),Y=(e.texture?e.texture.width:10)*U.w/2,_=(e.texture?e.texture.height:10)*U.h/2,me=A*4,X=g[me];X.pos.x=b.pos.x+-Y*V*z- -_*V*ne,X.pos.y=b.pos.y+-Y*V*ne+-_*V*z,X.uv.x=U.x,X.uv.y=U.y,X.color.r=D.r,X.color.g=D.g,X.color.b=D.b,X.opacity=N,X=g[me+1],X.pos.x=b.pos.x+Y*V*z- -_*V*ne,X.pos.y=b.pos.y+Y*V*ne+-_*V*z,X.uv.x=U.x+U.w,X.uv.y=U.y,X.color.r=D.r,X.color.g=D.g,X.color.b=D.b,X.opacity=N,X=g[me+2],X.pos.x=b.pos.x+Y*V*z-_*V*ne,X.pos.y=b.pos.y+Y*V*ne+_*V*z,X.uv.x=U.x+U.w,X.uv.y=U.y+U.h,X.color.r=D.r,X.color.g=D.g,X.color.b=D.b,X.opacity=N,X=g[me+3],X.pos.x=b.pos.x+-Y*V*z-_*V*ne,X.pos.y=b.pos.y+-Y*V*ne+_*V*z,X.uv.x=U.x,X.uv.y=U.y+U.h,X.color.r=D.r,X.color.g=D.g,X.color.b=D.b,X.opacity=N}Et(g,p,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(A){return H.add(A)},inspect(){return`count: ${x}/${e.max}`}}}function td(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){St(Object.assign(Nt(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new Ne(this.pts)},inspect(){return`polygon: ${this.pts.map(s=>`[${s.x},${s.y}]`).join(",")}`}}}function qa(e,t,s){let i;return y.game.root.get("area").forEach(n=>{if(s&&s.some(r=>n.is(r)))return;let a=n.worldArea().raycast(e,t);a&&(i?a.fraction<i.fraction&&(i=a,i.object=n):(i=a,i.object=n))}),i}function Ra(e,t,s={}){return{id:"rect",width:e,height:t,radius:s.radius||0,draw(){Je(Object.assign(Nt(this),{width:this.width,height:this.height,radius:this.radius,fill:s.fill}))},renderArea(){return new ge(T(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function nd(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function sd(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let s=y.game.root.add([_n(t.pos??T(0))]),i=e.length,n=0,a=null,r=null,l=null,o=null,d=A=>A.x+A.y*n,h=A=>T(Math.floor(A%n),Math.floor(A/n)),c=()=>{a=[];for(let A of s.children)u(A)},u=A=>{let b=d(A.tilePos);a[b]?a[b].push(A):a[b]=[A]},m=A=>{let b=d(A.tilePos);if(a[b]){let E=a[b].indexOf(A);E>=0&&a[b].splice(E,1)}},f=()=>{let A=!1;for(let b of s.children){let E=s.pos2Tile(b.pos);(b.tilePos.x!=E.x||b.tilePos.y!=E.y)&&(A=!0,m(b),b.tilePos.x=E.x,b.tilePos.y=E.y,u(b))}A&&s.trigger("spatialMapChanged")},w=()=>{let A=s.getSpatialMap(),b=s.numRows()*s.numColumns();r?r.length=b:r=new Array(b),r.fill(1,0,b);for(let E=0;E<A.length;E++){let M=A[E];if(M){let D=0;for(let O of M)if(O.isObstacle){D=1/0;break}else D+=O.cost;r[E]=D||1}}},p=()=>{let A=s.getSpatialMap(),b=s.numRows()*s.numColumns();l?l.length=b:l=new Array(b),l.fill(15,0,b);for(let E=0;E<A.length;E++){let M=A[E];if(M){let D=M.length,O=15;for(let N=0;N<D;N++)O|=M[N].edgeMask;l[E]=O}}},g=()=>{let A=s.numRows()*s.numColumns(),b=(M,D)=>{let O=[];for(O.push(M);O.length>0;){let N=O.pop();H(N).forEach(W=>{o[W]<0&&(o[W]=D,O.push(W))})}};o?o.length=A:o=new Array(A),o.fill(-1,0,A);let E=0;for(let M=0;M<r.length;M++){if(o[M]>=0){E++;continue}b(M,E),E++}},x=(A,b)=>r[b],P=(A,b)=>{let E=h(A),M=h(b);return E.dist(M)},H=(A,b)=>{let E=[],M=Math.floor(A%n),D=M>0&&l[A]&1&&r[A-1]!==1/0,O=A>=n&&l[A]&2&&r[A-n]!==1/0,N=M<n-1&&l[A]&4&&r[A+1]!==1/0,W=A<n*i-n-1&&l[A]&8&&r[A+n]!==1/0;return b?(D&&(O&&E.push(A-n-1),E.push(A-1),W&&E.push(A+n-1)),O&&E.push(A-n),N&&(O&&E.push(A-n+1),E.push(A+1),W&&E.push(A+n+1)),W&&E.push(A+n)):(D&&E.push(A-1),O&&E.push(A-n),N&&E.push(A+1),W&&E.push(A+n)),E},C={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(A,...b){let E=T(...b),M=(()=>{if(typeof A=="string"){if(t.tiles[A]){if(typeof t.tiles[A]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[A](E)}else if(t.wildcardTile)return t.wildcardTile(A,E)}else{if(Array.isArray(A))return A;throw new Error("Expected a symbol or a component list")}})();if(!M)return null;let D=!1,O=!1;for(let W of M)W.id==="tile"&&(O=!0),W.id==="pos"&&(D=!0);D||M.push(_n(this.tile2Pos(E))),O||M.push(_a());let N=s.add(M);return D&&(N.tilePosOffset=N.pos.clone()),N.tilePos=E,N.transform=fn(N),a&&(u(N),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),N},numColumns(){return n},numRows(){return i},levelWidth(){return n*this.tileWidth()},levelHeight(){return i*this.tileHeight()},tile2Pos(...A){return T(...A).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...A){let b=T(...A);return T(Math.floor(b.x/this.tileWidth()),Math.floor(b.y/this.tileHeight()))},getSpatialMap(){return a||c(),a},removeFromSpatialMap:m,insertIntoSpatialMap:u,onSpatialMapChanged(A){return this.on("spatialMapChanged",A)},onNavigationMapInvalid(A){return this.on("navigationMapInvalid",A)},getAt(A){a||c();let b=d(A);return a[b]||[]},raycast(A,b){let E=this.toWorld(A),M=this.toWorld(A.add(b)).sub(E),D=1/this.tileWidth(),O=A.scale(D),N=jr(O,b,W=>{let U=this.getAt(W);if(U.some(V=>V.isObstacle))return!0;let k=null;for(let V of U)if(V.has("area")){let z=V.worldArea().raycast(E,M);z&&(k?z.fraction<k.fraction&&(k=z,k.object=V):(k=z,k.object=V))}return k&&(k.point=this.fromWorld(k.point).scale(D)),k||!1},64);return N&&(N.point=N.point.scale(this.tileWidth())),N},update(){a&&f()},invalidateNavigationMap(){r=null,l=null,o=null},onNavigationMapChanged(A){return this.on("navigationMapChanged",A)},getTilePath(A,b,E={}){if(r||w(),l||p(),o||g(),A.x<0||A.x>=n||A.y<0||A.y>=i||b.x<0||b.x>=n||b.y<0||b.y>=i)return null;let M=d(A),D=d(b);if(r[D]===1/0)return null;if(M===D)return[];if(o[M]!=-1&&o[M]!==o[D])return null;let O=new ca((z,ne)=>z.cost<ne.cost);O.insert({cost:0,node:M});let N=new Map;N.set(M,M);let W=new Map;for(W.set(M,0);O.length!==0;){let z=O.remove()?.node;if(z===D)break;let ne=H(z,E.allowDiagonals);for(let Y of ne){let _=(W.get(z)||0)+x(z,Y)+P(Y,D);(!W.has(Y)||_<W.get(Y))&&(W.set(Y,_),O.insert({cost:_,node:Y}),N.set(Y,z))}}let U=[],k=D,V=h(k);for(U.push(V);k!==M;){let z=N.get(k);if(z===void 0)throw new Error("Bug in pathfinding algorithm");k=z;let ne=h(k);U.push(ne)}return U.reverse()},getPath(A,b,E={}){let M=this.tileWidth(),D=this.tileHeight(),O=this.getTilePath(this.pos2Tile(A),this.pos2Tile(b),E);return O?[A,...O.slice(1,-1).map(N=>N.scale(M,D).add(M/2,D/2)),b]:null}};return s.use(C),s.onNavigationMapInvalid(()=>{s.invalidateNavigationMap(),s.trigger("navigationMapChanged")}),e.forEach((A,b)=>{let E=A.split("");n=Math.max(E.length,n),E.forEach((M,D)=>{s.spawn(M,T(D,b))})}),s}function We(e,t,s){return y.game.objEvents.registers[e]||(y.game.objEvents.registers[e]=new da),y.game.objEvents.on(e,(i,...n)=>{i.is(t)&&s(i,...n)})}var id=(e,t,...s)=>{for(let i of y.game.root.children)i.is(t)&&i.trigger(e,s)},ad=ye(e=>{let t=y.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(s){t.paused=s},cancel:()=>t.destroy()}},(e,t)=>We("fixedUpdate",e,t)),Fa=ye(e=>{let t=y.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(s){t.paused=s},cancel:()=>t.destroy()}},(e,t)=>We("update",e,t)),rd=ye(e=>{let t=y.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(s){t.hidden=s},cancel:()=>t.destroy()}},(e,t)=>We("draw",e,t)),Oa=ye(e=>y.game.events.on("add",e),(e,t)=>We("add",e,t)),od=ye(e=>y.game.events.on("destroy",e),(e,t)=>We("destroy",e,t)),ld=ye(e=>y.game.events.on("use",e),(e,t)=>We("use",e,t)),dd=ye(e=>y.game.events.on("unuse",e),(e,t)=>We("unuse",e,t)),ja=ye(e=>y.game.events.on("tag",e),(e,t)=>We("tag",e,t)),ud=ye(e=>y.game.events.on("untag",e),(e,t)=>We("untag",e,t));function cd(e,t,s){return We("collide",e,(i,n,a)=>n.is(t)&&s(i,n,a))}function hd(e,t,s){return We("collideUpdate",e,(i,n,a)=>n.is(t)&&s(i,n,a))}function pd(e,t,s){return We("collideEnd",e,(i,n,a)=>n.is(t)&&s(i,n,a))}function rs(e,t){y.game.root.get(e,{recursive:!0}).forEach(t),Oa(e,t),ja((s,i)=>{i===e&&t(s)})}var fd=ye(e=>y.app.onMousePress(e),(e,t)=>{let s=[];return rs(e,i=>{if(!i.area)throw new Error("onClick() requires the object to have area() component");s.push(i.onClick(()=>t(i)))}),Lt.join(s)});function gd(e,t){let s=[];return rs(e,i=>{if(!i.area)throw new Error("onHover() requires the object to have area() component");s.push(i.onHover(()=>t(i)))}),Lt.join(s)}function md(e,t){let s=[];return rs(e,i=>{if(!i.area)throw new Error("onHoverUpdate() requires the object to have area() component");s.push(i.onHoverUpdate(()=>t(i)))}),Lt.join(s)}function yd(e,t){let s=[];return rs(e,i=>{if(!i.area)throw new Error("onHoverEnd() requires the object to have area() component");s.push(i.onHoverEnd(()=>t(i)))}),Lt.join(s)}function wd(e){y.game.events.on("loading",e)}function vd(e){y.app.onResize(e)}function bd(e){y.game.events.on("error",e)}function ci(e){y.assets.loaded?e():y.game.events.on("load",e)}function xd(e){if(y.assets.loaded)ya().forEach(t=>e(...t));else return y.game.events.on("loadError",e)}function Na(...e){y.game.cam.pos=T(...e)}function La(){return y.game.cam.pos?y.game.cam.pos.clone():$n()}function Ua(...e){y.game.cam.scale=T(...e)}function Ga(){return y.game.cam.scale.clone()}function za(e){y.game.cam.angle=e}function Ka(){return y.game.cam.angle}function Ad(){return y.game.cam.transform.clone()}function Xa(e=ae(255,255,255),t=1){let s=y.game.root.add([Ra(Be(),qe()),Ba(e),Ha(1),tr()]),i=s.fadeOut(t);return i.onEnd(()=>Za(s)),i}function Sd(){return y.game.cam.transform.clone()}function Pd(e=12){y.game.cam.shake+=e}function Ks(e){return y.game.cam.transform.multVec2(e)}function Wa(e){return y.game.cam.transform.invert().multVec2(e)}function Cd(...e){return kt("camPos","setCamPos / getCamPos"),e.length>0&&Na(...e),La()}function Md(...e){return kt("camScale","setCamScale / getCamScale"),e.length>0&&Ua(...e),Ga()}function Ed(e){return kt("camRot","setCamRot / getCamRot"),e!==void 0&&za(e),Ka()}function Td(e=ae(255,255,255),t=1){return kt("camFlash","flash"),Xa(e,t)}function hi(e=[]){let t=new Map,s=[],i={},n=new yn,a=[],r=new Set("*"),l=y.globalOpt.tagsAsComponents,o=null,d=!1,h={id:Lo(),hidden:!1,transform:new ht,children:[],parent:null,set paused(u){if(u!==d){d=u;for(let m of a)m.paused=u}},get paused(){return d},get tags(){return Array.from(r)},add(u){let m=Array.isArray(u)?hi(u):u;if(m.parent)throw new Error("Cannot add a game obj that already has a parent.");return m.parent=this,m.transform=fn(m),this.children.push(m),m.trigger("add",m),y.game.events.trigger("add",m),m},readd(u){let m=this.children.indexOf(u);return m!==-1&&(this.children.splice(m,1),this.children.push(u)),u},remove(u){let m=this.children.indexOf(u);if(m!==-1){u.parent=null,this.children.splice(m,1);let f=w=>{w.trigger("destroy"),y.game.events.trigger("destroy",w),w.children.forEach(p=>f(p))};f(u)}},removeAll(u){if(u)this.get(u).forEach(m=>this.remove(m));else for(let m of[...this.children])this.remove(m)},fixedUpdate(){this.paused||(this.children.forEach(u=>u.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(u=>u.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&($e(),this.canvas.bind());let u=y.gfx.fixed;this.fixed&&(y.gfx.fixed=!0),Qe(),xe(this.pos),vn(this.scale),Zt(this.angle);let m=this.children.sort((f,w)=>{let p=f.layerIndex??y.game.defaultLayerIndex,g=w.layerIndex??y.game.defaultLayerIndex;return p-g||(f.z??0)-(w.z??0)});if(this.mask){let f={intersect:y.k.drawMasked,subtract:y.k.drawSubtracted}[this.mask];if(!f)throw new Error(`Invalid mask func: "${this.mask}"`);f(()=>{m.forEach(w=>w.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),m.forEach(f=>f.draw());Ge(),y.gfx.fixed=u,this.canvas&&($e(),this.canvas.unbind())},drawInspect(){this.hidden||(Qe(),xe(this.pos),vn(this.scale),Zt(this.angle),this.children.forEach(u=>u.drawInspect()),this.trigger("drawInspect"),Ge())},use(u){if(typeof u=="string")return r.add(u);if(!u||typeof u!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof u}"`);let m=[];u.id?(this.unuse(u.id),i[u.id]=[],m=i[u.id],t.set(u.id,u),l&&r.add(u.id)):s.push(u);for(let w in u){if(go.has(w))continue;let p=Object.getOwnPropertyDescriptor(u,w);if(p)if(typeof p.value=="function"&&(u[w]=u[w].bind(this)),p.set&&Object.defineProperty(u,w,{set:p.set.bind(this)}),p.get&&Object.defineProperty(u,w,{get:p.get.bind(this)}),mo.has(w)){let g=w==="add"?()=>{o=x=>m.push(x),u[w]?.(),o=null}:u[w];m.push(this.on(w,g).cancel)}else if(this[w]===void 0)Object.defineProperty(this,w,{get:()=>u[w],set:g=>u[w]=g,configurable:!0,enumerable:!0}),m.push(()=>delete this[w]);else{let g=t.values().find(x=>x[w]!==void 0)?.id;throw new Error(`Duplicate component property: "${w}" while adding component "${u.id}"`+(g?` (originally added by "${g}")`:""))}}let f=()=>{if(u.require){for(let w of u.require)if(!this.c(w))throw new Error(`Component "${u.id}" requires component "${w}"`)}};u.destroy&&m.push(u.destroy.bind(this)),this.exists()?(f(),u.add&&(o=w=>m.push(w),u.add.call(this),o=null),u.id&&(this.trigger("use",u.id),y.game.events.trigger("use",this,u.id))):u.require&&m.push(this.on("add",f).cancel)},unuse(u){if(t.has(u)){for(let m of t.values())if(m.require&&m.require.includes(u))throw new Error(`Can't unuse. Component "${m.id}" requires component "${u}"`);t.delete(u),this.trigger("unuse",u),y.game.events.trigger("unuse",this,u)}else l&&r.has(u)&&r.delete(u);i[u]&&(i[u].forEach(m=>m()),delete i[u])},c(u){return t.get(u)??null},get(u,m={}){let f=(p,g)=>m.only==="comps"?p.has(g):m.only==="tags"?p.is(g):p.is(g)||p.has(g),w=m.recursive?this.children.flatMap(function p(g){return[g,...g.children.flatMap(p)]}):this.children;if(w=w.filter(p=>u?f(p,u):!0),m.liveUpdate){let p=x=>m.recursive?this.isAncestorOf(x):x.parent===this,g=[];g.push(y.k.onAdd(x=>{p(x)&&f(x,u)&&w.push(x)})),g.push(y.k.onDestroy(x=>{if(p(x)&&f(x,u)){let P=w.findIndex(H=>H.id===x.id);P!==-1&&w.splice(P,1)}})),this.onDestroy(()=>{for(let x of g)x.cancel()})}return w},query(u){let m=u.hierarchy||"children",f=u.include,w=u.exclude,p=[];switch(m){case"children":p=this.children;break;case"siblings":p=this.parent?this.parent.children.filter(x=>x!==this):[];break;case"ancestors":let g=this.parent;for(;g;)p.push(g),g=g.parent;break;case"descendants":p=this.children.flatMap(function x(P){return[P,...P.children.flatMap(x)]});break}if(f&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?p=p.filter(g=>g.is(f)):p=p.filter(g=>u.include.some(x=>g.is(x)))),w&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?p=p.filter(g=>!g.is(w)):p=p.filter(g=>!u.exclude.some(x=>g.is(x)))),u.visible===!0&&(p=p.filter(g=>g.visible)),u.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let g=u.distanceOp||"near",x=u.distance*u.distance;g==="near"?p=p.filter(P=>P.pos&&this.pos.sdist(P.pos)<=x):p=p.filter(P=>P.pos&&this.pos.sdist(P.pos)>x)}return u.name&&(p=p.filter(g=>g.name===u.name)),p},isAncestorOf(u){return u.parent?u.parent===this||this.isAncestorOf(u.parent):!1},exists(){return y.game.root.isAncestorOf(this)},is(u,m="and"){return Array.isArray(u)?m==="and"?u.every(f=>r.has(f)):u.some(f=>r.has(f)):r.has(u)},tag(u){if(Array.isArray(u))for(let m of u)r.add(m),this.trigger("tag",m),y.game.events.trigger("tag",this,m);else r.add(u),this.trigger("tag",u),y.game.events.trigger("tag",this,u)},untag(u){if(Array.isArray(u))for(let m of u)r.delete(m),this.trigger("untag",m),y.game.events.trigger("untag",this,m);else r.delete(u),this.trigger("untag",u),y.game.events.trigger("untag",this,u)},has(u,m="and"){return Array.isArray(u)?m==="and"?u.every(f=>t.has(f)):u.some(f=>t.has(f)):t.has(u)},on(u,m){let f=n.on(u,m.bind(this));return o&&o(()=>f.cancel()),f},trigger(u,...m){n.trigger(u,...m),y.game.objEvents.trigger(u,this,...m)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let u={};for(let[m,f]of t)u[m]=f.inspect?.()??null;for(let[m,f]of s.entries()){if(f.inspect){u[m]=f.inspect();continue}for(let[w,p]of Object.entries(f))typeof p!="function"&&(u[w]=`${w}: ${p}`)}return u},onAdd(u){return this.on("add",u)},onFixedUpdate(u){return this.on("fixedUpdate",u)},onUpdate(u){return this.on("update",u)},onDraw(u){return this.on("draw",u)},onDestroy(u){return this.on("destroy",u)},onUse(u){return this.on("use",u)},onUnuse(u){return this.on("unuse",u)},clearEvents(){n.clear()}},c=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let u of c)h[u]=(...m)=>{let f=y.app[u]?.(...m);return a.push(f),h.onDestroy(()=>f.cancel()),h.on("sceneEnter",()=>{a.splice(a.indexOf(f),1);let w=y.app[u]?.(...m);Lt.replace(f,w),a.push(f)}),f};for(let u of e)h.use(u);return h}var Id=()=>({events:new yn,objEvents:new yn,root:hi([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new B(1),angle:0,shake:0,transform:new ht}});function Dd(e){y.game.gravity=e?(y.game.gravity||T(0,1)).unit().scale(e):null}function Bd(){return y.game.gravity?y.game.gravity.len():0}function Hd(e){y.game.gravity=e.unit().scale(y.game.gravity?y.game.gravity.len():1)}function mn(){return y.game.gravity?y.game.gravity.unit():T(0,1)}var qd=fr("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"),Rd=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let s=new bn(il(e));return e.decodeAudioData(qd.buffer.slice(0)).then(i=>{s.buf=i}).catch(i=>{console.error("Failed to load burp: ",i)}),{ctx:e,masterNode:t,burpSnd:s}})();function Fd(e,t={}){let s=new Oe,i=new Audio(e);i.crossOrigin="anonymous",i.loop=!!t.loop,y.audio.ctx.createMediaElementSource(i).connect(y.audio.masterNode);function n(){y.debug.paused||y.app.isHidden()&&!y.globalOpt.backgroundAudio||y.audio.ctx.resume()}function a(){n(),i.play()}return t.paused||a(),i.onended=()=>s.trigger(),{play(){a()},seek(r){i.currentTime=r},stop(){i.pause(),this.seek(0)},set loop(r){i.loop=r},get loop(){return i.loop},set paused(r){r?i.pause():a()},get paused(){return i.paused},time(){return i.currentTime},duration(){return i.duration},set volume(r){i.volume=ct(r,0,1)},get volume(){return i.volume},set speed(r){i.playbackRate=Math.max(r,0)},get speed(){return i.playbackRate},set detune(r){},get detune(){return 0},onEnd(r){return s.add(r)},then(r){return this.onEnd(r)}}}function Od(e,t={}){if(typeof e=="string"&&y.assets.music[e])return Fd(y.assets.music[e],t);let s=y.audio.ctx,i=t.paused??!1,n=s.createBufferSource(),a=new Oe,r=s.createGain(),l=s.createStereoPanner(),o=t.seek??0,d=0,h=0,c=!1;n.loop=!!t.loop,n.detune.value=t.detune??0,n.playbackRate.value=t.speed??1,n.connect(l),n.onended=()=>{f()>=(n.buffer?.duration??Number.POSITIVE_INFINITY)&&a.trigger()},l.pan.value=t.pan??0,l.connect(r),r.connect(y.audio.masterNode),r.gain.value=t.volume??1;let u=p=>{n.buffer=p.buf,i||(d=s.currentTime,n.start(0,o),c=!0)},m=Hl(e);m instanceof _e&&m.onLoad(u);let f=()=>{if(!n.buffer)return 0;let p=i?h-d:s.currentTime-d,g=n.buffer.duration;return n.loop?p%g:Math.min(p,g)},w=p=>{let g=s.createBufferSource();return g.buffer=p.buffer,g.loop=p.loop,g.playbackRate.value=p.playbackRate.value,g.detune.value=p.detune.value,g.onended=p.onended,g.connect(l),g};return{stop(){this.paused=!0,this.seek(0)},set paused(p){if(i!==p)if(i=p,p)c&&(n.stop(),c=!1),h=s.currentTime;else{n=w(n);let g=h-d;n.start(0,g),c=!0,d=s.currentTime-g,h=0}},get paused(){return i},play(p=0){this.seek(p),this.paused=!1},seek(p){n.buffer?.duration&&(p>n.buffer.duration||(i?(n=w(n),d=h-p):(n.stop(),n=w(n),d=s.currentTime-p,n.start(0,p),c=!0,h=0)))},set speed(p){n.playbackRate.value=p},get speed(){return n.playbackRate.value},set detune(p){n.detune.value=p},get detune(){return n.detune.value},set volume(p){r.gain.value=Math.max(p,0)},get volume(){return r.gain.value},set pan(p){l.pan.value=p},get pan(){return l.pan.value},set loop(p){n.loop=p},get loop(){return n.loop},duration(){return n.buffer?.duration??0},time(){return f()%this.duration()},onEnd(p){return a.add(p)},then(p){return this.onEnd(p)}}}function Ya(e){return y.k.play(y.audio.burpSnd,e)}function Va(e){y.audio.masterNode.gain.value=e}function Qa(){return y.audio.masterNode.gain.value}function jd(e){return kt("volume","setVolume / getVolume"),e!==void 0&&Va(e),Qa()}function $a(){y.app.onHide(()=>{y.globalOpt.backgroundAudio||y.audio.ctx.suspend()}),y.app.onShow(()=>{!y.globalOpt.backgroundAudio&&!y.debug.paused&&y.audio.ctx.resume()}),y.app.onResize(()=>{if(y.app.isFullscreen())return;let e=y.globalOpt.width&&y.globalOpt.height;e&&!y.globalOpt.stretch&&!y.globalOpt.letterbox||(y.canvas.width=y.canvas.offsetWidth*y.pixelDensity,y.canvas.height=y.canvas.offsetHeight*y.pixelDensity,fa(),e||(y.gfx.frameBuffer.free(),y.gfx.frameBuffer=new Jn(y.gfx.ggl,y.gfx.ggl.gl.drawingBufferWidth,y.gfx.ggl.gl.drawingBufferHeight),y.gfx.width=y.gfx.ggl.gl.drawingBufferWidth/y.pixelDensity/y.gscale,y.gfx.height=y.gfx.ggl.gl.drawingBufferHeight/y.pixelDensity/y.gscale))}),y.globalOpt.debug!==!1&&(y.app.onKeyPress(y.globalOpt.debugKey??"f1",()=>y.debug.inspect=!y.debug.inspect),y.app.onKeyPress("f2",()=>y.debug.clearLog()),y.app.onKeyPress("f8",()=>y.debug.paused=!y.debug.paused),y.app.onKeyPress("f7",()=>{y.debug.timeScale=js(ct(y.debug.timeScale-.2,0,2),1)}),y.app.onKeyPress("f9",()=>{y.debug.timeScale=js(ct(y.debug.timeScale+.2,0,2),1)}),y.app.onKeyPress("f10",()=>y.debug.stepFrame())),y.globalOpt.burp&&y.app.onKeyPress("b",()=>Ya())}function Nd(e,t={}){let s=y.game.root.add([_n(e),er()]),i=(t.speed||1)*5,n=t.scale||1;s.add([Xs(y.boomSprite),kn(0),Vs("center"),Oi(i,n),...t.comps??[]]);let a=s.add([Xs(y.kaSprite),kn(0),Vs("center"),Ws(),...t.comps??[]]);return a.wait(.4/i,()=>a.use(Oi(i,n))),a.onDestroy(()=>s.destroy()),s}function Ja(e,t){if(y.game.layers)throw Error("Layers can only be assigned once.");let s=e.indexOf(t);if(s==-1)throw Error("The default layer name should be present in the layers list.");y.game.layers=e,y.game.defaultLayerIndex=s}function Ld(){return y.game.layers}function Ud(){return y.game.layers?.[y.game.defaultLayerIndex]??null}function Gd(e,t){kt("layers","setLayers"),Ja(e,t)}function Za(e){e.destroy()}function zd(){return y.game.root}function Kd(e,t){y.game.scenes[e]=t}function Xd(e,...t){if(!y.game.scenes[e])throw new Error(`Scene not found: ${e}`);y.game.events.onOnce("frameEnd",()=>{y.game.events.trigger("sceneLeave",e),y.app.events.clear(),y.game.events.clear(),y.game.objEvents.clear(),[...y.game.root.children].forEach(s=>{!s.stay||s.scenesToStay&&!s.scenesToStay.includes(e)?y.game.root.remove(s):s.trigger("sceneEnter",e)}),y.game.root.clearEvents(),$a(),y.game.cam={pos:null,scale:T(1),angle:0,shake:0,transform:new ht},y.game.scenes[e](...t)}),y.game.currentScene=e}function Wd(e){return y.game.events.on("sceneLeave",e)}function Yd(){return y.game.currentScene}function Xs(e,t={}){let s=null,i=null,n=null,a=new Oe;if(!e)throw new Error("Please pass the resource name or data to sprite()");let r=(d,h,c,u)=>{let m=T(1,1);return c&&u?(m.x=c/(d.width*h.w),m.y=u/(d.height*h.h)):c?(m.x=c/(d.width*h.w),m.y=m.x):u&&(m.y=u/(d.height*h.h),m.x=m.y),m},l=(d,h)=>{if(!h)return;let c=h.frames[0].clone();t.quad&&(c=c.scale(t.quad));let u=r(h.tex,c,t.width,t.height);if(d.width=h.tex.width*c.w*u.x,d.height=h.tex.height*c.h*u.y,h.anims)for(let m in h.anims){let f=h.anims[m];typeof f!="number"&&(f.frames=o(f))}s=h,a.trigger(s),t.anim&&d.play(t.anim)},o=d=>{if(d.frames)return d.frames;let h=[];if(d.from===void 0||d.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let c=Math.abs(d.to-d.from)+1;for(let u=0;u<c;u++)h.push(d.from+u*Math.sign(d.to-d.from));if(d.pingpong)for(let u=c-2;u>0;u--)h.push(h[u]);return h};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new be(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(d){let h=zn(d);h&&h.onLoad(c=>l(this,c))},get animFrame(){if(!s||!i||n===null)return this.frame;let d=s.anims[i.name];return typeof d=="number"?d:d.from===void 0||d.to===void 0?i.frameIndex:this.frame-Math.min(d.from,d.to)},draw(){if(!s)return;let d=s.frames[this.frame??0];if(!d)throw new Error(`Frame not found: ${this.frame??0}`);if(s.slice9){let{left:h,right:c,top:u,bottom:m}=s.slice9,f=s.tex.width*d.w,w=s.tex.height*d.h,p=this.width-h-c,g=this.height-u-m,x=h/f,P=c/f,H=1-x-P,C=u/w,A=m/w,b=1-C-A,E=[Se(0,0,x,C),Se(x,0,H,C),Se(x+H,0,P,C),Se(0,C,x,b),Se(x,C,H,b),Se(x+H,C,P,b),Se(0,C+b,x,A),Se(x,C+b,H,A),Se(x+H,C+b,P,A),Se(0,0,h,u),Se(h,0,p,u),Se(h+p,0,c,u),Se(0,u,h,g),Se(h,u,p,g),Se(h+p,u,c,g),Se(0,u+g,h,m),Se(h,u+g,p,m),Se(h+p,u+g,c,m)];for(let M=0;M<9;M++){let D=E[M],O=E[M+9];Zn(Object.assign(Nt(this),{pos:O.pos(),tex:s.tex,quad:d.scale(D),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:O.w,height:O.h}))}}else Zn(Object.assign(Nt(this),{tex:s.tex,quad:d.scale(this.quad??new be(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let d=zn(e);d?d.onLoad(h=>l(this,h)):ci(()=>l(this,zn(e).data))},update(){if(!s||!i||n===null)return;let d=s.anims[i.name];if(typeof d=="number"){this.frame=d;return}if(d.speed===0)throw new Error("Sprite anim speed cannot be 0");if(i.timer+=Te()*this.animSpeed,i.timer>=1/i.speed){i.timer=0,i.frameIndex+=n;let h=d.frames;if(i.frameIndex>=h.length)if(i.pingpong&&!d.pingpong)n=-1,i.frameIndex=h.length-2;else if(i.loop)i.frameIndex=0;else{this.frame=h.at(-1),i.onEnd(),this.stop();return}else if(i.frameIndex<0)if(i.pingpong&&i.loop)n=1,i.frameIndex=1;else if(i.loop)i.frameIndex=h.length-1;else{this.frame=h[0],i.onEnd(),this.stop();return}this.frame=h[i.frameIndex]}},play(d,h={}){if(!s){a.add(()=>this.play(d,h));return}let c=s.anims[d];if(c===void 0)throw new Error(`Anim not found: ${d}`);i&&this.stop(),i=typeof c=="number"?{name:d,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:d,timer:0,loop:h.loop??c.loop??!1,pingpong:h.pingpong??c.pingpong??!1,speed:h.speed??c.speed??10,frameIndex:0,onEnd:h.onEnd??(()=>{})},n=typeof c=="number"?null:1,this.frame=typeof c=="number"?c:c.frames[0],this.trigger("animStart",d)},stop(){if(!i)return;let d=i.name;i=null,this.trigger("animEnd",d)},numFrames(){return s?.frames.length??0},getCurAnim(){return i},curAnim(){return i?.name},getAnim(d){return s?.anims[d]??null},hasAnim(d){return!!this.getAnim(d)},onAnimEnd(d){return this.on("animEnd",d)},onAnimStart(d){return this.on("animStart",d)},renderArea(){return new ge(T(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function Vd(e,t={}){function s(n){let a=Ot(Object.assign(Nt(n),{text:n.text+"",size:n.textSize,font:n.font,width:t.width&&n.width,align:n.align,letterSpacing:n.letterSpacing,lineSpacing:n.lineSpacing,transform:n.textTransform,styles:n.textStyles,indentAll:t.indentAll}));return t.width||(n.width=a.width/(n.scale?.x||1)),n.height=a.height/(n.scale?.y||1),a}let i={id:"text",set text(n){e=n,s(this),this.renderedText=Gs(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?Gs(e).text:"",add(){ci(()=>s(this))},draw(){jt(s(this))},renderArea(){return new ge(T(0),this.width,this.height)}};return s(i),i}function Qd(e,t){return{id:"rect",width:e,height:t,draw(){xn(Object.assign(Nt(this),{width:this.width,height:this.height}))},renderArea(){return new ge(T(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function $d(e={}){let t=null,s=null,i=null,n=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return s&&i?s[i]:null},getPath(){return s?s.slice():null},getTarget(){return t},isNavigationFinished(){return s?i===null:!0},isTargetReachable(){return s!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(a){t=a,s=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),i=s?0:null,s&&i!==null?(n||(n=this.getLevel().onNavigationMapChanged(()=>{t&&s&&i!==null&&(s=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),s?(i=0,this.trigger("navigationNext",this,s[i])):(i=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>n?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,s[i])):this.trigger("navigationEnded",this)},update(){if(t&&s&&i!==null){if(this.pos.sdist(s[i])<2)if(i===s.length-1){this.pos=t.clone(),i=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else i++,this.trigger("navigationNext",this,s[i]);this.moveTo(s[i],this.agentSpeed)}},onNavigationStarted(a){return this.on("navigationStarted",a)},onNavigationNext(a){return this.on("navigationNext",a)},onNavigationEnded(a){return this.on("navigationEnded",a)},onTargetReached(a){return this.on("targetReached",a)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(s)})}}}function Jd(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(s){return this.graph?.getWaypointPath(this.pos,s,e.navigationOpt)},get graph(){if(t)return t;let s=this.parent;for(;s;){if(s.has("pathfinderMap"))return s.graph;s=s.parent}},set graph(s){t=s}}}function Zd(e={}){let t=e.waypoints,s=e.speed||100,i=e.endBehavior||"stop",n=0,a=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return s},set patrolSpeed(r){s=r},get waypoints(){return t},set waypoints(r){t=r,n=0,a=!1},get nextLocation(){return t?t[n]:void 0},update(){let r=this.nextLocation;if(!(!t||!r||a)&&(this.moveTo(r,s),this.pos.sdist(r)<9))switch(i){case"loop":n=(n+1)%t.length;break;case"ping-pong":n=n+1,n==t.length&&(t.reverse(),n=0);break;case"stop":n<t.length-1?n+=1:a||(a=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(r){return this.on("patrolFinished",r)}}}function _d(e,t={}){let s=typeof e=="function"?e:()=>y.game.root.query(e),i=t.checkFrequency||1,n=typeof t.direction=="number"?B.fromAngle(t.direction):t.direction,a=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?B.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(r){this.direction=r!==void 0?B.fromAngle(r):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(r,l,o){let d=(typeof l=="number"?B.fromAngle(l):l)||n,h=o||t.fieldOfView;if(!d||!h||h>=360)return!0;let c=h/2;return r.pos&&d.angleBetween(r.pos.sub(this.pos))<=c},hasLineOfSight(r){let l=qa(this.pos,r.pos.sub(this.pos),t.raycastExclude);return l!=null&&l.object===r},update(){if(a+=Te(),a>i){a-=i;let r=s();if(r.length&&n&&this.fieldOfView&&this.fieldOfView<360){let l=this.fieldOfView/2;r=r.filter(o=>o.pos&&n.angleBetween(o.pos.sub(this.pos))<=l)}r.length&&t.lineOfSight&&(r=r.filter(l=>l.pos&&this.hasLineOfSight(l))),r.length>0&&(this.spotted=r,this.trigger("objectSpotted",r))}},onObjectsSpotted(r){return this.on("objectSpotted",r)}}}function _a(e={}){let t=T(0),s=e.isObstacle??!1,i=e.cost??0,n=e.edges??[],a=()=>{let l={left:1,top:2,right:4,bottom:8};return n.map(o=>l[o]||0).reduce((o,d)=>o|d,0)},r=a();return{id:"tile",tilePosOffset:e.offset??T(0),set tilePos(l){let o=this.getLevel();t=l.clone(),this.pos=T(this.tilePos.x*o.tileWidth(),this.tilePos.y*o.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(l){s!==l&&(s=l,this.getLevel().invalidateNavigationMap())},get isObstacle(){return s},set cost(l){i!==l&&(i=l,this.getLevel().invalidateNavigationMap())},get cost(){return i},set edges(l){n=l,r=a(),this.getLevel().invalidateNavigationMap()},get edges(){return n},get edgeMask(){return r},getLevel(){return this.parent},tileMove(l){let o=this.getLevel();o.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(l),o.insertIntoSpatialMap(this),o.trigger("spatialMapChanged")},moveLeft(){this.tileMove(T(-1,0))},moveRight(){this.tileMove(T(1,0))},moveUp(){this.tileMove(T(0,-1))},moveDown(){this.tileMove(T(0,1))}}}var pi=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,s){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||wn.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=s}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,s){let i=t-1,n=e/this.duration;if(this.loops!==0&&n>=this.loops)return[i,0,!0];let a=Math.trunc(n);if(n-=a,(this.direction=="reverse"||this.direction=="ping-pong"&&a&1)&&(n=1-n),s){let r=0;for(;s[r+1]!==void 0&&s[r+1]<n;)r++;return r>=i?[i,0,!0]:[r,(n-s[r])/(s[r+1]-s[r]),!1]}else{let r=Math.floor((t-1)*n);return[r,(n-r/i)*i,!1]}}setValue(e,t,s){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(s);break;case"angle":e.angle=e.base.angle+s;break;case"scale":e.scale=e.base.scale.scale(s);break;case"opacity":e.opacity=e.base.opacity*s;break;default:e[t]=s}else e[t]=s}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=wn.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Fi(e,t){return t.add(t.sub(e))}var kd=class extends pi{keys;constructor(e,t,s,i){super(e,s,i),this.keys=t}update(e,t){let[s,i,n]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[s]);else{let a=this.easings?this.easings[s]:this.easing;this.setValue(e,this.name,ze(this.keys[s],this.keys[s+1],a(i)))}return n}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},eu=class extends pi{keys;curves;dcurves;constructor(e,t,s,i,n){if(super(e,s,i),this.keys=t,this.interpolation==="spline"){this.curves=[],n&&(this.dcurves=[]);for(let a=0;a<this.keys.length-1;a++){let r=this.keys[a],l=a+1,o=this.keys[l],d=a>0?this.keys[a-1]:Fi(o,r),h=l<this.keys.length-1?this.keys[l+1]:Fi(r,o);this.curves.push(Vn(d,r,o,h)),n&&this.dcurves?.push(Vn(d,r,o,h,Jr))}}}update(e,t){let[s,i,n]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[s]);else{let a=this.easings?this.easings[s]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[s].lerp(this.keys[s+1],a(i)));break;case"slerp":this.setValue(e,this.name,this.keys[s].slerp(this.keys[s+1],a(i)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[s](a(i))),this.dcurves&&this.setValue(e,"angle",this.dcurves[s](a(i)).angle());break}}}return n}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},tu=class extends pi{keys;constructor(e,t,s,i){super(e,s,i),this.keys=t}update(e,t){let[s,i,n]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(i==0||this.interpolation=="none")this.setValue(e,this.name,this.keys[s]);else{let a=this.easings?this.easings[s]:this.easing;this.setValue(e,this.name,this.keys[s].lerp(this.keys[s+1],a(i)))}return n}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function nu(e={}){let t=[],s=0,i=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:T(0,0),angle:0,scale:T(1,1),opacity:1},animation:{paused:!1,seek(n){s=ct(n,0,this.duration),t.forEach(a=>{a.isFinished=!1}),i=!1},get duration(){return t.reduce((n,a)=>Math.max(a.duration,n),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let n=!0,a;s+=Te();for(let r of t)a=r.update(this,s),a&&!r.isFinished&&(r.isFinished=!0,this.trigger("animateChannelFinished",r.name)),n&&=a;n&&!i&&(i=!0,this.trigger("animateFinished"))},animate(n,a,r){i=!1,this.unanimate(n),typeof a[0]=="number"?t.push(new kd(n,a,r,e.relative||!1)):a[0]instanceof B?t.push(new eu(n,a,r,e.relative||!1,n==="pos"&&(e.followMotion||!1))):a[0]instanceof te&&t.push(new tu(n,a,r,e.relative||!1))},unanimate(n){let a=t.findIndex(r=>r.name===n);a>=0&&t.splice(a,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(n){return this.on("animateFinished",n)},onAnimateChannelFinished(n){return this.on("animateChannelFinished",n)},serializeAnimationChannels(){return t.reduce((n,a)=>(n[a.name]=a.serialize(),n),{})},serializeAnimationOptions(){let n={};return e.followMotion&&(n.followMotion=!0),e.relative&&(n.relative=!0),n}}}function ka(e,t){let s={name:e.name};return e.has("animate")&&(s.channels=e.serializeAnimationChannels(),Object.assign(s,e.serializeAnimationOptions())),e.children.length>0&&(s.children=e.children.filter(i=>i.has("named")).map(i=>ka(i,i.name))),s}function Oi(e=2,t=1){let s=0;return{require:["scale"],update(){let i=Math.sin(s*e)*t;i<0&&this.destroy(),this.scale=T(i),s+=Te()}}}function su(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(s=1){this.setHP(e-s),this.trigger("hurt",s)},heal(s=1){let i=e;this.setHP(e+s),this.trigger("heal",e-i)},hp(){return e},maxHP(){return t??null},setMaxHP(s){t=s},setHP(s){e=t?Math.min(t,s):s,e<=0&&this.trigger("death")},onHurt(s){return this.on("hurt",s)},onHeal(s){return this.on("heal",s)},onDeath(s){return this.on("death",s)},inspect(){return`health: ${e}`}}}function iu(e,t={}){if(e==null)throw new Error("lifespan() requires time");let s=t.fade??0;return{id:"lifespan",require:["opacity"],add(){y.game.root.wait(e,()=>{this.opacity=this.opacity??1,s>0?y.game.root.tween(this.opacity,0,s,i=>this.opacity=i,wn.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function au(e){return{id:"named",name:e}}function ru(e,t,s){if(!e)throw new Error("state() requires an initial state");let i={};function n(o){i[o]||(i[o]={enter:new Oe,end:new Oe,update:new Oe,draw:new Oe})}function a(o,d,h){return n(d),i[d][o].add(h)}function r(o,d,...h){n(d),i[d][o].trigger(...h)}let l=!1;return{id:"state",state:e,enterState(o,...d){if(l=!0,t&&!t.includes(o))throw new Error(`State not found: ${o}`);let h=this.state;if(s){if(!s?.[h])return;let c=typeof s[h]=="string"?[s[h]]:s[h];if(!c.includes(o))throw new Error(`Cannot transition state from "${h}" to "${o}". Available transitions: ${c.map(u=>`"${u}"`).join(", ")}`)}r("end",h,...d),this.state=o,r("enter",o,...d),r("enter",`${h} -> ${o}`,...d)},onStateTransition(o,d,h){return a("enter",`${o} -> ${d}`,h)},onStateEnter(o,d){return a("enter",o,d)},onStateUpdate(o,d){return a("update",o,d)},onStateDraw(o,d){return a("draw",o,d)},onStateEnd(o,d){return a("end",o,d)},update(){l||(r("enter",e),l=!0),r("update",this.state)},draw(){r("draw",this.state)},inspect(){return`state: ${this.state}`}}}function er(e){return{id:"stay",stay:!0,scenesToStay:e}}function ou(e=!0,t){let s,i;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let n=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};s=y.k.onCharInput(a=>{this.hasFocus&&(!t||this.typedText.length<t)&&(y.k.isKeyDown("shift")?this.typedText+=a.toUpperCase():this.typedText+=a,n())}),i=y.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),n())})},destroy(){s.cancel(),i.cancel()}}}function Ws(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,s,i=1/0,n=!1){let a=n?0:t,r=new Oe,l=this.onUpdate(()=>{a+=y.app.state.dt;for(let o=0;a>=t&&o<this.maxLoopsPerFrame;o++)if(i--,s(),a-=t,i<=0){l.cancel(),r.trigger();return}});return{get paused(){return l.paused},set paused(o){l.paused=o},cancel:l.cancel,onEnd(o){r.add(o)},then(o){return r.add(o),this}}},wait(t,s){return this.loop(t,s??(()=>{}),1,!0)},tween(t,s,i,n,a=wn.linear){let r=0,l=[],o=this.onUpdate(()=>{r+=y.app.state.dt;let d=Math.min(r/i,1);n(ze(t,s,a(d))),d===1&&(o.cancel(),n(s),l.forEach(h=>h()))});return{get paused(){return o.paused},set paused(d){o.paused=d},onEnd(d){l.push(d)},then(d){return this.onEnd(d),this},cancel(){o.cancel()},finish(){o.cancel(),n(s),l.forEach(d=>d())}}}}}var Ys=0;function lu(){return Ys>0}function du(e={}){let t={},s=new Set,i=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){Ys++,this.area.cursor&&i.push(this.onHover(()=>y.app.setCursor(this.area.cursor))),i.push(this.onCollideUpdate((n,a)=>{if(!n.id)throw new Error("area() requires the object to have an id");t[n.id]||this.trigger("collide",n,a),a&&(t[n.id]=a,s.add(n.id))}))},destroy(){Ys--;for(let n of i)n.cancel()},fixedUpdate(){for(let n in t)s.has(Number(n))||(this.trigger("collideEnd",t[n].target),delete t[n]);s.clear()},drawInspect(){let n=this.localArea();Qe(),xe(this.area.offset);let a={outline:{width:4/ga(),color:ae(0,0,255)},anchor:this.anchor,fill:!1,fixed:qt(this)};n instanceof ge?Je({...a,pos:n.pos,width:n.width*this.area.scale.x,height:n.height*this.area.scale.y}):n instanceof Ne?St({...a,pts:n.pts,scale:this.area.scale}):n instanceof Ke&&tn({...a,pos:n.center,radius:n.radius}),Ge()},area:{shape:e.shape??null,scale:e.scale?T(e.scale):T(1),offset:e.offset??T(0),cursor:e.cursor??null},isClicked(){return y.app.isMousePressed()&&this.isHovering()},isHovering(){let n=qt(this)?y.k.mousePos():y.k.toWorld(y.k.mousePos());return this.hasPoint(n)},checkCollision(n){if(!n.id)throw new Error("checkCollision() requires the object to have an id");return t[n.id]??null},getCollisions(){return Object.values(t)},isColliding(n){if(!n.id)throw new Error("isColliding() requires the object to have an id");return!!t[n.id]},isOverlapping(n){if(!n.id)throw new Error("isOverlapping() requires the object to have an id");let a=t[n.id];return a&&a.hasOverlap()},onClick(n,a="left"){let r=this.onMousePress(a,()=>{this.isHovering()&&n()});return i.push(r),r},onHover(n){let a=!1;return this.onUpdate(()=>{a?a=this.isHovering():this.isHovering()&&(a=!0,n())})},onHoverUpdate(n){return this.onUpdate(()=>{this.isHovering()&&n()})},onHoverEnd(n){let a=!1;return this.onUpdate(()=>{a?this.isHovering()||(a=!1,n()):a=this.isHovering()})},onCollide(n,a){if(typeof n=="function"&&a===void 0)return this.on("collide",n);if(typeof n=="string")return this.onCollide((r,l)=>{r.is(n)&&a?.(r,l)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(n,a){if(typeof n=="function"&&a===void 0)return this.on("collideUpdate",n);if(typeof n=="string")return this.on("collideUpdate",(r,l)=>r.is(n)&&a?.(r,l));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(n,a){if(typeof n=="function"&&a===void 0)return this.on("collideEnd",n);if(typeof n=="string")return this.on("collideEnd",r=>r.is(n)&&a?.(r));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(n){return Ct(this.worldArea(),n)},resolveCollision(n){let a=this.checkCollision(n);a&&!a.resolved&&(this.pos=this.pos.add(a.displacement),a.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let n=this.localArea();if(!(n instanceof Ne||n instanceof ge))throw new Error("Only support polygon and rect shapes for now");let a=this.transform.clone().translate(this.area.offset).scale(T(this.area.scale??1));if(n instanceof ge){let r=en(this.anchor||ss).add(1,1).scale(-.5).scale(n.width,n.height);a.translate(r)}return n.transform(a)},screenArea(){let n=this.worldArea();return qt(this)?n:n.transform(y.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function uu(e={}){let t=null,s=null,i=!1,n=T(0),a=null,r=null,l;return{id:"body",require:["pos"],vel:T(0),drag:e.drag??0,jumpForce:e.jumpForce??yo,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),r=this.pos.clone(),l=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((o,d)=>{if(!d||!o.has("body")||d.resolved)return;this.trigger("beforePhysicsResolve",d);let h=d.reverse();if(o.trigger("beforePhysicsResolve",h),!(d.resolved||h.resolved)&&!(this.isStatic&&o.isStatic)){if(!this.isStatic&&!o.isStatic){let c=this.mass+o.mass;this.pos=this.pos.add(d.displacement.scale(o.mass/c)),o.pos=o.pos.add(d.displacement.scale(-this.mass/c)),this.transform=fn(this),o.transform=fn(o)}else{let c=!this.isStatic&&o.isStatic?d:d.reverse();c.source.pos=c.source.pos.add(c.displacement),c.source.transform=fn(c.source)}d.resolved=!0,this.trigger("physicsResolve",d),o.trigger("physicsResolve",d.reverse())}}),this.onPhysicsResolve(o=>{if(y.game.gravity)if(o.isBottom()&&this.isFalling()){this.vel=this.vel.reject(y.game.gravity.unit());let d=t;t=o.target,d!=t&&(s=o.target.pos),i?i=!1:d||(this.trigger("ground",t),o.target.trigger("land",this))}else o.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(y.game.gravity.unit()),this.trigger("headbutt",o.target),o.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(s&&!t.pos.eq(s)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(s)),s=t.pos);let o=Ls();o&&(this.pos.x==l.x&&(this.pos.x=ze(a.x,r.x,o/Ns()),l.x=this.pos.x),this.pos.y==l.y&&(this.pos.y=ze(a.y,r.y,o/Ns()),l.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==l.x&&(this.pos.x=a.x),this.pos.y==l.y&&(this.pos.y=a.y),a=null),y.game.gravity&&!this.isStatic){i&&(t=null,s=null,this.trigger("fallOff"),i=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(i=!0);let o=this.vel.clone();this.vel=this.vel.add(y.game.gravity.scale(this.gravityScale*Te()));let d=e.maxVelocity??wo;this.vel.slen()>d*d&&(this.vel=this.vel.unit().scale(d)),o.dot(y.game.gravity)<0&&this.vel.dot(y.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=n.x*Te(),this.vel.y+=n.y*Te(),this.vel.x*=1-this.drag*Te(),this.vel.y*=1-this.drag*Te(),this.move(this.vel),Ls()){a=this.pos.clone();let o=this.vel.add(n.scale(Te()));r=this.pos.add(o.scale(Te())),l=this.pos.clone()}n.x=0,n.y=0},onPhysicsResolve(o){return this.on("physicsResolve",o)},onBeforePhysicsResolve(o){return this.on("beforePhysicsResolve",o)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(mn())>0},isJumping(){return this.vel.dot(mn())<0},applyImpulse(o){this.isStatic||(this.vel=this.vel.add(o))},addForce(o){this.isStatic||(n.x+=o.x/this.mass,n.y+=o.y/this.mass)},jump(o){this.isStatic||(t=null,s=null,this.vel=mn().scale(-o||-this.jumpForce))},onGround(o){return this.on("ground",o)},onFall(o){return this.on("fall",o)},onFallOff(o){return this.on("fallOff",o)},onHeadbutt(o){return this.on("headbutt",o)},onLand(o){return this.on("land",o)},onHeadbutted(o){return this.on("headbutted",o)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function cu(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(s){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(s))},onDoubleJump(s){return this.on("doubleJump",s)},inspect(){return`jumpsLeft: ${t}`}}}function hu(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,s)=>{let i=s?.normal.normal(),n=t.vel.project(i),a=i?.scale(this.speed)?.sub(n);t.addForce(a?.scale(t.mass*this.forceScale))})}}}function pu(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,s)=>{if(!t.has("body"))return;let i=B.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(i),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function fu(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,s)=>{let i=this.pos.sub(t.pos),n=i.len(),a=n*this.distanceScale/10,r=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/a:1/a**2,l=i.scale(this.forceMagnitude*r/n);t.addForce(l),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function gu(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function mu(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let s=t.target.vel,i=mn().scale(-1).angleBetween(s);Math.abs(i)>this.surfaceArc/2&&t.preventResolution()})}}}function yu(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,s)=>{let i=t,n=i.worldArea(),[a,r]=n.cut(T(-100,this.surfaceLevel),T(100,this.surfaceLevel));a&&(this.applyBuoyancy(i,a),this.applyDrag(i,a)),this.flowMagnitude&&i.addForce(B.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,s){let i=this.density*s.area(),n=T(0,1).scale(-i);t.addForce(n)},applyDrag(t,s){let i=t.vel,n=this.density*this.linearDrag,a=i.scale(-n);t.addForce(a)}}}function Vs(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function tr(){return{id:"fixed",fixed:!0}}function wu(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??T(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function vu(e){let t=y.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?y.game.layers?.[t]??null:null},set layer(s){if(t=y.game.layers?.indexOf(s),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function bu(e,t){let s=typeof e=="number"?B.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(s.scale(t))}}}function xu(e={}){let t=!1,s=new ge(T(0),Be(),qe()),i=new ge(T(0),0,0),n=a=>{a.isOffScreen()?(t||(a.trigger("exitView"),t=!0),e.hide&&(a.hidden=!0),e.pause&&(a.paused=!0),e.destroy&&a.destroy()):(t&&(a.trigger("enterView"),t=!1),e.hide&&(a.hidden=!1),e.pause&&(a.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??Si,isOffScreen(){let a=this.screenPos();if(!a)return!1;if(s.width=Be(),s.height=qe(),!this.offscreenDistance&&this.width&&this.height)return i.width=this.width,i.height=this.height,i.pos=this.pos,i.collides(s);let r=this.offscreenDistance?this.offscreenDistance:Si;return!es(s,a)&&s.sdistToPoint(a)>r*r},onExitScreen(a){return this.on("exitView",a)},onEnterScreen(a){return this.on("enterView",a)},add(){e.pause&&e.unpause?Fa(()=>n(this)):this.onUpdate(()=>n(this))}}}function _n(...e){return{id:"pos",pos:T(...e),moveBy(...t){this.pos=this.pos.add(T(...t))},move(...t){this.moveBy(T(...t).scale(Te()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(T(t[0],t[1]),t[2]);let s=t[0],i=t[1];if(i===void 0){this.pos=T(s);return}let n=s.sub(this.pos);if(n.len()<=i*Te()){this.pos=T(s);return}this.move(n.unit().scale(i))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let s=this.worldPos();return s?qt(this)?s:Ks(s):null}},toScreen(t){let s=this.toWorld(t);return qt(this)?s:Ks(s)},fromScreen(t){return qt(this)?this.fromWorld(t):this.fromWorld(Wa(t))},toOther(t,s){return t.fromWorld(this.toWorld(s))},fromOther(t,s){return t.toOther(this,s)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){tn({color:ae(255,0,0),radius:4/ga()})}}}function Au(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function kn(...e){if(e.length===0)return kn(1);let t=T(...e);return{id:"scale",set scale(s){if(!(s instanceof B))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=T(s)},get scale(){return t},scaleTo(...s){t=T(...s)},scaleBy(...s){t=t.scale(T(...s))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function Su(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var Pu="data:image/png;base64,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",Cu="data:image/png;base64,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",Mu=gr.version,y={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},Eu=(e={tagsAsComponents:!0})=>{y.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),y.k.quit()),y.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let s=e.canvas??t.appendChild(document.createElement("canvas"));y.canvas=s;let i=e.scale??1;y.gscale=i;let n=e.width&&e.height&&!e.stretch&&!e.letterbox;n?(s.width=e.width*i,s.height=e.height*i):(s.width=s.parentElement.offsetWidth,s.height=s.parentElement.offsetHeight);let a=["outline: none","cursor: default"];if(n){let G=s.width,$=s.height;a.push(`width: ${G}px`),a.push(`height: ${$}px`)}else a.push("width: 100%"),a.push("height: 100%");e.crisp&&(a.push("image-rendering: pixelated"),a.push("image-rendering: crisp-edges")),s.style.cssText=a.join(";");let r=e.pixelDensity||1;y.pixelDensity=r,s.width*=r,s.height*=r,s.tabIndex=0;let l=document.createElement("canvas");l.width=256,l.height=256,y.fontCacheCanvas=l;let o=l.getContext("2d",{willReadFrequently:!0});y.fontCacheC2d=o;let d=Vo({canvas:s,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});y.app=d;let h=[],c=d.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!c)throw new Error("WebGL not supported");let u=c,m=Ul(u,{texFilter:e.texFilter}),f=Vl(e,m);y.gfx=f;let w=Rd();y.audio=w;let p=bl(m,e.spriteAtlasPadding??0);y.assets=p;let g=Id();y.game=g,g.root.use(Ws());function x(G,$){let ee=new Jn(m,G,$);return{clear:()=>ee.clear(),free:()=>ee.free(),toDataURL:()=>ee.toDataURL(),toImageData:()=>ee.toImageData(),width:ee.width,height:ee.height,draw:fe=>{$e(),ee.bind(),fe(),$e(),ee.unbind()},get fb(){return ee}}}function P(){u.clear(u.COLOR_BUFFER_BIT),f.frameBuffer.bind(),u.clear(u.COLOR_BUFFER_BIT),f.bgColor||At(()=>{xn({width:Be(),height:qe(),quad:new be(0,0,Be()/64,qe()/64),tex:f.bgTex,fixed:!0})}),f.renderer.numDraws=0,f.fixed=!1,f.transformStack.length=0,f.transform=new ht}function H(G,$){f.postShader=G,f.postShaderUniform=$??null}function C(){$e(),f.lastDrawCalls=f.renderer.numDraws,f.frameBuffer.unbind(),u.viewport(0,0,u.drawingBufferWidth,u.drawingBufferHeight);let G=f.width,$=f.height;f.width=u.drawingBufferWidth/r,f.height=u.drawingBufferHeight/r,Zn({flipY:!0,tex:f.frameBuffer.tex,pos:new B(f.viewport.x,f.viewport.y),width:f.viewport.width,height:f.viewport.height,shader:f.postShader,uniform:typeof f.postShaderUniform=="function"?f.postShaderUniform():f.postShaderUniform,fixed:!0}),$e(),f.width=G,f.height=$}let A=!1,b={inspect:!1,set timeScale(G){y.app.state.timeScale=G},get timeScale(){return y.app.state.timeScale},showLog:!0,fps:()=>d.fps(),numFrames:()=>d.numFrames(),stepFrame:vt,drawCalls:()=>f.lastDrawCalls,clearLog:()=>g.logs=[],log:(...G)=>{let $=e.logMax??8,ee=G.length>1?G.concat(" ").join(" "):G[0];g.logs.unshift({msg:ee,time:d.time()}),g.logs.length>$&&(g.logs=g.logs.slice(0,$))},error:G=>b.log(new Error(G.toString?G.toString():G)),curRecording:null,numObjects:()=>V("*",{recursive:!0}).length,get paused(){return A},set paused(G){A=G,G?w.ctx.suspend():w.ctx.resume()}};y.debug=b;function E(G,$){try{return JSON.parse(window.localStorage[G])}catch{return $?(M(G,$),$):null}}function M(G,$){window.localStorage[G]=JSON.stringify($)}function D(G,...$){let ee=G(st),fe;typeof ee=="function"?fe=ee(...$)(st):fe=ee;for(let Ce in fe)st[Ce]=fe[Ce],e.global!==!1&&(window[Ce]=fe[Ce]);return st}function O(G){let $=d.canvas.captureStream(G),ee=w.ctx.createMediaStreamDestination();w.masterNode.connect(ee);let fe=new MediaRecorder($),Ce=[];return fe.ondataavailable=se=>{se.data.size>0&&Ce.push(se.data)},fe.onerror=()=>{w.masterNode.disconnect(ee),$.getTracks().forEach(se=>se.stop())},fe.start(),{resume(){fe.resume()},pause(){fe.pause()},stop(){return fe.stop(),w.masterNode.disconnect(ee),$.getTracks().forEach(se=>se.stop()),new Promise(se=>{fe.onstop=()=>{se(new Blob(Ce,{type:"video/mp4"}))}})},download(se="kaboom.mp4"){this.stop().then(Re=>Pi(se,Re))}}}function N(){return document.activeElement===d.canvas}let W=g.root.add.bind(g.root),U=g.root.readd.bind(g.root),k=g.root.removeAll.bind(g.root),V=g.root.get.bind(g.root),z=g.root.wait.bind(g.root),ne=g.root.loop.bind(g.root),Y=g.root.query.bind(g.root),_=g.root.tween.bind(g.root),me=gn(null,Cu),X=gn(null,Pu);y.kaSprite=me,y.boomSprite=X;function ke(){g.root.fixedUpdate()}function vt(){g.root.update()}class zt{source;target;normal;distance;resolved=!1;constructor($,ee,fe,Ce,se=!1){this.source=$,this.target=ee,this.normal=fe,this.distance=Ce,this.resolved=se}get displacement(){return this.normal.scale(this.distance)}reverse(){return new zt(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(g.gravity||T(0,1))>0}isRight(){return this.displacement.cross(g.gravity||T(0,1))<0}isTop(){return this.displacement.dot(g.gravity||T(0,1))>0}isBottom(){return this.displacement.dot(g.gravity||T(0,1))<0}preventResolution(){this.resolved=!0}}function Kt(){if(!lu())return;let G={},$=e.hashGridSize||64,ee=new ht,fe=[];function Ce(se){if(fe.push(ee.clone()),se.pos&&ee.translate(se.pos),se.scale&&ee.scale(se.scale),se.angle&&ee.rotate(se.angle),se.transform=ee.clone(),se.c("area")&&!se.paused){let Re=se,bt=Re.worldArea().bbox(),us=Math.floor(bt.pos.x/$),cs=Math.floor(bt.pos.y/$),hs=Math.ceil((bt.pos.x+bt.width)/$),ps=Math.ceil((bt.pos.y+bt.height)/$),En=new Set;for(let it=us;it<=hs;it++)for(let xt=cs;xt<=ps;xt++)if(!G[it])G[it]={},G[it][xt]=[Re];else if(!G[it][xt])G[it][xt]=[Re];else{let Tn=G[it][xt];e:for(let Le of Tn){if(Le.paused||!Le.exists()||En.has(Le.id))continue;for(let pt of Re.collisionIgnore)if(Le.is(pt))continue e;for(let pt of Le.collisionIgnore)if(Re.is(pt))continue e;let nn=no(Re.worldArea(),Le.worldArea());if(nn){let pt=new zt(Re,Le,nn.normal,nn.distance);Re.trigger("collideUpdate",Le,pt);let In=pt.reverse();In.resolved=pt.resolved,Le.trigger("collideUpdate",Re,In)}En.add(Le.id)}Tn.push(Re)}}se.children.forEach(Ce),ee=fe.pop()}Ce(g.root)}function It(G){console.error(G),w.ctx.suspend();let $=G.message??String(G)??"Unknown error, check console for more info";d.run(()=>{},()=>{P(),At(()=>{let ee=Be(),fe=qe(),Ce={size:36,width:ee-64,letterSpacing:4,lineSpacing:4,font:Qn,fixed:!0};Je({width:ee,height:fe,color:ae(0,0,255),fixed:!0});let se=Ot({...Ce,text:"Error",pos:T(32),color:ae(255,128,0),fixed:!0});jt(se),Ri({...Ce,text:$,pos:T(32,32+se.height+16),fixed:!0}),Ge(),g.events.trigger("error",G)}),C()})}function ls(G){h.push(G)}function ds(){g.events.onOnce("frameEnd",()=>{d.quit(),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);let G=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(let $=0;$<G;$++)u.activeTexture(u.TEXTURE0+$),u.bindTexture(u.TEXTURE_2D,null),u.bindTexture(u.TEXTURE_CUBE_MAP,null);u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),m.destroy(),h.forEach($=>$())})}let Xt=!0;d.run(()=>{try{p.loaded&&(b.paused||ke(),Kt())}catch(G){It(G)}},(G,$)=>{try{G(),p.loaded||Ft()===1&&!Xt&&(p.loaded=!0,ya().forEach(ee=>g.events.trigger("loadError",...ee)),g.events.trigger("load")),!p.loaded&&e.loadingScreen!==!1||Xt?(P(),Kl(),C()):(b.paused||vt(),Kt(),P(),zl(),e.debug!==!1&&Gl(),C()),Xt&&(Xt=!1),g.events.trigger("frameEnd"),$()}catch(ee){It(ee)}}),fa(),$a();let st={_k:y,VERSION:Mu,loadRoot:yl,loadProgress:Ft,loadSprite:gn,loadSpriteAtlas:Ca,loadSound:ql,loadMusic:Rl,loadBitmapFont:Ml,loadFont:Pl,loadShader:Dl,loadShaderURL:Bl,loadAseprite:Sl,loadPedit:El,loadBean:Al,loadJSON:wl,load:Us,getSound:Pa,getFont:xa,getBitmapFont:Aa,getSprite:wa,getShader:Sa,getAsset:vl,Asset:_e,SpriteData:Mt,SoundData:bn,width:Be,height:qe,center:$n,dt:Te,fixedDt:Ns,restDt:Ls,time:d.time,screenshot:d.screenshot,record:O,isFocused:N,setCursor:d.setCursor,getCursor:d.getCursor,setCursorLocked:d.setCursorLocked,isCursorLocked:d.isCursorLocked,setFullscreen:d.setFullscreen,isFullscreen:d.isFullscreen,isTouchscreen:d.isTouchscreen,onLoad:ci,onLoadError:xd,onLoading:wd,onResize:vd,onGamepadConnect:d.onGamepadConnect,onGamepadDisconnect:d.onGamepadDisconnect,onError:bd,onCleanup:ls,flash:Xa,setCamPos:Na,getCamPos:La,setCamRot:za,getCamRot:Ka,setCamScale:Ua,getCamScale:Ga,getCamTransform:Ad,camPos:Cd,camScale:Md,camFlash:Td,camRot:Ed,camTransform:Sd,shake:Pd,toScreen:Ks,toWorld:Wa,setGravity:Dd,getGravity:Bd,setGravityDirection:Hd,getGravityDirection:mn,setBackground:cl,getBackground:hl,getGamepads:d.getGamepads,getTreeRoot:zd,add:W,make:hi,destroy:Za,destroyAll:k,get:V,query:Y,readd:U,pos:_n,scale:kn,rotate:Au,color:Ba,opacity:Ha,anchor:Vs,area:du,sprite:Xs,text:Vd,polygon:td,rect:Ra,circle:Ql,uvquad:Qd,outline:_l,particles:ed,body:uu,platformEffector:mu,surfaceEffector:hu,areaEffector:pu,pointEffector:fu,buoyancyEffector:yu,constantForce:gu,doubleJump:cu,shader:nd,textInput:ou,timer:Ws,fixed:tr,stay:er,health:su,lifespan:iu,named:au,state:ru,z:Su,layer:vu,move:bu,offscreen:xu,follow:wu,fadeIn:Jl,mask:Zl,drawon:$l,raycast:qa,tile:_a,animate:nu,serializeAnimation:ka,agent:$d,sentry:_d,patrol:Zd,pathfinder:Jd,trigger:id,on:We,onFixedUpdate:ad,onUpdate:Fa,onDraw:rd,onAdd:Oa,onDestroy:od,onTag:ja,onUntag:ud,onUse:ld,onUnuse:dd,onClick:fd,onCollide:cd,onCollideUpdate:hd,onCollideEnd:pd,onHover:gd,onHoverUpdate:md,onHoverEnd:yd,onKeyDown:d.onKeyDown,onKeyPress:d.onKeyPress,onKeyPressRepeat:d.onKeyPressRepeat,onKeyRelease:d.onKeyRelease,onMouseDown:d.onMouseDown,onMousePress:d.onMousePress,onMouseRelease:d.onMouseRelease,onMouseMove:d.onMouseMove,onCharInput:d.onCharInput,onTouchStart:d.onTouchStart,onTouchMove:d.onTouchMove,onTouchEnd:d.onTouchEnd,onScroll:d.onScroll,onHide:d.onHide,onShow:d.onShow,onGamepadButtonDown:d.onGamepadButtonDown,onGamepadButtonPress:d.onGamepadButtonPress,onGamepadButtonRelease:d.onGamepadButtonRelease,onGamepadStick:d.onGamepadStick,onButtonPress:d.onButtonPress,onButtonDown:d.onButtonDown,onButtonRelease:d.onButtonRelease,mousePos:d.mousePos,mouseDeltaPos:d.mouseDeltaPos,isKeyDown:d.isKeyDown,isKeyPressed:d.isKeyPressed,isKeyPressedRepeat:d.isKeyPressedRepeat,isKeyReleased:d.isKeyReleased,isMouseDown:d.isMouseDown,isMousePressed:d.isMousePressed,isMouseReleased:d.isMouseReleased,isMouseMoved:d.isMouseMoved,isGamepadButtonPressed:d.isGamepadButtonPressed,isGamepadButtonDown:d.isGamepadButtonDown,isGamepadButtonReleased:d.isGamepadButtonReleased,getGamepadStick:d.getGamepadStick,isButtonPressed:d.isButtonPressed,isButtonDown:d.isButtonDown,isButtonReleased:d.isButtonReleased,setButton:d.setButton,getButton:d.getButton,pressButton:d.pressButton,releaseButton:d.releaseButton,getLastInputDeviceType:d.getLastInputDeviceType,charInputted:d.charInputted,loop:ne,wait:z,play:Od,setVolume:Va,getVolume:Qa,volume:jd,burp:Ya,audioCtx:w.ctx,Line:Xe,Rect:ge,Circle:Ke,Ellipse:wt,Point:Nr,Polygon:Ne,Vec2:B,Color:te,Mat4:ht,Quad:be,RNG:Xi,rand:Ee,randi:Wi,randSeed:br,vec2:T,rgb:ae,hsl2rgb:mr,quad:Se,choose:Sr,chooseMultiple:Ar,shuffle:Yi,chance:xr,lerp:ze,tween:_,easings:wn,map:dt,mapc:yr,wave:Ki,deg2rad:Pe,rad2deg:Rt,clamp:ct,evaluateQuadratic:Ur,evaluateQuadraticFirstDerivative:Gr,evaluateQuadraticSecondDerivative:zr,evaluateBezier:si,evaluateBezierFirstDerivative:Kr,evaluateBezierSecondDerivative:Xr,evaluateCatmullRom:Wr,evaluateCatmullRomFirstDerivative:Yr,curveLengthApproximation:na,normalizedCurve:Vr,hermite:Sn,cardinal:sa,catmullRom:Vn,bezier:Qr,kochanekBartels:$r,easingSteps:to,easingLinear:kr,easingCubicBezier:eo,testLineLine:Zs,testRectRect:Vi,testRectLine:_s,testRectPoint:es,testCirclePolygon:ns,testLinePoint:ks,testLineCircle:An,isConvex:oo,triangulate:aa,NavMesh:dl,drawSprite:Wl,drawText:Ri,formatText:Ot,drawRect:Je,drawLine:hn,drawLines:ui,drawTriangle:Ia,drawCircle:tn,drawEllipse:Ma,drawUVQuad:xn,drawPolygon:St,drawCurve:Ea,drawBezier:Nl,drawFormattedText:jt,drawMasked:Xl,drawSubtracted:Yl,pushTransform:Qe,popTransform:Ge,pushTranslate:xe,pushScale:vn,pushRotate:Zt,pushMatrix:pl,usePostEffect:H,makeCanvas:x,debug:b,scene:Kd,getSceneName:Yd,go:Xd,onSceneLeave:Wd,layers:Gd,getLayers:Ld,setLayers:Ja,getDefaultLayer:Ud,addLevel:sd,getData:E,setData:M,download:ai,downloadJSON:Po,downloadText:ha,downloadBlob:Pi,plug:D,ASCII_CHARS:ra,canvas:d.canvas,addKaboom:Nd,LEFT:B.LEFT,RIGHT:B.RIGHT,UP:B.UP,DOWN:B.DOWN,RED:te.RED,GREEN:te.GREEN,BLUE:te.BLUE,YELLOW:te.YELLOW,MAGENTA:te.MAGENTA,CYAN:te.CYAN,WHITE:te.WHITE,BLACK:te.BLACK,quit:ds,KEvent:Oe,KEventHandler:yn,KEventController:Lt,cancel:()=>la};y.k=st;let Mn=e.plugins;if(Mn&&Mn.forEach(D),e.global!==!1)for(let G in st)window[G]=st[G];return e.focus!==!1&&d.canvas.focus(),st},Tu=Eu;const Q=Tu({width:1280,height:720,letterbox:!0,global:!1});let vs=null;function yt(){function e(){let t=null,s=null,i=!1,n="english",a=30,r={},l=!1,o=null,d=[],h=!1,c=!1,u=!1,m=!1,f=!1,w=!1;return{setPreviousScene(p){t=p},getPreviousScene(){return t},setCurrentScene(p){s=p},getCurrentScene(){return s},setFreezePlayer(p){i=p},getFreezePlayer(){return i},setFontSize(p){a=p},getFontSize(){return a},setLanguage(p){n=p},getLanguage(){return n},setChestOpened(p){r[p]=!0},getChestOpened(p){return!!r[p]},getOpenedChests(){return r},setPrisonDoorOpened(p){l=p},getPrisonDoorOpened(){return l},setCurrentSong(p){o=p},getCurrentSong(){return o},pauseCurrentSong(){o&&(typeof o.pause=="function"?o.pause():typeof o.stop=="function"?o.stop():typeof o.volume=="number"&&(o.volume=0),o=null)},getDeadSlimes(){return d},addDeadSlime(p){d.includes(p)||d.push(p)},setHasDefeatedGhost(p){h=p},getHasDefeatedGhost(){return h},setPrisonerFreed(p){c=p},getPrisonerFreed(){return c},setIsFenceDoorOpened(p){u=p},getIsFenceDoorOpened(){return u},setTrollDinnerHad(p){m=p},getTrollDinnerHad(){return m},setPlantedBeans(p){f=p},getPlantedBeans(){return f},setWolfEncountered(p){w=p},getWolfEncountered(){return w}}}return{getInstance(){return vs||(vs=e()),vs}}}function Iu(){let e=null,t=!1;function s(){let i=[];return{setSlimeHealth(n,a){typeof a>"u"||(console.log("Setting slimeHealth",n,a,"before:",[...i]),i[n]=a,console.log("slimeHealth after:",[...i]))},getSlimeHealth(){return i},areBothSlimesDead(){return i.length>=2&&i[0]<=0&&i[1]<=0},isAnySlimeDead(){return i.some(n=>n<=0)},isAnySlimeAlive(){return i.some(n=>n>0)},isInitialized(){return t},setInitialized(n){t=n},resetSlimeHealth(n){t||(i=Array(n).fill(3),t=!0)},forceResetSlimeHealth(n){i=Array(n).fill(3),t=!0}}}return{getInstance(){return e||(e=s()),e}}}function Du(){let e=null;function t(){let s=0;return{setNbTimesTalkedOldman(i){s=i},getNbTimesTalkedOldman(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Bu(){let e=null;function t(){let s=0,i=!1,n=!1;return{setNbTimesTalkedLumberjack(a){s=a},getNbTimesTalkedLumberjack(){return s},getHasMentionedGift(){return i},setHasMentionedGift(a){i=a},getHasMentionedSlimesDefeated(){return n},setHasMentionedSlimesDefeated(a){n=a}}}return{getInstance(){return e||(e=t()),e}}}function Hu(){let e=null;function t(){let s=!1,i=3,n=i,a=!1,r=0,l=[],o=!1,d=!1,h=!1,c=!1,u=!1,m=!1;return{setIsSwordEquipped(f){s=f},getIsSwordEquipped(){return s},setMaxHealth(f){i=f,n>i&&(n=i)},getMaxHealth(){return i},setHealth(f){n=Math.max(0,Math.min(f,i))},getHealth(){return n},setHasKey(f){hasKey=f},getHasKey(){return hasKey},getMaxHealth(){return i},getPotions(){return r},addPotion(f=1){r+=f,f>0&&(o=!0)},usePotion(){return r>0?(r--,!0):!1},debug(){console.log(`Health: ${n}/${i}, Potions: ${r}`)},setHasHadPotion(f){o=f},getHasHadPotion(){return o},setHasBasementKey(f){a=f},getHasBasementKey(){return a},setKeys(f){l=f},getKeys(){return[...l]},addKey(f){l.includes(f)||l.push(f)},hasKey(f){return l.includes(f)},setHasPrisonKey(f){d=f},getHasPrisonKey(){return d},setHasCarrot(f){h=f},getHasCarrot(){return h},setHasMagicalBeans(f){c=f},getHasMagicalBeans(){return c},setHasTavernSupplies(f){u=f},getHasTavernSupplies(){return u},setHasCrown(f){m=f},getHasCrown(){return m}}}return{getInstance(){return e||(e=t()),e}}}function qu(){let e=null;function t(){let s=0;return{setNbOfTimesTalkedShopkeeper(i){s=i},getNbOfTimesTalkedShopkeeper(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Ru(){let e=null;function t(){let s=0;return{setNbTimesTalkedPrisoner(i){s=i},getNbTimesTalkedPrisoner(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Fu(){let e=null;function t(){let s=0;return{setNbOfTimesTalkedWizard(i){s=i},getNbOfTimesTalkedWizard(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Ou(){let e=null;function t(){let s=0;return{setNbTimesTalkedGuard(i){s=i},getNbTimesTalkedGuard(){return s}}}return{getInstance(){return e||(e=t()),e}}}function ju(){let e=null;function t(){let s=0;return{setNbTimesTalkedFarmer(i){s=i},getNbTimesTalkedFarmer(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Nu(){let e=null,t=!1,s=!1,i=!1,n=!1;function a(){let r=[];return{setChickenHealth(l,o){typeof o!="number"||isNaN(o)||(r[l]=o)},getChickenHealth(){return r},isAnyChickenHurt(){return this.getChickenHealth().some(d=>d>0&&d<2)},isAnyChickenDead(){return r.some(o=>o<=0)},isAnyChickenAlive(){return r.some(o=>o>0)},isInitialized(){return t},setInitialized(l){t=l},resetChickenHealth(l){r=Array(l).fill(2),t=!0},initIfNeeded(l){(!t||r.length===0)&&this.resetChickenHealth(l)},hasTriggeredHurtInteraction(){return s},setTriggeredHurtInteraction(l){s=l},hasTriggeredDeadInteraction(){return i},setTriggeredDeadInteraction(l){i=l},hasTriggeredOneDeadInteraction(){return n},setTriggeredOneDeadInteraction(l){n=l},isSomeButNotAllDead(){const l=this.getChickenHealth(),o=l.filter(h=>h===0).length,d=l.length;return o>0&&o<d}}}return{getInstance(){return e||(e=a()),e}}}function Lu(){let e=null;function t(){let s=0;return{setNbTimesTalkedBartender(i){s=i},getNbTimesTalkedBartender(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Uu(){let e=null;function t(){let s=0;return{setNbTimesTalkedFrog(i){s=i},getNbTimesTalkedFrog(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Gu(){let e=null;function t(){let s=0;return{setNbTimesTalkedHatguy(i){s=i},getNbTimesTalkedHatguy(){return s}}}return{getInstance(){return e||(e=t()),e}}}function zu(){let e=null;function t(){let s=!1,i=!1,n=0;return{setIsFollowingPlayer(a){s=a},getIsFollowingPlayer(){return s},setCowQuestComplete(a){i=a},getCowQuestComplete(){return i},setNbTimesTalkedCow(a){n=a},getNbTimesTalkedCow(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Ku(){let e=null;function t(){let s=0,i=0,n=0,a=0,r=0;return{setNbTimesTalkedGardenerHeight1(l){s=l},getNbTimesTalkedGardenerHeight1(){return s},setNbTimesTalkedGardenerHeight2(l){i=l},getNbTimesTalkedGardenerHeight2(){return i},setNbTimesTalkedGardenerHeight3(l){n=l},getNbTimesTalkedGardenerHeight3(){return n},setNbTimesTalkedGardenerHeight4(l){a=l},getNbTimesTalkedGardenerHeight4(){return a},setNbTimesTalkedGardenerHeight5(l){r=l},getNbTimesTalkedGardenerHeight5(){return r}}}return{getInstance(){return e||(e=t()),e}}}function Xu(){let e=null;function t(){let s=0;return{setBeanStalkHeight(i){s=i},getBeanStalkHeight(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Wu(){let e=null;function t(){let s=0;return{setNbTimesTalkedSwordsman(i){s=i},getNbTimesTalkedSwordsman(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Yu(){let e=null;function t(){let s=0;return{setNbTimesTalkedDrunkard(i){s=i},getNbTimesTalkedDrunkard(){return s}}}return{getInstance(){return e||(e=t()),e}}}const S=yt().getInstance(),De=Iu().getInstance(),qn=Du().getInstance(),rt=Bu().getInstance(),F=Hu().getInstance(),Rn=qu().getInstance(),Fn=Ru().getInstance(),On=Fu().getInstance(),bs=Ou().getInstance(),xs=ju().getInstance(),oe=Nu().getInstance(),As=Lu().getInstance(),ji=Uu().getInstance(),Ni=Gu().getInstance(),je=zu().getInstance(),ot=Ku().getInstance(),Fe=Xu().getInstance(),Ss=Wu().getInstance(),jn=Yu().getInstance();function Z(e){let t=Math.floor(F.getHealth()),s=!1,i=F.getPotions(),a=F.getKeys().length,r=F.getIsSwordEquipped(),l=F.getHasHadPotion();F.getBasementKey?F.getBasementKey():F.getHasBasementKey(),F.getCarrot?F.getCarrot():F.getHasCarrot(),F.getMagicalBeans?F.getMagicalBeans():F.getHasMagicalBeans(),F.getTavernSupplies?F.getTavernSupplies():F.getHasTavernSupplies(),F.getCrown?F.getCrown():F.getHasCrown();let o=0;const d=e.add([e.pos(20,20),e.fixed(),"heartsContainer"]);for(let c=0;c<t;c++)d.add([e.sprite("full-heart"),e.pos(o,0)]),o+=48;F.getHealth()-t===.5&&(s=!0,d.add([e.sprite("half-heart"),e.pos(o,0)]),o+=48);let h=F.getMaxHealth()-t-(s?1:0);for(let c=0;c<h;c++)d.add([e.sprite("empty-heart"),e.pos(o,0)]),o+=48;return r===!0&&d.add([e.sprite("sword-icon"),e.pos(0,48)]),l===!0&&(d.add([e.sprite("health-potion"),e.pos(o+24,0)]),d.add([e.text(`x${i}`,{font:"gameboy",size:24}),e.pos(o+76,16)]),o+=98),a>0&&(d.add([e.sprite("key"),e.pos(o+24,0)]),d.add([e.text(`x${a}`,{font:"gameboy",size:24}),e.pos(o+76,16)]),o+=98),d}function Vu(e){return F.getPotions()>0&&F.getHealth()<F.getMaxHealth()?(F.usePotion(),F.setHealth(Math.min(F.getHealth()+2,F.getMaxHealth())),!0):!1}function R(e,t){e.curAnim()!==t&&e.play(t)}function nr(e,t){for(const s of t)if(e.isKeyDown(s))return!0;return!1}function re(e,t,s,i){e.add([e.rect(e.width(),e.height()),e.color(t,s,i),e.fixed()])}async function le(e){return await(await fetch(e)).json()}const ut=[];function de(e,t,s,i,n,a,r=0){for(let o=0;o<s.height;o++)for(let d=0;d<s.width;d++){s.height-1-o;const c=s.data[o*s.width+d]&536870911;if(!c||c<0)continue;let u=null,m=null;for(const w of a)c>=w.firstgid&&(u=w,m=c-w.firstgid);if(!u||!u.name){console.warn("Tileset missing or has no name for tileIndex:",c,u);continue}if(m<0||u.tilecount&&m>=u.tilecount){console.warn(`Invalid localTileId: ${m} for tileset ${u.name} (tileIndex: ${c})`);continue}const f=u.tiles?.find(w=>w.id===m);if(f&&f.animation){const w=f.animation.map(P=>P.tileid+u.firstgid),p=f.animation.map(P=>P.duration);if(w.filter(P=>P>=u.firstgid&&(!u.tilecount||P<u.firstgid+u.tilecount)).length===0){console.warn(`No valid animation frames for tile ${m} in tileset ${u.name}`);continue}const x=t.add([e.sprite(u.name,{frame:f.animation[0].tileid}),e.pos(d*n,o*i),e.z(r),{animFrames:f.animation.map(P=>P.tileid),animDurations:p,animTime:0,animIndex:0,isAnimatedTile:!0}]);ut.push(x)}else t.add([e.sprite(u.name,{frame:m}),e.pos(d*n,o*i),e.z(r)])}}function sr(e,t,s,i,n){return[e.rect(t,s),e.pos(i.x,i.y+16),e.area(),e.body({isStatic:!0}),e.opacity(0),e.offscreen(),n]}function ue(e,t,s,i){for(const n of s.objects){const{x:a,y:r,width:l,height:o}=n;let d;n.gid?d=e.vec2(a,r):d=e.vec2(a,r-16),t.add(sr(e,l,o,d,n.name))}}async function ir(e,t,s,i){t.vel=e.vec2(s.x*i,s.y*i),await e.wait(.12),t.vel=e.vec2(0,0)}async function fi(e,t,s=1,i=.08){for(let n=0;n<s;n++)t.color=e.rgb(255,255,255),await e.wait(i),t.color=e.rgb(255,0,0),await e.wait(i*2);t.color=e.rgb(255,255,255)}async function Ie(e,t,s,i={}){t.onCollide("swordHitBox",async()=>{if(t.isAttacking||t.isDead)return;const n=s();let a=e.vec2(0,0);switch(n.direction){case"left":a=e.vec2(-1,0);break;case"right":a=e.vec2(1,0);break;case"up":a=e.vec2(0,-1);break;case"down":a=e.vec2(0,1);break}fi(e,t),ir(e,t,a,200),t.hurt(s.attackPower);const r=t.hp&&t.hp();if(i.onHurt&&await i.onHurt(t),i.preventDeath&&i.preventDeath(t)){t.hp&&t.hp()<1&&t.setHP&&t.setHP(1);return}if(r<=0){t.isDead=!0,t.stop&&t.stop(),e.play&&e.play("player-hurt",{volume:.7}),t.color&&(t.color=e.rgb(255,0,80),await new Promise(l=>setTimeout(l,80))),t.scale&&t.opacity?(e.tween(t.scale,.2,.3,l=>{t.scale=l}),e.tween(t.opacity,0,.3,l=>{t.opacity=l}),await new Promise(l=>setTimeout(l,300))):t.opacity&&(e.tween(t.opacity,0,.3,l=>{t.opacity=l}),await new Promise(l=>setTimeout(l,300))),e.destroy(t);return}})}function He(e,t){t.onCollide("player",async s=>{t.isDead||s.isAttacking||(F.setHealth(F.getHealth()-t.attackPower),e.destroyAll("healthContainer"),Z(e),e.play("player-hurt"),await fi(e,s),F.getHealth()<=0&&(F.setHealth(F.getMaxHealth()),e.go("world")))})}let Ps=!1;function ce(e){e.onKeyPress("p",()=>{Ps?(e.setVolume(.3),Ps=!1):(e.setVolume(0),Ps=!0)})}function et(e,t=null){e.onKeyPress("m",()=>{const s=typeof t=="function"?t():t;e.go("world-map",s)})}function he(e){e.onKeyPress("h",()=>{if(Vu())e.play&&e.play("drink",{volume:.8}),e.destroyAll("heartsContainer"),Z(e);else if(F.getHealth()===F.getMaxHealth()&&F.getHasHadPotion()===!0){const t=e.add([e.text("Health is already full!",{size:24,font:"gameboy"}),e.anchor("center"),e.pos(e.width()/2,e.height()/2-200),e.fixed(),"tempMessage"]);e.wait(1,()=>{e.destroy(t)})}else if(F.getPotions()===0&&F.getHasHadPotion()===!0){const t=e.add([e.text("You are out of potions!",{size:24,font:"gameboy"}),e.anchor("center"),e.pos(e.width()/2,e.height()/2-200),e.fixed(),"tempMessage"]);e.wait(1,()=>{e.destroy(t)})}})}function ar(e,t,s){s==="health-potion"&&(F.addPotion(1),F.setHasHadPotion(!0),e.destroyAll("heartsContainer"),Z(e)),s==="basement-key"&&(F.addKey("basement-key"),F.setHasBasementKey(!0)),s==="prison-key"&&(F.addKey("prison-key"),F.setHasPrisonKey(!0)),s==="tavern-supplies"&&(F.setHasTavernSupplies(!0),e.destroyAll("heartsContainer"),Z(e))}function os(e,t,s,i=16){let n=null;if(s.name==="prisoner"?n={"player-idle-down":"prisoner-idle-down","player-down":"prisoner-down","player-idle-side":"prisoner-idle-side","player-side":"prisoner-side","player-idle-up":"prisoner-idle-up","player-up":"prisoner-up"}:s.name==="cow"&&(n={"player-idle-down":"cow-idle-down","player-down":"cow-down","player-idle-side":"cow-idle-side","player-side":"cow-side","player-idle-up":"cow-idle-up","player-up":"cow-up"}),s.isFollowing)return;s.isFollowing=!0,s.startFollowing=!1;const a=["left","a","right","d","up","w","down","s"];e.onKeyPress(a,()=>{s.startFollowing=!0});let r=e.onUpdate(()=>{if(!s.exists()||!t.exists()||!s.startFollowing)return;if(s.name==="cow"&&(je.getCowQuestComplete()||!je.getIsFollowingPlayer())){s.isFollowing=!1,s.startFollowing=!1,s.use(e.body({isStatic:!0})),R(s,"cow-idle-down"),r&&r.cancel&&r.cancel();return}let l=e.vec2(0,0);switch(t.direction){case"left":l=e.vec2(i,0);break;case"right":l=e.vec2(-i,0);break;case"up":l=e.vec2(0,i);break;case"down":l=e.vec2(0,-i);break;default:l=e.vec2(0,i)}if(s.pos=s.pos.lerp(t.pos.add(l),.1),s.name==="cow"||s.name==="prisoner"?s.flipX=t.direction==="right":s.flipX=t.direction==="left",t.curAnim&&s.curAnim&&t.curAnim()&&n){const o=n[t.curAnim()];o&&s.curAnim()!==o&&s.play(o)}})}function _t(e,t){const s=e.getCamPos(),i=4,n=1280,a=720,r=n/i,l=a/i,o=s.x-r/2,d=s.x+r/2,h=s.y-l/2,c=s.y+l/2,u=t.worldPos?t.worldPos():t.pos,m=t.area?t.area:null;let f=u.x,w=u.x,p=u.y,g=u.y;return m&&m.shape&&m.shape.w&&m.shape.h&&(f=u.x,w=u.x+m.shape.w,p=u.y,g=u.y+m.shape.h),f<d&&w>o&&p<c&&g>h}async function gi(e,t="./assets/"){const s=[];for(const i of e)if(i.source&&i.source.trim()!==""){let n=i.source.replace(/\\/g,"/");n.endsWith(".tsx")&&(n=n.replace(".tsx",".tsj")),n=n.replace(/^(\.\.\/)+/,"");const r=await(await fetch(t+n)).json();s.push({...i,...r})}else s.push(i);return s}const J=(()=>{let e=null;return{set(t){e=t?t.clone():null},get(){return e?e.clone():null},clear(){e=null}}})(),Qu=Object.freeze(Object.defineProperty({__proto__:null,animatedTileSprites:ut,areAnyOfTheseKeysDown:nr,blinkEffect:fi,colorizeBackground:re,drawBoundaries:ue,drawTiles:de,fetchMapData:le,followPlayer:os,generateColliderBoxComponents:sr,giveItem:ar,isPartiallyOnScreen:_t,knockback:ir,lastPlayerPosManager:J,loadTilesets:gi,onAttacked:Ie,onCollideWithPlayer:He,openWorldMap:et,playAnimIfNotPlaying:R,registerHealthPotionHandler:he,registerMuteHandler:ce},Symbol.toStringTag,{value:"Module"}));function L(e,t){return[e.sprite("sprites",{anim:"player-idle-down"}),e.area({shape:new e.Rect(e.vec2(3,4),10,12)}),e.body(),e.pos(t),e.opacity(),e.color(),{speed:100,attackPower:1,direction:"down",isAttacking:!1,inventory:[]},"player"]}function pe(e,t){let s=null,i=null,n=null;e.onUpdate(()=>{if(!t||t.isAttacking)return;if(S.getFreezePlayer()){t.stop();return}const a=e.isKeyDown("left")||e.isKeyDown("a"),r=e.isKeyDown("right")||e.isKeyDown("d"),l=e.isKeyDown("up")||e.isKeyDown("w"),o=e.isKeyDown("down")||e.isKeyDown("s"),d=e.isKeyDown("e");let h=e.vec2(0,0),c=t.direction,u=d&&s&&i,m=t.speed;if(u&&(m=Math.max(40,t.speed*.5)),a?(h.x-=m,c="left",t.flipX=!0):r&&(h.x+=m,c="right",t.flipX=!1),l?(h.y-=m,c="up"):o&&(h.y+=m,c="down"),h.x!==0&&h.y!==0&&(h=h.scale(.7071)),d&&!s){const f=e.get("pullable");console.log("[DEBUG] Player pos:",t.pos),f.forEach(w=>{const p=w.pos.dist(t.pos);console.log("[DEBUG] Pullable pos:",w.pos,"Distance:",p,"AreaWidth:",w.areaWidth,"AreaHeight:",w.areaHeight,"Tags:",w.tags)});for(const w of f){if(w.tags&&w.tags.includes&&w.tags.includes("secret-passage")&&(console.log("[DEBUG] Secret passage isFreed:",w.isFreed),!w.isFreed))continue;const p=t.worldPos?t.worldPos():t.pos;let g;if(w.tags&&w.tags.includes&&w.tags.includes("secret-passage"))g=w.pos;else if(typeof w.worldPos=="function")g=w.worldPos();else if(w.pos&&typeof w.pos.dist=="function")g=w.pos;else if(w.pos)g=w.pos;else return;if(g.dist(p)<20){s=w,i=g.sub(p),n=c,console.log("Started pulling:",w);break}}}if(!d&&s){s=null,i=null;const f=e.get("pullable");console.log("Pulling candidates:",f.map(w=>({name:w.name||w.tags||w._tags,pos:w.pos,areaWidth:w.areaWidth,areaHeight:w.areaHeight,isStatic:w.isStatic,body:w.body,tags:w.tags||w._tags}))),n=null}if(u&&(h.x!==0||h.y!==0)){let f=!1;const w=s.area?.shape?.width||s.areaWidth||14,p=s.area?.shape?.height||s.areaHeight||14,g={x:s.pos.x+h.x,y:s.pos.y+h.y,w,h:p};for(const x of e.get("solid")){if(x===s||!x.areaWidth||!x.areaHeight)continue;const P={x:x.pos.x,y:x.pos.y,w:x.areaWidth,h:x.areaHeight};if(g.x<P.x+P.w&&g.x+g.w>P.x&&g.y<P.y+P.h&&g.y+g.h>P.y){f=!0;break}}f||s.move(h)}h.x!==0||h.y!==0?(u&&n?(console.log("Triggering pulling animation",n),n==="left"?(t.flipX=!0,R(t,"player-pulling-side")):n==="right"?(t.flipX=!1,R(t,"player-pulling-side")):n==="up"?R(t,"player-pulling-up"):n==="down"&&R(t,"player-pulling-down")):c==="left"?(t.flipX=!0,R(t,"player-side")):c==="right"?(t.flipX=!1,R(t,"player-side")):c==="up"?R(t,"player-up"):c==="down"&&R(t,"player-down"),t.move(h),t.direction=c):(u&&n?n==="left"?(t.flipX=!0,R(t,"player-pulling-side-idle")):n==="right"?(t.flipX=!1,R(t,"player-pulling-side-idle")):n==="up"?R(t,"player-pulling-up-idle"):n==="down"&&R(t,"player-pulling-down-idle"):t.direction==="left"?(t.flipX=!0,R(t,"player-idle-side")):t.direction==="right"?(t.flipX=!1,R(t,"player-idle-side")):t.direction==="up"?R(t,"player-idle-up"):t.direction==="down"&&R(t,"player-idle-down"),t.stop())}),e.onKeyDown(a=>{if(a==="shift"&&t&&!S.getFreezePlayer()&&F.getIsSwordEquipped()&&!t.isAttacking){t.isAttacking=!0,t.stop();for(let r=0;r<2;r++)e.wait(.08*r*2,()=>{t.opacity=.3}),e.wait(.2*(r*2+1),()=>{t.opacity=1});t.direction==="up"?R(t,"player-charge-up"):t.direction==="down"?R(t,"player-charge-down"):t.direction==="left"?(t.flipX=!0,R(t,"player-charge-right")):t.direction==="right"&&(t.flipX=!1,R(t,"player-charge-right")),e.wait(.35,()=>{if(e.get("swordHitBox").length===0){const r={left:t.worldPos().x-12,right:t.worldPos().x+12,up:t.worldPos().x,down:t.worldPos().x},l={left:t.worldPos().y,right:t.worldPos().y,up:t.worldPos().y-16,down:t.worldPos().y+16},o=e.add([e.area({shape:new e.Rect(e.vec2(0),14,14)}),e.pos(r[t.direction],l[t.direction]),"swordHitBox"]);let d=`slash-${t.direction}`;t.direction==="left"?d="slash-left":t.direction==="right"&&(d="slash-right");const h=e.add([e.sprite("sprites",{anim:d}),e.pos(r[t.direction],l[t.direction]),e.scale(1.5),e.z(100),"slashEffect"]);e.wait(9,()=>{e.destroyAll("swordHitBox"),e.destroy(h)});const c=16;let u=0,m=0;t.direction==="up"?m=-c:t.direction==="down"?m=c:t.direction==="left"?u=-c:t.direction==="right"&&(u=c);const f=32;let w=!1;for(let p=1;p<=f;p++)e.wait(.01*p,()=>{if(w)return;const g=t.pos.add(e.vec2(u/f,m/f)),x=t.areaWidth||14,P=t.areaHeight||14,H={x:g.x,y:g.y,w:x,h:P};let C=!1;for(const b of e.get("solid")){if(!b.areaWidth||!b.areaHeight)continue;const E=b.pos,M={x:E.x,y:E.y,w:b.areaWidth,h:b.areaHeight};if(H.x<M.x+M.w&&H.x+H.w>M.x&&H.y<M.y+M.h&&H.y+H.h>M.y){C=!0;break}}if(C){w=!0;return}t.pos=g;let A=e.vec2(0,0);t.direction==="up"?A=e.vec2(0,-16):t.direction==="down"?A=e.vec2(0,16):t.direction==="left"?A=e.vec2(-16,0):t.direction==="right"&&(A=e.vec2(16,0)),o&&(o.pos=t.worldPos().add(A)),h&&(h.pos=t.worldPos().add(A))});e.wait(.36,()=>{e.destroyAll("swordHitBox"),e.destroy(h),t.direction==="left"||t.direction==="right"?(R(t,"player-side"),t.stop()):(R(t,`player-${t.direction}`),t.stop()),t.isAttacking=!1})}e.play("sword-swing"),R(t,`player-attack-${t.direction}`)})}}),e.onKeyPress(a=>{if(a==="space"&&!S.getFreezePlayer()&&F.getIsSwordEquipped()&&!t.isAttacking){if(t.isAttacking=!0,t.stop(),e.get("swordHitBox").length===0){const r={left:t.worldPos().x-2,right:t.worldPos().x+10,up:t.worldPos().x+5,down:t.worldPos().x+2},l={left:t.worldPos().y+5,right:t.worldPos().y+5,up:t.worldPos().y,down:t.worldPos().y+10};e.add([e.area({shape:new e.Rect(e.vec2(0),10,10)}),e.pos(r[t.direction],l[t.direction]),"swordHitBox"]),e.wait(.1,()=>{e.destroyAll("swordHitBox")}),e.wait(.25,()=>{t.direction==="left"||t.direction==="right"?(R(t,"player-side"),t.stop()):(R(t,`player-${t.direction}`),t.stop()),t.isAttacking=!1})}e.play("sword-swing"),R(t,`player-attack-${t.direction}`)}}),e.onKeyRelease(()=>{t&&(t.isAttacking||nr(e,["left","a","right","d","up","w","down","s"])||(t.direction==="left"||t.direction==="right"?R(t,"player-idle-side"):t.direction==="up"?R(t,"player-idle-up"):t.direction==="down"&&R(t,"player-idle-down"),t.stop()))})}const Qs=["left","right","up","down"];function Tt(e,t){return[e.sprite("sprites",{anim:"slime-idle-down"}),e.area({shape:new e.Rect(e.vec2(1,5),14,12)}),e.body(),e.pos(t),e.offscreen(),e.opacity(),e.state("idle",["idle",...Qs]),e.health(3),{speed:30,attackPower:.5},"slime"]}function Gt(e,t){t.on("hurt",()=>{typeof t._slimeIndex=="number"&&typeof De<"u"&&De.setSlimeHealth(t._slimeIndex,t.health)}),t.on("death",()=>{typeof t._slimeIndex=="number"&&typeof De<"u"&&(De.setSlimeHealth(t._slimeIndex,0),window&&window.console&&console.log("SlimeState health after death:",De.getSlimeHealth()))}),e.onUpdate(()=>{if(!t.isFrozen&&!(t.health<=0)&&_t(e,t))switch(t.state){case"idle":t.move(0);break;case"left":t.move(-t.speed,0);break;case"right":t.move(t.speed,0);break;case"up":t.move(0,-t.speed);break;case"down":t.move(0,t.speed);break}}),t.on("death",()=>{const l=t._spawnKey,o=`${Math.floor(t.pos.x)},${Math.floor(t.pos.y)}`;window&&window.console&&console.log("Slime died at spawnKey:",l,"deathKey:",o),window.gameState&&window.gameState.addDeadSlime&&l&&window.gameState.addDeadSlime(l)});const s=t.onStateEnter("idle",async()=>{t.stop(),await e.wait(3),_t(e,t)?t.enterState(Qs[Math.floor(Math.random()*Qs.length)]):t.enterState("idle")}),i=t.onStateEnter("right",async()=>{t.flipX=!1,R(t,"slime-side");const l=e.rand(1,5);let o=0,d=!1;for(;o<l;){if(t.isFrozen)return;if(await e.wait(.1),o+=.1,t.getCollisions().length>0){d=!0;break}}if(d){t.enterState("left");return}t.enterState("idle")}),n=t.onStateEnter("left",async()=>{t.flipX=!0,R(t,"slime-side");const l=e.rand(1,5);let o=0,d=!1;for(;o<l;){if(t.isFrozen)return;if(await e.wait(.1),o+=.1,t.getCollisions().length>0){d=!0;break}}if(d){t.enterState("idle");return}t.enterState("idle")}),a=t.onStateEnter("up",async()=>{R(t,"slime-up");const l=e.rand(1,5);let o=0,d=!1;for(;o<l;){if(t.isFrozen)return;if(await e.wait(.1),o+=.1,t.getCollisions().length>0){d=!0;break}}if(d){t.enterState("idle");return}t.enterState("idle")}),r=t.onStateEnter("down",async()=>{R(t,"slime-down");const l=e.rand(1,5);let o=0,d=!1;for(;o<l;){if(t.isFrozen)return;if(await e.wait(.1),o+=.1,t.getCollisions().length>0){d=!0;break}}if(d){t.enterState("idle");return}t.enterState("idle")});e.onSceneLeave(()=>{s.cancel(),i.cancel(),n.cancel(),a.cancel(),r.cancel()})}async function $u(e,t,s,i=10,n){if(e.play("dialogue",{volume:1}),t.text="",i===0){t.text=s;return}let a;const r=new Promise(d=>{a=d}),o=setInterval(()=>{n.skip&&a()},5);for(let d=0;d<s.length;d++){if(n.skip){t.text=s,clearInterval(o);return}if(await Promise.race([new Promise(h=>setTimeout(h,i)),r]),n.skip){t.text=s,clearInterval(o);return}t.text+=s[d]}clearInterval(o)}async function K(e,t,s,i={}){S.setFreezePlayer(!0);const n=e.add([e.rect(800,200,{radius:24}),e.pos(t),e.color(255,255,255),e.opacity(.92),e.outline(4,e.rgb(27,29,52)),e.z(100),e.fixed(),{shadow:!0},...i.tag?[i.tag]:[]]);n.shadow&&n.use({draw(){e.drawRect({width:800,height:200,pos:e.vec2(8,8),color:e.rgb(0,0,0),opacity:.25,radius:24})}}),i.portrait&&(n.add([e.sprite(i.portrait),e.pos(24,24),e.scale(1),e.z(102)]),n.add([e.rect(128,128,{radius:16}),e.color(230,230,230),e.pos(24,24),e.z(101)]));const a=i.portrait?168:32,r=n.add([e.text("",{font:"gameboy",width:700-(i.portrait?136:0),lineSpacing:15,size:S.getFontSize()}),e.color(27,29,52),e.pos(a,32),e.fixed()]);let l=0;const o=i.speed??10;let d=!1,h=!1;const c={skip:!1};async function u(){c.skip=!1,h=!0,await $u(e,r,s[l],o,c),h=!1}return i.onLine&&i.onLine(l),new Promise(m=>{const f=e.onKeyDown(["space","enter"],async()=>{if(!d){if(d=!0,setTimeout(()=>{d=!1},150),h){c.skip=!0;return}if(l++,!s[l]){e.destroy(n),f.cancel(),i.keepFrozen||S.setFreezePlayer(!1),m();return}r.text="",i.onLine&&i.onLine(l),await u()}});u()})}const rr=Object.freeze(Object.defineProperty({__proto__:null,dialog:K},Symbol.toStringTag,{value:"Module"})),Ju=[["These slimes are a real nuisance.","I'm sure that wizard up north has something to do with this.","Be sure to check in on my wife. She mentioned something about a gift for you."],["Well I better get back to work..."],["These trees won't chop themselves!"],["Did you get that gift from my wife?"],["Why are you looking at me like that?"],["I can see you got that potion! I bet it will come in handy against those slimes."]],Zu=[["Þessir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram að vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],_u={english:Ju,icelandic:Zu};function ku(e,t){return[e.sprite("sprites",{anim:"lumberjack-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,13)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),e.opacity(),{speed:30},"lumberjack"]}async function ec(e,t,s){s.direction==="left"&&(t.flipX=!1,R(t,"lumberjack-idle-side")),s.direction==="right"&&(t.flipX=!0,R(t,"lumberjack-idle-side")),s.direction==="up"&&R(t,"lumberjack-idle-down"),s.direction==="down"&&R(t,"lumberjack-idle-up");const i=_u[S.getLanguage()];let n=rt.getHasMentionedSlimesDefeated(),a=rt.getNbTimesTalkedLumberjack(),r=!1;if(typeof De<"u"&&De.areBothSlimesDead&&De.areBothSlimesDead()===!0&&!n&&(r=!0,n=!0,rt.setHasMentionedSlimesDefeated(!0)),F.getHasHadPotion()&&!rt.getHasMentionedGift()){await K(e,e.vec2(250,500),i[5],{speed:10}),rt.setHasMentionedGift(!0);return}a>4&&(rt.setNbTimesTalkedLumberjack(1),a=rt.getNbTimesTalkedLumberjack());let l=a;if(rt.getHasMentionedGift()&&(a===2||a===0)&&(l=4,rt.setNbTimesTalkedLumberjack(4)),i[l]){let o=i[l];r&&(o=[...o,"Oh and by the way... You really cleaned up those slimes! You're a real natural.","Let me teach you a trick. You can perform a charge attack by pressing 'shift'."]),await K(e,e.vec2(250,500),o,{speed:10}),rt.setNbTimesTalkedLumberjack(a+1)}}function tt(e,t,s,i=!1){return[e.sprite("Sprite-0005",{anim:i?"chest-opened":"chest-closed"}),e.area({shape:new e.Rect(e.vec2(1,0),14,10)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"chest",{isOpen:i,contents:s}]}function tc(e){const t=`${Math.round(e.pos.x)},${Math.round(e.pos.y)}`;yt().getInstance().setChestOpened(t)}async function nt(e,t,s){t.isOpen||(e.play("chest-open"),t.isOpen=!0,t.use(e.sprite("Sprite-0005",{anim:"chest-opened"})),ar(e,s,t.contents),tc(t),e.get("heartsContainer").forEach(i=>i.destroy()),Z(e),t.contents==="tavern-supplies"?await K(e,e.vec2(250,500),["You found some tavern supplies!"]):await K(e,e.vec2(250,500),[`You found a ${t.contents.replace("-"," ")}`]))}const Cs=24,Ms=160;let Nn=null;function we(e){let t=!1;e.onKeyPress("i",()=>{t?(S.setFreezePlayer(!1),Nn&&e.destroy(Nn),Nn=null,t=!1):(S.setFreezePlayer(!0),Nn=sc(e),t=!0)})}function nc(e){switch(e){case"healthPotion":return"Restores your health. You can use them by pressing 'H'.";case"basement-key":return"It's a key to a basement.";case"prison-key":return"It's a key to a prison cell.";case"carrot":return"A crunchy carrot. Maybe someone would want this?";case"magicalBeans":return["The beans seem to shimmer with a faint light. You should find a way to plant them."];case"tavernSupplies":return"It's a barrel full of drinks. They were probably meant for a tavern.";case"crown":return"The princess's royal crown. Somebody must want this!";default:return e.endsWith("key")?"A mysterious key. It must open something!":"No info available."}}function sc(e){const t=F.getKeys(),s=[{key:"healthPotion",label:"Potion",sprite:"health-potion",has:F.getPotions()>0},...t.map(g=>({key:g,label:g.replace(/-/g," ").replace(/\b\w/g,x=>x.toUpperCase()),sprite:"key",has:!0})),{key:"carrot",label:"Carrot",sprite:"carrot",has:F.getHasCarrot()},{key:"magicalBeans",label:"Beans",sprite:"magical-beans",has:F.getHasMagicalBeans()},{key:"tavernSupplies",label:"Supplies",sprite:"tavern-supplies",has:F.getHasTavernSupplies()},{key:"crown",label:"Crown",sprite:"crown",has:F.getHasCrown()}].filter(g=>g.has);if(s.length===0){const P=e.add([e.pos(Cs,Ms),e.fixed(),"inventoryContainer",e.z(200),{opacity:0}]);P.add([e.rect(380,180,{radius:8}),e.color(27,29,52),e.opacity(.35),e.pos(6,6),e.z(198)]),P.add([e.rect(380,180,{radius:8}),e.color(27,29,52),e.opacity(.96),e.outline(6,e.rgb(255,255,255)),e.pos(0,0),e.z(199)]),P.add([e.text("INVENTORY",{font:"gameboy",size:28}),e.color(255,255,255),e.pos(380/6,16),e.z(201)]),P.add([e.text(`Your inventory
    is empty!`,{font:"gameboy",size:20}),e.color(180,180,180),e.pos(60,180/2),e.z(202)]);let H=0;const C=e.onUpdate(()=>{P.exists()&&H<1&&(H+=.1,P.opacity=Math.min(H,1))});return P.onDestroy(()=>C.cancel()),P}const i=380,n=72,a=Math.max(100,s.length*64+110),r=e.add([e.pos(Cs,Ms),e.fixed(),"inventoryContainer",e.z(200),{opacity:0}]);r.add([e.rect(i,a,{radius:8}),e.color(27,29,52),e.opacity(.35),e.pos(6,6),e.z(198)]),r.add([e.rect(i,a,{radius:8}),e.color(27,29,52),e.opacity(.96),e.outline(6,e.rgb(255,255,255)),e.pos(0,0),e.z(199)]),r.add([e.text("INVENTORY",{font:"gameboy",size:28}),e.color(255,255,255),e.pos(i/3-80,16),e.z(201)]),s.forEach((g,x)=>{r.add([e.sprite(g.sprite),e.pos(28,54+x*n),e.scale(1.3),e.z(203)]),r.add([e.text(g.label,{font:"gameboy",size:22}),e.color(255,255,255),e.pos(120,68+x*n),e.z(203)])});let l=0;const o=r.add([e.rect(i-24,70,{radius:8}),e.pos(12,48+l*n),e.color(255,255,255),e.opacity(.18),e.z(210),"inventoryHighlight"]);function d(){o.pos=e.vec2(12,48+l*n)}let h=null;async function c(){h&&(h(),h=null);const g=s[l].key;let x=nc(g);x||(x=[`Info about ${s[l].label}`]),typeof x=="string"&&(x=[x]);let P=!1;h=()=>{P||(P=!0,e.get("dialogBox").forEach(H=>e.destroy(H)))},await K(e,[Cs+420,Ms+320],x,{speed:0,tag:"dialogBox"}),P=!0,h=null,S.setFreezePlayer(!0)}const u=e.onKeyPress(["down","s"],()=>{l<s.length-1&&(l++,d(),h&&h())}),m=e.onKeyPress(["up","w"],()=>{l>0&&(l--,d(),h&&h())}),f=e.onKeyPress("e",async()=>{await c()});let w=0;const p=e.onUpdate(()=>{r.exists()&&w<1&&(w+=.1,r.opacity=Math.min(w,1))});return r.onDestroy(()=>{u.cancel(),m.cancel(),f.cancel(),p.cancel(),h&&h()}),r}async function ic(e){ut.length=0,ce(e),he(e);const t=S.getPreviousScene();console.log(t),re(e,8,148,236);const s=await le("./assets/maps/world.json"),i=await gi(s.tilesets,"./assets/"),n=e.add([e.pos(0,0)]),a={player:null,slimes:[],chests:[]},r=S.getDeadSlimes?S.getDeadSlimes():[];let l=0;!De.isInitialized()&&(!De.getSlimeHealth()||De.getSlimeHealth().length===0)&&De.resetSlimeHealth(2);const o=s.layers;for(const M of o){if(M.name==="Boundaries"){ue(e,n,M);continue}if(M.name==="SpawnPoints"){for(const D of M.objects){if(D.name==="chest"){const O=D.contents||D.properties?.find(k=>k.name==="contents")?.value||"health-potion",N=`${Math.round(D.x)},${Math.round(D.y)}`,W=S.getChestOpened(N),U=n.add(tt(e,e.vec2(D.x,D.y),O,W));a.chests.push(U)}if(D.name==="player-town-upper"&&!a.player&&t==="town-upper"){a.player=n.add(L(e,e.vec2(D.x,D.y)));continue}if(D.name==="player-town"&&!a.player&&t==="town"){a.player=n.add(L(e,e.vec2(D.x,D.y)));continue}if(D.name==="player-house"&&!a.player&&t==="house"){a.player=n.add(L(e,e.vec2(D.x,D.y)));continue}if(D.name==="player-shop"&&!a.player&&t==="shop"){a.player=n.add(L(e,e.vec2(D.x,D.y)));continue}if(D.name==="player-tower"&&!a.player&&t==="tower"){a.player=n.add(L(e,e.vec2(D.x,D.y)));continue}if(D.name==="player"&&!a.player&&!["town","town-upper","house","shop","tower"].includes(t)){a.player=n.add(L(e,e.vec2(D.x,D.y)));continue}if(D.name==="slime"){const O=`${Math.floor(D.x)},${Math.floor(D.y)}`;if(!r.includes(O)){const N=n.add(Tt(e,e.vec2(D.x,D.y)));N._spawnKey=O,l<2&&(N._slimeIndex=l,l++),a.slimes.push(N)}continue}if(D.name==="lumberjack"){a.lumberjack=n.add(ku(e,e.vec2(D.x,D.y)));continue}}continue}M.type==="tilelayer"&&de(e,n,M,s.tileheight,s.tilewidth,i)}a.player.onCollide("door-entrance",null),a.player.onCollide("shop-entrance",null),a.player.onCollide("tower-entrance",null),a.player.onCollide("chest",null),a.player.onCollide("lumberjack",null),a.player.onCollideEnd("lumberjack",null),a.player.onCollide("door-entrance",()=>{e.play("door-open"),e.go("house")}),a.player.onCollide("shop-entrance",()=>{e.play("door-open"),e.go("shop")}),a.player.onCollide("tower-entrance",()=>{e.play("door-open"),e.go("tower")}),a.player.onCollide("town-entrance",()=>{S.setPreviousScene("world"),e.go("town")}),a.player.onCollide("town-upper-entrance",()=>{S.setPreviousScene("world-upper"),e.go("town")}),a.player.onCollide("chest",M=>{nt(e,M,a.player)}),a.player.onCollide("lumberjack",()=>{ec(e,a.lumberjack,a.player)}),a.player.onCollideEnd("lumberjack",async()=>{await new Promise(M=>setTimeout(M,500)),R(a.lumberjack,"lumberjack-idle-down")});for(const M of a.slimes)Gt(e,M),Ie(e,M,()=>a.player),He(e,M),M.onDeath&&M.onDeath(()=>{const D=M.pos,O=`${Math.floor(D.x)},${Math.floor(D.y)}`;S.addDeadSlime&&S.addDeadSlime(O)});e.setCamScale(5),e.setCamPos(a.player.worldPos()),pe(e,a.player),Z(e),e.onUpdate(()=>{const M=e.getCamPos(),D=a.player.worldPos();a.player.pos.dist(M)>2&&e.tween(M,D,.15,O=>{e.setCamPos(O)},e.easings.linear)}),we(e);let d=0;const h=4,c=7;let u=0,m=[];for(const M of o)if(M.type==="objectgroup")for(const D of M.objects)(D.name==="big-tree"||D.type==="big-tree")&&m.push({x:D.x,y:D.y});const f=m.map(M=>n.add([e.sprite("big-tree",{frame:0}),e.pos(M.x,M.y),"animated-big-tree"]));e.onUpdate(()=>{u++,u>=c&&(d=(d+1)%h,u=0,f.forEach(M=>{M.frame=d}))});const w=[],p=10;let g=0,x=.2+Math.random()*1;function P(){const M=e.getCamPos(),O=(typeof e.getCamScale=="function"&&e.getCamScale()||{x:1}).x||1,N=e.width()/O,W=e.height()/O,U=M.x-N*.3+Math.random()*(N*2),k=M.y-W/2-16,V=200+Math.random()*100,z=(Math.random()-.5)*30,ne=8+Math.random()*16,Y=1+Math.random()*1.5,_=.5+Math.random()*.8,X=Math.random()<.5?e.scale(-_,_):e.scale(_,_),ke=n.add([e.sprite("leaf"),e.pos(U,k),X,{speedY:V,drift:z,swayAmplitude:ne,swaySpeed:Y,swayTime:Math.random()*Math.PI*2,baseX:U},{z:100}]);w.push(ke)}e.onUpdate(()=>{g+=e.dt(),w.length<p&&g>x&&(P(),g=0,x=.2+Math.random()*1);const M=e.getCamPos(),O=(typeof e.getCamScale=="function"&&e.getCamScale()||{x:1}).x||1,N=e.height()/O;for(let W=w.length-1;W>=0;W--){const U=w[W];U.move(U.drift*e.dt(),U.speedY*e.dt()),U.swayTime+=U.swaySpeed*e.dt(),U.pos.x=U.baseX+Math.sin(U.swayTime)*U.swayAmplitude,U.pos.y>M.y+N/2+8&&(U.destroy(),w.splice(W,1))}});const H=s.tilewidth,C=s.tileheight,A=new Map;function b(M){return JSON.stringify({frames:M.animFrames,durations:M.animDurations})}e.onUpdate(()=>{const M=e.getCamPos(),O=(typeof e.getCamScale=="function"&&e.getCamScale()||{x:1}).x||1,N=e.width()/O,W=e.height()/O,U=M.x-N/2,k=M.x+N/2,V=M.y-W/2,z=M.y+W/2;for(const ne of ut){const Y=b(ne);A.has(Y)||A.set(Y,{time:0,index:0})}for(const[ne,Y]of A.entries()){const _=ut.find(X=>b(X)===ne);if(!_)continue;Y.time+=e.dt()*1e3;let me=_.animDurations[Y.index];for(;Y.time>=me;)Y.time-=me,Y.index=(Y.index+1)%_.animFrames.length,me=_.animDurations[Y.index]}for(const ne of ut){const Y=ne.pos.x,_=ne.pos.y,me=Y,X=Y+H,ke=_,vt=_+C;if(me<k&&X>U&&ke<z&&vt>V){const Kt=b(ne),It=A.get(Kt);It&&(ne.frame=ne.animFrames[It.index])}}});const E=J.get();E&&(a.player.pos=E,J.clear(),e.setCamPos(a.player.worldPos())),a.player&&et(e,()=>(J.set(a.player.pos),S.setPreviousScene("world"),J.get()))}const ac=[["Where have you been?","Can you go take care of those slimes over by the bridge for me?",`Take this sword, 
press space to use it.`],["Press space to use your sword!"],["Well, what are you waiting for?","Take care of those slimes!"],["Did you defeat the slimes yet?","Slay them with your sword! Press space to use it."]],rc=[["Geturdu drepid thessa slimunga vid bruna fyrir mig?","Taktu thetta sverd, yttu a 'space' til ad nota thad."],["Yttu a 'space' til ad nota sverdid thitt!"],["Jaeja, eftir hverju ertu ad bida?","Sjadu um thessa slimunga!"],["Hefurdu drepid slimungana?","Dreptu tha med sverdinu thinu! Yttu a 'space' til ad nota thad."]],oc={english:ac,icelandic:rc};function lc(e,t){return[e.sprite("sprites",{anim:"oldman-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,23)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"oldman"]}async function dc(e,t,s){s.direction==="left"&&(t.flipX=!0,R(t,"oldman-idle-side")),s.direction==="right"&&(t.flipX=!1,R(t,"oldman-idle-side")),s.direction==="up"&&R(t,"oldman-idle-down"),s.direction==="down"&&R(t,"oldman-idle-up");const i=oc[S.getLanguage()];let n=qn.getNbTimesTalkedOldman();if(n>i.length-1&&(qn.setNbTimesTalkedOldman(1),n=qn.getNbTimesTalkedOldman()),i[n]){let a={};n===0&&(a.onLine=r=>{r===2&&e.play&&(e.play("item"),F.setIsSwordEquipped(!0),e.destroyAll("heartsContainer"),Z(e))}),await K(e,e.vec2(250,500),i[n],a),qn.setNbTimesTalkedOldman(n+1)}}async function uc(e){he(e),ce(e),re(e,27,29,52);const t=await le("./assets/maps/house.json"),s=e.add([e.pos(100,200)]),i={player:null,oldman:[]},n=t.layers;for(const a of n){if(a.name==="Boundaries"){ue(e,s,a);continue}if(a.name==="SpawnPoints")for(const r of a.objects){if(r.name==="player"){i.player=s.add(L(e,e.vec2(r.x,r.y)));continue}else if(r.name==="oldman"){i.oldman=s.add(lc(e,e.vec2(r.x,r.y)));continue}if(r.name==="door-entrance"){s.add(generateColliderBoxComponents(e,r.width,r.height,e.vec2(r.x,r.y),"door-entrance"));continue}}a.type==="tilelayer"&&de(e,s,a,t.tileheight,t.tilewidth,t.tilesets)}e.setCamScale(4),pe(e,i.player),i.player.onCollide("door-exit",()=>{S.setPreviousScene("house"),e.play("door-open"),e.go("world")}),i.player.onCollide("oldman",()=>{dc(e,i.oldman,i.player)}),i.player.onCollideEnd("oldman",async()=>{await new Promise(a=>setTimeout(a,500)),R(i.oldman,"oldman-idle-down")}),Z(e),we(e)}const cc=[["Good morning sugar. How's your uncle doing?",`Well anyway... 
I just got finished making these potions. Here, take one.`,"You can drink them by pressing 'H'. They'll heal any wounds you have."],["Did you see my husband outside?","I'm just so worried about him ever since these slimes showed up."]],hc=[["Godan daginn elskan. Hvernig hefur fraendi þinn þad?","Allavegana... Eg er nybuin að bua til þessi seyði. Herna, taktu eitt.","Þu getur drukkið það með þvi að smella a 'H'. Þeir graeda oll sarin þin."],["Sastu manninn minn fyrir utan?","Eg er svo ahyggjufull yfir honum siðan þessir slímungar komu fram."]],pc={english:cc,icelandic:hc};function fc(e,t){return[e.sprite("sprites",{anim:"shopkeeper-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,18)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"shopkeeper"]}async function Ln(e,t,s,i={}){if(i.overrideDialogue&&Array.isArray(i.overrideDialogue)){t.flipX=!0,R(t,"shopkeeper-idle-side"),await K(e,e.vec2(250,500),i.overrideDialogue),setTimeout(()=>{R(t,"shopkeeper-idle-down")},7e3);return}else s.direction==="left"&&(t.flipX=!1,R(t,"shopkeeper-idle-side")),s.direction==="right"&&(t.flipX=!0,R(t,"shopkeeper-idle-side")),s.direction==="up"&&R(t,"shopkeeper-idle-down"),s.direction==="down"&&R(t,"shopkeeper-idle-up");const n=pc[S.getLanguage()];let a=Rn.getNbOfTimesTalkedShopkeeper(),r={};a===0&&(r.onLine=o=>{o===1&&e.play&&(F.setHasHadPotion(!0),e.destroyAll("heartsContainer"),Z(e))}),a>n.length-1&&(Rn.setNbOfTimesTalkedShopkeeper(1),a=Rn.getNbOfTimesTalkedShopkeeper());let l=!1;a===0&&(F.addPotion(1),l=!0),n[a]&&(await K(e,e.vec2(250,500),n[a],r),Rn.setNbOfTimesTalkedShopkeeper(a+1),l&&(e.destroyAll("heartsContainer"),Z(e),e.play&&e.play("item")))}const gc=[["Please, you have to get me out of here!","I was collecting herbs for the wizard when that lumberjack attacked me.","The next thing I know, I'm locked up in here!"],["Please, you have to get me out of here!"],["I need you to find a way to free me."]],mc=[["Thank you for freeing me!","I don't think I would have survived much longer.","Could you help me get out of here?"]],yc=[["Gerdu þad, Þu verdur bjarga mer!","Eg var ad safna jurtum fyrir galdrakallinn þegar thessi skogarhogsmadur reðst a mig.","Naesta sem eg veit, þa er eg fastur herna!"],["Þu verdur ad koma mer hedan! Gerdu þad!"],["Þu þarft að finna leid til ad opna hurdina."]],wc=[["Takk fyrir ad bjarga mer!","Eg held ad eg hefdi ekki lifad þetta af mikid lengur.","Geturdu hjalpad mer að komast hedan ut?"]],vc={english:gc,icelandic:yc},bc={english:mc,icelandic:wc};function mi(e,t){return[e.sprite("sprites",{anim:"prisoner-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,50)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"prisoner",{name:"prisoner",hp(){return 1},hurt(){}}]}async function xc(e,t,s){if(s.direction==="left"&&(t.flipX=!0,R(t,"prisoner-idle-side")),s.direction==="right"&&(t.flipX=!1,R(t,"prisoner-idle-side")),s.direction==="up"&&R(t,"prisoner-idle-down"),s.direction==="down"&&R(t,"prisoner-idle-up"),S.getPrisonDoorOpened()){const a=bc[S.getLanguage()][0];await K(e,e.vec2(250,500),a),t.unuse("body"),os(e,s,t),e.onUpdate(()=>{if(t.isFollowing&&t.vel)if(t.vel.x===0&&t.vel.y===0)switch(s.direction){case"left":t.flipX=!0,t.play&&t.play("prisoner-idle-side");break;case"right":t.flipX=!1,t.play&&t.play("prisoner-idle-side");break;case"up":t.play&&t.play("prisoner-idle-down");break;case"down":t.play&&t.play("prisoner-idle-up");break}else switch(s.direction){case"left":t.flipX=!0,t.play&&t.play("prisoner-walk-side");break;case"right":t.flipX=!1,t.play&&t.play("prisoner-walk-side");break;case"up":t.play&&t.play("prisoner-walk-up");break;case"down":t.play&&t.play("prisoner-walk-down");break}});return}const i=vc[S.getLanguage()];let n=Fn.getNbTimesTalkedPrisoner();n>i.length-1&&(Fn.setNbTimesTalkedPrisoner(1),n=Fn.getNbTimesTalkedPrisoner()),i[n]&&(await K(e,e.vec2(250,500),i[n]),Fn.setNbTimesTalkedPrisoner(n+1))}async function Ac(e){he(e),ce(e);const t=S.getPreviousScene();console.log("Previous scene:",t),re(e,27,29,52);const s=await le("./assets/maps/shop.json"),i=e.add([e.pos(-240,-372)]),n={player:null,shopkeeper:null,prisoner:null},a=s.layers;for(const l of a){if(l.name==="Boundaries"){ue(e,i,l);continue}if(l.name==="SpawnPointsShop"){for(const o of l.objects)if(o.name==="player-shop"&&!n.player&&t==="basement"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}}if(l.name==="SpawnPointsShopSecondFloor"){for(const o of l.objects)if(o.name==="player-shop-second-floor"&&!n.player&&t==="shop-second-floor"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}}if(l.name==="SpawnPoints")for(const o of l.objects){if(o.name==="player"&&!n.player&&t!=="basement"&&t!=="shop-second-floor"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="shopkeeper"){n.shopkeeper=i.add(fc(e,e.vec2(o.x,o.y)));continue}if(o.name==="prisoner"){n.prisoner=i.add(mi(e,e.vec2(o.x,o.y)));continue}if(o.name==="basement-entrance"){i.add(L(e,o.width,o.height,e.vec2(o.x,o.y)));continue}}l.type==="tilelayer"&&de(e,i,l,s.tileheight,s.tilewidth,s.tilesets)}if(!n.player)return;e.setCamScale(5),e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{n.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),n.player.worldPos(),.15,l=>{e.setCamPos(l)},e.easings.linear)}),pe(e,n.player),n.prisoner&&n.player&&S.getPrisonDoorOpened()?(n.prisoner.use({opacity:1}),n.prisoner.unuse("body"),os(e,n.player,n.prisoner,20)):(n.prisoner.use({opacity:0}),n.prisoner.unuse("area")),n.player.onCollide("shop-exit",()=>{S.setPreviousScene("shop"),e.play("door-open"),e.go("world")}),n.player.onCollide("shop-second-floor",()=>{S.setPreviousScene("shop"),e.go("shop-second-floor")}),n.player.onCollide("shopkeeper",()=>{Ln(e,n.shopkeeper,n.player)});let r=0;n.player.onCollide("basement-entrance",()=>{F.hasKey("basement-key")?(S.setPreviousScene("shop"),e.go("basement")):(r=(r||0)+1,r===1?Ln(e,n.shopkeeper,n.player,{overrideDialogue:["What do you think you're doing?"]}):r===2?Ln(e,n.shopkeeper,n.player,{overrideDialogue:["Get away from there!"]}):r===3&&Ln(e,n.shopkeeper,n.player,{overrideDialogue:["You won't get down there without a key, honey."]}))}),Z(e),we(e)}async function Sc(e){he(e),ce(e);const t=S.getPreviousScene();re(e,27,29,52);const s=await le("./assets/maps/shop-second-floor.json"),i=e.add([e.pos(-240,-372)]),n={player:null},a=s.layers;for(const r of a){if(r.name==="Boundaries"){ue(e,i,r);continue}if(r.name==="SpawnPoints"){for(const l of r.objects)if(l.name==="player"&&!n.player&&t!=="basement"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}}r.type==="tilelayer"&&de(e,i,r,s.tileheight,s.tilewidth,s.tilesets)}e.setCamScale(5),e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{n.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),n.player.worldPos(),.15,r=>{e.setCamPos(r)},e.easings.linear)}),pe(e,n.player),n.player.onCollide("shop",()=>{S.setPreviousScene("shop-second-floor"),e.go("shop")}),Z(e),we(e)}function Pc(e,t,s,i=!1){return[e.sprite("sprites",{anim:i?"prison-door-opened":"prison-door-closed"}),e.area({shape:new e.Rect(e.vec2(1,0),14,10)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"prison-door",{isOpen:i}]}function Cc(e){const t=`${Math.round(e.pos.x)},${Math.round(e.pos.y)}`;yt().getInstance().setPrisonDoorOpened(t)}function Mc(e,t){return[e.sprite("shifting-walls",{anim:"wall-1"}),e.area({shape:new e.Rect(e.vec2(0,0),64,52)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"shifting-wall"]}function Ec(e,t,s=!1){const i=[e.sprite("sprites",{anim:"secret-passage"}),e.area({shape:new e.Rect(e.vec2(0,0),16,14)}),e.body({isStatic:!s}),e.pos(t),"secret-passage","solid"];return s&&i.push("pullable"),i}function Tc(e,t){return[e.area({shape:new e.Rect(e.vec2(0,0),16,16)}),e.pos(t),e.offscreen(),"transition"]}function Ic(e,t,s=!1){return[e.sprite("sprites",{anim:"pressure-plate-up"}),e.area({shape:new e.Rect(e.vec2(4,4),10,10)}),e.pos(t),e.offscreen(),"pressure-plate"]}function Dc(e,t){return[e.sprite("dungeonDoor",{anim:"dungeon-door-1"}),e.area({shape:new e.Rect(e.vec2(0,0),48,52)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"dungeon-door"]}function Bc(e,t){return[e.sprite("sprites",{anim:"ghost-down"}),e.area({shape:new e.Rect(e.vec2(2,4),12,12)}),e.body(),e.pos(t),e.health(6),e.opacity(),e.offscreen(),e.state("idle",["idle","right","backtrack","attack","evade"]),{isAttacking:!1,attackPower:.5,prevPos:e.vec2(0,0)},"ghost"]}function Hc(e,t,s){const i=e.onUpdate(()=>{s.pos.dist(t.pos)<30&&(t.enterState("backtrack"),i.cancel())});e.loop(5,()=>{t.prevPos=t.pos});const n=t.onStateEnter("backtrack",async()=>{await e.tween(t.pos.y,t.pos.y-40,.2,o=>t.pos.y=o,e.easings.linear),t.enterState("right")}),a=t.onStateEnter("right",async()=>{await e.tween(t.pos.x,t.pos.x+50,1,o=>t.pos.x=o,e.easings.linear),t.enterState("attack")}),r=t.onStateEnter("attack",async()=>{const o=[.5,.8,1];if(await e.tween(t.pos,s.pos,o[Math.floor(Math.random()*o.length)],d=>t.pos=d,e.easings.linear),t.getCollisions().length>0){t.enterState("evade");return}t.enterState("attack")}),l=t.onStateEnter("evade",async()=>{await e.tween(t.pos,t.prevPos,.8,o=>t.pos=o,e.easings.linear),t.enterState("attack")});e.onSceneLeave(()=>{n.cancel(),a.cancel(),r.cancel(),l.cancel(),i.cancel()})}function qc(e){S.setHasDefeatedGhost(!0)}function or(e,t){const s=Rc(e,t);return t.on("healthChange",i=>{s.setHealth(i)}),s}function Rc(e,t){const a=e.add([e.pos(e.width()/2-200,20),e.fixed(),"bossHealthBarContainer"]);a.add([e.rect(404,24),e.color(255,225,165),e.pos(-2,-2)]);const r=a.add([e.rect(400,20),e.color(181,84,123),e.pos(0,0)]),l=t.hp();function o(d){const h=Math.max(0,Math.min(d/l,1));r.width=400*h}return o(l),{setHealth:o,destroy(){a.destroy()}}}const lt=yt().getInstance();async function Fc(e){const t=e.assets&&e.assets.sprites&&e.assets.sprites.Everything;t&&t.frames&&console.log("[DEBUG] Everything sprite total frames:",t.frames.length),ut.length=0;const s=lt.getCurrentSong();if(!s||!s.name||s.name!=="basement-soundtrack"){lt.pauseCurrentSong();const p=e.play("basement-soundtrack",{loop:!0});p.name="basement-soundtrack",lt.setCurrentSong(p)}he(e),ce(e),lt.getPreviousScene(),re(e,27,29,52);const i=await le("./assets/maps/basement.json"),n=await gi(i.tilesets,"./assets/"),a=e.add([e.pos(-385,-690)]),r={player:null,chests:[],prisonDoor:null,secretPassage:null,pressurePlates:[],prisoner:null,dungeonDoor:null,shiftingWalls:null,ghost:null,pullables:[],spikes:[],spikeBoundaries:[]};for(const p of i.layers){if(p.type==="tilelayer"){const g=p.name==="Prison-Top"||p.name==="Wall-Top"?10:void 0;de(e,a,p,i.tileheight,i.tilewidth,n,g)}if(p.name==="Boundaries"&&ue(e,a,p),p.name==="SpikeBoundaries")for(const g of p.objects){let x=null;if(g.spikeId)x=g.spikeId;else if(g.properties){const H=g.properties.find(C=>C.name==="spikeId");H&&(x=H.value)}if(!x)continue;const P=a.add([e.rect(g.width,g.height),e.pos(g.x,g.y),e.area(),e.body({isStatic:!0}),e.opacity(0),"spike-boundary",{spikeId:x}]);P.spikeId=x,r.spikeBoundaries.push(P)}if(p.name==="SpawnPointsChest"){for(const g of p.objects)if(g.name==="chest"){const x=g.contents||g.properties?.find(A=>A.name==="contents")?.value||"health-potion",P=`${Math.round(g.x)},${Math.round(g.y)}`,H=lt.getChestOpened(P),C=a.add(tt(e,e.vec2(g.x,g.y),x,H));r.chests.push(C)}}if(p.name==="SpawnPoints"){for(const g of p.objects)if(!(!g||typeof g.x!="number"||typeof g.y!="number")){if(g.name==="player"){r.player=a.add([...L(e,e.vec2(g.x,g.y)),e.z(5)]);continue}if(g.name==="prisoner"){r.prisoner=a.add([...mi(e,e.vec2(g.x,g.y)),e.z(5)]);continue}if(g.name==="prison-door"){r.prisonDoor=a.add(Pc(e,e.vec2(g.x,g.y)));continue}if(g.name==="secret-passage"){const x=Ec(e,e.vec2(g.x,g.y),!1);r.secretPassage=a.add(x),x.unuse&&x.unuse("pullable");continue}if(g.name==="transition"){a.add(Tc(e,e.vec2(g.x,g.y)));continue}if(g.name==="pressure-plate"){const x=a.add(Ic(e,e.vec2(g.x,g.y)));let P=[];if(g.controls)Array.isArray(g.controls)?P=g.controls:typeof g.controls=="string"&&(P=g.controls.split(/[, ]+/).map(H=>H.trim()).filter(Boolean));else if(g.properties){const H=g.properties.find(C=>C.name==="controls");H&&(Array.isArray(H.value)?P=H.value:typeof H.value=="string"&&(P=H.value.split(/[, ]+/).map(C=>C.trim()).filter(Boolean)))}x.controls=P,r.pressurePlates.push(x);continue}if(g.name==="spikes"){const x=e.sprite("Everything",{frame:10660});let P=g.id||g.name;if(g.properties){const C=g.properties.find(A=>A.name==="type");C&&C.value&&(P=C.value)}console.log("[DEBUG] Creating spike:",{animation:"spikes-up",frame:10660,sprite:x,pos:{x:g.x,y:g.y},id:P});const H=a.add([x,e.pos(g.x,g.y),e.z(0),"spikes",{id:P}]);H.id=P,r.spikes.push(H);continue}if(g.name==="dungeon-door"){r.dungeonDoor=a.add(Dc(e,e.vec2(g.x,g.y)));continue}if(g.name==="shifting-walls"){r.shiftingWalls=a.add(Mc(e,e.vec2(g.x,g.y)));continue}if(g.name==="ghost"){r.ghost=a.add(Bc(e,e.vec2(g.x,g.y)));continue}g.name==="player-dungeon"&&r.player.onCollide("dungeon",()=>{r.player.pos.x=g.x,r.player.pos.y=g.y}),g.name==="player-dungeon-2"&&r.player.onCollide("dungeon-2",()=>{r.player.pos.x=g.x,r.player.pos.y=g.y,r.ghost&&!f&&(f=or(e,r.ghost))})}}}let l=!1,o=null;for(const p of i.layers){if(p.name==="SpawnPoints"){for(const g of p.objects)if(g.name==="player"){o={x:g.x,y:g.y};break}}if(o)break}r.player&&r.player.onCollide("dungeon",()=>{if(l)return;l=!0;const p="Everything",g=10665,x=r.player.worldPos();[{x:48,y:-32},{x:-16,y:-48},{x:-72,y:-48}].forEach(C=>{const A=e.add([e.sprite(p,{frame:g}),e.area({shape:new e.Rect(e.vec2(0,4),16,16)}),e.pos(x.x+C.x,x.y+C.y),e.body({isStatic:!1}),{areaWidth:16,areaHeight:16},"pullable","solid"]);r.pullables.push(A),A.onCollide("pressure-plate",b=>{b._colliderCount===void 0&&(b._colliderCount=0),b._colliderCount++,b.isDown||(b.isDown=!0,b.play("pressure-plate-down"),h(b,!0))}),A.onCollideEnd("pressure-plate",b=>{b._colliderCount===void 0&&(b._colliderCount=0),b._colliderCount=Math.max(0,b._colliderCount-1),b._colliderCount===0&&b.isDown&&(b.isDown=!1,b.play("pressure-plate-up"),h(b,!1))}),console.log("[DEBUG] Added pullable object:",{pos:A.pos,sprite:p,frame:g})});const H=e.get("pullable");console.log("[DEBUG] Pullables in basement:",H.map(C=>({name:C.name||C.tags||C._tags,pos:C.pos,areaWidth:C.areaWidth,areaHeight:C.areaHeight,isStatic:C.isStatic,body:C.body,tags:C.tags||C._tags})))});function d(){return r.pressurePlates.length>0&&r.pressurePlates.filter(p=>p.isDown).length===2}function h(p,g){if(!p.controls||p.controls.length===0){console.log("[DEBUG] setSpikesState: plate.controls is empty",p.controls);return}console.log("[DEBUG] setSpikesState: plate.controls",p.controls,"entities.spikes ids:",r.spikes.map(x=>x.id)),p.controls.forEach(x=>{const P=r.spikes.filter(C=>C.id===x);P.length===0?console.log("[DEBUG] setSpikesState: spike not found for id",x):P.forEach(C=>{console.log("[DEBUG] setSpikesState: found spike for id",x,"setting frame",g?10661:10660);const A=g?10661:10660;C.sprite&&typeof C.sprite=="object"?C.sprite.frame=A:C.use&&typeof C.use=="function"&&C.use(e.sprite("Everything",{frame:A}))}),r.spikeBoundaries.filter(C=>C.spikeId===x).forEach(C=>{g&&C.exists()&&C.destroy()})})}r.player.onCollide("pressure-plate",p=>{p._colliderCount===void 0&&(p._colliderCount=0),p._colliderCount++,console.log("[DEBUG] Player collided with pressure plate:",{controls:p.controls,isDown:p.isDown,colliderCount:p._colliderCount}),p.isDown||(p.isDown=!0,p.play("pressure-plate-down"),h(p,!0),d()&&u())}),r.secretPassage&&r.secretPassage.onCollide("pressure-plate",p=>{p._colliderCount===void 0&&(p._colliderCount=0),p._colliderCount++,p.isDown||(p.isDown=!0,p.play("pressure-plate-down"),d()&&u())}),r.player.onCollide("chest",p=>{nt(e,p,r.player)}),r.prisoner&&r.player.onCollide("prisoner",()=>{r.prisoner.isFollowing||xc(e,r.prisoner,r.player)}),r.player.onCollide("prison-door",()=>{if(F.getHasPrisonKey()&&r.prisonDoor&&!r.prisonDoor.isOpen){if(r.prisonDoor.isOpen=!0,e.play("door-open"),r.prisonDoor.play("prison-door-opened"),r.prisonDoor.unuse("body"),Cc(r.prisonDoor),r.prisoner.unuse("area"),r.prisoner.use(e.area({shape:new e.Rect(e.vec2(2,6),15,12)})),F.setHasPrisonKey(!1),F.getKeys&&F.setKeys){const g=F.getKeys(),x=g.indexOf("prison-key");x!==-1&&(g.splice(x,1),F.setKeys(g))}if(e.get("heartsContainer").forEach(g=>g.destroy()),Z(e),F.getKeys&&F.setKeys){const g=F.getKeys(),x=g.indexOf("prison-key");x!==-1&&(g.splice(x,1),F.setKeys(g))}r.secretPassage&&(r.secretPassage.unuse("body"),r.secretPassage.use(e.body({isStatic:!1})),r.secretPassage.use("pullable"),r.secretPassage.isFreed=!0,e.add([{get pos(){return r.secretPassage.pos},get areaWidth(){return r.secretPassage.areaWidth},get areaHeight(){return r.secretPassage.areaHeight},get isStatic(){return r.secretPassage.isStatic},get body(){return r.secretPassage.body},get name(){return"secret-passage"},get isFreed(){return r.secretPassage.isFreed},move:(...g)=>r.secretPassage.move&&r.secretPassage.move(...g)},"pullable","secret-passage"]))}});let c=!1;r.player.onCollide("transition",async()=>{if(c)return;lt.setFreezePlayer(!0);const p=r.player.pos.y,g=p-100,x=1;r.player.play("player-up"),await e.tween(p,g,x,P=>{r.player.pos.y=P},e.easings.linear),r.player.play("player-idle-up"),await e.tween(e.getCamPos(),r.player.worldPos(),.5,P=>{e.setCamPos(P)},e.easings.easeInOutSine),await e.wait(.3),c=!0,lt.setFreezePlayer(!1)}),r.player.onCollide("basement-exit",()=>{r.prisoner&&r.prisoner.isFollowing?K(e,e.vec2(250,500),["Wait! It's too dangerous.","That old woman is very powerful.","Do you see that cracked wall next to the chest?","We might be able to break through."]):(lt.setPreviousScene("basement"),e.go("shop"))}),r.player.onCollide("castle",()=>{lt.setPreviousScene("basement"),e.go("castle")}),e.setCamScale(4),e.onUpdate(()=>{if(c){const p=e.getCamPos(),g=r.player.worldPos(),x=p.lerp(g,.1);e.setCamPos(x)}}),pe(e,r.player),Z(e),we(e),r.player.onCollideEnd("pressure-plate",p=>{p._colliderCount===void 0&&(p._colliderCount=0),p._colliderCount=Math.max(0,p._colliderCount-1),p._colliderCount===0&&p.isDown&&(p.isDown=!1,p.play("pressure-plate-up"),h(p,!1))}),r.secretPassage&&r.secretPassage.onCollideEnd("pressure-plate",p=>{p._colliderCount===void 0&&(p._colliderCount=0),p._colliderCount=Math.max(0,p._colliderCount-1),p._colliderCount===0&&p.isDown&&(p.isDown=!1,p.play("pressure-plate-up"))});async function u(){r.dungeonDoor&&(await r.dungeonDoor.play("dungeon-door-2"),await e.wait(.5),await r.dungeonDoor.play("dungeon-door-3"),await e.wait(.5),await r.dungeonDoor.play("dungeon-door-4"),r.dungeonDoor.unuse("body"))}async function m(){r.shiftingWalls&&(await r.shiftingWalls.play("wall-2"),await e.wait(.5),await r.shiftingWalls.play("wall-3"),await e.wait(.5),await r.shiftingWalls.play("wall-4"),await e.wait(.5),await r.shiftingWalls.play("wall-5"),await e.wait(.5),await r.shiftingWalls.play("wall-6"),await e.wait(.5),await r.shiftingWalls.play("wall-7"),await e.wait(.5),r.shiftingWalls.unuse("body"))}let f=null;if(r.ghost&&(Hc(e,r.ghost,r.player),Ie(e,r.ghost,()=>r.player),He(e,r.ghost),r.ghost.on("hurt",()=>{r.ghost.trigger("healthChange",r.ghost.hp())}),r.ghost.on("heal",()=>{r.ghost.trigger("healthChange",r.ghost.hp())}),r.ghost.onDestroy(()=>{qc(),f&&f.destroy(),lt.getHasDefeatedGhost()===!0&&r.shiftingWalls&&m()})),!e._hasAnimatedTileUpdate){let g=function(x){return JSON.stringify({frames:x.animFrames,durations:x.animDurations})};var w=g;e._hasAnimatedTileUpdate=!0,i.tilewidth,i.tileheight;const p=new Map;e.onUpdate(()=>{const x=e.getCamPos(),H=(typeof e.getCamScale=="function"&&e.getCamScale()||{x:1}).x||1,C=e.width()/H,A=e.height()/H;x.x-C/2,x.x+C/2,x.y-A/2,x.y+A/2;for(const b of ut){const E=g(b);p.has(E)||p.set(E,{time:0,index:0})}for(const[b,E]of p.entries()){const M=ut.find(O=>g(O)===b);if(!M)continue;E.time+=e.dt()*1e3;let D=M.animDurations[E.index];for(;E.time>=D;)E.time-=D,E.index=(E.index+1)%M.animFrames.length,D=M.animDurations[E.index]}for(const b of ut){const E=g(b),M=p.get(E);M&&(b.frame=b.animFrames[M.index])}})}}const Oc=[[`What are you doing here? 
I don't like visitors`,`Well since you're here... 
I need some help.`,`My apprentice has gone missing. 
Can you help me find him?`,"The last time I saw him, he was heading south to the forest to gather herbs."],[`Have you found my apprentice? 
I haven't seen him for days.`],["The last time I saw him, he was heading south to the forest to gather herbs."],["Could you... leave me alone?"],["I'm a little busy here..."]],jc=[[`Hvað ertu að gera herna? 
Eg vil ekki gesti`,`Jaeja, fyrst þú ert herna... 
Eg þarf sma hjalp.`,`Laerlingurinn minn er horfinn. 
Geturðu hjalpad mer ad finna hann?`,"Seinast þegar eg sa hann, var hann að fara sudur i skoginn til ad safna jurtum."],[`Hefurðu fundið laerlinginn minn? 
Eg hef ekki sed hann i marga daga`],["Getur þu latið mig i fridi?"],["Eg er sma upptekin herna."]],Nc={english:Oc,icelandic:jc};function Lc(e,t){return[e.sprite("sprites",{anim:"wizard-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,18)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"wizard"]}async function Uc(e,t,s,i={}){if(i.overrideDialogue&&Array.isArray(i.overrideDialogue)){t.flipX=!0,R(t,"wizard-idle-side"),await K(e,e.vec2(250,500),i.overrideDialogue),setTimeout(()=>{R(t,"wizard-idle-down")},7e3);return}else s.direction==="left"&&(t.flipX=!1,R(t,"wizard-idle-side")),s.direction==="right"&&(t.flipX=!0,R(t,"wizard-idle-side")),s.direction==="up"&&R(t,"wizard-idle-up"),s.direction==="down"&&R(t,"wizard-idle-down");const n=Nc[S.getLanguage()];let a=On.getNbOfTimesTalkedWizard();a>n.length-1&&(On.setNbOfTimesTalkedWizard(1),a=On.getNbOfTimesTalkedWizard()),n[a]&&(await K(e,e.vec2(250,500),n[a]),On.setNbOfTimesTalkedWizard(a+1))}async function Gc(e){he(e),ce(e);const t=S.getPreviousScene();console.log("Previous scene:",t),re(e,27,29,52);const s=await le("./assets/maps/tower.json"),i=e.add([e.pos(-240,-372)]),n={player:null,wizard:[]},a=s.layers;for(const r of a){if(r.name==="Boundaries"){ue(e,i,r);continue}if(r.name==="SpawnPointsTowerSecondFloor"){for(const l of r.objects)if(l.name==="tower-second-floor"&&!n.player&&t==="tower-second-floor"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}}if(r.name==="SpawnPoints")for(const l of r.objects){if(l.name==="player"&&!n.player&&t!=="tower-second-floor"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}if(l.name==="wizard"){n.wizard=i.add(Lc(e,e.vec2(l.x,l.y)));continue}}r.type==="tilelayer"&&de(e,i,r,s.tileheight,s.tilewidth,s.tilesets)}n.player&&(e.setCamScale(5),e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{n.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),n.player.worldPos(),.15,r=>{e.setCamPos(r)},e.easings.linear)}),pe(e,n.player),n.player.onCollide("tower-exit",()=>{S.setPreviousScene("tower"),e.go("world")}),n.player.onCollide("tower-second-floor",()=>{S.setPreviousScene("tower"),e.go("tower-second-floor")}),n.player.onCollide("wizard",()=>{Uc(e,n.wizard,n.player)}),Z(e),we(e))}async function zc(e){he(e),ce(e);const t=S.getPreviousScene();re(e,27,29,52);const s=await le("./assets/maps/tower-second-floor.json"),i=e.add([e.pos(-240,-372)]),n={player:null},a=s.layers;for(const r of a){if(r.name==="Boundaries"){ue(e,i,r);continue}if(r.name==="SpawnPoints"){for(const l of r.objects)if(l.name==="player"&&!n.player&&t!=="basement"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}}r.type==="tilelayer"&&de(e,i,r,s.tileheight,s.tilewidth,s.tilesets)}e.setCamScale(5),e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{n.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),n.player.worldPos(),.15,r=>{e.setCamPos(r)},e.easings.linear)}),pe(e,n.player),n.player.onCollide("tower",()=>{S.setPreviousScene("tower-second-floor"),e.go("tower")}),Z(e),we(e)}const Kc=[["Ribbit... Ribbit..."],["..... Ribbit..."],["Ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit."],["Ribbit?"],["Ribbit... Ribbit..."],["R. I. B. B. I. T."],["Rib","bit."],["Ribbit?"],["tibbiR ... tibbiR ..."],["Ri Ri Ri Biii Biii Biii Tt Tt Tt"]],Xc=[["Þessir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram að vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],Wc={english:Kc,icelandic:Xc};function Yc(e,t){return[e.sprite("sprites",{anim:"frog-idle-down"}),e.pos(t.x,t.y),e.area({shape:new e.Rect(e.vec2(2,6),12,12)}),e.body({isStatic:!0}),"frog"]}async function Vc(e,t,s,i=0){const n=Wc[S.getLanguage()];let a=ji.getNbTimesTalkedFrog(),r=a;n[r]&&await K(e,e.vec2(250,500),[n[r]],{speed:10}),ji.setNbTimesTalkedFrog(a+1)}const Qc=[["Moo... Moo..."],["..... Moo..."],["Moo?"],["Moo... Moo..."],["Moo","moo."],["Moo?"],["Moo... Moo..."],["Moo","moo?","Moo moo!"],["Moo?"],["Moo ... Moo ..."],["Ribbi-... I mean Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo"]],$c=[["Þessir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram að vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],Jc={english:Qc,icelandic:$c};function Zc(e,t){return[e.sprite("cow",{anim:"cow-idle-up"}),e.area({shape:new e.Rect(e.vec2(8,12),16,16)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"cow",{name:"cow",hp(){return 1},hurt(){}}]}async function _c(e,t,s){if(s.direction==="left"&&(t.flipX=!0,R(t,"cow-idle-side")),s.direction==="right"&&(t.flipX=!1,R(t,"cow-idle-side")),s.direction==="up"&&R(t,"cow-idle-down"),s.direction==="down"&&R(t,"cow-idle-up"),je.getCowQuestComplete()===!0||F.getHasCarrot()===!1){const i=Jc[S.getLanguage()];let n=je.getNbTimesTalkedCow(),a=n;i[a]&&await K(e,e.vec2(250,500),[i[a]],{speed:10}),je.setNbTimesTalkedCow(n+1)}}let Li=!1;async function kc(e,t,s){t.unuse("body"),je.getCowQuestComplete()===!1?(Li||await K(e,e.vec2(250,500),["Moo?"],{speed:10}),Li=!0,os(e,s,t,20),je.setIsFollowingPlayer(!0)):(t.use(e.body({isStatic:!0})),R(t,"cow-idle-down"),je.setIsFollowingPlayer(!1))}const eh=[["This gosh darn fence keeps breaking!","Hey there!","My cow escaped again. Could you help me find her?","If you find her, please bring her back to me and I'll give you a reward.","Here, take this carrot. She loves carrots."],["If you find her she'll definitely come with you. She's very fond of carrots."],["Have you seen my cow?"],["I've got to fix this fence..."]],th=[["Þessir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram að vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],nh={english:eh,icelandic:th};function sh(e,t){return[e.sprite("Everything",{anim:"hatguy-idle-down"}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(3),e.offscreen(),"hatguy"]}async function ih(e,t,s,i=0){s.direction==="left"&&(t.flipX=!1,R(t,"hatguy-idle-side")),s.direction==="right"&&(t.flipX=!0,R(t,"hatguy-idle-side")),s.direction==="up"&&R(t,"hatguy-idle-down"),s.direction==="down"&&R(t,"hatguy-idle-up");let n=Ni.getNbTimesTalkedHatguy();const a=nh[S.getLanguage()];let r=a[n]||a[a.length-1];if(je.getIsFollowingPlayer()===!0&&je.getCowQuestComplete()===!1){await K(e,e.vec2(250,500),["You found her! Hooray! Thank you so much for bringing her back.","Here is a reward for your kindness. I don't have much, but please take this.","It's beans, they taste pretty bad but you might find them useful.","Oh and could I maybe... Get that carrot back?"],{speed:10}),F.setHasCarrot(!1),F.setHasMagicalBeans(!0),e.destroyAll("heartsContainer"),Z(e),e.play("item"),je.setCowQuestComplete(!0);return}if(je.getCowQuestComplete()===!0){await K(e,e.vec2(250,500),["Thank you again for bringing her back! You are a true hero."],{speed:10});return}let l={};n===0&&(l.onLine=o=>{o===4&&(F.setHasCarrot(!0),e.destroyAll("heartsContainer"),Z(e),e.play&&e.play("item"))}),r&&(await K(e,e.vec2(250,500),r,{speed:10,...l}),Ni.setNbTimesTalkedHatguy(n+1))}async function ah(e){ce(e),he(e);const t=S.getPreviousScene();re(e,8,148,236);const s=await le("./assets/maps/town.json"),i=e.add([e.pos(0,0)]),n={player:null,slimes:[],cow:null,frog:null,hatguy:null,fenceDoor:null},a=S.getDeadSlimes?S.getDeadSlimes():[];let r=0;!De.isInitialized()&&(!De.getSlimeHealth()||De.getSlimeHealth().length===0)&&De.resetSlimeHealth(2);const l=s.layers;for(const f of l){if(f.name==="Boundaries"){ue(e,i,f);continue}if(f.name==="SpawnPoints"){for(const w of f.objects){if(w.name==="player"&&!n.player&&t!=="village"&&t!=="world-upper"){n.player=i.add(L(e,e.vec2(w.x,w.y)));continue}if(w.name==="player-town-upper"&&!n.player&&t==="world-upper"){n.player=i.add(L(e,e.vec2(w.x,w.y)));continue}if(w.name==="player-village"&&!n.player&&t==="village"){n.player=i.add(L(e,e.vec2(w.x,w.y)));continue}if(w.name==="frog"){n.frog=i.add(Yc(e,e.vec2(w.x,w.y)));continue}if(w.name==="cow"&&!n.cow){n.cow=i.add(Zc(e,e.vec2(w.x,w.y)));continue}if(w.name==="hatguy"){n.hatguy=i.add(sh(e,e.vec2(w.x,w.y)));continue}if(w.name==="fence-door"){const g=S.getIsFenceDoorOpened()?"fence-door-opened":"fence-door-closed",x=i.add([e.sprite("fence-door",{anim:g}),e.pos(w.x,w.y),e.area(),e.body({isStatic:!0}),e.offscreen(),"fence-door"]);n.fenceDoor=x;continue}if(w.name==="slime"){const p=`${Math.floor(w.x)},${Math.floor(w.y)}`;if(window&&window.console&&console.log("Spawning slime at",p,"deadSlimes:",a),!a.includes(p)){const g=i.add(Tt(e,e.vec2(w.x,w.y)));g._spawnKey=p,r<2&&(g._slimeIndex=r,window&&window.console&&console.log("Assigned _slimeIndex",r,"to slime at",p),r++),n.slimes.push(g)}continue}}continue}f.type==="tilelayer"&&de(e,i,f,s.tileheight,s.tilewidth,s.tilesets)}n.player&&(n.player.onCollide("town-exit",()=>{S.setPreviousScene("town"),e.go("world")}),n.player.onCollide("town-upper-exit",()=>{S.setPreviousScene("town-upper"),e.go("world")}),n.player.onCollide("village-entrance",()=>{S.setPreviousScene("town"),e.go("village")}),n.player.onCollide("frog",()=>{Vc(e)}),n.player.onCollide("cow",()=>{je.getCowQuestComplete()===!1&&F.getHasCarrot()===!0?kc(e,n.cow,n.player):(je.getCowQuestComplete()===!0||F.getHasCarrot()===!1)&&_c(e,n.cow,n.player)}),n.player.onCollide("hatguy",()=>{ih(e,n.hatguy,n.player)}),n.fenceDoor&&n.player.onCollide("fence-door",()=>{S.getIsFenceDoorOpened()||(S.setIsFenceDoorOpened(!0),n.fenceDoor.play("fence-door-opened"),e.play("door-open"),n.fenceDoor.unuse("body"),e.wait(.5,()=>{n.fenceDoor.play("fence-door-closed"),n.fenceDoor.use("body"),S.setIsFenceDoorOpened(!1)}))}));for(const f of n.slimes)Gt(e,f),Ie(e,f,()=>n.player),He(e,f),f.onDeath&&f.onDeath(()=>{const w=f.pos,p=`${Math.floor(w.x)},${Math.floor(w.y)}`;S.addDeadSlime&&S.addDeadSlime(p)});e.setCamScale(5),e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{n.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),n.player.worldPos(),.15,f=>{e.setCamPos(f)},e.easings.linear)}),pe(e,n.player),Z(e);const o=[],d=10;let h=0,c=.2+Math.random()*1;function u(){const f=e.getCamPos(),p=(typeof e.getCamScale=="function"&&e.getCamScale()||{x:1}).x||1,g=e.width()/p,x=e.height()/p,P=f.x-g*.3+Math.random()*(g*2),H=f.y-x/2-16,C=200+Math.random()*100,A=(Math.random()-.5)*30,b=8+Math.random()*16,E=1+Math.random()*1.5,M=.5+Math.random()*.8,O=Math.random()<.5?e.scale(-M,M):e.scale(M,M),N=i.add([e.sprite("leaf"),e.pos(P,H),O,{speedY:C,drift:A,swayAmplitude:b,swaySpeed:E,swayTime:Math.random()*Math.PI*2,baseX:P},{z:100}]);o.push(N)}e.onUpdate(()=>{h+=e.dt(),o.length<d&&h>c&&(u(),h=0,c=.2+Math.random()*1);const f=e.getCamPos(),p=(typeof e.getCamScale=="function"&&e.getCamScale()||{x:1}).x||1,g=e.height()/p;for(let x=o.length-1;x>=0;x--){const P=o[x];P.move(P.drift*e.dt(),P.speedY*e.dt()),P.swayTime+=P.swaySpeed*e.dt(),P.pos.x=P.baseX+Math.sin(P.swayTime)*P.swayAmplitude,P.pos.y>f.y+g/2+8&&(P.destroy(),o.splice(x,1))}}),we(e);const m=J.get();m&&(n.player.pos=m,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("town"),J.get()))}const rh="modulepreload",oh=function(e){return"/zelda-game/"+e},Ui={},$s=function(t,s,i){let n=Promise.resolve();if(s&&s.length>0){let d=function(h){return Promise.all(h.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};var r=d;document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),o=l?.nonce||l?.getAttribute("nonce");n=d(s.map(h=>{if(h=oh(h),h in Ui)return;Ui[h]=!0;const c=h.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${u}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":rh,c||(m.as="script"),m.crossOrigin="",m.href=h,o&&m.setAttribute("nonce",o),document.head.appendChild(m),c)return new Promise((f,w)=>{m.addEventListener("load",f),m.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${h}`)))})}))}function a(l){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=l,window.dispatchEvent(o),!o.defaultPrevented)throw l}return n.then(l=>{for(const o of l||[])o.status==="rejected"&&a(o.reason);return t().catch(a)})},Js=["left","right"];yt().getInstance();function lh(e,t,s=2){return[e.sprite("Everything",{anim:"chicken-idle-side"}),e.area({shape:new e.Rect(e.vec2(1,5),14,12)}),e.body(),e.pos(t),e.offscreen(),e.opacity(),e.state("idle",["idle",...Js]),e.health(s),{speed:30,attackPower:.5},"chicken"]}function dh(e,t,s){t.on("hurt",()=>{console.log(`[ChickenAI] Chicken ${s} hurt event: hp=${t.hp&&t.hp()}`)}),t.on("death",()=>{console.log(`[ChickenAI] Chicken ${s} death event: hp=${t.hp&&t.hp()}`)}),e.onUpdate(()=>{if(t.health<=0){t._deathEmitted||(t._deathEmitted=!0,t.trigger("death"));return}if(_t(e,t))switch(t.state){case"idle":t.move(0);break;case"left":t.move(-t.speed,0);break;case"right":t.move(t.speed,0);break}});const i=t.onStateEnter("idle",async()=>{t.stop(),await e.wait(3),_t(e,t)?t.enterState(Js[Math.floor(Math.random()*Js.length)]):t.enterState("idle")}),n=t.onStateEnter("right",async()=>{t.flipX=!0,R(t,"chicken-side");let r=0,l=!1;for(;r<2;)if(await e.wait(.1),r+=.1,t.getCollisions().length>0){l=!0;break}if(l){t.enterState("left");return}t.enterState("idle")}),a=t.onStateEnter("left",async()=>{t.flipX=!1,R(t,"chicken-side");let r=0,l=!1;for(;r<3;)if(await e.wait(.1),r+=.1,t.getCollisions().length>0){l=!0;break}if(l){t.enterState("idle");return}t.enterState("idle")});t.on("hurt",()=>{const r=t.hp&&t.hp();typeof r=="number"&&!isNaN(r)&&(console.log(`[ChickenAI] setChickenHealth called for index=${s}, hp=${r}`),oe.setChickenHealth(s,r))}),t.on("death",()=>{oe.setChickenHealth(s,0)}),e.onSceneLeave(()=>{i.cancel(),n.cancel(),a.cancel()})}async function uh(e){const t=S.getCurrentSong();if(!t||!t.name||t.name!=="castle-soundtrack"){S.pauseCurrentSong();const o=e.play("castle-soundtrack",{loop:!0});o.name="castle-soundtrack",S.setCurrentSong(o)}const s=S.getPreviousScene();console.log("previousScene:",s),he(e),ce(e),re(e,8,148,236);const i=await le("./assets/maps/castle.json"),n=e.add([e.pos(100,100)]),a={player:null,chicken:[],chests:[],prisoner:null},r=i.layers;for(const o of r){if(o.name==="Boundaries"){ue(e,n,o);continue}if(o.name==="SpawnPoints"){const d=o.objects.filter(c=>c.name==="chicken").slice(0,3);!oe.isInitialized()&&oe.getChickenHealth().length===0&&oe.initIfNeeded(d.length);const h=oe.getChickenHealth();for(let c=0;c<d.length&&!(c>=h.length);c++){const u=h[c];if(u===0){a.chicken.push(null);continue}const m=d[c],f=n.add(lh(e,e.vec2(m.x,m.y),u));a.chicken.push(f)}for(const c of o.objects){if(c.name==="prisoner"&&!a.prisoner&&S.getPrisonDoorOpened()&&!S.getPrisonerFreed()){a.prisoner=n.add(mi(e,e.vec2(c.x,c.y)));continue}if(a.prisoner&&a.player&&S.getPrisonDoorOpened()&&(a.prisoner.unuse("body"),e.wait(.1,()=>{$s(async()=>{const{followPlayer:u}=await Promise.resolve().then(()=>Qu);return{followPlayer:u}},void 0).then(({followPlayer:u})=>{u(e,a.player,a.prisoner)})})),c.name==="player-barn"&&!a.player&&s==="barn"){a.player=n.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="player-barn-side"&&!a.player&&s==="barn-side"){a.player=n.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="player-tavern"&&!a.player&&s==="tavern"){a.player=n.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="player-forest"&&!a.player&&s==="forest"){a.player=n.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="player-castle-main"&&!a.player&&s==="castle-main"){a.player=n.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="player-forest-east"&&!a.player&&s==="forest-east"){a.player=n.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="player"&&!a.player&&s!=="barn"&&s!=="barn-side"&&s!=="tavern"&&s!=="forest"&&s!=="castle-main"&&s!=="forest-east"){a.player=n.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="chest"){const u=c.contents||c.properties?.find(p=>p.name==="contents")?.value||"health-potion",m=`${Math.round(c.x)},${Math.round(c.y)}`,f=S.getChestOpened(m),w=n.add(tt(e,e.vec2(c.x,c.y),u,f));a.chests.push(w)}}}o.type==="tilelayer"&&de(e,n,o,i.tileheight,i.tilewidth,i.tilesets)}for(let o=0;o<a.chicken.length;o++)a.chicken[o]&&(dh(e,a.chicken[o],o),Ie(e,a.chicken[o],()=>a.player));if(a.player.onCollide("barn-entrance",()=>{e.play("door-open"),e.go("barn")}),a.player.onCollide("barn-side-entrance",()=>{e.play("door-open"),e.go("barn")}),a.player.onCollide("castle-main-entrance",()=>{e.go("castle-main")}),a.player.onCollide("tavern-entrance",()=>{e.play("door-open"),e.go("tavern")}),a.player.onCollide("forest-entrance",()=>{e.go("forest")}),a.player.onCollide("forest-east-entrance",()=>{e.go("forest-east")}),a.player.onCollide("chest",o=>{nt(e,o,a.player)}),e.setCamScale(4),e.setCamPos(a.player.worldPos()),e.onUpdate(()=>{a.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),a.player.worldPos(),.15,o=>{e.setCamPos(o)},e.easings.linear)}),pe(e,a.player),Z(e),e.add([e.text(`FPS: ${(1/e.dt()).toFixed(1)}`,{size:16,font:"gameboy"}),e.pos(12,12),e.fixed(),{layer:"ui"},{update(){this.text=`FPS: ${(1/e.dt()).toFixed(1)}`}}]),console.log("Prisoner Freed:",S.getPrisonerFreed()),S.getPrisonerFreed()===!1){const o=e.vec2(436,614);let d=!1,h=S.getFreezePlayer();e.onUpdate(()=>{s==="basement"&&(!a.prisoner.exists()||!a.player.exists()||d||a.player.pos.dist(o)<32&&(d=!0,(async()=>{const{dialog:c}=await $s(async()=>{const{dialog:p}=await Promise.resolve().then(()=>rr);return{dialog:p}},void 0),u=[["Thank you! You saved my life. I'm forever in your debt."],["I'll make sure you get rewarded for your help. I will see you later."]];await c(e,e.vec2(250,500),u);const m=a.prisoner.pos,f=e.vec2(m.x+a.prisoner.width+75,m.y+a.prisoner.height+70),w=e.add([e.sprite("smoke",{anim:"smoke"}),e.pos(f.x,f.y),e.z(100)]);await new Promise(p=>e.wait(.2,p)),a.prisoner.destroy(),await new Promise(p=>e.wait(.5,p)),w.destroy(),S.setFreezePlayer(h),S.setPrisonerFreed(!0)})()))})}const l=J.get();l&&(a.player.pos=l,J.clear(),e.setCamPos(a.player.worldPos())),a.player&&et(e,()=>(J.set(a.player.pos),S.setPreviousScene("castle"),J.get()))}const ch=[["Stop right there!","What business do you have here?","We don't just let anyone through pal."],["Get lost!"],["Get out of my face buddy!"]],hh=[["Þessir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram að vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],ph={english:ch,icelandic:hh};function $t(e,t,s,i="guard-1"){return[e.sprite("sprites",{anim:s}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(3),e.offscreen(),i]}async function Jt(e,t,s,i=0){const n=ph[S.getLanguage()][i];let a=bs.getNbTimesTalkedGuard();a>=n.length&&(a=n.length-1,bs.setNbTimesTalkedGuard(a)),n[a]&&(await K(e,e.vec2(250,500),n,{speed:10}),bs.setNbTimesTalkedGuard(a+1))}async function fh(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/castle-main.json"),i=e.add([e.pos(100,100)]),n={player:null,chests:[],guards:[]},a=s.layers;console.log("Map layers:",a);for(const l of a){if(l.name==="Boundaries"){ue(e,i,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="player"&&!n.player&&t!=="throne-room"&&t!=="castle-main-underground"&&t!=="castle-main-well"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="chest"){const d=o.contents||o.properties?.find(m=>m.name==="contents")?.value||"health-potion",h=`${Math.round(o.x)},${Math.round(o.y)}`,c=S.getChestOpened(h),u=i.add(tt(e,e.vec2(o.x,o.y),d,c));n.chests.push(u)}if(o.name==="player-throne-room"&&!n.player&&t==="throne-room"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-castle-main-underground"&&!n.player&&t==="castle-main-underground"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-castle-well"&&!n.player&&t==="castle-main-well"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="guard-1"){n.guards.push(i.add($t(e,e.vec2(o.x,o.y),"guard-1-idle-down")));continue}if(o.name==="guard-2"){n.guards.push(i.add($t(e,e.vec2(o.x,o.y),"guard-2-idle-down")));continue}if(o.name==="guard-3"){const d=i.add($t(e,e.vec2(o.x,o.y),"guard-3-down","guard-3"));n.guards.push(d);const h=o.y,c=h-300;let u=-1,m="guard-3-down";e.loop(.3,()=>{e.wait(Math.random(.5,1.5)),_t(e,d)&&(d.pos.y<=c&&(u=1,m!=="guard-3-down"&&(d.play("guard-3-down"),m="guard-3-down")),d.pos.y>=h&&(u=-1,m!=="guard-3-up"&&(d.play("guard-3-up"),m="guard-3-up")),d.move(0,40*u))})}}continue}l.type==="tilelayer"&&de(e,i,l,s.tileheight,s.tilewidth,s.tilesets)}n.player&&(n.player.onCollide("guard-1",l=>{Jt(e,l,n.player,0)}),n.player.onCollide("guard-2",l=>{Jt(e,l,n.player,1)}),n.player.onCollide("guard-3",l=>{Jt(e,l,n.player,2)}),n.player.onCollide("castle-main-exit",()=>{S.setPreviousScene("castle-main"),e.go("castle")}),n.player.onCollide("throne-room-entrance",()=>{e.go("throne-room")}),n.player.onCollide("castle-main-underground-entrance",()=>{S.setPreviousScene("castle-main"),e.go("castle-main-underground")}),n.player.onCollide("castle-well-exit",()=>{S.setPreviousScene("castle-main-well"),e.go("castle-main-underground")})),e.setCamScale(3),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const l=n.player.worldPos(),o=e.getCamPos();l&&o&&l.dist(o)>1&&e.tween(o,l,.15,d=>{e.setCamPos(d)},e.easings.linear)}}),pe(e,n.player),Z(e),e.add([e.text(`FPS: ${Math.round(1/e.dt())}`,{size:16,font:"gameboy"}),e.pos(12,12),e.fixed(),{layer:"ui"},{update(){this.text=`FPS: ${Math.round(1/e.dt())}`}}]),we(e);const r=J.get();r&&(n.player.pos=r,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("castle-main"),J.get()))}async function gh(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,27,29,52);const s=await le("./assets/maps/castle-main-underground.json"),i=e.add([e.pos(100,100)]),n={player:null,chests:[]},a=s.layers;for(const r of a){if(r.name==="Boundaries"){ue(e,i,r);continue}if(r.name==="SpawnPoints"){for(const l of r.objects){if(l.name==="player"&&t!=="castle-main-well"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-castle-well"&&!n.player&&t==="castle-main-well"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}if(l.name==="chest"){const o=l.contents||l.properties?.find(u=>u.name==="contents")?.value||"health-potion",d=`${Math.round(l.x)},${Math.round(l.y)}`,h=S.getChestOpened(d),c=i.add(tt(e,e.vec2(l.x,l.y),o,h));n.chests.push(c)}}continue}r.type==="tilelayer"&&de(e,i,r,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("castle-main-underground-exit",()=>{S.setPreviousScene("castle-main-underground"),e.go("castle-main")}),n.player.onCollide("castle-well-entrance",()=>{S.setPreviousScene("castle-main-well"),e.go("castle-main")}),n.player.onCollide("chest",r=>{nt(e,r,n.player)}),e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const r=n.player.worldPos(),l=e.getCamPos();r&&l&&r.dist(l)>1&&e.tween(l,r,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e)}function mh(e,t,s="king-idle-down",i="king"){return[e.sprite("sprites",{anim:s}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(5),e.offscreen(),i]}async function yh(e){he(e),ce(e),re(e,27,29,52);const t=await le("./assets/maps/throne-room.json"),s=e.add([e.pos(100,100)]),i={player:null,king:null,slimes:[],guards:[]},n=t.layers;console.log("Map layers:",n);for(const a of n){if(a.name==="Boundaries"){ue(e,s,a);continue}if(a.name==="SpawnPoints"){for(const r of a.objects){if(r.name==="player"&&!i.player){i.player=s.add(L(e,e.vec2(r.x,r.y)));continue}if(r.name==="slime"){i.slimes.push(s.add(Tt(e,e.vec2(r.x,r.y))));continue}if(r.name==="guard-1"){i.guards.push(s.add($t(e,e.vec2(r.x,r.y),"guard-1-idle-down")));continue}if(r.name==="guard-2"){i.guards.push(s.add($t(e,e.vec2(r.x,r.y),"guard-2-idle-down")));continue}if(r.name==="guard-3"){const l=s.add($t(e,e.vec2(r.x,r.y),"guard-3-down","guard-3"));i.guards.push(l);const o=r.y,d=o-300;let h=-1,c="guard-3-down";e.loop(.3,()=>{e.wait(Math.random(.5,1.5)),l.pos.y<=d&&(h=1,c!=="guard-3-down"&&(l.play("guard-3-down"),c="guard-3-down")),l.pos.y>=o&&(h=-1,c!=="guard-3-up"&&(l.play("guard-3-up"),c="guard-3-up")),l.move(0,40*h)})}r.name==="king"&&(i.king=s.add(mh(e,e.vec2(r.x,r.y),"king-sitting-down","king")))}continue}a.type==="tilelayer"&&de(e,s,a,t.tileheight,t.tilewidth,t.tilesets)}i.player.onCollide("guard-1",a=>{Jt(e,a,i.player,0)}),i.player.onCollide("guard-2",a=>{Jt(e,a,i.player,1)}),i.player.onCollide("guard-3",a=>{Jt(e,a,i.player,2)}),i.player.onCollide("throne-room-exit",()=>{S.setPreviousScene("throne-room"),e.go("castle-main")}),e.setCamScale(4),i.player&&typeof i.player.worldPos=="function"&&e.setCamPos(i.player.worldPos()),e.onUpdate(()=>{if(i.player&&typeof i.player.worldPos=="function"){const a=i.player.worldPos(),r=e.getCamPos();a&&r&&a.dist(r)>1&&e.tween(r,a,.15,l=>{e.setCamPos(l)},e.easings.linear)}}),pe(e,i.player),Z(e),we(e)}const wh=[["Howdy there! I haven't seen you around before. It's nice to meet you stranger.","Feel free to pet the chickens!","You can pet the chickens by pressing 'space'... if I remember correctly."],["Well, I should get back to work... Have a good day!"],["Thanks for stopping by!"]],vh=[["Þessir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram að vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],bh={english:wh,icelandic:vh};function xh(e,t,s="farmer"){return[e.sprite("sprites",{anim:"farmer-idle-down"}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(2),e.offscreen(),s]}async function Un(e,t,s,i=0){if(S.getPreviousScene()==="barn-side"&&(oe.isAnyChickenHurt()||oe.isAnyChickenDead())){t.flipX=!0,R(t,"farmer-idle-side");let r;oe.isAnyChickenAlive()?oe.isSomeButNotAllDead&&typeof oe.isSomeButNotAllDead=="function"&&oe.isSomeButNotAllDead()?r=[["You killed Beatrice! That was my favorite chicken!"],["I can't believe you would do this!"]]:r=[["Hey! What's your problem? Leave my chickens alone!"],["You think you can just waltz in here and mess with my chickens?"],["Get lost!"]]:r=[["No! My chickens! What have you done? T-they're all dead!"],["Just leave! You monster!"]],await K(e,e.vec2(250,500),r),await e.wait(2),R(t,"farmer-idle-down");return}s.direction==="left"&&(t.flipX=!1,R(t,"farmer-idle-side")),s.direction==="right"&&(t.flipX=!0,R(t,"farmer-idle-side")),s.direction==="up"&&R(t,"farmer-idle-down"),s.direction==="down"&&R(t,"farmer-idle-up");const n=bh[S.getLanguage()];let a=xs.getNbTimesTalkedFarmer();a>=n.length&&(a=n.length-1,xs.setNbTimesTalkedFarmer(a)),await K(e,e.vec2(250,500),n[a],{speed:10}),xs.setNbTimesTalkedFarmer(a+1)}async function Ah(e){he(e),ce(e),re(e,27,29,52);const t=await le("./assets/maps/barn.json"),s=e.add([e.pos(-70,-160)]);let i=S.getPreviousScene();const n={player:null,farmer:null},a=t.layers;for(const r of a){if(r.name==="Boundaries"){ue(e,s,r);continue}if(r.name==="SpawnPoints"){for(const l of r.objects){if(l.name==="player"&&!n.player&&i!=="barn-side"){n.player=s.add(L(e,e.vec2(l.x,l.y)));continue}if(l.name==="farmer"){n.farmer=s.add(xh(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-barn"&&!n.player&&i==="barn-side"){n.player=s.add(L(e,e.vec2(l.x,l.y)));continue}}continue}r.type==="tilelayer"&&de(e,s,r,t.tileheight,t.tilewidth,t.tilesets)}n.player.onCollide("farmer",()=>{oe.isAnyChickenAlive()&&!oe.isAnyChickenHurt()?Un(e,n.farmer,n.player):K(e,e.vec2(250,500),[["I don't want to talk to you!"]],{speed:10})}),n.player.onCollide("barn-exit",()=>{S.setPreviousScene("barn"),e.play("door-open"),e.go("castle")}),n.player.onCollide("barn-side-exit",()=>{S.setPreviousScene("barn-side"),e.play("door-open"),e.go("castle")}),i==="barn-side"&&n.farmer&&n.player&&(oe.isAnyChickenHurt()||oe.isAnyChickenDead())&&(!oe.isAnyChickenAlive()&&!oe.hasTriggeredDeadInteraction()?(oe.setTriggeredDeadInteraction(!0),Un(e,n.farmer,n.player)):oe.isSomeButNotAllDead()&&!oe.hasTriggeredOneDeadInteraction()?(oe.setTriggeredOneDeadInteraction(!0),Un(e,n.farmer,n.player)):oe.isAnyChickenHurt()&&oe.isAnyChickenAlive()&&!oe.hasTriggeredHurtInteraction()&&(oe.setTriggeredHurtInteraction(!0),Un(e,n.farmer,n.player))),e.setCamScale(4),pe(e,n.player),Z(e),we(e)}const Sh=[["Hello there, traveler! What can I get for you?","Perhaps a health potion? No offense, but you look like you could use one.","You look like an adventurer. I might have a little quest for you.","I was expecting supplies from the east today, but they seem to be delayed.","If you happen to find them, could you bring them to me?","I'd be willing to reward you handsomely."],["Have you found the supplies yet?","I would recommend starting your search in the forest to the east of here."],"It can be dangerous out in the forest, so be careful!",[]],Ph=[[],[],[],[]],Ch={english:Sh,icelandic:Ph};function Mh(e,t){return[e.sprite("sprites",{anim:"bartender-idle-down"}),e.pos(t.x,t.y),e.area({shape:new e.Rect(e.vec2(2,6),12,25)}),e.body({isStatic:!0}),"bartender"]}async function Eh(e,t,s,i=0){const n=Ch[S.getLanguage()][i];let a=As.getNbTimesTalkedBartender();if(F.getHasTavernSupplies()===!0){await K(e,e.vec2(250,500),["You found it! Thank you so much.","Here, take this potion as a reward. It's a special brew.","It increases your health by 1 heart."],{speed:10}),F.setHasTavernSupplies(!1),F.setMaxHealth(F.getMaxHealth()+1),F.setHealth(F.getHealth()+1),e.play("item"),e.destroyAll("heartsContainer"),Z(e);return}let r={};a===0&&(F.addPotion(1),r.onLine=o=>{o===1&&e.play&&(F.setHasHadPotion(!0),e.play("item"),e.destroyAll("heartsContainer"),Z(e))}),a>=n.length&&(a=n.length-1,As.setNbTimesTalkedBartender(a)),n[a]&&(await K(e,e.vec2(250,500),n,{speed:10,...r}),As.setNbTimesTalkedBartender(a+1))}const Th=[["That's a nice sword you have there.","You look like you know how to handle it.","Do you know you can do a charge attack by pressing 'shift'?"],["Those bats in the forest can be a problem.","Try to keep your distance and strike when you see an opening."],[]],Ih=[[],[],[],[]],Dh={english:Th,icelandic:Ih};function Bh(e,t){return[e.sprite("Everything",{anim:"swordsman-idle-down"}),e.pos(t.x,t.y),e.area({shape:new e.Rect(e.vec2(2,6),12,25)}),e.body({isStatic:!0}),"swordsman"]}async function Hh(e,t,s,i=0){s.direction==="left"&&(t.flipX=!1,R(t,"swordsman-idle-side")),s.direction==="right"&&(t.flipX=!0,R(t,"swordsman-idle-side")),s.direction==="up"&&R(t,"swordsman-idle-down"),s.direction==="down"&&R(t,"swordsman-idle-up");const n=Dh[S.getLanguage()][i];let a=Ss.getNbTimesTalkedSwordsman(),r={};a===0&&(F.addPotion(1),r.onLine=o=>{o===1&&e.play&&(F.setHasHadPotion(!0),e.play("item"),e.destroyAll("heartsContainer"),Z(e))}),a>=n.length&&(a=n.length-1,Ss.setNbTimesTalkedSwordsman(a)),n[a]&&(await K(e,e.vec2(250,500),n,{speed:10,...r}),Ss.setNbTimesTalkedSwordsman(a+1))}const qh=[["*Hic* These health potions are good stuff! *Hic*","Is this room spinning? *Hic*"],["*Hic* I've never felt healthier!"],"whoa"],Rh=[[],[],[],[]],Fh={english:qh,icelandic:Rh};function Oh(e,t){return[e.sprite("Everything",{anim:"drunkard-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,50)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"drunkard",{name:"drunkard",hp(){return 1},hurt(){}}]}async function jh(e,t,s){s.direction==="left"&&(t.flipX=!0,R(t,"drunkard-idle-side")),s.direction==="right"&&(t.flipX=!1,R(t,"drunkard-idle-side")),s.direction==="up"&&R(t,"drunkard-idle-down"),s.direction==="down"&&R(t,"drunkard-idle-up");const i=Fh[S.getLanguage()];let n=jn.getNbTimesTalkedDrunkard();n>i.length-1&&(jn.setNbTimesTalkedDrunkard(1),n=jn.getNbTimesTalkedDrunkard()),i[n]&&(await K(e,e.vec2(250,500),i[n]),jn.setNbTimesTalkedDrunkard(n+1))}async function Nh(e){he(e),ce(e),re(e,27,29,52);const t=await le("./assets/maps/tavern.json"),s=e.add([e.pos(-70,-160)]);let i=S.getPreviousScene();const n={player:null,bartender:null,swordsman:null,drunkard:null},a=t.layers;console.log("Map layers:",a);for(const r of a){if(r.name==="Boundaries"){ue(e,s,r);continue}if(r.name==="SpawnPoints"){for(const l of r.objects){if(l.name==="player"&&!n.player&&i!=="tavern-second-floor"){n.player=s.add(L(e,e.vec2(l.x,l.y)));continue}if(l.name==="bartender"){n.bartender=s.add(Mh(e,e.vec2(l.x,l.y)));continue}if(l.name==="swordsman"){n.swordsman=s.add(Bh(e,e.vec2(l.x,l.y)));continue}if(l.name==="drunkard"){n.drunkard=s.add(Oh(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-tavern-second-floor"&&!n.player&&i==="tavern-second-floor"){n.player=s.add(L(e,e.vec2(l.x,l.y)));continue}}continue}r.type==="tilelayer"&&de(e,s,r,t.tileheight,t.tilewidth,t.tilesets)}n.player.onCollide("bartender",async()=>{await Eh(e)}),n.player.onCollide("swordsman",async()=>{await Hh(e,n.swordsman,n.player)}),n.player.onCollide("drunkard",async()=>{await jh(e,n.drunkard,n.player)}),n.player.onCollide("tavern-exit",()=>{S.setPreviousScene("tavern"),e.play("door-open"),e.go("castle")}),n.player.onCollide("tavern-second-floor-entrance",()=>{S.setPreviousScene("tavern-second-floor"),e.go("tavern-second-floor")}),e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const r=n.player.worldPos(),l=e.getCamPos();r&&l&&r.dist(l)>1&&e.tween(l,r,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e)}async function Lh(e){he(e),ce(e),re(e,27,29,52);const t=await le("./assets/maps/tavern-second-floor.json"),s=e.add([e.pos(-70,-160)]);S.getPreviousScene();const i={player:null},n=t.layers;console.log("Map layers:",n);for(const a of n){if(a.name==="Boundaries"){ue(e,s,a);continue}if(a.name==="SpawnPoints"){for(const r of a.objects)if(r.name==="player"&&!i.player){i.player=s.add(L(e,e.vec2(r.x,r.y)));continue}continue}a.type==="tilelayer"&&de(e,s,a,t.tileheight,t.tilewidth,t.tilesets)}i.player.onCollide("tavern-second-floor-exit",()=>{S.setPreviousScene("tavern-second-floor"),e.go("tavern")}),e.setCamScale(4),i.player&&typeof i.player.worldPos=="function"&&e.setCamPos(i.player.worldPos()),e.onUpdate(()=>{if(i.player&&typeof i.player.worldPos=="function"){const a=i.player.worldPos(),r=e.getCamPos();a&&r&&a.dist(r)>1&&e.tween(r,a,.15,l=>{e.setCamPos(l)},e.easings.linear)}}),pe(e,i.player),Z(e),we(e)}function Pn(e,t){return[e.sprite("Everything",{anim:"bat-down"}),e.area({shape:new e.Rect(e.vec2(2,4),12,12)}),e.pos(t),e.health(2),e.opacity(),e.offscreen(),e.state("idle",["idle","attack","evade","patrol"]),{isAttacking:!1,attackPower:.5,prevPos:e.vec2(0,0),isFrozen:!1},"bat"]}function Cn(e,t,s){const i=60+Math.random()*40,n=t.pos.clone();let a=1;function r(){return s&&s.pos&&t.pos.dist(s.pos)<96}const l=t.onStateEnter("patrol",async()=>{for(;!r();){if(t.isFrozen)return;const h=n.x+a*i;await e.tween(t.pos.x,h,3+Math.random()*2,c=>{t.isFrozen||(t.pos.x=c)},e.easings.linear),a*=-1}t.enterState("attack")}),o=t.onStateEnter("attack",async()=>{if(!r()){t.enterState("patrol");return}if(t.isFrozen)return;const h=[1,1.5,2];if(await e.tween(t.pos,s.pos,h[Math.floor(Math.random()*h.length)],c=>t.pos=c,e.easings.linear),t.getCollisions().length>0){t.enterState("evade");return}t.enterState("attack")}),d=t.onStateEnter("evade",async()=>{t.isFrozen||(await e.tween(t.pos,t.prevPos,2+Math.random()*2,h=>t.pos=h,e.easings.linear),t.enterState("patrol"))});e.loop(5,()=>{t.prevPos=t.pos.clone()}),t.enterState("patrol"),e.onSceneLeave(()=>{l.cancel(),o.cancel(),d.cancel()})}async function Uh(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/forest.json"),i=e.add([e.pos(100,100)]),n={player:null,chests:[],bats:[],slimes:[]},a=s.layers;for(const l of a){if(l.name==="Boundaries"){ue(e,i,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="bat"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Pn(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.bats.push(h);continue}if(o.name==="slime"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Tt(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.slimes.push(h);continue}if(o.name==="player"&&!n.player&&t!=="witch-house"&&t!=="wolf-house"&&t!=="mountain"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-wolf-house"&&!n.player&&t==="wolf-house"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-witch-house"&&!n.player&&t==="witch-house"&&(n.player=i.add(L(e,e.vec2(o.x,o.y)))),o.name==="player-mountain"&&!n.player&&t==="mountain"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="chest"){const d=o.contents||o.properties?.find(m=>m.name==="contents")?.value||"health-potion",h=`${Math.round(o.x)},${Math.round(o.y)}`,c=S.getChestOpened(h),u=i.add(tt(e,e.vec2(o.x,o.y),d,c));n.chests.push(u)}}continue}l.type==="tilelayer"&&de(e,i,l,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("wolf-house-entrance",()=>{S.setPreviousScene("forest"),e.go("wolf-house")}),n.player.onCollide("forest-exit",()=>{S.setPreviousScene("forest"),e.go("castle")}),n.player.onCollide("witch-house-entrance",()=>{S.setPreviousScene("forest"),e.go("witch-house")}),n.player.onCollide("mountain-entrance",()=>{S.setPreviousScene("forest"),e.go("mountain")}),n.player.onCollide("chest",l=>{nt(e,l,n.player)});for(const l of n.bats)Cn(e,l,n.player),l.enterState("idle"),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadBat&&S.addDeadBat(d)});for(const l of n.slimes)Gt(e,l),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadSlime&&S.addDeadSlime(d)});e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const l=n.player.worldPos(),o=e.getCamPos();l&&o&&l.dist(o)>1&&e.tween(o,l,.15,d=>{e.setCamPos(d)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e);const r=J.get();r&&(n.player.pos=r,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("forest"),J.get()))}function lr(e,t){return[e.sprite("Everything",{anim:"troll-idle-down"}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"troll"]}function Gh(e,t){return[e.sprite("snake",{anim:"snake-side"}),e.area({shape:new e.Rect(e.vec2(18,4),12,12)}),e.body(),e.pos(t),e.health(4),e.opacity(),e.offscreen(),e.state("idle",["idle","attack","evade","patrol"]),{isAttacking:!1,attackPower:.5,prevPos:e.vec2(0,0),isFrozen:!1},"snake"]}function zh(e,t,s){const i=60+Math.random()*40,n=t.pos.clone();let a=1,r=null;function l(){return s&&s.pos&&t.pos.dist(s.pos)<96}function o(){return s&&s.pos&&t.pos.dist(s.pos)<40}function d(f,w,p,g){const x=p.x-w.x,P=p.y-w.y;g?Math.abs(x)>Math.abs(P)?t.area.shape=new e.Rect(e.vec2(0,0),32,16):t.area.shape=new e.Rect(e.vec2(16,0),16,16):Math.abs(x)>Math.abs(P)?x>0?t.area.shape=new e.Rect(e.vec2(0,0),16,16):t.area.shape=new e.Rect(e.vec2(16,0),16,16):t.area.shape=new e.Rect(e.vec2(16,0),16,16)}function h(f,w,p,g=!1){const x=p.x-w.x,P=p.y-w.y;d(f,w,p,g),Math.abs(x)>Math.abs(P)?(t.flipX=x>0,t.play(`${f}-side`)):P>0?(t.flipX=!1,t.play(`${f}-down`)):(t.flipX=!1,t.play(`${f}-up`))}const c=t.onStateEnter("patrol",async()=>{if(t.isFrozen){t.enterState("idle");return}for(;!l();){if(t.isFrozen){t.enterState("idle");return}const f=n.x+a*i;if(r=e.tween(t.pos.x,f,3+Math.random()*2,w=>{if(t.isFrozen){r&&r.cancel();return}t.pos.x=w},e.easings.linear),await r,t.isFrozen||(a*=-1,await e.wait(.1),t.isFrozen))return}t.enterState("attack")}),u=t.onStateEnter("attack",async()=>{if(t.isFrozen){t.enterState("idle");return}if(!l()){t.enterState("patrol");return}const f=[1,1.5,2];for(;l();){if(t.isFrozen){r&&r.cancel();return}const w=t.pos.clone(),p=s.pos.clone();let g=!1;if(r=e.tween(0,1,f[Math.floor(Math.random()*f.length)],x=>{if(t.isFrozen){r&&r.cancel();return}t.pos.x=w.x+(p.x-w.x)*x,t.pos.y=w.y+(p.y-w.y)*x,!g&&o()&&(h("snake-attack",w,p,!0),g=!0)},e.easings.linear),await r,t.isFrozen)return;if(g&&(h("snake",t.pos,s.pos,!1),d("snake",t.pos,s.pos,!1)),t.getCollisions().length>0){t.enterState("evade");return}if(await e.wait(.1),t.isFrozen)return}t.enterState("patrol")}),m=t.onStateEnter("evade",async()=>{if(t.isFrozen){t.enterState("idle");return}const f=t.pos.clone(),w=t.prevPos.clone();h("snake",f,w,!1),r=e.tween(t.pos,t.prevPos,2+Math.random()*2,p=>{if(t.isFrozen){r&&r.cancel();return}t.pos=p},e.easings.linear),await r,!t.isFrozen&&t.enterState("patrol")});e.loop(5,()=>{t.prevPos=t.pos.clone()}),t.enterState("patrol"),e.onSceneLeave(()=>{c.cancel(),u.cancel(),m.cancel()})}function Gi(e,t,s){return[e.sprite("bean-stalk",{anim:s}),e.area({shape:new e.Rect(e.vec2(0,240),16,16)}),e.pos(t),"bean-stalk"]}const Kh=[["Oh hello, I was just trying to decide what to plant here.","The soil here is so rich and fertile, I could grow anything!","But I can't decide what to plant...","Do you have any ideas?","..."],["Well I better get back to work..."],["These trees won't chop themselves!"],["Did you get that gift from my wife?"],["Why are you looking at me like that?"],["I can see you got that potion! I bet it will come in handy against those slimes."]],Xh=[["Þessir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram að vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],Wh={english:Kh,icelandic:Xh};function Yh(e,t){return[e.sprite("Everything",{anim:"gardener-idle-side"}),e.area({shape:new e.Rect(e.vec2(2,6),12,13)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),e.opacity(),{speed:30},"gardener"]}async function Vh(e,t,s,i){if(s.direction==="left"&&(t.flipX=!1,R(t,"gardener-idle-side")),s.direction==="right"&&(t.flipX=!0,R(t,"gardener-idle-side")),s.direction==="up"&&R(t,"gardener-idle-down"),s.direction==="down"&&R(t,"gardener-idle-up"),Wh[S.getLanguage()],S.getPlantedBeans()===!1){let d=t.curAnim();if(t.play("gardener-idle-side"),t.flipX=!1,await K(e,e.vec2(250,500),["Hmm... maybe some tulips? no that's too common...","Or perhaps some carrots? no, that's too predictable...","What about some roses? no, those are too basic...","Ugh, I just can't decide!"],{speed:10}),await t.play(d),await t.play(d),t.flipX===!1&&(t.flipX=!0),await K(e,e.vec2(250,500),["Oh hello, I was just trying to decide what to plant here."],{speed:10}),t.play("gardener-idle-side"),t.flipX===!0&&(t.flipX=!1),await K(e,e.vec2(250,500),["The soil here is so rich and fertile, I could grow anything!","But I can't decide what to plant...","It has to be something truly special!"],{speed:10}),await t.play(d),t.flipX===!1&&(t.flipX=!0),await K(e,e.vec2(250,500),["Do you have any ideas?","..."],{speed:10}),F.getHasMagicalBeans()===!0){if(await K(e,e.vec2(250,500),["Wait a minute... those beans you have...","Could they be... magical beans?","I've heard stories about them, but I never thought I'd see some in person!","Could I maybe... Plant them?","..."],{speed:10}),await F.setHasMagicalBeans(!1),await e.destroyAll("heartsContainer"),await Z(e),await S.setPlantedBeans(!0),e.play("item"),await K(e,e.vec2(250,500),["Thank you so much!"],{speed:10}),S.setFreezePlayer(!0),await e.tween(t.pos,t.pos.add(e.vec2(32,0)),2,h=>{t.pos=h,t.curAnim()!=="gardener-side"&&(t.flipX=!1,t.play("gardener-side"))},e.easings.linear),t.play("gardener-idle-up"),await e.wait(2),i){if(i.play)i.play("bean-stalk-2");else{const h=i.use&&i.use("sprite");h&&h.play&&h.play("bean-stalk-2")}Fe.setBeanStalkHeight(1)}await e.tween(t.pos,t.pos.add(e.vec2(-32,0)),2,h=>{t.pos=h,t.curAnim()!=="gardener-side"&&(t.flipX=!0,t.play("gardener-side"))},e.easings.linear),t.play(d),await K(e,e.vec2(250,500),["This is so exciting! I can't wait to see what grows!","Be sure to come back and check on it when you're passing by."],{speed:10})}else await K(e,e.vec2(250,500),["Hmm... I guess not. Well, if you come across anything interesting, please let me know!"],{speed:10})}let n=ot.getNbTimesTalkedGardenerHeight1()||0;if(Fe.getBeanStalkHeight()===1){let d=[["Thank you again for those magical beans!"],["I can't wait to see what grows!"]];await K(e,e.vec2(250,500),d[n%d.length],{speed:10}),ot.setNbTimesTalkedGardenerHeight1(n+1)}let a=ot.getNbTimesTalkedGardenerHeight2()||0;if(Fe.getBeanStalkHeight()===2){let d=[["Look! It's already grown so much!"],["I wonder how tall it will get?"]];await K(e,e.vec2(250,500),d[a%d.length],{speed:10}),ot.setNbTimesTalkedGardenerHeight2(a+1)}let r=ot.getNbTimesTalkedGardenerHeight3()||0;if(Fe.getBeanStalkHeight()===3){let d=[["Wow, it's getting really tall now!"],["Thank you again for this!"],["I can't wait to see how high it will grow!"]];await K(e,e.vec2(250,500),d[r%d.length],{speed:10}),ot.setNbTimesTalkedGardenerHeight3(r+1)}let l=ot.getNbTimesTalkedGardenerHeight4()||0;if(Fe.getBeanStalkHeight()===4){let d=[["It's almost reaching the clouds!"],["This is amazing!"]];await K(e,e.vec2(250,500),d[l%d.length],{speed:10}),ot.setNbTimesTalkedGardenerHeight4(l+1)}let o=ot.getNbTimesTalkedGardenerHeight5()||0;if(Fe.getBeanStalkHeight()>=5){let d=[["It's so tall now, It has reached the clouds!","Thank you, thank you, thank you!","I wonder what's up there..."],["This is unbelievable!"]];await K(e,e.vec2(250,500),d[o%d.length],{speed:10}),ot.setNbTimesTalkedGardenerHeight5(o+1)}await e.wait(.5),t.play("gardener-idle-side"),t.flipX=!1}async function Qh(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/forest-east.json"),i=e.add([e.pos(100,100)]),n={player:null,chests:[],slimes:[],bats:[],snakes:[],troll:null,gardener:null,beanStalk:null},a=s.layers;for(const c of a){if(c.name==="Boundaries"){ue(e,i,c);continue}if(c.name==="SpawnPoints"){for(const u of c.objects){if(u.name==="slime"&&!n.slimes.find(m=>m.id===u.id)){const m=`${Math.round(u.x)},${Math.round(u.y)}`;if((S.getDeadSlimes?S.getDeadSlimes():[]).includes(m))continue;const w=i.add(Tt(e,e.vec2(u.x,u.y)));n.slimes.push(w)}if(u.name==="bat"){const m=`${Math.floor(u.x)},${Math.floor(u.y)}`,f=i.add(Pn(e,e.vec2(u.x,u.y)));f._spawnKey=m,n.bats.push(f);continue}if(u.name==="snake"){const m=i.add(Gh(e,e.vec2(u.x,u.y)));n.snakes.push(m);continue}if(u.name==="player"&&!n.player&&t!=="troll-dinner"&&t!=="bean-stalk"&&t!=="swamp"){n.player=i.add(L(e,e.vec2(u.x,u.y)));continue}if(u.name==="player-troll-dinner"&&!n.player&&t==="troll-dinner"&&(n.player=i.add(L(e,e.vec2(u.x,u.y)))),u.name==="player-bean-stalk"&&!n.player&&t==="bean-stalk"&&(n.player=i.add(L(e,e.vec2(u.x,u.y)))),u.name==="player-swamp"&&!n.player&&t==="swamp"&&(n.player=i.add(L(e,e.vec2(u.x,u.y)))),u.name==="troll"&&(n.troll=i.add(lr(e,e.vec2(u.x,u.y)))),u.name==="gardener"&&(n.gardener=i.add(Yh(e,e.vec2(u.x,u.y)))),u.name==="bean-stalk"){const m=Fe.getBeanStalkHeight()+1;m<6&&(n.beanStalk=i.add(Gi(e,e.vec2(u.x,u.y),`bean-stalk-${m}`)))}if(u.name==="bean-stalk-max"&&Fe.getBeanStalkHeight()>=5&&(n.beanStalk=i.add(Gi(e,e.vec2(u.x,u.y),"bean-stalk-6"))),u.name==="chest"){const m=u.contents||u.properties?.find(g=>g.name==="contents")?.value||"health-potion",f=`${Math.round(u.x)},${Math.round(u.y)}`,w=S.getChestOpened(f),p=i.add(tt(e,e.vec2(u.x,u.y),m,w));n.chests.push(p)}}continue}c.type==="tilelayer"&&de(e,i,c,s.tileheight,s.tilewidth,s.tilesets)}for(const c of n.slimes)Gt(e,c),Ie(e,c,()=>n.player),He(e,c),c.onDeath&&c.onDeath(()=>{const u=c.pos,m=`${Math.round(u.x)},${Math.round(u.y)}`;S.addDeadSlime&&S.addDeadSlime(m)});n.player.onCollide("forest-east-exit",()=>{Fe.setBeanStalkHeight(Fe.getBeanStalkHeight()+1),S.setPreviousScene("forest-east"),e.go("castle")}),n.player.onCollide("gardener",()=>{Vh(e,n.gardener,n.player,n.beanStalk)}),n.player.onCollide("chest",c=>{nt(e,c,n.player)}),n.player.onCollide("troll-dinner-entrance",()=>{S.getTrollDinnerHad()===!0&&(S.setPreviousScene("forest-east"),e.go("troll-dinner"))}),n.player.onCollide("bean-stalk",()=>{Fe.getBeanStalkHeight()>=5&&e.go("bean-stalk")}),n.player.onCollide("swamp-entrance",()=>{S.setPreviousScene("forest-east"),e.go("swamp")});for(const c of n.bats)Cn(e,c,n.player),c.enterState("idle"),Ie(e,c,()=>n.player),He(e,c),c.onDeath&&c.onDeath(()=>{const u=c.pos,m=`${Math.floor(u.x)},${Math.floor(u.y)}`;S.addDeadBat&&S.addDeadBat(m)});for(const c of n.snakes)zh(e,c,n.player),c.enterState("idle"),Ie(e,c,()=>n.player),He(e,c),c.onDeath&&c.onDeath(()=>{const u=c.pos,m=`${Math.round(u.x)},${Math.round(u.y)}`;S.addDeadSnake&&S.addDeadSnake(m)});e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const c=n.player.worldPos(),u=e.getCamPos();c&&u&&c.dist(u)>1&&e.tween(u,c,.15,m=>{e.setCamPos(m)},e.easings.linear)}});const r=e.vec2(1180,705);let l=!1;async function o(c){c.play("troll-down"),await e.tween(c.pos,c.pos.add(e.vec2(0,16)),2,m=>c.pos=m,e.easings.linear),c.play("troll-side"),c.flipX=!1,await e.tween(c.pos,c.pos.add(e.vec2(48,0)),4,m=>c.pos=m,e.easings.linear),c.play("troll-up"),await e.tween(c.pos,c.pos.add(e.vec2(0,-32)),3,m=>c.pos=m,e.easings.linear),c.play("troll-side"),c.flipX=!0,await e.tween(c.pos,c.pos.add(e.vec2(-48,0)),4,m=>c.pos=m,e.easings.linear),c.play("troll-idle-side")}async function d(c,u,m){n.troll.unuse("body"),n.player.unuse("body"),S.setFreezePlayer(!0);const f=16;u.play("troll-side"),u.flipX=!1,await c.tween(u.pos,u.pos.add(c.vec2(5*f,0)),2,w=>{u.pos=w,u.flipX=!1},c.easings.linear),u.play("troll-down"),await c.tween(u.pos,u.pos.add(c.vec2(0,2*f)),1.2,w=>{u.pos=w},c.easings.linear),u.play("troll-side"),u.flipX=!0,await c.tween(u.pos,u.pos.add(c.vec2(-3*f,0)),1.6,w=>{u.pos=w,u.flipX=!0},c.easings.linear),u.play("troll-up"),await c.tween(u.pos,u.pos.add(c.vec2(0,-1*f)),.8,w=>{u.pos=w},c.easings.linear),u.play("troll-idle-down"),await c.wait(.3),m.play("player-side"),m.flipX=!1,await c.tween(m.pos,m.pos.add(c.vec2(6*f,0)),1.6,w=>{m.pos=w,m.flipX=!1},c.easings.linear),m.play("player-down"),await c.tween(m.pos,m.pos.add(c.vec2(0,2*f)),1,w=>{m.pos=w},c.easings.linear),m.play("player-side"),m.flipX=!0,await c.tween(m.pos,m.pos.add(c.vec2(-3*f,0)),1.2,w=>{m.pos=w,m.flipX=!0},c.easings.linear),m.play("player-up"),await c.tween(m.pos,m.pos.add(c.vec2(0,-.5*f)),.6,w=>{m.pos=w},c.easings.linear),m.play("player-idle-down"),n.player.use("body")}e.onUpdate(()=>{!n.player||!n.troll||S.getTrollDinnerHad()===!0||l||n.player.pos.dist(r)<48&&(n.bats.forEach(c=>c.destroy()),n.slimes.forEach(c=>c.destroy()),n.snakes.forEach(c=>c.destroy()),K(e,e.vec2(250,500),["Stop right there!"],{keepFrozen:!0}),l=!0,S.setFreezePlayer(!0),o(n.troll).then(async()=>{const{dialog:c}=await $s(async()=>{const{dialog:b}=await Promise.resolve().then(()=>rr);return{dialog:b}},void 0),u=["You shall not pass until you answer my riddle! And if you get it wrong...","I will eat you! Muahaha!","Alright here it comes...","What has eyes but... can't see... ummm...","Wait... What has umm... a mouth? No, that's not right..."];await c(e,e.vec2(250,500),u),n.troll.play("troll-idle-side"),n.troll.flipX=!1;const m=["Oh god this is so embarrassing... How did that stupid riddle go again...","...","..."];await c(e,e.vec2(250,500),m),n.troll.flipX=!0;const f=16;n.troll.play("troll-idle-side");const w=["Forget that stupid riddle!"];await c(e,e.vec2(250,500),w),S.setFreezePlayer(!0),await e.tween(n.troll.pos,n.troll.pos.add(e.vec2(-2*f,0)),3,b=>{n.troll.pos=b,n.troll.curAnim()!=="troll-side"&&n.troll.play("troll-side"),n.troll.flipX=!0},e.easings.linear),n.troll.play("troll-idle-side");const p=["I'll just eat you anyway!"];await c(e,e.vec2(250,500),p);const g=["Muhahaha!"];n.troll.play("troll-side"),await c(e,e.vec2(250,500),g),e.wait(2e3),n.troll.play("troll-idle-side");const x=["Wait, why aren't you running away?","I-I'm about to eat you. I mean it!"];await c(e,e.vec2(250,500),x),e.wait(4e3);const P=["...","...","...","*Sigh* Can i be honest with you?"];await c(e,e.vec2(250,500),P),S.setFreezePlayer(!0),await e.tween(n.troll.pos,n.troll.pos.add(e.vec2(0,.5*f)),2,b=>{n.troll.pos=b,n.troll.curAnim()!=="troll-down"&&n.troll.play("troll-down")},e.easings.linear),n.troll.play("troll-idle-down");const H=["I don't really like the taste of humans...","But please don't tell anyone, ok?","What would people think of me if they knew I didn't like eating humans?","I would be the laughing stock of the troll community!"];await c(e,e.vec2(250,500),H),S.setFreezePlayer(!0),await e.tween(n.troll.pos,n.troll.pos.add(e.vec2(0,-.5*f)),2,b=>{n.troll.pos=b,n.troll.curAnim()!=="troll-up"&&n.troll.play("troll-up")},e.easings.linear),n.troll.play("troll-idle-side");const C=["Look, I'll let you pass. If you let me invite you to dinner.","I promise it will be worth your while.","The grass is like way greener on the other side of this bridge.","...","I'll take that as a yes! Follow me."];await c(e,e.vec2(250,500),C),await d(e,n.troll,n.player);const A=e.add([e.rect(e.width(),e.height()),e.color(27,29,52),e.opacity(0),e.fixed(),"fadeToBlack"]);await e.tween(A.opacity,1,1,b=>A.opacity=b,e.easings.linear),S.setFreezePlayer(!1),e.go("troll-dinner")}))}),pe(e,n.player),Z(e),we(e);const h=J.get();h&&(n.player.pos=h,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("forest-east"),J.get()))}async function $h(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/witch-house.json"),i=e.add([e.pos(100,100)]),n={player:null},a=s.layers;console.log("Map layers:",a);for(const l of a){if(l.name==="Boundaries"){ue(e,i,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="player"&&!n.player&&t!=="witch-house-inside"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}o.name==="player-witch-house-inside"&&!n.player&&t==="witch-house-inside"&&(n.player=i.add(L(e,e.vec2(o.x,o.y))))}continue}l.type==="tilelayer"&&de(e,i,l,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("witch-house-exit",()=>{S.setPreviousScene("witch-house"),e.go("forest")}),n.player.onCollide("witch-house-inside-entrance",()=>{S.setPreviousScene("witch-house"),e.go("witch-house-inside")}),e.setCamScale(4),e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{n.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),n.player.worldPos(),.15,l=>{e.setCamPos(l)},e.easings.linear)}),pe(e,n.player),Z(e),we(e);const r=J.get();r&&(n.player.pos=r,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("witch-house"),J.get()))}function Jh(e,t){return[e.sprite("Everything",{anim:"witch-idle-side"}),e.area({shape:new e.Rect(e.vec2(2,6),12,15)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"witch"]}const zi=yt().getInstance();async function Zh(e){he(e),ce(e);const t=zi.getPreviousScene();re(e,27,29,52);const s=await le("./assets/maps/witch-house-inside.json"),i=e.add([e.pos(-380,-392)]),n={player:null,witch:null};for(const a of s.layers){if(a.name==="Boundaries"){ue(e,i,a);continue}if(a.name==="SpawnPoints")for(const r of a.objects){if(r.name==="player"&&!n.player&&t!=="witch-house-inside"){n.player=i.add(L(e,e.vec2(r.x,r.y)));continue}if(r.name==="witch"&&!n.witch){n.witch=i.add(Jh(e,e.vec2(r.x,r.y)));continue}}a.type==="tilelayer"&&de(e,i,a,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("chest",a=>{nt(e,a,n.player)}),n.player.onCollide("witch-house-inside-exit",()=>{zi.setPreviousScene("witch-house-inside"),e.go("witch-house")}),e.setCamScale(4),e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{const a=e.getCamPos(),r=n.player.worldPos(),l=a.lerp(r,.1);e.setCamPos(l)}),pe(e,n.player),Z(e),we(e)}async function _h(e){const t=S.getCurrentSong();if(!t||!t.name||t.name!=="troll-dinner-soundtrack"){S.pauseCurrentSong();const o=e.play("troll-dinner-soundtrack",{loop:!0});o.name="troll-dinner-soundtrack",S.setCurrentSong(o)}S.getTrollDinnerHad()===!1&&S.setFreezePlayer(!0);const s=S.getPreviousScene();he(e),ce(e),re(e,8,148,236);const i=await le("./assets/maps/troll-dinner.json"),n=e.add([e.pos(100,100)]),a={player:null,troll:null,chests:[]},r=i.layers;for(const o of r){if(o.name==="Boundaries"){ue(e,n,o);continue}if(o.name==="SpawnPoints"){for(const d of o.objects){if(d.name==="player"&&!a.player&&s!=="forest-east"&&S.getTrollDinnerHad()===!1){a.player=n.add(L(e,e.vec2(d.x,d.y))),a.player&&a.player.play&&a.player.play("player-sitting-up");continue}if(d.name==="troll"&&!a.troll&&(a.troll=n.add(lr(e,e.vec2(d.x,d.y))),a.troll&&a.troll.play&&a.troll.play("troll-sitting-down")),d.name==="player-troll-dinner-entrance"&&!a.player&&s==="forest-east"&&S.getTrollDinnerHad()===!0){a.player=n.add(L(e,e.vec2(d.x,d.y)));continue}if(d.name==="chest"){const h=d.contents||d.properties?.find(f=>f.name==="contents")?.value||"health-potion",c=`${Math.round(d.x)},${Math.round(d.y)}`,u=S.getChestOpened(c),m=n.add(tt(e,e.vec2(d.x,d.y),h,u));a.chests.push(m)}}continue}o.type==="tilelayer"&&de(e,n,o,i.tileheight,i.tilewidth,i.tilesets)}let l=!1;if(a.player.onCollide("chest",async o=>{await nt(e,o),l||(a.troll.play("troll-sitting-left"),await K(e,e.vec2(250,500),["Oh you're gonna take that? I guess that's fine.","Since we're friends and all."]),l=!0,a.troll.play("troll-sitting-down"))}),a.player.onCollide("troll-dinner-exit",()=>{S.setPreviousScene("troll-dinner"),e.go("forest-east")}),e.setCamScale(4),a.player&&typeof a.player.worldPos=="function"&&e.setCamPos(a.player.worldPos().sub(0,20)),pe(e,a.player),Z(e),S.getTrollDinnerHad()===!1){e.onUpdate(()=>{a.player&&S.getFreezePlayer()&&a.player.curAnim&&a.player.curAnim()!=="player-sitting-up"&&a.player.play("player-sitting-up")});const o=e.add([e.rect(e.width(),e.height()),e.color(27,29,52),e.opacity(1),e.fixed(),"fadeFromBlack"]);await e.tween(o.opacity,0,1,c=>o.opacity=c,e.easings.linear),console.log("previousScene:",s);const d=["So ummm... How do you like the lamb?","It's like... totally cool if you don't like it.","Really, it's just something I threw together.","...","You're not much of a talker huh?","That's cool, I've always thought talking was like super overrated anyway. Haha","...","Anyway, I just wanted to say thanks for coming.","It's been... nice having someone over for dinner.","This might be hard to believe but I actually don't have very many friends."];await K(e,e.vec2(250,500),d),a.troll&&a.troll.play("troll-laugh"),await K(e,e.vec2(250,500),[`Crazy huh?
*chuckles softly*`]);const h=["...","Being a troll under a bridge definitely has its downsides.","But, you know... I'm proud of my work.","My father was a troll under a bridge, and his father before him.","Guess you could say it runs in the family.","...","Well, I've held you long enough. I bet you have a bunch of friends to go see. *sigh*","W-would you mind if I called you my... friend?","...","I'll take that as a yes! Thanks, friend.","You can feel free to travel over my bridge anytime you want.","Be sure to stop by for dinner again sometime, okay?"];await K(e,e.vec2(250,500),h),S.setTrollDinnerHad(!0)}e.onUpdate(()=>{a.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),a.player.worldPos(),.15,o=>{e.setCamPos(o)},e.easings.linear)})}async function kh(e){Fe.setBeanStalkHeight(5),S.setPlantedBeans(!0);const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/bean-stalk.json"),i=e.add([e.pos(100,100)]),n={player:null},a=s.layers;for(const r of a){if(r.name==="Boundaries"){ue(e,i,r);continue}if(r.name==="SpawnPoints"){for(const l of r.objects){if(l.name==="player"&&!n.player&&t!=="clouds"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}l.name==="player-clouds"&&!n.player&&t==="clouds"&&(n.player=i.add(L(e,e.vec2(l.x,l.y))))}continue}r.type==="tilelayer"&&de(e,i,r,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("clouds-entrance",()=>{Fe.setBeanStalkHeight(Fe.getBeanStalkHeight()+1),S.setPreviousScene("bean-stalk"),e.go("clouds")}),n.player.onCollide("bean-stalk-exit",()=>{S.setPreviousScene("bean-stalk"),e.go("forest-east")}),e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const r=n.player.worldPos(),l=e.getCamPos();r&&l&&r.dist(l)>1&&e.tween(l,r,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e)}async function ep(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/clouds.json"),i=e.add([e.pos(100,100)]),n={player:null},a=s.layers;for(const r of a){if(r.name==="Boundaries"){ue(e,i,r);continue}if(r.name==="SpawnPoints"){for(const l of r.objects)if(l.name==="player"&&!n.player&&t!=="troll-dinner"){n.player=i.add(L(e,e.vec2(l.x,l.y)));continue}continue}r.type==="tilelayer"&&de(e,i,r,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("clouds-exit",()=>{S.setPreviousScene("clouds"),e.go("bean-stalk")}),n.player.onCollide("bean-stalk-exit",()=>{S.setPreviousScene("bean-stalk"),e.go("forest-east")}),e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const r=n.player.worldPos(),l=e.getCamPos();r&&l&&r.dist(l)>1&&e.tween(l,r,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e)}function tp(e,t){return[e.sprite("Everything",{anim:"wolf-idle-down"}),e.area({shape:new e.Rect(e.vec2(3,4),10,12)}),e.body({isStatic:!0}),e.pos(t),e.health(10),e.opacity(),e.offscreen(),e.state("idle",["idle","circle","charge","attack","evade"]),{attackPower:.5},"wolf"]}function np(e,t,s){t.isBoss=!0,t.isStatic=!1,e.loop(5,()=>{t.prevPos=t.pos.clone()});const i=t.onStateEnter("circle",async()=>{if(!t.isBoss||t.paused)return;t.circleAngle===void 0&&(t.circleAngle=0);const l=1.5+Math.random(),o=e.time();for(;e.time()-o<l;){if(!t.isBoss||t.paused)return;t.circleAngle+=e.dt()*1.5;const d=48,h=60,u=s.pos.add(e.vec2(Math.cos(t.circleAngle),Math.sin(t.circleAngle)).scale(d)).sub(t.pos).unit();t.move(u.scale(h)),R(t,"wolf-side"),t.flipX=u.x<0,await e.wait(.01)}!t.isBoss||t.paused||t.enterState("charge")}),n=t.onStateEnter("charge",async()=>{if(!t.isBoss||t.paused)return;const l=e.vec2(s.pos.x,s.pos.y),o=180,d=.5+Math.random(),h=e.time(),c=l.sub(t.pos).unit();let u;for(Math.abs(c.x)>Math.abs(c.y)?(u="wolf-side",t.flipX=c.x<0):c.y>0?(u="wolf-down",t.flipX=!1):(u="wolf-up",t.flipX=!1),R(t,u);e.time()-h<d;){if(!t.isBoss||t.paused)return;t.move(c.scale(o)),await e.wait(.01)}!t.isBoss||t.paused||t.enterState("attack")}),a=t.onStateEnter("attack",async()=>{if(!t.isBoss||t.paused)return;const l=e.vec2(s.pos.x,s.pos.y),o=l.sub(t.pos).unit();let d;if(Math.abs(o.x)>Math.abs(o.y)?(d="wolf-side",t.flipX=o.x<0):o.y>0?(d="wolf-down",t.flipX=!1):(d="wolf-up",t.flipX=!1),R(t,d),await e.tween(t.pos,l,.7,h=>t.pos=h,e.easings.linear),t.lastChargeDir=o,t.getCollisions().some(h=>h.target&&h.target.is&&h.target.is("player"))){t.enterState("evade");return}t.enterState("evade")}),r=t.onStateEnter("evade",async()=>{if(!t.isBoss||t.paused)return;const l=100,o=.7,d=e.time(),h=t.lastChargeDir?t.lastChargeDir.scale(-1):t.pos.sub(s.pos).unit();for(;e.time()-d<o;){if(!t.isBoss||t.paused)return;t.move(h.scale(l)),R(t,"wolf-side"),t.flipX=h.x<0,await e.wait(.01)}t.enterState("circle")});He(e,t),e.onSceneLeave(()=>{i.cancel(),n.cancel(),a.cancel(),r.cancel()}),t.enterState("evade"),s.isAttacking=!0,setTimeout(()=>{s.isAttacking=!1},200)}function sp(e,t){return[e.sprite("Everything",{anim:"red-riding-hood-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,50)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"red-riding-hood",{name:"red-riding-hood",hp(){return 1},hurt(){}}]}async function ip(e){he(e),ce(e),re(e,27,29,52);let t=null;const s=await le("./assets/maps/wolf-house.json"),i=e.add([e.pos(100,192)]),n={player:null,wolf:null,redRidingHood:null},a=s.layers;for(const h of a){if(h.name==="Boundaries"){ue(e,i,h);continue}if(h.name==="SpawnPoints")for(const c of h.objects){if(c.name==="player"){n.player=i.add(L(e,e.vec2(c.x,c.y)));continue}if(c.name==="wolf"){n.wolf=i.add(tp(e,e.vec2(c.x,c.y)));continue}if(c.name==="red-riding-hood"){n.redRidingHood=i.add(sp(e,e.vec2(c.x,c.y)));continue}}h.type==="tilelayer"&&de(e,i,h,s.tileheight,s.tilewidth,s.tilesets)}const r=16;e.onUpdate(async()=>{n.player&&n.wolf&&!S.getWolfEncountered()&&(n.player.pos.y<416&&(S.setFreezePlayer(!0),S.setWolfEncountered(!0),setTimeout(async()=>{const h=["Hey honey, you're back already?","What treats did you bring me this time?","...","Wait... you're not my granddaugher..."];await K(e,e.vec2(250,500),h),S.setFreezePlayer(!0),await e.tween(n.wolf.pos,n.wolf.pos.add(e.vec2(1.5*r,0)),1,u=>{n.wolf.pos=u,n.wolf.curAnim()!=="wolf-side"&&n.wolf.play("wolf-side")},e.easings.linear),n.wolf.pos.y<432&&await e.tween(n.wolf.pos,n.wolf.pos.add(e.vec2(0,n.player.pos.y-n.wolf.pos.y-r)),1.5,u=>{n.wolf.pos=u,n.wolf.curAnim()!=="wolf-down"&&n.wolf.play("wolf-down")},e.easings.linear),n.wolf.pos.x<n.player.pos.x-r?await e.tween(n.wolf.pos,n.wolf.pos.add(e.vec2(n.player.pos.x-n.wolf.pos.x,0)),(n.player.pos.x-n.wolf.pos.x)/16,u=>{n.wolf.pos=u,n.wolf.curAnim()!=="wolf-side"&&n.wolf.play("wolf-side")},e.easings.linear):n.wolf.pos.x>n.player.pos.x+r&&await e.tween(n.wolf.pos,n.wolf.pos.add(e.vec2(n.player.pos.x-n.wolf.pos.x,0)),(n.wolf.pos.x-n.player.pos.x)/16,u=>{n.wolf.pos=u,n.wolf.curAnim()!=="wolf-side"&&n.wolf.play("wolf-side"),n.wolf.flipX=!0},e.easings.linear),R(n.wolf,"wolf-idle-down");const c=["...","Yeah, yeah, laugh it up. I'm a wolf in a pink nightgown.","It's not like I wanted to end up like this...","I was going to eat that girl... but then she kept bringing me these delicious treats.","Look at me now! I can barely fit in this dress. Can’t even see my own paws past this gut!","It turns out the girl is actually really nice.","Somehow she thinks I'm really her grandma. I don't have the heart to tell her otherwise.","So I've just been going along with it.","But now you've seen me like this... I can't let anybody find out the truth.","I'm going to have to eat you now."];await K(e,e.vec2(250,500),c),t=or(e,n.wolf),S.setFreezePlayer(!1),np(e,n.wolf,n.player)},0)),n.wolf.health<=1&&n.wolf.isBoss&&(S.setFreezePlayer(!0),await e.tween(n.redRidingHood.pos,n.redRidingHood.pos.add(e.vec2(-4*r,0)),2,h=>{n.redRidingHood.pos=h,n.redRidingHood.curAnim()!=="red-riding-hood-up"&&n.redRidingHood.play("red-riding-hood-up")},e.easings.linear))),n.player&&n.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),n.player.worldPos(),.15,h=>{e.setCamPos(h)},e.easings.linear)}),n.player.onCollide("wolf-house-exit",()=>{n.wolf.isBoss||(S.setPreviousScene("wolf-house"),e.play("door-open"),e.go("forest"))}),e.setCamScale(4),e.setCamPos(n.player.worldPos()),pe(e,n.player),Z(e),n.wolf.onCollide("player",h=>{n.wolf.isBoss&&h&&h.hurt&&h.hurt(1)});let l=!1;Ie(e,n.wolf,()=>n.player,{onHurt:async h=>{if(!l&&h.hp()<=1&&h.isBoss){l=!0,t&&t.destroy(),S.setFreezePlayer(!0),h.paused=!0,h.isBoss=!1;const c=e.vec2(704,432);await e.tween(h.pos,c,1.2,u=>{h.pos=u},e.easings.linear),h.flipX=!1,R(h,"wolf-idle-down"),await e.tween(n.redRidingHood.pos,h.pos.add(e.vec2(-16,16)),2,u=>{n.redRidingHood.pos=u,n.redRidingHood.curAnim()!=="red-riding-hood-up"&&n.redRidingHood.play("red-riding-hood-up")},e.easings.linear),n.redRidingHood.play("red-riding-hood-idle-down"),await K(e,e.vec2(250,500),["Grandma! Are you okay?","What the hell is going on here!"]),n.player.flipX=!0,await e.tween(n.player.pos,h.pos.add(e.vec2(16,16)),2,u=>{n.player.pos=u,n.player.curAnim()!=="player-side"&&n.player.play("player-side")},e.easings.linear),n.player.play("player-idle-side"),n.redRidingHood.play("red-riding-hood-idle-side"),await K(e,e.vec2(250,500),["Did you just attack my grandma?","What is wrong with you? She's a poor innocent old lady!"]),S.setFreezePlayer(!1)}},preventDeath:h=>h.hp()<=1});const o=n.wolf,d=o.hurt.bind(o);o.hurt=function(h){d(h),o.trigger("healthChange",o.hp())}}async function ap(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/swamp.json"),i=e.add([e.pos(100,100)]),n={player:null,chests:[],bats:[],slimes:[]},a=s.layers;for(const l of a){if(l.name==="Boundaries"){ue(e,i,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="bat"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Pn(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.bats.push(h);continue}if(o.name==="slime"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Tt(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.slimes.push(h);continue}if(o.name==="player"&&!n.player&&t!=="village"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-village"&&!n.player&&t==="village"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="chest"){const d=o.contents||o.properties?.find(m=>m.name==="contents")?.value||"health-potion",h=`${Math.round(o.x)},${Math.round(o.y)}`,c=S.getChestOpened(h),u=i.add(tt(e,e.vec2(o.x,o.y),d,c));n.chests.push(u)}}continue}l.type==="tilelayer"&&de(e,i,l,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("swamp-exit",()=>{S.setPreviousScene("swamp"),e.go("forest-east")}),n.player.onCollide("village-entrance",()=>{S.setPreviousScene("swamp"),e.go("village")}),n.player.onCollide("chest",l=>{nt(e,l,n.player)});for(const l of n.bats)Cn(e,l,n.player),l.enterState("idle"),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadBat&&S.addDeadBat(d)});for(const l of n.slimes)Gt(e,l),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadSlime&&S.addDeadSlime(d)});e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const l=n.player.worldPos(),o=e.getCamPos();l&&o&&l.dist(o)>1&&e.tween(o,l,.15,d=>{e.setCamPos(d)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e);const r=J.get();r&&(n.player.pos=r,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("swamp"),J.get()))}async function rp(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/village.json"),i=e.add([e.pos(100,100)]),n={player:null,chests:[],bats:[],slimes:[]},a=s.layers;for(const l of a){if(l.name==="Boundaries"){ue(e,i,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="bat"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Pn(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.bats.push(h);continue}if(o.name==="slime"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Tt(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.slimes.push(h);continue}if(o.name==="player"&&!n.player&&t!=="town"&&t!=="mountain"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-town"&&!n.player&&t==="town"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-mountain"&&!n.player&&t==="mountain"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="chest"){const d=o.contents||o.properties?.find(m=>m.name==="contents")?.value||"health-potion",h=`${Math.round(o.x)},${Math.round(o.y)}`,c=S.getChestOpened(h),u=i.add(tt(e,e.vec2(o.x,o.y),d,c));n.chests.push(u)}}continue}l.type==="tilelayer"&&de(e,i,l,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("village-exit",()=>{S.setPreviousScene("village"),e.go("swamp")}),n.player.onCollide("town-entrance",()=>{S.setPreviousScene("village"),e.go("town")}),n.player.onCollide("mountain-entrance",()=>{S.setPreviousScene("village"),e.go("mountain")}),n.player.onCollide("chest",l=>{nt(e,l,n.player)});for(const l of n.bats)Cn(e,l,n.player),l.enterState("idle"),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadBat&&S.addDeadBat(d)});for(const l of n.slimes)Gt(e,l),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadSlime&&S.addDeadSlime(d)});e.setCamScale(5),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const l=n.player.worldPos(),o=e.getCamPos();l&&o&&l.dist(o)>1&&e.tween(o,l,.15,d=>{e.setCamPos(d)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e);const r=J.get();r&&(n.player.pos=r,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("village"),J.get()))}async function op(e){const t=S.getPreviousScene();console.log("previousScene:",t),he(e),ce(e),re(e,8,148,236);const s=await le("./assets/maps/mountain.json"),i=e.add([e.pos(100,100)]),n={player:null,chests:[],bats:[],slimes:[],pullables:[]},a=s.layers;for(const l of a){if(l.name==="Boundaries"){ue(e,i,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="bat"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Pn(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.bats.push(h);continue}if(o.name==="slime"){const d=`${Math.floor(o.x)},${Math.floor(o.y)}`,h=i.add(Tt(e,e.vec2(o.x,o.y)));h._spawnKey=d,n.slimes.push(h);continue}if(o.name==="player-village"&&!n.player&&t!=="forest"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="player-forest"&&!n.player&&t==="forest"&&t!=="village"){n.player=i.add(L(e,e.vec2(o.x,o.y)));continue}if(o.name==="chest"){const d=o.contents||o.properties?.find(m=>m.name==="contents")?.value||"health-potion",h=`${Math.round(o.x)},${Math.round(o.y)}`,c=S.getChestOpened(h),u=i.add(tt(e,e.vec2(o.x,o.y),d,c));n.chests.push(u)}}continue}l.type==="tilelayer"&&de(e,i,l,s.tileheight,s.tilewidth,s.tilesets)}n.player.onCollide("forest-entrance",()=>{S.setPreviousScene("mountain"),e.go("forest")}),n.player.onCollide("village-entrance",()=>{S.setPreviousScene("mountain"),e.go("village")}),n.player.onCollide("chest",l=>{nt(e,l,n.player)});for(const l of n.bats)Cn(e,l,n.player),l.enterState("idle"),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadBat&&S.addDeadBat(d)});for(const l of n.slimes)Gt(e,l),Ie(e,l,()=>n.player),He(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,d=`${Math.floor(o.x)},${Math.floor(o.y)}`;S.addDeadSlime&&S.addDeadSlime(d)});if(n.pullables.length===0&&n.player){const l=[e.sprite("sprites",{frame:0}),e.area({shape:new e.Rect(e.vec2(0,4),16,16)}),e.pos(n.player.pos.x-32,n.player.pos.y),e.body(),{areaWidth:16,areaHeight:16},"pullable","solid"],o=e.add(l);n.pullables.push(o)}e.setCamScale(4),n.player&&typeof n.player.worldPos=="function"&&e.setCamPos(n.player.worldPos()),e.onUpdate(()=>{if(n.player&&typeof n.player.worldPos=="function"){const l=n.player.worldPos(),o=e.getCamPos();l&&o&&l.dist(o)>1&&e.tween(o,l,.15,d=>{e.setCamPos(d)},e.easings.linear)}}),pe(e,n.player),Z(e),we(e);const r=J.get();r&&(n.player.pos=r,J.clear(),e.setCamPos(n.player.worldPos())),n.player&&et(e,()=>(J.set(n.player.pos),S.setPreviousScene("mountain"),J.get()))}const lp={title:"The Game",languageIndication:"Press 'F' to switch between English and Icelandic.",playIndication:"Press 'Enter' to Start."},dp={title:"Leikurinn",languageIndication:"Smelltu a 'F' til ad skipta a milli ensku og islensku.",playIndication:"Smelltu a 'Enter' til ad byrja."},Es={english:lp,icelandic:dp},rn=yt().getInstance();function up(e){const t=rn.getLanguage();re(e,27,29,52),e.add([e.text(Es[t].title,{size:32,font:"gameboy"}),e.area(),e.anchor("center"),e.pos(e.center().x,e.center().y-100)]),e.add([e.text(Es[t].languageIndication,{size:16,font:"gameboy"}),e.area(),e.anchor("center"),e.pos(e.center().x,e.center().y+100)]),e.add([e.text(Es[t].playIndication,{size:24,font:"gameboy"}),e.area(),e.anchor("center"),e.pos(e.center().x,e.center().y+200)]),e.onKeyPress("f",()=>{const s=rn.getLanguage();rn.setLanguage(s==="english"?"icelandic":"english"),e.go("mainMenu")}),e.onKeyPress("enter",()=>{oe.initIfNeeded(3),rn.pauseCurrentSong();const s=e.play("soundtrack",{loop:!0});rn.setCurrentSong(s),e.go("world")})}function cp(e,t){function s(){g&&typeof e.setCamPos=="function"&&e.setCamPos(g.pos.clone())}console.log("playerPos in worldMapScene:",t);for(let H=0;H<e.height();H+=8)e.add([e.rect(e.width(),8),e.pos(0,H),e.color(8,148,236),e.z(0),e.fixed()]);const i=12;e.add([e.rect(e.width(),i),e.pos(0,0),e.color(218,165,32),e.z(1),e.fixed()]),e.add([e.rect(e.width(),i),e.pos(0,e.height()-i),e.color(218,165,32),e.z(1),e.fixed()]),e.add([e.rect(i,e.height()),e.pos(0,0),e.color(218,165,32),e.z(1),e.fixed()]),e.add([e.rect(i,e.height()),e.pos(e.width()-i,0),e.color(218,165,32),e.z(1),e.fixed()]),e.add([e.polygon([e.vec2(0,32),e.vec2(32,0),e.vec2(64,32),e.vec2(0,32),e.vec2(32,64),e.vec2(64,32)]),e.pos(i+32,i+32),e.scale(2),e.z(2),e.fixed()]);const n=yt().getInstance().getPreviousScene(),a=1024,r=1024,l=512,o=512,d=l/a,h=o/r;let c=1,u=e.vec2(0,0);if(t){const C=(t.x*d*2-l/2)*c,A=(t.y*h*2-o/2)*c;let b=e.width()/2+C,E=e.height()/2+A;n==="castle"&&(b+=-390*c,E+=-600*c),n==="forest-east"&&(b+=670*c,E+=-840*c),n==="forest"&&(b+=-1608*c,E+=-828*c),n==="witch-house"&&(b+=300*c,E+=1e3*c),n==="castle-main"&&(b+=-490*c,E+=-1540*c),n==="swamp"&&(b+=455*c,E+=-215*c),n==="village"&&(b+=-170*c,E+=-250*c),n==="mountain"&&(b+=-580*c,E+=-425*c),n==="town"&&(b+=-22*c,E+=384*c),n==="world"&&(b+=-600*c,E+=384*c),u=e.vec2(u.x+(e.width()/2-b),u.y+(e.height()/2-E))}const m=e.add([e.sprite("world-map"),e.pos(e.width()/2+u.x,e.height()/2+u.y),e.anchor("center"),e.z(3),e.scale(c)]);m.pos.x,m.pos.y;const f=2;t&&((t.x*d*f-l/2)*c,(t.y*h*f-o/2)*c);const w=1.8,p=2.5;let g=e.add([e.sprite("sprites",{anim:"player-idle-down"}),e.pos(0,0),e.anchor("center"),e.z(5),e.scale(Math.min(Math.max(2*c,w),p))]);function x(){if(m.scaleTo(c),m.pos=e.vec2(e.width()/2+u.x,e.height()/2+u.y),g&&t){const H=a/2,C=r/2,A=(t.x-H)*d*f*c,b=(t.y-C)*h*f*c;let E=m.pos.x+A,M=m.pos.y+b;n==="castle"&&(E+=-390*c,M+=-600*c),n==="forest-east"&&(E+=670*c,M+=-840*c),n==="forest"&&(E+=-1608*c,M+=-828*c),n==="witch-house"&&(E+=-1530*c,M+=-1740*c),n==="castle-main"&&(E+=-490*c,M+=-1540*c),n==="swamp"&&(E+=455*c,M+=-215*c),n==="village"&&(E+=-170*c,M+=-250*c),n==="mountain"&&(E+=-580*c,M+=-425*c),n==="town"&&(E+=-22*c,M+=384*c),n==="world"&&(E+=-1110*c,M+=-95*c),g.pos=e.vec2(E,M),g.scaleTo(Math.min(Math.max(2*c,w),p))}}x(),s(),e.onKeyPress("+",()=>{c=Math.min(c+.2,3),x(),s()}),e.onKeyPress("-",()=>{c=Math.max(c-.2,.2),x(),s()});const P=32;e.onKeyDown(["left","a"],()=>{u.x+=P*c,x()}),e.onKeyDown(["right","d"],()=>{u.x-=P*c,x()}),e.onKeyDown(["up","w"],()=>{u.y+=P*c,x()}),e.onKeyDown(["down","s"],()=>{u.y-=P*c,x()}),e.onKeyPress("0",()=>{c=1,u=e.vec2(0,0),x(),s()}),e.add([e.text(["'M': Close Map","'+/-': Zoom In/Out","'Arrows/WASD': Pan","'0': Reset View"].join(`
`),{size:18,font:"gameboy"}),e.pos(24,e.height()-110),e.color(255,255,255),e.z(10),e.fixed()]),e.onKeyPress("m",()=>{const H=yt().getInstance().getPreviousScene()||"world";e.go(H)})}Q.loadFont("gameboy","./assets/gb.ttf");Q.loadSprite("Everything","./assets/Everything.png",{sliceX:128,sliceY:128,anims:{"chicken-idle-side":20,"chicken-side":{from:20,to:23,loop:!0},"witch-idle-down":12684,"witch-down":{from:12684,to:12687,loop:!0},"witch-idle-up":12940,"witch-up":{from:12940,to:12943,loop:!0},"witch-idle-side":12812,"witch-side":{from:12812,to:12815,loop:!0},"hatguy-idle-down":12688,"hatguy-down":{from:12688,to:12691,loop:!0},"hatguy-idle-up":12944,"hatguy-up":{from:12944,to:12947,loop:!0},"hatguy-idle-side":12816,"hatguy-side":{from:12816,to:12819,loop:!0},"troll-idle-down":12692,"troll-down":{from:12692,to:12695,loop:!0},"troll-idle-side":12820,"troll-side":{from:12820,to:12823,loop:!0},"troll-idle-up":12948,"troll-up":{from:12948,to:12951,loop:!0},"troll-sitting-down":13460,"troll-sitting-side":13461,"troll-sitting-up":13462,"troll-sitting-left":13463,"troll-laugh":{from:13332,to:13335,loop:!1},"gardener-idle-down":12696,"gardener-down":{from:12696,to:12699,loop:!0},"gardener-idle-side":12824,"gardener-side":{from:12824,to:12827,loop:!0},"gardener-idle-up":12952,"gardener-up":{from:12952,to:12955,loop:!0},"bat-idle-down":{from:11404,to:11407,loop:!0},"bat-down":{from:11404,to:11407,loop:!0},"bat-idle-side":11532,"bat-side":{from:11532,to:11535,loop:!0},"bat-idle-up":11660,"bat-up":{from:11660,to:11663,loop:!0},"swordsman-idle-down":13588,"swordsman-idle-side":13716,"swordsman-idle-up":13844,"drunkard-idle-down":13592,"drunkard-idle-side":13593,"drunkard-idle-up":13594,"wolf-idle-down":12700,"wolf-down":{from:12700,to:12703,loop:!0},"wolf-idle-side":12828,"wolf-side":{from:12828,to:12831,loop:!0},"wolf-idle-up":12956,"wolf-up":{from:12956,to:12959,loop:!0},"red-riding-hood-idle-down":13596,"red-riding-hood-down":{from:13596,to:13599,loop:!0},"red-riding-hood-idle-side":13724,"red-riding-hood-side":{from:13724,to:13727,loop:!0},"red-riding-hood-idle-up":13852,"red-riding-hood-up":{from:13852,to:13855,loop:!0},"spikes-up":10660,"spikes-down":10661}});Q.loadSprite("House","./assets/House.png",{sliceX:14,sliceY:7});Q.loadSprite("1_terrain","./assets/1_terrain.png",{sliceX:16,sliceY:16});Q.loadSprite("Maple Tree","./assets/Maple Tree.png",{sliceX:10,sliceY:3});Q.loadSprite("4_buildings","./assets/4_buildings.png",{sliceX:24,sliceY:24});Q.loadSprite("floors-walls","./assets/floors-walls.png",{sliceX:9,sliceY:7});Q.loadSprite("candy-house","./assets/candy-house.png",{sliceX:16,sliceY:16});Q.loadSprite("bean-stalk-tiles","./assets/bean-stalk-tiles.png",{sliceX:6,sliceY:16});Q.loadSprite("Sprite-0005","./assets/Sprite-0005.png",{sliceX:33,sliceY:24,anims:{"chest-closed":239,"chest-opened":240}});Q.loadSprite("topdownasset","./assets/topdownasset.png",{sliceX:39,sliceY:62});Q.loadSprite("sprites","./assets/topdownasset.png",{sliceX:39,sliceY:62,anims:{"player-idle-down":936,"player-down":{from:936,to:939,loop:!0},"player-idle-side":975,"player-side":{from:976,to:978,loop:!0},"player-idle-up":1014,"player-up":{from:1014,to:1017,loop:!0},"player-attack-up":1094,"player-charge-up":1055,"player-attack-down":1092,"player-charge-down":1053,"player-attack-left":1093,"player-charge-left":1056,"player-attack-right":1093,"player-charge-right":1054,"player-sitting-up":1172,"player-pulling-up-idle":1560,"player-pulling-up":{from:1560,to:1563,loop:!0},"player-pulling-side-idle":1521,"player-pulling-side":{from:1521,to:1524,loop:!0},"player-pulling-down-idle":1482,"player-pulling-down":{from:1482,to:1485,loop:!0},"slash-up":{from:1087,to:1091,loop:!1},"slash-down":{from:1126,to:1130,loop:!1},"slash-left":{from:1048,to:1052,loop:!1},"slash-right":{from:1009,to:1013,loop:!1},"slime-idle-down":858,"slime-down":{from:858,to:859,loop:!0},"slime-idle-side":860,"slime-side":{from:860,to:861,loop:!0},"slime-idle-up":897,"slime-up":{from:897,to:898,loop:!0},"lumberjack-idle-down":948,"lumberjack-idle-side":989,"lumberjack-idle-up":1026,"oldman-idle-down":866,"oldman-idle-side":907,"oldman-idle-up":905,"shopkeeper-idle-down":964,"shopkeeper-idle-side":1003,"shopkeeper-idle-up":1042,"prisoner-idle-down":940,"prisoner-down":{from:940,to:943,loop:!0},"prisoner-idle-side":979,"prisoner-side":{from:980,to:982,loop:!0},"prisoner-idle-up":1018,"prisoner-up":{from:1018,to:1021,loop:!0},"prison-door-closed":505,"prison-door-opened":506,"ghost-down":{from:862,to:863,loop:!0},"wizard-idle-down":792,"wizard-idle-side":793,"wizard-idle-up":794,"secret-passage":414,"pressure-plate-up":618,"pressure-plate-down":619,"guard-1-idle-down":944,"guard-2-idle-down":679,"guard-3-idle-down":679,"guard-3-down":{from:679,to:682,loop:!0},"guard-3-idle-up":767,"guard-3-up":{from:757,to:760,loop:!0},"king-sitting-down":918,"farmer-idle-down":1209,"farmer-idle-side":1248,"farmer-idle-up":1287,"bartender-idle-down":1213,"frog-idle-down":789}});Q.loadSprite("dungeonDoor","./assets/dungeonDoor.png",{sliceX:4,sliceY:1,anims:{"dungeon-door-1":0,"dungeon-door-2":1,"dungeon-door-3":2,"dungeon-door-4":3}});Q.loadSprite("fence-door","./assets/fence-door.png",{sliceX:2,sliceY:1,anims:{"fence-door-closed":0,"fence-door-opened":1}});Q.loadSprite("shifting-walls","./assets/shifting-walls.png",{sliceX:7,sliceY:1,anims:{"wall-1":0,"wall-2":1,"wall-3":2,"wall-4":3,"wall-5":4,"wall-6":5,"wall-7":6}});Q.loadSprite("bean-stalk","./assets/bean-stalk.png",{sliceX:6,sliceY:1,anims:{"bean-stalk-1":0,"bean-stalk-2":1,"bean-stalk-3":2,"bean-stalk-4":3,"bean-stalk-5":4,"bean-stalk-6":5}});Q.loadSprite("snake","./assets/snake.png",{sliceX:4,sliceY:6,anims:{"snake-idle-side":0,"snake-side":{from:0,to:3,loop:!0},"snake-idle-down":4,"snake-down":{from:4,to:7,loop:!0},"snake-idle-up":8,"snake-up":{from:8,to:11,loop:!0},"snake-attack-side":{from:12,to:15,loop:!1},"snake-attack-down":{from:16,to:19,loop:!1},"snake-attack-up":{from:20,to:23,loop:!1}}});Q.loadSpriteAtlas("./assets/topdownasset.png",{"full-heart":{x:0,y:224,width:48,height:48},"half-heart":{x:48,y:224,width:48,height:48},"empty-heart":{x:96,y:224,width:48,height:48},"health-potion":{x:0,y:272,width:48,height:48},"sword-icon":{x:192,y:224,width:48,height:48},key:{x:96,y:272,width:48,height:48},carrot:{x:144,y:272,width:48,height:48},"magical-beans":{x:192,y:272,width:48,height:48},"tavern-supplies":{x:192,y:176,width:48,height:48},crown:{x:144,y:176,width:48,height:48}});Q.loadSprite("smoke","./assets/smoke.png",{sliceX:7,sliceY:1,anims:{smoke:{from:0,to:6,loop:!1}}});Q.loadSpriteAtlas("./assets/smoke.png",{"smoke-1":{x:0,y:0,width:32,height:32},"smoke-2":{x:32,y:0,width:32,height:32},"smoke-3":{x:64,y:0,width:32,height:32},"smoke-4":{x:96,y:0,width:32,height:32}});Q.loadSprite("cow","./assets/cow.png",{sliceX:4,sliceY:3,anims:{"cow-idle-down":4,"cow-down":{from:4,to:7,loop:!0},"cow-idle-side":0,"cow-side":{from:0,to:3,loop:!0},"cow-idle-up":8,"cow-up":{from:8,to:11,loop:!0}}});Q.loadSprite("world-map","./assets/world-map.png");Q.loadSprite("oldman-portrait","./assets/oldman-portrait.png");Q.loadSprite("flower","./assets/flower.png",{sliceX:2});Q.loadSprite("big-tree","./assets/big-tree.png",{sliceX:4});Q.loadSprite("leaf","./assets/leaf.png");Q.loadSound("soundtrack","./assets/sounds/soundtrack.mp3");Q.loadSound("basement-soundtrack","./assets/sounds/basement-soundtrack.mp3");Q.loadSound("castle-soundtrack","./assets/sounds/castle-soundtrack.mp3");Q.loadSound("troll-dinner-soundtrack","./assets/sounds/23 - Road.ogg");Q.loadSound("dialogue","./assets/sounds/dialogue.mp3");Q.loadSound("sword-swing","./assets/sounds/sword-swing.mp3");Q.loadSound("item","./assets/sounds/item.mp3");Q.loadSound("drink","./assets/sounds/drink.mp3");Q.loadSound("chest-open","./assets/sounds/chest-open.mp3");Q.loadSound("player-hurt","./assets/sounds/player-hurt.mp3");Q.loadSound("door-open","./assets/sounds/door-open.mp3");const Ts={mainMenu:up,world:ic,house:uc,shop:Ac,"shop-second-floor":Sc,basement:Fc,tower:Gc,"tower-second-floor":zc,castle:uh,"castle-main":fh,"throne-room":yh,barn:Ah,tavern:Nh,"tavern-second-floor":Lh,forest:Uh,"witch-house":$h,"witch-house-inside":Zh,"forest-east":Qh,"castle-main-underground":gh,town:ah,"troll-dinner":_h,"bean-stalk":kh,clouds:ep,"wolf-house":ip,swamp:ap,village:rp,mountain:op,"world-map":cp};for(const e in Ts)e==="world-map"?Q.scene(e,t=>Ts[e](Q,t)):Q.scene(e,()=>Ts[e](Q));Q.go("mainMenu");Q.setVolume(.3);
