(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();var ia=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return n=>{for(var i=n.length,s=new Uint8Array((i-(n[i-1]=="=")-(n[i-2]=="="))*3/4|0),r=0,a=0;r<i;){var l=e[n.charCodeAt(r++)],o=e[n.charCodeAt(r++)],u=e[n.charCodeAt(r++)],d=e[n.charCodeAt(r++)];s[a++]=l<<2|o>>4,s[a++]=o<<4|u>>2,s[a++]=u<<6|d}return s}})(),ra={version:"3001.0.19"};function tt(e,t,n){return t>n?tt(e,n,t):Math.min(Math.max(e,t),n)}var Z=class ve{r=255;g=255;b=255;constructor(t,n,i){this.r=tt(t,0,255),this.g=tt(n,0,255),this.b=tt(i,0,255)}static fromArray(t){return new ve(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new ve(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!n)throw new Error("Invalid hex color format");return new ve(parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,n,i){if(n==0)return new ve(255*i,255*i,255*i);let s=(d,f,c)=>(c<0&&(c+=1),c>1&&(c-=1),c<1/6?d+(f-d)*6*c:c<1/2?f:c<2/3?d+(f-d)*(2/3-c)*6:d),r=i<.5?i*(1+n):i+n-i*n,a=2*i-r,l=s(a,r,t+1/3),o=s(a,r,t),u=s(a,r,t-1/3);return new ve(Math.round(l*255),Math.round(o*255),Math.round(u*255))}static RED=new ve(255,0,0);static GREEN=new ve(0,255,0);static BLUE=new ve(0,0,255);static YELLOW=new ve(255,255,0);static MAGENTA=new ve(255,0,255);static CYAN=new ve(0,255,255);static WHITE=new ve(255,255,255);static BLACK=new ve(0,0,0);clone(){return new ve(this.r,this.g,this.b)}lighten(t){return new ve(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new ve(255-this.r,255-this.g,255-this.b)}mult(t){return new ve(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,n){return new ve(Ne(this.r,t.r,n),Ne(this.g,t.g,n),Ne(this.b,t.b,n))}toHSL(){let t=this.r/255,n=this.g/255,i=this.b/255,s=Math.max(t,n,i),r=Math.min(t,n,i),a=(s+r)/2,l=a,o=a;if(s==r)a=l=0;else{let u=s-r;switch(l=o>.5?u/(2-s-r):u/(s+r),s){case t:a=(n-i)/u+(n<i?6:0);break;case n:a=(i-t)/u+2;break;case i:a=(t-n)/u+4;break}a/=6}return[a,l,o]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function ne(...e){if(e.length===0)return new Z(255,255,255);if(e.length===1){if(e[0]instanceof Z)return e[0].clone();if(typeof e[0]=="string")return Z.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Z.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof Z)return e[0].clone()}else if(e.length===3||e.length===4)return new Z(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var aa=(e,t,n)=>Z.fromHSL(e,t,n);function Ae(e){return e*Math.PI/180}function St(e){return e*180/Math.PI}function Ne(e,t,n){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*n;if(e instanceof P&&t instanceof P||e instanceof Z&&t instanceof Z)return e.lerp(t,n);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function et(e,t,n,i,s){return i+(e-t)/(n-t)*(s-i)}function oa(e,t,n,i,s){return tt(et(e,t,n,i,s),i,s)}var P=class Se{x=0;y=0;constructor(t=0,n=t){this.x=t,this.y=n}static fromAngle(t){let n=Ae(t);return new Se(Math.cos(n),Math.sin(n))}static fromArray(t){return new Se(t[0],t[1])}static ZERO=new Se(0,0);static ONE=new Se(1,1);static LEFT=new Se(-1,0);static RIGHT=new Se(1,0);static UP=new Se(0,-1);static DOWN=new Se(0,1);clone(){return new Se(this.x,this.y)}add(...t){let n=x(...t);return new Se(this.x+n.x,this.y+n.y)}sub(...t){let n=x(...t);return new Se(this.x-n.x,this.y-n.y)}scale(...t){let n=x(...t);return new Se(this.x*n.x,this.y*n.y)}dist(...t){let n=x(...t);return this.sub(n).len()}sdist(...t){let n=x(...t);return this.sub(n).slen()}static sdist(t,n){let i=t.x-n.x,s=t.y-n.y;return i*i+s*s}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new Se(0):this.scale(1/t)}normal(){return new Se(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,n){return t.x*n.x+t.y*n.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,n){return t.x*n.y-t.y*n.x}angle(...t){let n=x(...t);return St(Math.atan2(this.y-n.y,this.x-n.x))}angleBetween(...t){let n=x(...t);return St(Math.atan2(this.cross(n),this.dot(n)))}lerp(t,n){return new Se(Ne(this.x,t.x,n),Ne(this.y,t.y,n))}slerp(t,n){let i=this.dot(t),s=this.cross(t),r=Math.atan2(s,i);return this.scale(Math.sin((1-n)*r)).add(t.scale(Math.sin(n*r))).scale(1/s)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new Se(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new ae(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function x(...e){if(e.length===1){if(e[0]instanceof P)return new P(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new P(...e[0])}return new P(...e)}var pe=class ws{x=0;y=0;w=1;h=1;constructor(t,n,i,s){this.x=t,this.y=n,this.w=i,this.h=s}scale(t){return new ws(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new P(this.x,this.y)}clone(){return new ws(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function be(e,t,n,i){return new pe(e,t,n,i)}var On=class jt{a;b;c;d;constructor(t,n,i,s){this.a=t,this.b=n,this.c=i,this.d=s}mul(t){return new jt(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return x(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new jt(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new jt(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,n=this.det,i=t+Math.sqrt(t*t-n),s=t-Math.sqrt(t*t-n);return[i,s]}eigenvectors(t,n){return this.c!=0?[[t-this.d,this.c],[n-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,n-this.a]]:Math.abs(this.transform(x(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let n=Math.cos(t),i=Math.sin(t);return new jt(n,i,-i,n)}static scale(t,n){return new jt(t,0,0,n)}},_t=class kt{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(t,n,i,s,r,a,l,o,u){this.m11=t,this.m12=n,this.m13=i,this.m21=s,this.m22=r,this.m23=a,this.m31=l,this.m32=o,this.m33=u}static fromMat2(t){return new kt(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new On(this.m11,this.m12,this.m21,this.m22)}mul(t){return new kt(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let n=Math.cos(t),i=Math.sin(t),s=this.m11,r=this.m12;return this.m11=n*this.m11+i*this.m21,this.m12=n*this.m12+i*this.m22,this.m21=n*this.m21-i*s,this.m22=n*this.m22-i*r,this}scale(t,n){return this.m11*=t,this.m12*=t,this.m21*=n,this.m22*=n,this}get inverse(){let t=this.det;return new kt((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new kt(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},nt=class at{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(t){t&&(this.m=t)}static translate(t){return new at([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new at([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=Ae(-t);let n=Math.cos(t),i=Math.sin(t);return new at([1,0,0,0,0,n,-i,0,0,i,n,0,0,0,0,1])}static rotateY(t){t=Ae(-t);let n=Math.cos(t),i=Math.sin(t);return new at([n,0,i,0,0,1,0,0,-i,0,n,0,0,0,0,1])}static rotateZ(t){t=Ae(-t);let n=Math.cos(t),i=Math.sin(t);return new at([n,-i,0,0,i,n,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=Ae(-t);let n=Math.cos(t),i=Math.sin(t),s=this.m[0],r=this.m[1],a=this.m[4],l=this.m[5];return this.m[0]=s*n+r*i,this.m[1]=-s*i+r*n,this.m[4]=a*n+l*i,this.m[5]=-a*i+l*n,this}mult(t){let n=[];for(let i=0;i<4;i++)for(let s=0;s<4;s++)n[i*4+s]=this.m[0+s]*t.m[i*4+0]+this.m[4+s]*t.m[i*4+1]+this.m[8+s]*t.m[i*4+2]+this.m[12+s]*t.m[i*4+3];return new at(n)}multVec2(t){return new P(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new P(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],n=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new P(n,t/n)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],n=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new P(t/n,n)}else return new P(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return St(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return St(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new P(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new P(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new P(0,0)}invert(){let t=[],n=this.m[10]*this.m[15]-this.m[14]*this.m[11],i=this.m[9]*this.m[15]-this.m[13]*this.m[11],s=this.m[9]*this.m[14]-this.m[13]*this.m[10],r=this.m[8]*this.m[15]-this.m[12]*this.m[11],a=this.m[8]*this.m[14]-this.m[12]*this.m[10],l=this.m[8]*this.m[13]-this.m[12]*this.m[9],o=this.m[6]*this.m[15]-this.m[14]*this.m[7],u=this.m[5]*this.m[15]-this.m[13]*this.m[7],d=this.m[5]*this.m[14]-this.m[13]*this.m[6],f=this.m[4]*this.m[15]-this.m[12]*this.m[7],c=this.m[4]*this.m[14]-this.m[12]*this.m[6],g=this.m[5]*this.m[15]-this.m[13]*this.m[7],p=this.m[4]*this.m[13]-this.m[12]*this.m[5],w=this.m[6]*this.m[11]-this.m[10]*this.m[7],y=this.m[5]*this.m[11]-this.m[9]*this.m[7],v=this.m[5]*this.m[10]-this.m[9]*this.m[6],C=this.m[4]*this.m[11]-this.m[8]*this.m[7],D=this.m[4]*this.m[10]-this.m[8]*this.m[6],F=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*n-this.m[6]*i+this.m[7]*s,t[4]=-(this.m[4]*n-this.m[6]*r+this.m[7]*a),t[8]=this.m[4]*i-this.m[5]*r+this.m[7]*l,t[12]=-(this.m[4]*s-this.m[5]*a+this.m[6]*l),t[1]=-(this.m[1]*n-this.m[2]*i+this.m[3]*s),t[5]=this.m[0]*n-this.m[2]*r+this.m[3]*a,t[9]=-(this.m[0]*i-this.m[1]*r+this.m[3]*l),t[13]=this.m[0]*s-this.m[1]*a+this.m[2]*l,t[2]=this.m[1]*o-this.m[2]*u+this.m[3]*d,t[6]=-(this.m[0]*o-this.m[2]*f+this.m[3]*c),t[10]=this.m[0]*g-this.m[1]*f+this.m[3]*p,t[14]=-(this.m[0]*d-this.m[1]*c+this.m[2]*p),t[3]=-(this.m[1]*w-this.m[2]*y+this.m[3]*v),t[7]=this.m[0]*w-this.m[2]*C+this.m[3]*D,t[11]=-(this.m[0]*y-this.m[1]*C+this.m[3]*F),t[15]=this.m[0]*v-this.m[1]*D+this.m[2]*F;let M=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let b=0;b<4;b++)for(let A=0;A<4;A++)t[b*4+A]*=1/M;return new at(t)}clone(){return new at([...this.m])}toString(){return this.m.toString()}};function Fi(e,t,n,i=s=>-Math.cos(s)){return e+(i(n)+1)/2*(t-e)}var la=1103515245,ua=12345,hi=2147483648,Oi=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(la*this.seed+ua)%hi,this.seed/hi}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new P(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new Z(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof P)return this.genVec2(x(0,0),e[0]);if(e[0]instanceof Z)return this.genColor(ne(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof P&&e[1]instanceof P)return this.genVec2(e[0],e[1]);if(e[0]instanceof Z&&e[1]instanceof Z)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},vs=new Oi(Date.now());function da(e){return e!=null&&(vs.seed=e),vs.seed}function Pe(...e){return vs.genAny(...e)}function ji(...e){return Math.floor(Pe(...e.length>0?e:[2]))}function ca(e){return Pe()<=e}function Ni(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function ha(e,t){return e.length<=t?e.slice():Ni(e.slice()).slice(0,t)}function fa(e){return e[ji(e.length)]}function Li(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function pa(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let n=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(n===0)return null;let i=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/n,s=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/n;return i<0||i>1||s<0||s>1?null:i}function Us(e,t){let n=pa(e,t);return n?x(e.p1.x+n*(e.p2.x-e.p1.x),e.p1.y+n*(e.p2.y-e.p1.y)):null}function Gs(e,t){let n=t.p2.sub(t.p1),i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;if(n.x!=0){let r=(e.pos.x-t.p1.x)/n.x,a=(e.pos.x+e.width-t.p1.x)/n.x;i=Math.max(i,Math.min(r,a)),s=Math.min(s,Math.max(r,a))}if(n.y!=0){let r=(e.pos.y-t.p1.y)/n.y,a=(e.pos.y+e.height-t.p1.y)/n.y;i=Math.max(i,Math.min(r,a)),s=Math.min(s,Math.max(r,a))}return s>=i&&s>=0&&i<=1}function Yn(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function Ui(e,t){let n=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),i=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return x(n,i).sdist(t.center)<=t.radius*t.radius}function Gi(e,t){return Ki(t,new He(e.points()))}function Ks(e,t){let n=t.sub(e.p1),i=e.p2.sub(e.p1);if(Math.abs(n.cross(i))>Number.EPSILON)return!1;let s=n.dot(i)/i.dot(i);return s>=0&&s<=1}function pn(e,t){let n=e.p2.sub(e.p1),i=n.dot(n),s=e.p1.sub(t.center),r=2*n.dot(s),a=s.dot(s)-t.radius*t.radius,l=r*r-4*i*a;if(i<=Number.EPSILON||l<0)return!1;if(l==0){let o=-r/(2*i);if(o>=0&&o<=1)return!0}else{let o=(-r+Math.sqrt(l))/(2*i),u=(-r-Math.sqrt(l))/(2*i);if(o>=0&&o<=1||u>=0&&u<=1)return!0}return Wn(t,e.p1)}function Xs(e,t){if(pt(t,e.p1)||pt(t,e.p2))return!0;for(let n=0;n<t.pts.length;n++){let i=t.pts[n],s=t.pts[(n+1)%t.pts.length];if(Us(e,new Ue(i,s)))return!0}return!1}function Wn(e,t){return e.center.sdist(t)<e.radius*e.radius}function ga(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function Vn(e,t){let n=t.pts[t.pts.length-1];for(let i of t.pts){if(pn(new Ue(n,i),e))return!0;n=i}return Wn(e,t.pts[0])?!0:pt(t,e.center)}function Ki(e,t){for(let n=0;n<e.pts.length;n++)if(Xs(new Ue(e.pts[n],e.pts[(n+1)%e.pts.length]),t))return!0;return!!(e.pts.some(n=>pt(t,n))||t.pts.some(n=>pt(e,n)))}function pt(e,t){let n=!1,i=e.pts;for(let s=0,r=i.length-1;s<i.length;r=s++)i[s].y>t.y!=i[r].y>t.y&&t.x<(i[r].x-i[s].x)*(t.y-i[s].y)/(i[r].y-i[s].y)+i[s].x&&(n=!n);return n}function zs(e,t){t=t.sub(e.center);let n=Ae(e.angle),i=Math.cos(n),s=Math.sin(n),r=t.x*i+t.y*s,a=-t.x*s+t.y*i;return r*r/(e.radiusX*e.radiusX)+a*a/(e.radiusY*e.radiusY)<1}function jn(e,t){let n=t.center.sub(e.center),i=Ae(e.angle),s=Math.cos(i),r=Math.sin(i),a=n.x*s+n.y*r,l=-n.x*r+n.y*s;return zs(new ot(x(),e.radiusX+t.radius,e.radiusY+t.radius,0),x(a,l))}function Xi(e,t){let n=e.toMat2().inverse;return t=new Ue(n.transform(t.p1.sub(e.center)),n.transform(t.p2.sub(e.center))),pn(t,new Le(x(),1))}function ma(e,t){if(e.radiusX===e.radiusY)return jn(t,new Le(e.center,e.radiusX));if(t.radiusX===t.radiusY)return jn(e,new Le(t.center,t.radiusX));let n=new _t(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),i=new _t(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),s=e.center.x,r=e.center.y,a=t.center.x,l=t.center.y,o=Ae(e.angle),u=Ae(t.angle),d=new _t(Math.cos(o),-Math.sin(o),s,Math.sin(o),Math.cos(o),r,0,0,1),f=new _t(Math.cos(u),-Math.sin(u),a,Math.sin(u),Math.cos(u),l,0,0,1),c=d.inverse,g=f.inverse,p=c.transpose.mul(n).mul(c),w=g.transpose.mul(i).mul(g),y=p.m11,v=p.m12,C=p.m13,D=p.m21,F=p.m22,M=p.m23,b=p.m31,A=p.m32,I=p.m33,q=w.m11,B=w.m12,O=w.m13,L=w.m21,Q=w.m22,J=w.m23,$=w.m31,X=w.m32,U=w.m33,he=y*F*I-y*M*A-v*D*I+v*M*b+C*D*A-C*F*b,_=(y*F*U-y*M*X-y*A*J+y*I*Q-v*D*U+v*M*$+v*b*J-v*I*L+C*D*X-C*F*$-C*b*Q+C*A*L+D*A*O-D*I*B-F*b*O+F*I*q+M*b*B-M*A*q)/he,se=(y*Q*U-y*J*X-v*L*U+v*J*$+C*L*X-C*Q*$-D*B*U+D*O*X+F*q*U-F*O*$-M*q*X+M*B*$+b*B*J-b*O*Q-A*q*J+A*O*L+I*q*Q-I*B*L)/he,Me=(q*Q*U-q*J*X-B*L*U+B*J*$+O*L*X-O*Q*$)/he;if(_>=0){let K=-3*se+_**2,yt=3*_*Me+se*_**2-4*se**2,Rt=-27*Me**2+18*Me*_*se+_**2*se**2-4*_**3*Me-4*se**3;return!(K>0&&yt<0&&Rt>0)}else{let K=-3*se+_**2,yt=-27*Me**2+18*Me*_*se+_**2*se**2-4*_**3*Me-4*se**3;return!(K>0&&yt>0)}}function zi(e,t){return Ys(e,new He(t.points()))}function Ys(e,t){let n=e.toMat2().inverse;return t=new He(t.pts.map(i=>n.transform(i.sub(e.center)))),Vn(new Le(x(),1),t)}function ya(e,t){return e.x===t.x&&e.y===t.y}function wa(e,t){return t instanceof P?ya(t,e.pt):t instanceof Le?Wn(t,e.pt):t instanceof Ue?Ks(t,e.pt):t instanceof ae?Yn(t,e.pt):t instanceof He?pt(t,e.pt):t instanceof ot?zs(t,e.pt):!1}function va(e,t){return t instanceof P?Ks(e,t):t instanceof Le?pn(e,t):t instanceof Ue?Us(e,t)!=null:t instanceof ae?Gs(t,e):t instanceof He?Xs(e,t):t instanceof ot?Xi(t,e):!1}function ba(e,t){return t instanceof P?Wn(e,t):t instanceof Le?ga(e,t):t instanceof Ue?pn(t,e):t instanceof ae?Ui(t,e):t instanceof He?Vn(e,t):t instanceof ot?jn(t,e):!1}function Aa(e,t){return t instanceof P?Yn(e,t):t instanceof Le?Ui(e,t):t instanceof Ue?Gs(e,t):t instanceof ae?Li(e,t):t instanceof He?Gi(e,t):t instanceof ot?zi(t,e):!1}function xa(e,t){return t instanceof P?pt(e,t):t instanceof Le?Vn(t,e):t instanceof Ue?Xs(t,e):t instanceof ae?Gi(t,e):t instanceof He?Ki(t,e):t instanceof ot?Ys(t,e):!1}function Sa(e,t){return t instanceof P?zs(e,t):t instanceof Le?jn(e,t):t instanceof Ue?Xi(e,t):t instanceof ae?zi(e,t):t instanceof He?Ys(e,t):t instanceof ot?ma(t,e):!1}function Yi(e,t,n){let i=e,s=n.p1,r=n.p2,a=t,l=r.sub(s),o=a.cross(l);if(Math.abs(o)<Number.EPSILON)return null;let u=s.sub(i),d=u.cross(l)/o;if(d<=0||d>=1)return null;let f=u.cross(a)/o;if(f<=0||f>=1)return null;let c=l.normal().unit();return t.dot(c)>0&&(c.x*=-1,c.y*=-1),{point:i.add(a.scale(d)),normal:c,fraction:d}}function Pa(e,t,n){let i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,r;if(e.x!=0){let a=(n.pos.x-e.x)/t.x,l=(n.pos.x+n.width-e.x)/t.x;r=x(-Math.sign(t.x),0),i=Math.max(i,Math.min(a,l)),s=Math.min(s,Math.max(a,l))}if(e.y!=0){let a=(n.pos.y-e.y)/t.y,l=(n.pos.y+n.height-e.y)/t.y;Math.min(a,l)>i&&(r=x(0,-Math.sign(t.y))),i=Math.max(i,Math.min(a,l)),s=Math.min(s,Math.max(a,l))}return s>=i&&i>=0&&i<=1?{point:e.add(t.scale(i)),normal:r,fraction:i}:null}function Wi(e,t,n){let i=e,s=n.center,r=t,a=r.dot(r),l=i.sub(s),o=2*r.dot(l),u=l.dot(l)-n.radius*n.radius,d=o*o-4*a*u;if(a<=Number.EPSILON||d<0)return null;if(d==0){let f=-o/(2*a);if(f>=0&&f<=1){let c=i.add(r.scale(f));return{point:c,normal:c.sub(s),fraction:f}}}else{let f=(-o+Math.sqrt(d))/(2*a),c=(-o-Math.sqrt(d))/(2*a),g=null;if(f>=0&&f<=1&&(g=f),c>=0&&c<=1&&(g=Math.min(c,g??c)),g!=null){let p=i.add(r.scale(g));return{point:p,normal:p.sub(s).unit(),fraction:g}}}return null}function Ea(e,t,n){let i=n.pts,s=null,r=i[i.length-1];for(let a=0;a<i.length;a++){let l=i[a],o=Yi(e,t,new Ue(r,l));o&&(!s||s.fraction>o.fraction)&&(s=o),r=l}return s}function Ma(e,t,n){let i=n.toMat2(),s=i.inverse,r=s.transform(e.sub(n.center)),a=s.transform(t),l=Wi(r,a,new Le(x(),1));if(l){let o=On.rotation(Ae(-n.angle)),u=On.scale(n.radiusX,n.radiusY).transform(l.point),d=i.transform(l.point).add(n.center),f=d.dist(e)/t.len();return{point:d,normal:o.transform(x(n.radiusY**2*u.x,n.radiusX**2*u.y)).unit(),fraction:f}}return l}function Ca(e,t,n,i=64){let s=e,r=t.len(),a=t.scale(1/r),l=0,o=x(Math.floor(e.x),Math.floor(e.y)),u=x(a.x>0?1:-1,a.y>0?1:-1),d=x(Math.abs(1/a.x),Math.abs(1/a.y)),f=x(u.x>0?o.x+1-e.x:e.x-o.x,u.y>0?o.y+1-e.y:e.y-o.y),c=x(d.x<1/0?d.x*f.x:1/0,d.y<1/0?d.y*f.y:1/0),g=-1;for(;l<=i;){let p=n(o);if(p===!0)return{point:s.add(a.scale(l)),normal:x(g===0?-u.x:0,g===1?-u.y:0),fraction:l/r,gridPos:o};if(p)return p;c.x<c.y?(o.x+=u.x,l=c.x,c.x+=d.x,g=0):(o.y+=u.y,l=c.y,c.y+=d.y,g=1)}return null}var Ta=class bs{pt;constructor(t){this.pt=t.clone()}transform(t){return new bs(t.multVec2(this.pt))}bbox(){return new ae(this.pt,0,0)}area(){return 0}clone(){return new bs(this.pt)}collides(t){return wa(this,t)}contains(t){return this.pt.eq(t)}raycast(t,n){return null}random(){return this.pt.clone()}},Ue=class As{p1;p2;constructor(t,n){this.p1=t.clone(),this.p2=n.clone()}transform(t){return new As(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return ae.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new As(this.p1,this.p2)}collides(t){return va(this,t)}contains(t){return this.collides(t)}raycast(t,n){return Yi(t,n,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(Pe(1)))}},ae=class xs{pos;width;height;constructor(t,n,i){this.pos=t.clone(),this.width=n,this.height=i}static fromPoints(t,n){return new xs(t.clone(),n.x-t.x,n.y-t.y)}center(){return new P(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new He(this.points().map(n=>t.multVec2(n)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new xs(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let n=this.pos,i=this.pos.add(this.width,this.height),s=Math.max(n.x-t.x,0,t.x-i.x),r=Math.max(n.y-t.y,0,t.y-i.y);return s*s+r*r}collides(t){return Aa(this,t)}contains(t){return this.collides(t)}raycast(t,n){return Pa(t,n,this)}random(){return this.pos.add(Pe(this.width),Pe(this.height))}},Le=class Vi{center;radius;constructor(t,n){this.center=t.clone(),this.radius=n}transform(t){return new ot(this.center,this.radius,this.radius).transform(t)}bbox(){return ae.fromPoints(this.center.sub(x(this.radius)),this.center.add(x(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new Vi(this.center,this.radius)}collides(t){return ba(this,t)}contains(t){return this.collides(t)}raycast(t,n){return Wi(t,n,this)}random(){return this.center.add(P.fromAngle(Pe(360)).scale(Pe(this.radius)))}},ot=class Nt{center;radiusX;radiusY;angle;constructor(t,n,i,s=0){this.center=t.clone(),this.radiusX=n,this.radiusY=i,this.angle=s}static fromMat2(t){let n=t.inverse,i=n.transpose.mul(n),[s,r]=i.eigenvalues,[a,l]=i.eigenvectors(s,r),[o,u]=[1/Math.sqrt(s),1/Math.sqrt(r)];return o>u?new Nt(x(),o,u,St(Math.atan2(-a[1],a[0]))):new Nt(x(),u,o,St(Math.atan2(-l[1],l[0])))}toMat2(){let t=Ae(this.angle),n=Math.cos(t),i=Math.sin(t);return new On(n*this.radiusX,-i*this.radiusY,i*this.radiusX,n*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new Nt(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let n=this.toMat2(),i=t.getRotation(),s=t.getScale();n=_t.fromMat2(n).scale(s.x,s.y).rotate(i).toMat2();let r=Nt.fromMat2(n);return r.center=t.multVec2(this.center),r}}bbox(){if(this.angle==0)return ae.fromPoints(this.center.sub(x(this.radiusX,this.radiusY)),this.center.add(x(this.radiusX,this.radiusY)));{let t=Ae(this.angle),n=Math.cos(t),i=Math.sin(t),s=this.radiusX*n,r=this.radiusX*i,a=this.radiusY*i,l=this.radiusY*n,o=Math.sqrt(s*s+a*a),u=Math.sqrt(r*r+l*l);return ae.fromPoints(this.center.sub(x(o,u)),this.center.add(x(o,u)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new Nt(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return Sa(this,t)}contains(t){t=t.sub(this.center);let n=Ae(this.angle),i=Math.cos(n),s=Math.sin(n),r=t.x*i+t.y*s,a=-t.x*s+t.y*i;return r*r/(this.radiusX*this.radiusX)+a*a/(this.radiusY*this.radiusY)<1}raycast(t,n){return Ma(t,n,this)}random(){return this.center}};function Ia(e,t,n,i){let s=t.sub(e),r=i.sub(n),a=s.cross(r);return a<1e-5&&a>-1e-5||(a=n.sub(e).cross(r)/a,a<0||a>1)?null:e.add(s.scale(a))}var He=class en{pts;constructor(t){if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new en(this.pts.map(n=>t.multVec2(n)))}bbox(){let t=x(Number.MAX_VALUE),n=x(-Number.MAX_VALUE);for(let i of this.pts)t.x=Math.min(t.x,i.x),n.x=Math.max(n.x,i.x),t.y=Math.min(t.y,i.y),n.y=Math.max(n.y,i.y);return ae.fromPoints(t,n)}area(){let t=0,n=this.pts.length;for(let i=0;i<n;i++){let s=this.pts[i],r=this.pts[(i+1)%n];t+=s.x*r.y*.5,t-=r.x*s.y*.5}return Math.abs(t)}clone(){return new en(this.pts.map(t=>t.clone()))}collides(t){return xa(this,t)}contains(t){return this.collides(t)}raycast(t,n){return Ea(t,n,this)}random(){return x()}cut(t,n){new Ue(t,n);let i=[],s=[],r=n.sub(t),a=this.pts[this.pts.length-1],l=a.sub(t),o=r.cross(l)>0;return this.pts.forEach(u=>{l=u.sub(t);let d=r.cross(l)>0;if(o!=d){let f=Ia(a,u,t,n);i.push(f),s.push(f),o=d}(d?i:s).push(u),a=u}),[i.length?new en(i):null,s.length?new en(s):null]}};function Da(e,t,n,i){let s=i*i,r=1-i,a=r*r;return e.scale(a).add(t.scale(2*r*i)).add(n.scale(s))}function qa(e,t,n,i){let s=1-i;return t.sub(e).scale(2*s).add(n.sub(t).scale(2*i))}function Ba(e,t,n,i){return n.sub(t.scale(2)).add(e).scale(2)}function Ws(e,t,n,i,s){let r=s*s,a=r*s,l=1-s,o=l*l,u=o*l;return e.scale(u).add(t.scale(3*o*s)).add(n.scale(3*l*r)).add(i.scale(a))}function Ra(e,t,n,i,s){let r=s*s,a=1-s,l=a*a;return t.sub(e).scale(3*l).add(n.sub(t).scale(6*a*s)).add(i.sub(n).scale(3*r))}function Ha(e,t,n,i,s){let r=1-s;return n.sub(t.scale(2)).add(e).scale(6*r).add(i.sub(n.scale(2)).add(t).scale(6*s))}function Fa(e,t,n,i,s){let r=.5*(((-s+2)*s-1)*s),a=.5*((3*s-5)*s*s+2),l=.5*(((-3*s+4)*s+1)*s),o=.5*((s-1)*s*s);return e.scale(r).add(t.scale(a)).add(n.scale(l)).add(i.scale(o))}function Oa(e,t,n,i,s){let r=.5*((-3*s+4)*s-1),a=.5*((9*s-10)*s),l=.5*((-9*s+8)*s+1),o=.5*((3*s-2)*s);return e.scale(r).add(t.scale(a)).add(n.scale(l)).add(i.scale(o))}function ja(e){let t=Qi(e),n=t(1);return i=>{let s=i*n,r=t(s,!0);return e(r)}}function Qi(e,t=10,n=10){let i=[0],s=[0],r=1/(t-1)/n,a=0,l=e(0),o=0;for(let u=1;u<t;u++){for(let d=0;d<n;d++){o+=r;let f=e(o),c=f.dist(l);a+=c,l=f}i[u]=a,s[u]=o}return s[t-1]=1,(u,d=!1)=>{if(d){let f=u;if(f<=0)return 0;if(f>=a)return 1;let c=0;for(;i[c+1]<f;)c++;let g=s[c],p=s[c+1],w=i[c],y=i[c+1],v=(f-w)/(y-w);return g+(p-g)*v}else{if(u<=0)return 0;if(u>=1)return i[t-1];let f=0;for(;s[f+1]<u;)f++;let c=s[f],g=s[f+1],p=i[f],w=i[f+1],y=(u-c)/(g-c);return p+(w-p)*y}}}function gn(e,t,n,i){let s=2*e+t-2*i+n,r=-3*e+3*i-2*t-n,a=t,l=e;return o=>{let u=o*o,d=u*o;return s*d+r*u+a*o+l}}function Ji(e,t,n,i,s,r=gn){let a=r(t.x,(1-s)*(n.x-e.x),(1-s)*(i.x-t.x),n.x),l=r(t.y,(1-s)*(n.y-e.y),(1-s)*(i.y-t.y),n.y);return o=>new P(a(o),l(o))}function Nn(e,t,n,i,s=gn){return Ji(e,t,n,i,.5,s)}function Na(e,t,n,i,s=gn){return Nn(i.add(e.sub(t).scale(6)),e,i,e.add(i.sub(n).scale(6)),s)}function La(e,t,n,i,s,r,a,l=gn){let o=l(t.x,.5*(1-s)*(1+a)*(1+r)*(t.x-e.x)+.5*(1-s)*(1-a)*(1-r)*(n.x-t.x),.5*(1-s)*(1+a)*(1-r)*(n.x-t.x)+.5*(1-s)*(1-a)*(1+r)*(i.x-n.x),n.x),u=l(t.y,.5*(1-s)*(1+a)*(1+r)*(t.y-e.y)+.5*(1-s)*(1-a)*(1-r)*(n.y-t.y),.5*(1-s)*(1+a)*(1-r)*(n.y-t.y)+.5*(1-s)*(1-a)*(1+r)*(i.y-n.y),n.y);return d=>new P(o(d),u(d))}function Ua(e,t,n,i){let s=2*e+t-2*i+n,r=-3*e+3*i-2*t+n,a=t;return l=>{let o=l*l;return 3*s*o+2*r*l+a}}function Jt(e){return 0<=e&&e<=1}function ls(e,t){return Math.abs(e-t)<=Number.EPSILON}function Zt(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Ga(e,t,n,i){let s=3*e-6*t+3*n,r=-3*e+3*t,a=e,l=-e+3*t-3*n+i;if(ls(l,0)){if(ls(s,0))return ls(r,0)?[]:[-a/r].filter(Jt);let y=Math.sqrt(r*r-4*s*a),v=2*s;return[(y-r)/v,(-r-y)/v].filter(Jt)}s/=l,r/=l,a/=l;let o=(3*r-s*s)/3,u=o/3,d=(2*s*s*s-9*s*r+27*a)/27,f=d/2,c=f*f+u*u*u;if(c<0){let y=-o/3,v=y*y*y,C=Math.sqrt(v),D=-d/(2*C),F=D<-1?-1:D>1?1:D,M=Math.acos(F),b=2*Zt(C),A=b*Math.cos(M/3)-s/3,I=b*Math.cos((M+2*Math.PI)/3)-s/3,q=b*Math.cos((M+4*Math.PI)/3)-s/3;return[A,I,q].filter(Jt)}if(c===0){let y=f<0?Zt(-f):-Zt(f),v=2*y-s/3,C=-y-s/3;return[v,C].filter(Jt)}let g=Math.sqrt(c),p=Zt(g-f),w=Zt(g+f);return[p-w-s/3].filter(Jt)}function Ka(e,t,n,i,s){let r=Ga(e.x-s,t.x-s,n.x-s,i.x-s);return r.length>0?Ws(e,t,n,i,r[0]).y:NaN}function Xa(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return n=>{if(n<=0||e.length==1||n<=e[0].x)return e[0].y;for(let i=0;i<t;i++)if(e[i].x>=n)return et(n,e[i-1].x,e[i].x,e[i-1].y,e[i].y);return e[e.length-1].y}}function za(e,t){return n=>Ka(x(0,0),e,t,x(1,1),n)}function Ya(e,t="jump-end"){let n=1/e,i=t=="jump-start"||t=="jump-both",s=t=="jump-end"||t=="jump-both",r=1/(e+(s?1:0)),a=i?r:0;return l=>{let o=Math.floor(l/n);return a+o*r}}function Wa(e,t){let n=Number.MAX_VALUE,i={normal:x(0),distance:0};for(let s of[e,t])for(let r=0;r<s.pts.length;r++){let a=s.pts[r],l=s.pts[(r+1)%s.pts.length].sub(a).normal().unit(),o=Number.MAX_VALUE,u=-Number.MAX_VALUE;for(let g=0;g<e.pts.length;g++){let p=e.pts[g].dot(l);o=Math.min(o,p),u=Math.max(u,p)}let d=Number.MAX_VALUE,f=-Number.MAX_VALUE;for(let g=0;g<t.pts.length;g++){let p=t.pts[g].dot(l);d=Math.min(d,p),f=Math.max(f,p)}let c=Math.min(u,f)-Math.max(o,d);if(c<0)return null;if(c<Math.abs(n)){let g=f-o,p=d-u;n=Math.abs(g)<Math.abs(p)?g:p,i.normal=l,i.distance=n}}return i}function Zi(e,t,n){return(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)>=0}function Va(e){let t=0,n=e[e.length-1];for(let i=0;i<e.length;i++)t+=(e[i].x-n.x)*(e[i].y+n.y),n=e[i];return t<0}function us(e,t,n,i){let s=i.x-n.x,r=i.y-n.y,a=s*(e.y-n.y)-r*(e.x-n.x),l=s*(t.y-n.y)-r*(t.x-n.x);return a*l>=0}function Qa(e,t,n,i){return us(e,t,n,i)&&us(e,n,t,i)&&us(e,i,t,n)}function Ja(e,t,n,i){for(let s of e)if(s!==t&&s!==n&&s!==i&&Qa(s,t,n,i))return!0;return!1}function Za(e,t,n,i){return Zi(e,t,n)&&!Ja(i,e,t,n)}function $i(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],n=[],i=0;for(let f=0;f<e.length;f++){let c=e[i],g=e[f];(g.x<c.x||g.x==c.x&&g.y<c.y)&&(i=i),t[f]=f+1,n[f]=f-1}t[t.length-1]=0,n[0]=n.length-1,Va(e)||([t,n]=[n,t]);let s=[];for(let f=0;f<e.length;++f)Zi(e[n[f]],e[f],e[t[f]])||s.push(e[f]);let r=[],a=e.length,l=1,o=0,u,d;for(;a>3;){u=t[l],d=n[l];let f=e[d],c=e[l],g=e[u];if(Za(f,c,g,s))r.push([f,c,g]),t[d]=u,n[u]=d,s.splice(s.indexOf(c),1),--a,o=0;else if(++o>a)return[];l=u}return u=t[l],d=n[l],r.push([e[d],e[l],e[u]]),r}function $a(e){if(e.length<3)return!1;let t=e.length-2,n=e.length-1,i=0,s=e[n].sub(e[t]),r=e[i].sub(e[n]),a=s.cross(r);for(;i+1<e.length;)if(t=n,n=i,i++,s=e[n].sub(e[t]),r=e[i].sub(e[n]),s.cross(r)*a<0)return!1;return!0}var _i=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",Qn="topleft",_a="monospace",Ln="monospace",Ss="linear",Vs=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],ka=Vs.reduce((e,t)=>e+t.size,0),ki=2048,eo=ki*4*ka,to=ki*6,no=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,so=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Ps=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Es=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,io=new Set(["id","require"]),ro=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),fi=200,ao=640,oo=65536,er=Symbol.for("kaplay.cancel"),tr=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},Tt=class nr{paused=!1;cancel;constructor(t){this.cancel=t}static join(t){let n=new nr(()=>t.forEach(i=>i.cancel()));return Object.defineProperty(n,"paused",{get:()=>t[0].paused,set:i=>t.forEach(s=>s.paused=i)}),n.paused=!1,n}static replace(t,n){return t.cancel=()=>n.cancel(),n.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>n.paused,set:i=>n.paused=i}),t}},Be=class{cancellers=new WeakMap;handlers=new tr;add(e){function t(...s){if(!i.paused)return e(...s)}let n=this.handlers.pushd(t),i=new Tt(n);return this.cancellers.set(t,n),i}addOnce(e){let t=this.add((...n)=>{t.cancel(),e(...n)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let n=t(...e),i;n===er&&(i=this.cancellers.get(t))&&i()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},un=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new Be),this.handlers[e].add(t)}onOnce(e,t){let n=this.on(e,(...i)=>{n.cancel(),t(...i)});return n}next(e){return new Promise(t=>{this.onOnce(e,(...n)=>t(n[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},lo=e=>e[0]instanceof Z,uo=e=>e[0]instanceof P,co=e=>typeof e[0]=="number",sr=class{_items;_compareFn;constructor(e=(t,n)=>t<n){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function ho(e){let t=window.atob(e),n=t.length,i=new Uint8Array(n);for(let s=0;s<n;s++)i[s]=t.charCodeAt(s);return i.buffer}function fo(e){return ho(e.split(",")[1])}function Qs(e,t){let n=document.createElement("a");n.href=t,n.download=e,n.click()}function ir(e,t){Qs(e,"data:text/plain;charset=utf-8,"+t)}function po(e,t){ir(e,JSON.stringify(t))}function pi(e,t){let n=URL.createObjectURL(t);Qs(e,n),URL.revokeObjectURL(n)}var rr=e=>e.match(/^data:\w+\/\w+;base64,.+/),go=e=>e.split(".").slice(0,-1).join(".");function Js(e,t){if(e===t)return!0;let n=typeof e,i=typeof t;if(n!==i)return!1;if(n==="object"&&i==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let s=Object.keys(e),r=Object.keys(t);if(s.length!==r.length)return!1;for(let a of s){let l=e[a],o=t[a];if(!Js(l,o))return!1}return!0}return!1}var gi=new Set,mo=e=>e instanceof Error?e.message:String(e);function yo(e){gi.has(e)||(gi.add(e),console.warn(e))}function Xt(e,t){yo(`${e} is deprecated. Use ${t} instead.`)}function Ms(e,t){return Number(e.toFixed(t))}function le(e,t){return(...n)=>{let i=n.length;if(i===e.length)return e(...n);if(i===t.length)return t(...n)}}var wo=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function vo(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],n=0,i=0;for(;n<e.length;){if(i+=bo(n+i,e),Co(e[n+i])&&i++,Po(e[n+i])&&i++,Eo(e[n+i])&&i++,To(e[n+i])){i++;continue}t.push(e.substring(n,n+i)),n+=i,i=0}return t}function bo(e,t){let n=t[e];if(!Ao(n)||e===t.length-1)return 1;let i=n+t[e+1],s=t.substring(e+2,e+5);return mi(i)&&mi(s)?4:xo(i)&&Mo(s)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:So(s)?4:2}function Ao(e){return e&&It(e[0].charCodeAt(0),55296,56319)}function mi(e){return It(Zs(e),127462,127487)}function xo(e){return It(Zs(e),127988,127988)}function So(e){return It(Zs(e),127995,127999)}function Po(e){return typeof e=="string"&&It(e.charCodeAt(0),65024,65039)}function Eo(e){return typeof e=="string"&&It(e.charCodeAt(0),8400,8447)}function Mo(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&It(t,917504,917631)}function Co(e){return typeof e=="string"&&wo.includes(e.charCodeAt(0))}function To(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function Zs(e){let t=e.charCodeAt(0)-55296,n=e.charCodeAt(1)-56320;return(t<<10)+n+65536}function It(e,t,n){return e>=t&&e<=n}var Xe=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,$e=(e,t)=>Array.isArray(t)?t.some(n=>e.has(n)):e.has(t),Pn=(e,t,n)=>{e.has(t)?e.get(t)?.push(n):e.set(t,[n])},Io=(()=>{let e=0;return()=>e++})(),Do={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function ar(){let e=h.globalOpt.pixelDensity??1,t=h.globalOpt.width,n=h.globalOpt.height,i=h.gfx.ggl.gl.drawingBufferWidth,s=h.gfx.ggl.gl.drawingBufferHeight,r=i/e,a=s/e,l=0,o=0,u=r,d=a;if(h.globalOpt.letterbox){if(!t||!n)throw new Error("Letterboxing requires width and height defined.");let f=r/a,c=t/n;if(f>c){let g=a*c;l=(r-g)/2,u=g}else{let g=r/c;d=g,o=(a-g)/2}}if(h.globalOpt.stretch&&(!h.globalOpt.width||!h.globalOpt.height))throw new Error("Stretching requires width and height defined.");h.gfx.viewport={x:l,y:o,width:u,height:d,scale:(h.gfx.viewport.width+h.gfx.viewport.height)/(h.gfx.width+h.gfx.height)}}function qo(e){return new P(e.x*h.gfx.viewport.width/h.gfx.width,e.y*h.gfx.viewport.height/h.gfx.height)}function rt(e){return new P((e.x-h.gfx.viewport.x)*h.gfx.width/h.gfx.viewport.width,(e.y-h.gfx.viewport.y)*h.gfx.height/h.gfx.viewport.height)}var Bo=()=>At.lastInputDevice,Ro=()=>{let e=At.buttons;for(let t in e){let n=e[t].keyboard&&[e[t].keyboard].flat(),i=e[t].keyboardCode&&[e[t].keyboardCode].flat(),s=e[t].gamepad&&[e[t].gamepad].flat(),r=e[t].mouse&&[e[t].mouse].flat();n&&n.forEach(a=>{Pn(At.buttonsByKey,a,t)}),i&&i.forEach(a=>{Pn(At.buttonsByKeyCode,a,t)}),s&&s.forEach(a=>{Pn(At.buttonsByGamepad,a,t)}),r&&r.forEach(a=>{Pn(At.buttonsByMouse,a,t)})}},rn=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},Ho=class{buttonState=new rn;stickState=new Map},Fo=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,n)=>t+n)/this.dts.length)),this.dts=[])}},At,yi=Do,Oo=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new Fo,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new P(0),mouseDeltaPos:new P(0),keyState:new rn,mouseState:new rn,mergedGamepadState:new Ho,gamepadStates:new Map,lastInputDevice:null,buttonState:new rn,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new un}},jo=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=Oo(e);At=t,Ro();function n(){return t.dt*t.timeScale}function i(){return t.fixedDt*t.timeScale}function s(){return t.restDt*t.timeScale}function r(){return t.isHidden}function a(){return t.time}function l(){return t.fpsCounter.fps}function o(){return t.numFrames}function u(){return t.canvas.toDataURL()}function d(m){t.canvas.style.cursor=m}function f(){return t.canvas.style.cursor}function c(m){if(m)try{let S=t.canvas.requestPointerLock();S?.catch&&S.catch(T=>console.error(T))}catch(S){console.error(S)}else document.exitPointerLock()}function g(){return!!document.pointerLockElement}function p(m){m.requestFullscreen?m.requestFullscreen():m.webkitRequestFullscreen&&m.webkitRequestFullscreen()}function w(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function y(m=!0){m?p(t.canvas):w()}function v(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function C(){t.stopped=!0;let m=Object.entries(Oe),S=Object.entries(as),T=Object.entries(Sn);for(let[R,te]of m)t.canvas.removeEventListener(R,te);for(let[R,te]of S)document.removeEventListener(R,te);for(let[R,te]of T)window.removeEventListener(R,te);ci.disconnect()}function D(m,S){t.loopID!==null&&cancelAnimationFrame(t.loopID);let T=0,R=0,te=fe=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(te);return}let Ke=fe/1e3,Ft=Math.min(Ke-t.realTime,.25),it=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Ke,R+=Ft,R>it){if(!t.skipTime){for(T+=R,t.dt=t.fixedDt,t.restDt=0;T>t.fixedDt;)T-=t.fixedDt,T<t.fixedDt&&(t.restDt=T),m();t.restDt=T,t.dt=R,t.time+=n(),t.fpsCounter.tick(t.dt)}R=0,t.skipTime=!1,t.numFrames++,S(kr,ea)}t.loopID=requestAnimationFrame(te)};te(0)}function F(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function M(){return t.mousePos.clone()}function b(){return t.mouseDeltaPos.clone()}function A(m="left"){return t.mouseState.pressed.has(m)}function I(m="left"){return t.mouseState.down.has(m)}function q(m="left"){return t.mouseState.released.has(m)}function B(){return t.isMouseMoved}function O(m){return m===void 0?t.keyState.pressed.size>0:$e(t.keyState.pressed,m)}function L(m){return m===void 0?t.keyState.pressedRepeat.size>0:$e(t.keyState.pressedRepeat,m)}function Q(m){return m===void 0?t.keyState.down.size>0:$e(t.keyState.down,m)}function J(m){return m===void 0?t.keyState.released.size>0:$e(t.keyState.released,m)}function $(m){return m===void 0?t.mergedGamepadState.buttonState.pressed.size>0:$e(t.mergedGamepadState.buttonState.pressed,m)}function X(m){return m===void 0?t.mergedGamepadState.buttonState.down.size>0:$e(t.mergedGamepadState.buttonState.down,m)}function U(m){return m===void 0?t.mergedGamepadState.buttonState.released.size>0:$e(t.mergedGamepadState.buttonState.released,m)}function he(m){return m===void 0?t.buttonState.pressed.size>0:$e(t.buttonState.pressed,m)}function _(m){return m===void 0?t.buttonState.down.size>0:$e(t.buttonState.down,m)}function se(m){return m===void 0?t.buttonState.released.size>0:$e(t.buttonState.released,m)}function Me(m){return t.buttons?.[m]}function K(m,S){t.buttons[m]={...t.buttons[m],...S}}function yt(m){t.buttonState.press(m),t.events.trigger("buttonPress",m)}function Rt(m){t.buttonState.release(m),t.events.trigger("buttonRelease",m)}function Vt(m){return t.events.on("resize",m)}let yn=le(m=>t.events.on("keyDown",m),(m,S)=>t.events.on("keyDown",T=>Xe(m,T)&&S(T))),wn=le(m=>t.events.on("keyPress",S=>m(S)),(m,S)=>t.events.on("keyPress",T=>Xe(m,T)&&S(T))),es=le(m=>t.events.on("keyPressRepeat",m),(m,S)=>t.events.on("keyPressRepeat",T=>Xe(m,T)&&S(T))),ts=le(m=>t.events.on("keyRelease",m),(m,S)=>t.events.on("keyRelease",T=>Xe(m,T)&&S(T))),Ht=le(m=>t.events.on("mouseDown",S=>m(S)),(m,S)=>t.events.on("mouseDown",T=>Xe(m,T)&&S(T))),Je=le(m=>t.events.on("mousePress",S=>m(S)),(m,S)=>t.events.on("mousePress",T=>Xe(m,T)&&S(T))),vn=le(m=>t.events.on("mouseRelease",S=>m(S)),(m,S)=>t.events.on("mouseRelease",T=>T===m&&S(T)));function j(m){return t.events.on("mouseMove",()=>m(M(),b()))}function z(m){return t.events.on("charInput",m)}function W(m){return t.events.on("touchStart",m)}function re(m){return t.events.on("touchMove",m)}function xe(m){return t.events.on("touchEnd",m)}function ee(m){return t.events.on("scroll",m)}function De(m){return t.events.on("hide",m)}function lt(m){return t.events.on("show",m)}let ns=le(m=>t.events.on("gamepadButtonPress",(S,T)=>m(S,T)),(m,S)=>t.events.on("gamepadButtonPress",(T,R)=>Xe(m,T)&&S(T,R))),ss=le(m=>t.events.on("gamepadButtonDown",(S,T)=>m(S,T)),(m,S)=>t.events.on("gamepadButtonDown",(T,R)=>Xe(m,T)&&S(T,R))),is=le(m=>t.events.on("gamepadButtonRelease",(S,T)=>m(S,T)),(m,S)=>t.events.on("gamepadButtonRelease",(T,R)=>Xe(m,T)&&S(T,R)));function rs(m,S){return t.events.on("gamepadStick",(T,R,te)=>T===m&&S(R,te))}function bn(m){t.events.on("gamepadConnect",m)}function Ze(m){t.events.on("gamepadDisconnect",m)}function ut(m){return t.mergedGamepadState.stickState.get(m)||new P(0)}function An(){return[...t.charInputted]}function Fe(){return[...t.gamepads]}let Qt=le(m=>t.events.on("buttonPress",S=>m(S)),(m,S)=>t.events.on("buttonPress",T=>Xe(m,T)&&S(T))),st=le(m=>t.events.on("buttonDown",S=>m(S)),(m,S)=>t.events.on("buttonDown",T=>Xe(m,T)&&S(T))),xn=le(m=>t.events.on("buttonRelease",S=>m(S)),(m,S)=>t.events.on("buttonRelease",T=>Xe(m,T)&&S(T)));function kr(){t.events.trigger("input"),t.keyState.down.forEach(m=>t.events.trigger("keyDown",m)),t.mouseState.down.forEach(m=>t.events.trigger("mouseDown",m)),t.buttonState.down.forEach(m=>{t.events.trigger("buttonDown",m)}),na()}function ea(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((m,S)=>{t.mergedGamepadState.stickState.set(S,new P(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new P(0),t.gamepadStates.forEach(m=>{m.buttonState.update(),m.stickState.forEach((S,T)=>{m.stickState.set(T,new P(0))})})}function oi(m){let S={index:m.index,isPressed:T=>t.gamepadStates.get(m.index)?.buttonState.pressed.has(T)||!1,isDown:T=>t.gamepadStates.get(m.index)?.buttonState.down.has(T)||!1,isReleased:T=>t.gamepadStates.get(m.index)?.buttonState.released.has(T)||!1,getStick:T=>t.gamepadStates.get(m.index)?.stickState.get(T)||x()};return t.gamepads.push(S),t.gamepadStates.set(m.index,{buttonState:new rn,stickState:new Map([["left",new P(0)],["right",new P(0)]])}),S}function ta(m){t.gamepads=t.gamepads.filter(S=>S.index!==m.index),t.gamepadStates.delete(m.index)}function na(){for(let m of navigator.getGamepads())m&&!t.gamepadStates.has(m.index)&&oi(m);for(let m of t.gamepads){let S=navigator.getGamepads()[m.index];if(!S)continue;let T=(e.gamepads??{})[S.id]||yi[S.id]||yi.default,R=t.gamepadStates.get(m.index);if(R){for(let te=0;te<S.buttons.length;te++){let fe=T.buttons[te],Ke=S.buttons[te],Ft=t.buttonsByGamepad.has(fe);if(Ke.pressed){if(R.buttonState.down.has(fe)){t.events.trigger("gamepadButtonDown",fe,m);continue}t.lastInputDevice="gamepad",Ft&&t.buttonsByGamepad.get(fe)?.forEach(it=>{t.buttonState.press(it),t.events.trigger("buttonPress",it)}),t.mergedGamepadState.buttonState.press(fe),R.buttonState.press(fe),t.events.trigger("gamepadButtonPress",fe,m)}else R.buttonState.down.has(fe)&&(Ft&&t.buttonsByGamepad.get(fe)?.forEach(it=>{t.buttonState.release(it),t.events.trigger("buttonRelease",it)}),t.mergedGamepadState.buttonState.release(fe),R.buttonState.release(fe),t.events.trigger("gamepadButtonRelease",fe,m))}for(let te in T.sticks){let fe=T.sticks[te];if(!fe)continue;let Ke=new P(S.axes[fe.x],S.axes[fe.y]);R.stickState.set(te,Ke),t.mergedGamepadState.stickState.set(te,Ke),t.events.trigger("gamepadStick",te,Ke,m)}}}}let Oe={},as={},Sn={},li=e.pixelDensity||1;Oe.mousemove=m=>{let S=rt(new P(m.offsetX,m.offsetY)),T=new P(m.movementX,m.movementY);if(v()){let R=t.canvas.width/li,te=t.canvas.height/li,fe=window.innerWidth,Ke=window.innerHeight,Ft=fe/Ke,it=R/te;if(Ft>it){let wt=Ke/te,os=(fe-R*wt)/2;S.x=et(m.offsetX-os,0,R*wt,0,R),S.y=et(m.offsetY,0,te*wt,0,te)}else{let wt=fe/R,os=(Ke-te*wt)/2;S.x=et(m.offsetX,0,R*wt,0,R),S.y=et(m.offsetY-os,0,te*wt,0,te)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=S,t.mouseDeltaPos=T,t.events.trigger("mouseMove")})};let ui=["left","middle","right","back","forward"];Oe.mousedown=m=>{t.events.onOnce("input",()=>{let S=ui[m.button];S&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(S)&&t.buttonsByMouse.get(S)?.forEach(T=>{t.buttonState.press(T),t.events.trigger("buttonPress",T)}),t.mouseState.press(S),t.events.trigger("mousePress",S))})},Oe.mouseup=m=>{t.events.onOnce("input",()=>{let S=ui[m.button];S&&(t.buttonsByMouse.has(S)&&t.buttonsByMouse.get(S)?.forEach(T=>{t.buttonState.release(T),t.events.trigger("buttonRelease",T)}),t.mouseState.release(S),t.events.trigger("mouseRelease",S))})};let sa=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),di={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};Oe.keydown=m=>{sa.has(m.key)&&m.preventDefault(),t.events.onOnce("input",()=>{let S=di[m.key]||m.key.toLowerCase(),T=m.code;if(S===void 0)throw new Error(`Unknown key: ${m.key}`);S.length===1?(t.events.trigger("charInput",S),t.charInputted.push(S)):S==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),m.repeat?(t.keyState.pressRepeat(S),t.events.trigger("keyPressRepeat",S)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(S)&&t.buttonsByKey.get(S)?.forEach(R=>{t.buttonState.press(R),t.events.trigger("buttonPress",R)}),t.buttonsByKeyCode.has(T)&&t.buttonsByKeyCode.get(T)?.forEach(R=>{t.buttonState.press(R),t.events.trigger("buttonPress",R)}),t.keyState.press(S),t.events.trigger("keyPressRepeat",S),t.events.trigger("keyPress",S))})},Oe.keyup=m=>{t.events.onOnce("input",()=>{let S=di[m.key]||m.key.toLowerCase(),T=m.code;t.buttonsByKey.has(S)&&t.buttonsByKey.get(S)?.forEach(R=>{t.buttonState.release(R),t.events.trigger("buttonRelease",R)}),t.buttonsByKeyCode.has(T)&&t.buttonsByKeyCode.get(T)?.forEach(R=>{t.buttonState.release(R),t.events.trigger("buttonRelease",R)}),t.keyState.release(S),t.events.trigger("keyRelease",S)})},Oe.touchstart=m=>{m.preventDefault(),t.events.onOnce("input",()=>{let S=[...m.changedTouches],T=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=rt(new P(S[0].clientX-T.x,S[0].clientY-T.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(R=>{t.buttonState.press(R),t.events.trigger("buttonPress",R)}),t.mouseState.press("left"),t.events.trigger("mousePress","left")),S.forEach(R=>{t.events.trigger("touchStart",rt(new P(R.clientX-T.x,R.clientY-T.y)),R)})})},Oe.touchmove=m=>{m.preventDefault(),t.events.onOnce("input",()=>{let S=[...m.changedTouches],T=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let R=t.mousePos;t.mousePos=rt(new P(S[0].clientX-T.x,S[0].clientY-T.y)),t.mouseDeltaPos=t.mousePos.sub(R),t.events.trigger("mouseMove")}S.forEach(R=>{t.events.trigger("touchMove",rt(new P(R.clientX-T.x,R.clientY-T.y)),R)})})},Oe.touchend=m=>{t.events.onOnce("input",()=>{let S=[...m.changedTouches],T=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=rt(new P(S[0].clientX-T.x,S[0].clientY-T.y)),t.mouseDeltaPos=new P(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(R=>{t.buttonState.release(R),t.events.trigger("buttonRelease",R)}),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),S.forEach(R=>{t.events.trigger("touchEnd",rt(new P(R.clientX-T.x,R.clientY-T.y)),R)})})},Oe.touchcancel=m=>{t.events.onOnce("input",()=>{let S=[...m.changedTouches],T=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=rt(new P(S[0].clientX-T.x,S[0].clientY-T.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),S.forEach(R=>{t.events.trigger("touchEnd",rt(new P(R.clientX-T.x,R.clientY-T.y)),R)})})},Oe.wheel=m=>{m.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new P(m.deltaX,m.deltaY))})},Oe.contextmenu=m=>m.preventDefault(),as.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},Sn.gamepadconnected=m=>{let S=oi(m.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",S)})},Sn.gamepaddisconnected=m=>{let S=Fe().filter(T=>T.index===m.gamepad.index)[0];ta(m.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",S)})};for(let[m,S]of Object.entries(Oe))t.canvas.addEventListener(m,S);for(let[m,S]of Object.entries(as))document.addEventListener(m,S);for(let[m,S]of Object.entries(Sn))window.addEventListener(m,S);let ci=new ResizeObserver(m=>{for(let S of m)if(S.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return ci.observe(t.canvas),{state:t,dt:n,fixedDt:i,restDt:s,time:a,run:D,canvas:t.canvas,fps:l,numFrames:o,quit:C,isHidden:r,setFullscreen:y,isFullscreen:v,setCursor:d,screenshot:u,getGamepads:Fe,getCursor:f,setCursorLocked:c,isCursorLocked:g,isTouchscreen:F,mousePos:M,mouseDeltaPos:b,isKeyDown:Q,isKeyPressed:O,isKeyPressedRepeat:L,isKeyReleased:J,isMouseDown:I,isMousePressed:A,isMouseReleased:q,isMouseMoved:B,isGamepadButtonPressed:$,isGamepadButtonDown:X,isGamepadButtonReleased:U,getGamepadStick:ut,isButtonPressed:he,isButtonDown:_,isButtonReleased:se,setButton:K,getButton:Me,pressButton:yt,releaseButton:Rt,charInputted:An,onResize:Vt,onKeyDown:yn,onKeyPress:wn,onKeyPressRepeat:es,onKeyRelease:ts,onMouseDown:Ht,onMousePress:Je,onMouseRelease:vn,onMouseMove:j,onCharInput:z,onTouchStart:W,onTouchMove:re,onTouchEnd:xe,onScroll:ee,onHide:De,onShow:lt,onGamepadButtonDown:ss,onGamepadButtonPress:ns,onGamepadButtonRelease:is,onGamepadStick:rs,onGamepadConnect:bn,onGamepadDisconnect:Ze,onButtonPress:Qt,onButtonDown:st,onButtonRelease:xn,getLastInputDeviceType:Bo,events:t.events}};function Ee(){return h.app.dt()}function Cs(){return h.app.fixedDt()}function Ts(){return h.app.restDt()}var No=new P(-1,-1),Lo=new P(0,-1),Uo=new P(1,-1),Go=new P(-1,0),Ko=new P(0,0),Xo=new P(1,0),zo=new P(-1,1),Yo=new P(0,1),Wo=new P(1,1);function zt(e){switch(e){case"topleft":return No;case"top":return Lo;case"topright":return Uo;case"left":return Go;case"center":return Ko;case"right":return Xo;case"botleft":return zo;case"bot":return Yo;case"botright":return Wo;default:return e}}function Vo(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function Qo(e){return e.createBuffer(1,1,44100)}var En=2.5949095,wi=1.70158+1,vi=2*Math.PI/3,bi=2*Math.PI/4.5,Bn={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>wi*e*e*e-1.70158*e*e,easeOutBack:e=>1+wi*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((En+1)*2*e-En)/2:(Math.pow(2*e-2,2)*((En+1)*(e*2-2)+En)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*vi),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*vi)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*bi))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*bi)/2+1,easeInBounce:e=>1-Bn.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Bn.easeOutBounce(1-2*e))/2:(1+Bn.easeOutBounce(2*e-1))/2},dn=Bn;function Jo(e,t,n){let i=[],s=t;for(i.push(s);s!==e;){if(s=n.get(s),s==null)return null;i.push(s)}return i.reverse()}function Zo(e,t,n){let i=new sr((a,l)=>a.cost<l.cost);i.insert({cost:0,node:t});let s=new Map;s.set(t,t);let r=new Map;for(r.set(t,0);i.length!==0;){let a=i.remove()?.node;if(a===n)break;let l=e.getNeighbours(a);for(let o of l){let u=(r.get(a)||0)+e.getCost(a,o)+e.getHeuristic(o,n);(!r.has(o)||u<r.get(o))&&(r.set(o,u),i.insert({cost:u,node:o}),s.set(o,a))}}return Jo(t,n,s)}var $o=class{a;b;polygon;constructor(e,t,n){this.a=e,this.b=t,this.polygon=new WeakRef(n)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},_o=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,n=0,i=0;for(let s of this._edges){s.polygon=new WeakRef(this);let r=s.a.x*s.b.y-s.a.y*s.b.x;t+=(s.a.x+s.b.x)*r,n+=(s.a.y+s.b.y)*r,i+=r}i/=2,this._centroid=x(t/(6*i),n/(6*i))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let n of this.edges)n.b.y>e.y!=n.a.y>e.y&&e.x<(n.a.x-n.b.x)*(e.y-n.b.y)/(n.a.y-n.b.y)+n.b.x&&(t=!t);return t}},ko=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let n=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[n]}_findCommonEdge(e,t){for(let n of e.edges){let i=this._findEdge(n.b,n.a);if(i&&i.polygon.deref().id===t.id)return i}return null}addPolygon(e){let t=new _o(this._polygons.length),n=e.map((i,s)=>new $o(i,e[(s+1)%e.length],t));t.edges=n,this._polygons.push(t);for(let i of t.edges)this._addEdge(i);return t}addRect(e,t){let n=this._addPoint(e),i=this._addPoint(e.add(t.x,0)),s=this._addPoint(e.add(t)),r=this._addPoint(e.add(0,t.y));return this.addPolygon([n,i,s,r])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let n of this._polygons[e].edges){let i=this._findEdge(n.b,n.a);if(i){let s=i.polygon.deref();s&&t.push(s.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let n=this._polygons[e],i=this._polygons[t],s=n.centroid.x-i.centroid.x,r=n.centroid.y-i.centroid.y;return Math.sqrt(s*s+r*r)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:Zo(this,e,t)}getWaypointPath(e,t,n){let i=n?.type||"centroids",s=this._getLocation(e),r=this._getLocation(t);if(s===void 0||r===void 0)return[];let a=this.getPath(s.id,r.id);if(!a)return[];if(i==="edges"){let l=[];for(let o=1;o<a.length;o++){let u=this._polygons[a[o-1]],d=this._polygons[a[o]],f=this._findCommonEdge(u,d);l.push(f.middle.add(d.centroid.sub(f.middle).unit().scale(4)))}return[e,...l,t]}else return[e,...a.slice(1,-1).map(l=>this._polygons[l].centroid),t]}};function an(e){let t=new nt;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function el(e){return new P(e.x/Te()*2-1,-e.y/Ie()*2+1)}function tn(e,t,n,i,s,r=1){i=Ae(i%360),s=Ae(s%360),s<=i&&(s+=Math.PI*2);let a=[],l=Math.ceil((s-i)/Ae(8)*r),o=(s-i)/l,u=x(Math.cos(i),Math.sin(i)),d=x(Math.cos(o),Math.sin(o));for(let f=0;f<=l;f++)a.push(e.add(t*u.x,n*u.y)),u=x(u.x*d.x-u.y*d.y,u.x*d.y+u.y*d.x);return a}function tl(...e){let t=ne(...e),n=e[3]??1;h.gfx.bgColor=t,h.gfx.bgAlpha=n,h.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,n)}function nl(){return h.gfx.bgColor?.clone?.()??null}function we(...e){if(e[0]===void 0)return;let t=x(...e);t.x===0&&t.y===0||h.gfx.transform.translate(t)}function ze(){h.gfx.transformStack.push(h.gfx.transform.clone())}function sl(e){h.gfx.transform=e.clone()}function cn(...e){if(e[0]===void 0)return;let t=x(...e);t.x===1&&t.y===1||h.gfx.transform.scale(t)}function Gt(e){e&&h.gfx.transform.rotate(e)}function je(){h.gfx.transformStack.length>0&&(h.gfx.transform=h.gfx.transformStack.pop())}function Ye(){h.gfx.renderer.flush()}function Te(){return h.gfx.width}function Ie(){return h.gfx.height}function or(){return(h.gfx.viewport.width+h.gfx.viewport.height)/(h.gfx.width+h.gfx.height)}function Un(){return x(Te()/2,Ie()/2)}var il=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,n,i){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=n,this.textures=[ft.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=i;let s=this.canvas.getContext("2d");if(!s)throw new Error("Failed to get 2d context");this.c2d=s}addSingle(e){let t=ft.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new pe(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,n=e.height+this.padding*2;if(t>this.canvas.width||n>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+n>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(ft.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let i=this.textures[this.textures.length-1],s=new P(this.x+this.padding,this.y+this.padding);return this.x+=t,n>this.curHeight&&(this.curHeight=n),e instanceof ImageData?this.c2d.putImageData(e,s.x,s.y):this.c2d.drawImage(e,s.x,s.y),i.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:s,size:new P(e.width,e.height),texture:i}),this.lastTextureId++,[i,new pe(s.x/this.canvas.width,s.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Ve(e){return typeof e!="string"||rr(e)?e:h.assets.urlPrefix+e}var Qe=class lr{loaded=!1;data=null;error=null;onLoadEvents=new Be;onErrorEvents=new Be;onFinishEvents=new Be;constructor(t){t.then(n=>{this.loaded=!0,this.data=n,this.onLoadEvents.trigger(n)}).catch(n=>{if(this.error=n,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(n);else throw n}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let n=new lr(Promise.resolve(t));return n.data=t,n.loaded=!0,n}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},Ot=class{assets=new Map;lastUID=0;add(e,t){let n=e??this.lastUID+++"",i=new Qe(t);return this.assets.set(n,i),i}addLoaded(e,t){let n=e??this.lastUID+++"",i=Qe.loaded(t);return this.assets.set(n,i),i}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function $s(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function Jn(e){return $s(e).then(t=>t.json())}function rl(e){return $s(e).then(t=>t.text())}function al(e){return $s(e).then(t=>t.arrayBuffer())}function ol(e){return e!==void 0&&(h.assets.urlPrefix=e),h.assets.urlPrefix}function ll(e,t){return h.assets.custom.add(e,Jn(Ve(t)))}function Zn(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((n,i)=>{t.onload=()=>n(t),t.onerror=()=>i(new Error(`Failed to load image from "${e}"`))})}function Pt(){let e=[h.assets.sprites,h.assets.sounds,h.assets.shaders,h.assets.fonts,h.assets.bitmapFonts,h.assets.custom];return e.reduce((t,n)=>t+n.progress(),0)/e.length}function ur(){return[h.assets.sprites,h.assets.sounds,h.assets.shaders,h.assets.fonts,h.assets.bitmapFonts,h.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function ul(e){return h.assets.custom.get(e)??null}function Is(e){return h.assets.custom.add(null,e)}var dl=(e,t)=>({urlPrefix:"",sprites:new Ot,fonts:new Ot,bitmapFonts:new Ot,sounds:new Ot,shaders:new Ot,custom:new Ot,music:{},packer:new il(e,2048,2048,t),loaded:!1}),cl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",gt=class nn{tex;frames=[new pe(0,0,1,1)];anims={};slice9=null;constructor(t,n,i={},s=null){this.tex=t,n&&(this.frames=n),this.anims=i,this.slice9=s}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,n={}){return typeof t=="string"?nn.fromURL(t,n):Promise.resolve(nn.fromImage(t,n))}static fromImage(t,n={}){let[i,s]=n.singular?h.assets.packer.addSingle(t):h.assets.packer.add(t),r=n.frames?n.frames.map(a=>new pe(s.x+a.x*s.w,s.y+a.y*s.h,a.w*s.w,a.h*s.h)):cr(n.sliceX||1,n.sliceY||1,s.x,s.y,s.w,s.h);return new nn(i,r,n.anims,n.slice9)}static fromURL(t,n={}){return Zn(t).then(i=>nn.fromImage(i,n))}};function Rn(e){if(typeof e=="string"){let t=dr(e);if(t)return t;if(Pt()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof gt)return Qe.loaded(e);if(e instanceof Qe)return e;throw new Error(`Invalid sprite: ${e}`)}}function dr(e){return h.assets.sprites.get(e)??null}function on(e,t,n={sliceX:1,sliceY:1,anims:{}}){return t=Ve(t),Array.isArray(t)?t.some(i=>typeof i=="string")?h.assets.sprites.add(e,Promise.all(t.map(i=>typeof i=="string"?Zn(i):Promise.resolve(i))).then(i=>Ai(i,n))):h.assets.sprites.addLoaded(e,Ai(t,n)):typeof t=="string"?h.assets.sprites.add(e,gt.from(t,n)):h.assets.sprites.addLoaded(e,gt.fromImage(t,n))}function cr(e=1,t=1,n=0,i=0,s=1,r=1){let a=[],l=s/e,o=r/t;for(let u=0;u<t;u++)for(let d=0;d<e;d++)a.push(new pe(n+d*l,i+u*o,l,o));return a}function Ai(e,t={}){let n=document.createElement("canvas"),i=e[0].width,s=e[0].height;n.width=i*e.length,n.height=s;let r=n.getContext("2d");if(!r)throw new Error("Failed to create canvas context");e.forEach((l,o)=>{l instanceof ImageData?r.putImageData(l,o*i,0):r.drawImage(l,o*i,0)});let a=r.getImageData(0,0,e.length*i,s);return gt.fromImage(a,{...t,sliceX:e.length,sliceY:1})}function hl(e="bean"){return on(e,cl)}function fl(e,t,n){t=Ve(t),n=Ve(n),typeof t=="string"&&!n&&(n=go(t)+".json");let i=typeof n=="string"?Jn(n):Promise.resolve(n);return h.assets.sprites.add(e,i.then(s=>{let r=s.meta.size,a=s.frames.map(o=>new pe(o.frame.x/r.w,o.frame.y/r.h,o.frame.w/r.w,o.frame.h/r.h)),l={};for(let o of s.meta.frameTags)o.from===o.to?l[o.name]=o.from:l[o.name]={from:o.from,to:o.to,speed:10,loop:!0,pingpong:o.direction==="pingpong"};return gt.from(t,{frames:a,anims:l})}))}var Hn=class{fontface;filter=Ss;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??Ss,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:ne(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function hr(e){if(!e)return hr(h.globalOpt.font??_a);if(typeof e=="string"){let t=pr(e),n=fr(e);if(t)return t.data??t;if(n)return n.data??n;if(document.fonts.check(`64px ${e}`))return e;if(Pt()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof Qe)return e.data?e.data:e;return e}function fr(e){return h.assets.fonts.get(e)??null}function pl(e,t,n={}){let i=Ve(t),s=new FontFace(e,typeof t=="string"?`url(${i})`:i);return document.fonts.add(s),h.assets.fonts.add(e,s.load().catch(r=>{throw new Error(`Failed to load font from "${i}": ${r}`)}).then(r=>new Hn(r,n)))}function gl(e,t,n,i){let s=e.width/t,r={},a=i.split("").entries();for(let[l,o]of a)r[o]=new pe(l%s*t,Math.floor(l/s)*n,t,n);return{tex:e,map:r,size:n}}function pr(e){return h.assets.bitmapFonts.get(e)??null}function ml(e,t,n,i,s={}){let r=Ve(t);return h.assets.bitmapFonts.add(e,Zn(r).then(a=>gl(ft.fromImage(h.gfx.ggl,a,s),n,i,s.chars??_i)))}function yl(e,t){return t=Ve(t),h.assets.sprites.add(e,new Promise(async n=>{let i=typeof t=="string"?await Jn(t):t,s=await Promise.all(i.frames.map(Zn)),r=document.createElement("canvas");r.width=i.width,r.height=i.height*i.frames.length;let a=r.getContext("2d");if(!a)throw new Error("Failed to create canvas context");s.forEach((o,u)=>{a.drawImage(o,0,u*i.height)});let l=await on(null,r,{sliceY:i.frames.length,anims:i.anims});n(l)}))}var wl=class{ctx;glProgram;constructor(e,t,n,i){this.ctx=e,e.onDestroy(()=>this.free());let s=e.gl,r=s.createShader(s.VERTEX_SHADER),a=s.createShader(s.FRAGMENT_SHADER);if(!r||!a)throw new Error("Failed to create shader");s.shaderSource(r,t),s.shaderSource(a,n),s.compileShader(r),s.compileShader(a);let l=s.createProgram();if(this.glProgram=l,s.attachShader(l,r),s.attachShader(l,a),i.forEach((o,u)=>s.bindAttribLocation(l,u,o)),s.linkProgram(l),!s.getProgramParameter(l,s.LINK_STATUS)){let o=s.getShaderInfoLog(r);if(o)throw new Error("VERTEX SHADER "+o);let u=s.getShaderInfoLog(a);if(u)throw new Error("FRAGMENT SHADER "+u)}s.deleteShader(r),s.deleteShader(a)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let n in e){let i=e[n],s=t.getUniformLocation(this.glProgram,n);if(typeof i=="number")t.uniform1f(s,i);else if(i instanceof nt)t.uniformMatrix4fv(s,!1,new Float32Array(i.m));else if(i instanceof Z)t.uniform3f(s,i.r,i.g,i.b);else if(i instanceof P)t.uniform2f(s,i.x,i.y);else if(Array.isArray(i))i[0],co(i)?t.uniform1fv(s,i):uo(i)?t.uniform2fv(s,i.map(r=>[r.x,r.y]).flat()):lo(i)&&t.uniform3fv(s,i.map(r=>[r.r,r.g,r.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function _s(e,t=Ps,n=Es){let i=no.replace("{{user}}",t??Ps),s=so.replace("{{user}}",n??Es);try{return new wl(e,i,s,Vs.map(r=>r.name))}catch(r){let a=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,l=mo(r).match(a);if(!l?.groups)throw r;let o=Number(l.groups.line)-14,u=l.groups.msg.trim(),d=l.groups.type.toLowerCase();throw new Error(`${d} shader line ${o}: ${u}`)}}function vl(e){if(!e)return h.gfx.defShader;if(typeof e=="string"){let t=gr(e);if(t)return t.data??t;if(Pt()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof Qe)return e.data?e.data:e;return e}function gr(e){return h.assets.shaders.get(e)??null}function bl(e,t,n){return h.assets.shaders.addLoaded(e,_s(h.gfx.ggl,t,n))}function Al(e,t,n){t=Ve(t),n=Ve(n);let i=r=>r?rl(r):Promise.resolve(null),s=Promise.all([i(t),i(n)]).then(([r,a])=>_s(h.gfx.ggl,r,a));return h.assets.shaders.add(e,s)}var hn=class Fn{buf;constructor(t){this.buf=t}static fromArrayBuffer(t){return new Promise((n,i)=>h.audio.ctx.decodeAudioData(t,n,i)).then(n=>new Fn(n))}static fromURL(t){return rr(t)?Fn.fromArrayBuffer(fo(t)):al(t).then(n=>Fn.fromArrayBuffer(n))}};function xl(e){if(typeof e=="string"){let t=mr(e);if(t)return t;if(Pt()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof hn)return Qe.loaded(e);if(e instanceof Qe)return e;throw new Error(`Invalid sound: ${e}`)}}function mr(e){return h.assets.sounds.get(e)??null}function Sl(e,t){return t=Ve(t),h.assets.sounds.add(e,typeof t=="string"?hn.fromURL(t):hn.fromArrayBuffer(t))}function Pl(e,t){let n=Ve(t),i=new Audio(n);return i.preload="auto",h.assets.music[e]=n}function yr(e,t){return e=Ve(e),Is(typeof t=="string"?new Promise((n,i)=>{Jn(t).then(s=>{yr(e,s).then(n).catch(i)})}):gt.from(e).then(n=>{let i={};for(let s in t){let r=t[s],a=n.frames[0],l=2048*a.w,o=2048*a.h,u=r.frames?r.frames.map(f=>new pe(a.x+(r.x+f.x)/l*a.w,a.y+(r.y+f.y)/o*a.h,f.w/l*a.w,f.h/o*a.h)):cr(r.sliceX||1,r.sliceY||1,a.x+r.x/l*a.w,a.y+r.y/o*a.h,r.width/l*a.w,r.height/o*a.h),d=new gt(n.tex,u,r.anims);h.assets.sprites.addLoaded(s,d),i[s]=d}return i}))}function mt(e,t,n=!1,i,s,r={}){let a=i??h.gfx.defTex,l=s??h.gfx.defShader,o=vl(l);if(!o||o instanceof Qe)return;let u=h.gfx.fixed||n?h.gfx.transform:h.game.cam.transform.mult(h.gfx.transform),d=[];for(let f of e){let c=el(u.multVec2(f.pos));d.push(c.x,c.y,f.uv.x,f.uv.y,f.color.r/255,f.color.g/255,f.color.b/255,f.opacity)}h.gfx.renderer.push(h.gfx.ggl.gl.TRIANGLES,d,t,o,a,r)}function ht(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(ze(),we(e.pos),cn(e.scale),Gt(e.angle),we(e.offset),e.fill!==!1){let n=e.color??Z.WHITE,i=e.pts.map((r,a)=>({pos:new P(r.x,r.y),uv:e.uv?e.uv[a]:new P(0,0),color:e.colors&&e.colors[a]?e.colors[a].mult(n):n,opacity:e.opacity??1})),s;e.triangulate?s=$i(e.pts).map(r=>r.map(a=>e.pts.indexOf(a))).flat():s=[...Array(t-2).keys()].map(r=>[0,r+1,r+2]).flat(),mt(i,e.indices??s,e.fixed,e.uv?e.tex:h.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&ks({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),je()}}function wr(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,n=e.end??360,i=zt(e.anchor??"center").scale(new P(-e.radiusX,-e.radiusY)),s=tn(i,e.radiusX,e.radiusY,t,n,e.resolution);s.unshift(i);let r=Object.assign({},e,{pts:s,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(s.length-1).fill(e.gradient[1])]}:{}});if(n-t>=360&&e.outline){e.fill!==!1&&ht(Object.assign({},r,{outline:null})),ht(Object.assign({},r,{pts:s.slice(1),fill:!1}));return}ht(r)}function Yt(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&wr(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function sn(e){let{p1:t,p2:n}=e;if(!t||!n)throw new Error('drawLine() requires properties "p1" and "p2".');let i=e.width||1,s=n.sub(t).unit().normal().scale(i*.5),r=[t.sub(s),t.add(s),n.add(s),n.sub(s)].map(a=>({pos:new P(a.x,a.y),uv:new P(0),color:e.color??Z.WHITE,opacity:e.opacity??1}));mt(r,[0,1,3,1,2,3],e.fixed,h.gfx.defTex,e.shader,e.uniform??void 0)}function El(e){let t=e.pts,n=[],i=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),r=e.pos||x(0,0),a;s?a=t[0].sub(t[t.length-2]):a=t[1].sub(t[0]);let l=a.len(),o=a.normal().scale(-i/l),u,d=t[0];if(!s)switch(e.cap){case"square":{let p=a.scale(-i/l);n.push(d.add(p).add(o)),n.push(d.add(p).sub(o));break}case"round":{let p=Math.max(i,10),w=Math.PI/p,y=o.scale(-1),v=Math.cos(w),C=Math.sin(w);for(let D=0;D<p;D++)n.push(d),n.push(d.sub(y)),y=x(y.x*v-y.y*C,y.x*C+y.y*v)}}for(let p=1;p<t.length;p++){if(d===t[p]||d.eq(t[p]))continue;u=d,d=t[p];let w=d.sub(u),y=w.len(),v=w.normal().scale(-i/y),C=a.cross(w);if(Math.abs(C)/(l*y)<.05){n.push(u.add(o)),n.push(u.sub(o)),a.dot(w)<0&&(n.push(u.sub(o)),n.push(u.add(o))),a=w,l=y,o=v;continue}let D=v.sub(o).cross(w)/C,F=o.add(a.scale(D));C>0?(n.push(u.add(F)),n.push(u.sub(o)),n.push(u.add(F)),n.push(u.sub(v))):(n.push(u.add(o)),n.push(u.sub(F)),n.push(u.add(v)),n.push(u.sub(F))),a=w,l=y,o=v}if(!s)switch(n.push(d.add(o)),n.push(d.sub(o)),e.cap){case"square":{let p=a.scale(i/l);n.push(d.add(p).add(o)),n.push(d.add(p).sub(o));break}case"round":{let p=Math.max(i,10),w=Math.PI/p,y=o.scale(1),v=Math.cos(w),C=Math.sin(w);for(let D=0;D<p;D++)y=x(y.x*v-y.y*C,y.x*C+y.y*v),n.push(d),n.push(d.sub(y))}}if(n.length<4)return;let f=n.map(p=>({pos:r.add(p),uv:x(),color:e.color||Z.WHITE,opacity:e.opacity??1})),c=[],g=0;for(let p=0;p<n.length-2;p+=2)c[g++]=p+1,c[g++]=p,c[g++]=p+2,c[g++]=p+2,c[g++]=p+3,c[g++]=p+1;s&&(c[g++]=n.length-1,c[g++]=n.length-2,c[g++]=0,c[g++]=0,c[g++]=1,c[g++]=n.length-1),mt(f,c,e.fixed,h.gfx.defTex,e.shader,e.uniform??void 0)}function Ml(e){let t=e.pts,n=[],i=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),r=e.pos||x(0,0),a;s?a=t[0].sub(t[t.length-2]):a=t[1].sub(t[0]);let l=a.len(),o=a.normal().scale(-i/l),u,d=t[0];if(!s)switch(e.cap){case"square":{let p=a.scale(-i/l);n.push(d.add(p).add(o)),n.push(d.add(p).sub(o));break}case"round":{let p=Math.max(i,10),w=Math.PI/p,y=o.scale(-1),v=Math.cos(w),C=Math.sin(w);for(let D=0;D<p;D++)n.push(d),n.push(d.sub(y)),y=x(y.x*v-y.y*C,y.x*C+y.y*v)}}for(let p=1;p<t.length;p++){if(d===t[p]||d.eq(t[p]))continue;u=d,d=t[p];let w=d.sub(u),y=w.len(),v=w.normal().scale(-i/y),C=a.cross(w);if(Math.abs(C)/(l*y)<.05){n.push(u.add(o)),n.push(u.sub(o)),a.dot(w)<0&&(n.push(u.sub(o)),n.push(u.add(o))),a=w,l=y,o=v;continue}let D=v.sub(o).cross(w)/C,F=o.add(a.scale(D));if(C>0){let M=u.add(F),b=Math.max(i,10),A=Ae(o.angleBetween(v)/b),I=o,q=Math.cos(A),B=Math.sin(A);for(let O=0;O<b;O++)n.push(M),n.push(u.sub(I)),I=x(I.x*q-I.y*B,I.x*B+I.y*q)}else{let M=u.sub(F),b=Math.max(i,10),A=Ae(o.angleBetween(v)/b),I=o,q=Math.cos(A),B=Math.sin(A);for(let O=0;O<b;O++)n.push(u.add(I)),n.push(M),I=x(I.x*q-I.y*B,I.x*B+I.y*q)}a=w,l=y,o=v}if(!s)switch(n.push(d.add(o)),n.push(d.sub(o)),e.cap){case"square":{let p=a.scale(i/l);n.push(d.add(p).add(o)),n.push(d.add(p).sub(o));break}case"round":{let p=Math.max(i,10),w=Math.PI/p,y=o.scale(1),v=Math.cos(w),C=Math.sin(w);for(let D=0;D<p;D++)y=x(y.x*v-y.y*C,y.x*C+y.y*v),n.push(d),n.push(d.sub(y))}}if(n.length<4)return;let f=n.map(p=>({pos:r.add(p),uv:x(),color:e.color||Z.WHITE,opacity:e.opacity??1})),c=[],g=0;for(let p=0;p<n.length-2;p+=2)c[g++]=p+1,c[g++]=p,c[g++]=p+2,c[g++]=p+2,c[g++]=p+3,c[g++]=p+1;s&&(c[g++]=n.length-1,c[g++]=n.length-2,c[g++]=0,c[g++]=0,c[g++]=1,c[g++]=n.length-1),mt(f,c,e.fixed,h.gfx.defTex,e.shader,e.uniform??void 0)}function Cl(e){let t=e.pts,n=[],i=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),r=e.pos||x(0,0),a;s?a=t[0].sub(t[t.length-2]):a=t[1].sub(t[0]);let l=a.len(),o=a.normal().scale(-i/l),u,d=t[0];if(!s)switch(e.cap){case"square":{let p=a.scale(-i/l);n.push(d.add(p).add(o)),n.push(d.add(p).sub(o));break}case"round":{let p=Math.max(i,10),w=Math.PI/p,y=o.scale(-1),v=Math.cos(w),C=Math.sin(w);for(let D=0;D<p;D++)n.push(d),n.push(d.sub(y)),y=x(y.x*v-y.y*C,y.x*C+y.y*v)}}for(let p=1;p<t.length;p++){if(d===t[p]||d.eq(t[p]))continue;u=d,d=t[p];let w=d.sub(u),y=w.len(),v=w.normal().scale(-i/y),C=a.cross(w);if(Math.abs(C)/(l*y)<.05){n.push(u.add(o)),n.push(u.sub(o)),a.dot(w)<0&&(n.push(u.sub(o)),n.push(u.add(o))),a=w,l=y,o=v;continue}let D=v.sub(o).cross(w)/C,F=o.add(a.scale(D));n.push(u.add(F)),n.push(u.sub(F)),a=w,l=y,o=v}if(!s)switch(n.push(d.add(o)),n.push(d.sub(o)),e.cap){case"square":{let p=a.scale(i/l);n.push(d.add(p).add(o)),n.push(d.add(p).sub(o));break}case"round":{let p=Math.max(i,10),w=Math.PI/p,y=o.scale(1),v=Math.cos(w),C=Math.sin(w);for(let D=0;D<p;D++)y=x(y.x*v-y.y*C,y.x*C+y.y*v),n.push(d),n.push(d.sub(y))}}if(n.length<4)return;let f=n.map(p=>({pos:r.add(p),uv:x(),color:e.color||Z.WHITE,opacity:e.opacity??1})),c=[],g=0;for(let p=0;p<n.length-2;p+=2)c[g++]=p+1,c[g++]=p,c[g++]=p+2,c[g++]=p+2,c[g++]=p+3,c[g++]=p+1;s&&(c[g++]=n.length-1,c[g++]=n.length-2,c[g++]=0,c[g++]=0,c[g++]=1,c[g++]=n.length-1),mt(f,c,e.fixed,h.gfx.defTex,e.shader,e.uniform??void 0)}function ks(e){let t=e.pts,n=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return El(e);case"round":return Ml(e);case"miter":return Cl(e)}if(e.radius&&t.length>=3){sn(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let i=1;i<t.length-2;i++){let s=t[i],r=t[i+1];sn(Object.assign({},e,{p1:s,p2:r}))}sn(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let i=0;i<t.length-1;i++)sn(Object.assign({},e,{p1:t[i],p2:t[i+1]})),e.join!=="none"&&Yt(Object.assign({},e,{pos:t[i],radius:n/2}))}}function vr(e,t){let n=t.segments??16,i=[];for(let s=0;s<=n;s++)i.push(e(s/n));ks({pts:i,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function Tl(e){vr(t=>Ws(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var ft=class br{ctx;src=null;glTex;width;height;constructor(t,n,i,s={}){this.ctx=t;let r=t.gl,a=t.gl.createTexture();if(!a)throw new Error("Failed to create texture");this.glTex=a,t.onDestroy(()=>this.free()),this.width=n,this.height=i;let l={linear:r.LINEAR,nearest:r.NEAREST}[s.filter??t.opts.texFilter??"nearest"],o={repeat:r.REPEAT,clampToEdge:r.CLAMP_TO_EDGE}[s.wrap??"clampToEdge"];this.bind(),n&&i&&r.texImage2D(r.TEXTURE_2D,0,r.RGBA,n,i,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,l),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,l),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,o),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,n,i={}){let s=new br(t,n.width,n.height,i);return s.update(n),s.src=n,s}update(t,n=0,i=0){let s=this.ctx.gl;this.bind(),s.texSubImage2D(s.TEXTURE_2D,0,n,i,s.RGBA,s.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},Gn=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,n,i={}){this.ctx=e;let s=e.gl;e.onDestroy(()=>this.free()),this.tex=new ft(e,t,n,i);let r=s.createFramebuffer(),a=s.createRenderbuffer();if(!r||!a)throw new Error("Failed to create framebuffer");this.glFramebuffer=r,this.glRenderbuffer=a,this.bind(),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,t,n),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tex.glTex,0),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let n=this.width*4,i=new Uint8Array(n);for(let s=0;s<(this.height/2|0);s++){let r=s*n,a=(this.height-s-1)*n;i.set(t.subarray(r,r+n)),t.copyWithin(r,a,a+n),t.set(i,a)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},Il=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,n,i){let s=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((a,l)=>a+l.size,0),this.maxVertices=n,this.maxIndices=i;let r=s.createBuffer();if(!r)throw new Error("Failed to create vertex buffer");this.glVBuf=r,e.pushArrayBuffer(this.glVBuf),s.bufferData(s.ARRAY_BUFFER,n*4,s.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=s.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),s.bufferData(s.ELEMENT_ARRAY_BUFFER,i*4,s.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,n,i,s=null,r={}){(e!==this.curPrimitive||s!==this.curTex||i!==this.curShader||!Js(this.curUniform,r)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+n.length>this.maxIndices)&&this.flush();let a=this.vqueue.length/this.stride;for(let l of t)this.vqueue.push(l);for(let l of n)this.iqueue.push(l+a);this.curPrimitive=e,this.curShader=i,this.curTex=s,this.curUniform=r}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function vt(e){let t=[],n=r=>{t.push(r),e(r)},i=()=>{t.pop(),e(s()??null)},s=()=>t[t.length-1];return[n,i,s]}function Dl(e,t={}){let n=[];function i(M){n.push(M)}function s(){n.forEach(b=>b());let M=e.getExtension("WEBGL_lose_context");M&&M.loseContext()}let r=null;function a(M){if(Js(M,r))return;r=M;let b=M.reduce((A,I)=>A+I.size,0);M.reduce((A,I,q)=>(e.vertexAttribPointer(q,I.size,e.FLOAT,!1,b*4,A),e.enableVertexAttribArray(q),A+I.size*4),0)}let[l,o]=vt(M=>e.bindTexture(e.TEXTURE_2D,M)),[u,d]=vt(M=>e.bindBuffer(e.ARRAY_BUFFER,M)),[f,c]=vt(M=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,M)),[g,p]=vt(M=>e.bindFramebuffer(e.FRAMEBUFFER,M)),[w,y]=vt(M=>e.bindRenderbuffer(e.RENDERBUFFER,M)),[v,C]=vt(M=>{if(!M)return;let{x:b,y:A,w:I,h:q}=M;e.viewport(b,A,I,q)}),[D,F]=vt(M=>e.useProgram(M));return v({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:i,destroy:s,pushTexture2D:l,popTexture2D:o,pushArrayBuffer:u,popArrayBuffer:d,pushElementArrayBuffer:f,popElementArrayBuffer:c,pushFramebuffer:g,popFramebuffer:p,pushRenderbuffer:w,popRenderbuffer:y,pushViewport:v,popViewport:C,pushProgram:D,popProgram:F,setVertexFormat:a}}var ds={};function xi(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(x(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function Ds(e){let t={},n="",i=[],s=String(e),r=a=>{i.length>0&&(t[n.length]=i.slice()),n+=a};for(;s!=="";){if(s[0]==="\\"){if(s.length===1)throw new Error("Styled text error: \\ at end of string");r(s[1]),s=s.slice(2);continue}if(s[0]==="["){let a=/^\[(\/)?(\w+?)\]/.exec(s);if(!a){r(s[0]),s=s.slice(1);continue}let[l,o,u]=a;if(o!==void 0){let d=i.pop();if(d!==u)throw d!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${d}], got [/${u}]`):new Error(`Styled text error: stray end tag [/${u}]`)}else i.push(u);s=s.slice(l.length);continue}r(s[0]),s=s.slice(1)}if(i.length>0)throw new Error(`Styled text error: unclosed tags ${i}`);return{charStyleMap:t,text:n}}function Et(e){if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=hr(e.font);if(!e.text||e.text===""||t instanceof Qe||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:n,text:i}=Ds(e.text+""),s=vo(i);if(t instanceof Hn||typeof t=="string"){let D=t instanceof Hn?t.fontface.family:t,F=t instanceof Hn?{outline:t.outline,filter:t.filter}:{outline:null,filter:Ss},M=ds[D]??{font:{tex:new ft(h.gfx.ggl,2048,2048,{filter:F.filter}),map:{},size:64},cursor:new P(0),maxHeight:0,outline:F.outline};ds[D]||(ds[D]=M),t=M.font;for(let b of s)if(!M.font.map[b]){let A=h.fontCacheC2d;if(!A)throw new Error("fontCacheC2d is not defined.");if(!h.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");A.clearRect(0,0,h.fontCacheCanvas.width,h.fontCacheCanvas.height),A.font=`${t.size}px ${D}`,A.textBaseline="top",A.textAlign="left",A.fillStyle="#ffffff";let I=A.measureText(b),q=Math.ceil(I.width);if(!q)continue;let B=Math.ceil(Math.abs(I.actualBoundingBoxAscent))+Math.ceil(Math.abs(I.actualBoundingBoxDescent));M.outline&&M.outline.width&&M.outline.color&&(A.lineJoin="round",A.lineWidth=M.outline.width*2,A.strokeStyle=M.outline.color.toHex(),A.strokeText(b,M.outline.width,M.outline.width),q+=M.outline.width*2,B+=M.outline.width*3),A.fillText(b,M.outline?.width??0,M.outline?.width??0);let O=A.getImageData(0,0,q,B);if(M.cursor.x+q>2048&&(M.cursor.x=0,M.cursor.y+=M.maxHeight,M.maxHeight=0,M.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(O,M.cursor.x,M.cursor.y),t.map[b]=new pe(M.cursor.x,M.cursor.y,q,B),M.cursor.x+=q+1,M.maxHeight=Math.max(M.maxHeight,B)}}let r=e.size||t.size,a=x(e.scale??1).scale(r/t.size),l=e.lineSpacing??0,o=e.letterSpacing??0,u=0,d=0,f=0,c=[],g=[],p=0,w=null,y=0,v;for(;p<s.length;){let D=s[p];if(D===`
`)f+=r+l,c.push({width:u-o,chars:g}),w=null,y=0,u=0,g=[],v=void 0;else{let F=t.map[D];if(F){let M=F.w*a.x;e.width&&u+M>e.width&&(f+=r+l,w!=null&&(p-=g.length-w,D=s[p],F=t.map[D],M=F.w*a.x,g=g.slice(0,w-1),u=y),w=null,y=0,c.push({width:u-o,chars:g}),u=v??0,g=[]),g.push({tex:t.tex,width:F.w,height:F.h,quad:new pe(F.x/t.tex.width,F.y/t.tex.height,F.w/t.tex.width,F.h/t.tex.height),ch:D,pos:new P(u,f),opacity:e.opacity??1,color:e.color??Z.WHITE,scale:x(a),angle:0}),D===" "&&(w=g.length,y=u),e.indentAll&&v===void 0&&/\S/.test(D)&&(v=u),u+=M,d=Math.max(d,u),u+=o}}p++}c.push({width:u-o,chars:g}),f+=r,e.width&&(d=e.width);let C=[];for(let D=0;D<c.length;D++){let F=(d-c[D].width)*Vo(e.align??"left");for(let M of c[D].chars){let b=t.map[M.ch],A=C.length+D;if(M.pos=M.pos.add(F,0).add(b.w*a.x*.5,b.h*a.y*.5),e.transform){let I=typeof e.transform=="function"?e.transform(A,M.ch):e.transform;I&&xi(M,I)}if(n[A]){let I=n[A];for(let q of I){let B=e.styles?.[q],O=typeof B=="function"?B(A,M.ch):B;O&&xi(M,O)}}C.push(M)}}return{width:d,height:f,chars:C,opt:e,renderedText:i}}function fn(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,i=zt(e.anchor||Qn).scale(new P(t,n).scale(-.5)),s=e.quad||new pe(0,0,1,1),r=e.color||ne(255,255,255),a=e.opacity??1,l=e.tex?.1/e.tex.width:0,o=e.tex?.1/e.tex.height:0,u=s.x+l,d=s.y+o,f=s.w-l*2,c=s.h-o*2;ze(),we(e.pos),Gt(e.angle),cn(e.scale),we(i),mt([{pos:new P(-t/2,n/2),uv:new P(e.flipX?u+f:u,e.flipY?d:d+c),color:r,opacity:a},{pos:new P(-t/2,-n/2),uv:new P(e.flipX?u+f:u,e.flipY?d+c:d),color:r,opacity:a},{pos:new P(t/2,-n/2),uv:new P(e.flipX?u:u+f,e.flipY?d+c:d),color:r,opacity:a},{pos:new P(t/2,n/2),uv:new P(e.flipX?u:u+f,e.flipY?d:d+c),color:r,opacity:a}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),je()}function Mt(e){ze(),we(e.opt.pos),Gt(e.opt.angle),we(zt(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{fn({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),je()}function We(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,i=zt(e.anchor||Qn).add(1,1).scale(new P(t,n).scale(-.5)),s=[new P(0,0),new P(t,0),new P(t,n),new P(0,n)];if(e.radius){let r=Math.min(t,n)/2,a=Array.isArray(e.radius)?e.radius.map(l=>Math.min(r,l)):new Array(4).fill(Math.min(r,e.radius));s=[new P(a[0],0),...a[1]?tn(new P(t-a[1],a[1]),a[1],a[1],270,360):[x(t,0)],...a[2]?tn(new P(t-a[2],n-a[2]),a[2],a[2],0,90):[x(t,n)],...a[3]?tn(new P(a[3],n-a[3]),a[3],a[3],90,180):[x(0,n)],...a[0]?tn(new P(a[0],a[0]),a[0],a[0],180,270):[]]}ht(Object.assign({},e,{offset:i,pts:s,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function ct(e){Ye();let t=h.gfx.width,n=h.gfx.height;h.gfx.width=h.gfx.viewport.width,h.gfx.height=h.gfx.viewport.height,e(),Ye(),h.gfx.width=t,h.gfx.height=n}function Si(e,t){ct(()=>{let n=x(8);ze(),we(e);let i=Et({text:t,font:Ln,size:16,pos:n,color:ne(255,255,255),fixed:!0}),s=i.width+n.x*2,r=i.height+n.x*2;e.x+s>=Te()&&we(x(-s,0)),e.y+r>=Ie()&&we(x(0,-r)),We({width:s,height:r,color:ne(0,0,0),radius:4,opacity:.8,fixed:!0}),Mt(i),je()})}function Ar(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return ht(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function ql(){if(h.debug.inspect){let e=null;for(let t of h.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(h.game.root.drawInspect(),e){let t=[],n=e.inspect();for(let i in n)n[i]?t.push(`${n[i]}`):t.push(`${i}`);Si(qo(h.k.mousePos()),t.join(`
`))}Si(x(8),`FPS: ${h.debug.fps()}`)}h.debug.paused&&ct(()=>{ze(),we(Te(),0),we(-8,8);let e=32;We({width:e,height:e,anchor:"topright",color:ne(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)We({width:4,height:e*.6,anchor:"center",pos:x(-e/3*t,e*.5),color:ne(255,255,255),radius:2,fixed:!0});je()}),h.debug.timeScale!==1&&ct(()=>{ze(),we(Te(),Ie()),we(-8,-8);let e=8,t=Et({text:h.debug.timeScale.toFixed(1),font:Ln,size:16,color:ne(255,255,255),pos:x(-e),anchor:"botright",fixed:!0});We({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:ne(0,0,0),opacity:.8,radius:4,fixed:!0});for(let n=0;n<2;n++){let i=h.debug.timeScale<1;Ar({p1:x(-t.width-e*(i?2:3.5),-e),p2:x(-t.width-e*(i?2:3.5),-e-t.height),p3:x(-t.width-e*(i?3.5:2),-e-t.height/2),pos:x(-n*e*1+(i?-e*.5:0),0),color:ne(255,255,255),fixed:!0})}Mt(t),je()}),h.debug.curRecording&&ct(()=>{ze(),we(0,Ie()),we(24,-24),Yt({radius:12,color:ne(255,0,0),opacity:Fi(0,1,h.app.time()*4),fixed:!0}),je()}),h.debug.showLog&&h.game.logs.length>0&&ct(()=>{ze(),we(0,Ie()),we(8,-8);let e=8,t=[];for(let i of h.game.logs){let s="",r=i.msg instanceof Error?"error":"info";s+=`[time]${i.time.toFixed(2)}[/time]`,s+=" ",s+=`[${r}]${qs(i.msg)}[/${r}]`,t.push(s)}h.game.logs=h.game.logs.filter(i=>h.app.time()-i.time<(h.globalOpt.logTime||4));let n=Et({text:t.join(`
`),font:Ln,pos:x(e,-e),anchor:"botleft",size:16,width:Te()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:ne(127,127,127)},info:{color:ne(255,255,255)},error:{color:ne(255,0,127)}}});We({width:n.width+e*2,height:n.height+e*2,anchor:"botleft",color:ne(0,0,0),radius:4,opacity:.8,fixed:!0}),Mt(n),je()})}function qs(e,t=!1,n=new Set){if(n.has(e))return"<recursive>";var i="",s;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(i=["[",e.map(r=>qs(r,!0,n.union(new Set([e])))).join(", "),"]"].join(""),e=i),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(i+=e.constructor.name+" "),i+=["{",(s=Object.getOwnPropertyNames(e).map(r=>`${/^\w+$/.test(r)?r:JSON.stringify(r)}: ${qs(e[r],!0,n.union(new Set([e])))}`).join(", "))?` ${s} `:"","}"].join(""),e=i),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function Bl(){let e=h.game.cam,t=P.fromAngle(Pe(0,360)).scale(e.shake);e.shake=Ne(e.shake,0,5*Ee()),e.transform=new nt().translate(Un()).scale(e.scale).rotate(e.angle).translate((e.pos??Un()).scale(-1).add(t)),h.game.root.draw(),Ye()}function Rl(){let e=Pt();h.game.events.numListeners("loading")>0?h.game.events.trigger("loading",e):ct(()=>{let t=Te()/2,n=24,i=x(Te()/2,Ie()/2).sub(x(t/2,n/2));We({pos:x(0),width:Te(),height:Ie(),color:ne(0,0,0)}),We({pos:i,width:t,height:n,fill:!1,outline:{width:4}}),We({pos:i,width:t*e,height:n})})}function xr(e,t,n){let i=h.gfx.ggl.gl;Ye(),i.clear(i.STENCIL_BUFFER_BIT),i.enable(i.STENCIL_TEST),i.stencilFunc(i.NEVER,1,255),i.stencilOp(i.REPLACE,i.REPLACE,i.REPLACE),t(),Ye(),i.stencilFunc(n,1,255),i.stencilOp(i.KEEP,i.KEEP,i.KEEP),e(),Ye(),i.disable(i.STENCIL_TEST)}function Hl(e,t){let n=h.gfx.ggl.gl;xr(e,t,n.EQUAL)}function Kn(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new pe(0,0,1,1),n=e.tex.width*t.w,i=e.tex.height*t.h,s=new P(1);if(e.tiled){let r=zt(e.anchor||Qn);(e.pos?.x||0)-(r.x+1)*.5*(e.width||n),(e.pos?.y||0)-(r.y+1)*.5*(e.height||i);let a=(e.width||n)/n,l=(e.height||i)/i,o=Math.floor(a),u=Math.floor(l),d=a-o,f=l-u,c=(o+d?1:0)*(u+f?1:0),g=new Array(c*6),p=new Array(c*4),w=0,y=(v,C,D,F,M)=>{g[w*6+0]=w*4+0,g[w*6+1]=w*4+1,g[w*6+2]=w*4+3,g[w*6+3]=w*4+1,g[w*6+4]=w*4+2,g[w*6+5]=w*4+3,p[w*4+0]={pos:new P(v-r.x,C-r.y),uv:new P(M.x,M.y),color:e.color||Z.WHITE,opacity:e.opacity||1},p[w*4+1]={pos:new P(v+D-r.x,C-r.y),uv:new P(M.x+M.w,M.y),color:e.color||Z.WHITE,opacity:e.opacity||1},p[w*4+2]={pos:new P(v+D-r.x,C+F-r.y),uv:new P(M.x+M.w,M.y+M.h),color:e.color||Z.WHITE,opacity:e.opacity||1},p[w*4+3]={pos:new P(v-r.x,C+F-r.y),uv:new P(M.x,M.y+M.h),color:e.color||Z.WHITE,opacity:e.opacity||1},w++};for(let v=0;v<u;v++){for(let C=0;C<o;C++)y(C*n,v*i,n,i,t);d&&y(o*n,v*i,n*d,i,new pe(t.x,t.y,t.w*d,t.h))}if(f){for(let v=0;v<o;v++)y(v*n,u*i,n,i*f,new pe(t.x,t.y,t.w,t.h*f));d&&y(o*n,u*i,n*d,i*f,new pe(t.x,t.y,t.w*d,t.h*f))}mt(p,g,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(s.x=e.width/n,s.y=e.height/i):e.width?(s.x=e.width/n,s.y=s.x):e.height&&(s.y=e.height/i,s.x=s.y),fn(Object.assign({},e,{scale:s.scale(e.scale||new P(1)),tex:e.tex,quad:t,width:n,height:i}))}function Fl(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Rn(e.sprite);if(!t||!t.data)return;let n=t.data.frames[e.frame??0];if(!n)throw new Error(`Frame not found: ${e.frame??0}`);Kn(Object.assign({},e,{tex:t.data.tex,quad:n.scale(e.quad??new pe(0,0,1,1))}))}function Ol(e,t){let n=h.gfx.ggl.gl;xr(e,t,n.NOTEQUAL)}function Pi(e){Mt(Et(e))}var jl=(e,t)=>{let n=_s(t,Ps,Es),i=e.pixelDensity??1,s=e.scale??1,{gl:r}=t,a=ft.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),l=e.width&&e.height?new Gn(t,e.width*i*s,e.height*i*s):new Gn(t,r.drawingBufferWidth,r.drawingBufferHeight),o=null,u=1;e.background&&(typeof e.background=="string"?o=ne(e.background):(o=ne(...e.background),u=e.background[3]??1),r.clearColor(o.r/255,o.g/255,o.b/255,u??1)),r.enable(r.BLEND),r.blendFuncSeparate(r.ONE,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA);let d=new Il(t,Vs,eo,to),f=ft.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:n,defTex:a,frameBuffer:l,postShader:null,postShaderUniform:null,renderer:d,transform:new nt,transformStack:[],bgTex:f,bgColor:o,bgAlpha:u,width:e.width??r.drawingBufferWidth/i/s,height:e.height??r.drawingBufferHeight/i/s,viewport:{x:0,y:0,width:r.drawingBufferWidth,height:r.drawingBufferHeight,scale:1},fixed:!1}};function xt(e){return e.fixed?!0:e.parent?xt(e.parent):!1}function Ct(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Nl(e,t={}){return{id:"circle",radius:e,draw(){Yt(Object.assign(Ct(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new ae(new P(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Sr(...e){return{id:"color",color:ne(...e),inspect(){return`color: ${this.color.toString()}`}}}function Ll(e){return{add(){this.canvas=e}}}function Ul(e=1){let t,n=0,i=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){i||(n+=Ee(),this.opacity=et(n,0,e,0,t),n>=e&&(this.opacity=t,i=!0))}}}function Gl(e="intersect"){return{id:"mask",mask:e}}function Pr(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,n=h.k.easings.linear){return h.game.root.tween(0,this.opacity,t,i=>this.opacity=i,n)},fadeOut(t=1,n=h.k.easings.linear){return h.game.root.tween(this.opacity,0,t,i=>this.opacity=i,n)},inspect(){return`opacity: ${Ms(this.opacity,1)}`}}}function Kl(e=1,t=ne(0,0,0),n=1,i="miter",s=10,r="butt"){return{id:"outline",outline:{width:e,color:t,opacity:n,join:i,miterLimit:s,cap:r},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var Xl=class{pos=x(0);vel=x(0);acc=x(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function zl(e,t){let n=t.lifetime,i=[],s=e.colors||[Z.WHITE],r=e.opacities||[1],a=e.quads||[new pe(0,0,1,1)],l=e.scales||[1],o=e.lifeTime,u=t.direction,d=t.spread,f=e.speed||[0,0],c=e.angle||[0,0],g=e.angularVelocity||[0,0],p=e.acceleration||[x(0),x(0)],w=e.damping||[0,0],y=[],v=new Array(e.max),C=0,D=0;for(let b=0;b<e.max;b++){y[b*6+0]=b*4+0,y[b*6+1]=b*4+1,y[b*6+2]=b*4+3,y[b*6+3]=b*4+1,y[b*6+4]=b*4+2,y[b*6+5]=b*4+3;for(let A=0;A<4;A++)v[b*4+A]={pos:new P(0,0),uv:new P(0,0),color:ne(255,255,255),opacity:1};i[b]=new Xl}let F=new Be;function M(b=0){for(;b<e.max;){if(i[b].gc)return b;b++}return null}return{id:"particles",emit(b){let A=0;for(let I=0;I<b;I++){if(A=M(A),A==null)return;let q=Pe(u-d,u+d),B=P.fromAngle(q).scale(Pe(f[0],f[1])),O=Pe(c[0],c[1]),L=Pe(g[0],g[1]),Q=x(Pe(p[0].x,p[1].x),Pe(p[0].y,p[1].y)),J=Pe(w[0],w[1]),$=o?Pe(o[0],o[1]):null,X=t.shape?t.shape.random():x(),U=i[A];U.lt=$,U.pos=X,U.vel=B,U.acc=Q,U.angle=O,U.angularVelocity=L,U.damping=J,U.angularVelocity=L,U.gc=!1}C+=b},update(){if(n!==void 0&&n<=0)return;let b=Ee();for(let A of i)if(!A.gc){if(A.t+=b,A.lt&&A.t>=A.lt){A.gc=!0,C--;continue}A.vel=A.vel.add(A.acc.scale(b)).scale(1-A.damping*b),A.pos=A.pos.add(A.vel.scale(b)),A.angle+=A.angularVelocity*b}for(n!==void 0&&(n-=b,n<=0&&F.trigger()),D+=b;C<e.max&&t.rate&&D>t.rate;)this.emit(1),C++,D-=t.rate},draw(){if(!(n!==void 0&&n<=0)){for(let b=0;b<i.length;b++){let A=i[b];if(A.gc)continue;let I=A.progress,q=Math.floor(A.progress*s.length),B=q<s.length-1?Ne(s[q],s[q+1],et(I,q/s.length,(q+1)/s.length,0,1)):s[q],O=Math.floor(A.progress*r.length),L=O<r.length-1?Ne(r[O],r[O+1],et(I,O/r.length,(O+1)/r.length,0,1)):r[O],Q=Math.floor(A.progress*a.length),J=a[Q],$=Math.floor(A.progress*l.length),X=l[$],U=Math.cos(A.angle*Math.PI/180),he=Math.sin(A.angle*Math.PI/180),_=(e.texture?e.texture.width:10)*J.w/2,se=(e.texture?e.texture.height:10)*J.h/2,Me=b*4,K=v[Me];K.pos.x=A.pos.x+-_*X*U- -se*X*he,K.pos.y=A.pos.y+-_*X*he+-se*X*U,K.uv.x=J.x,K.uv.y=J.y,K.color.r=B.r,K.color.g=B.g,K.color.b=B.b,K.opacity=L,K=v[Me+1],K.pos.x=A.pos.x+_*X*U- -se*X*he,K.pos.y=A.pos.y+_*X*he+-se*X*U,K.uv.x=J.x+J.w,K.uv.y=J.y,K.color.r=B.r,K.color.g=B.g,K.color.b=B.b,K.opacity=L,K=v[Me+2],K.pos.x=A.pos.x+_*X*U-se*X*he,K.pos.y=A.pos.y+_*X*he+se*X*U,K.uv.x=J.x+J.w,K.uv.y=J.y+J.h,K.color.r=B.r,K.color.g=B.g,K.color.b=B.b,K.opacity=L,K=v[Me+3],K.pos.x=A.pos.x+-_*X*U-se*X*he,K.pos.y=A.pos.y+-_*X*he+se*X*U,K.uv.x=J.x,K.uv.y=J.y+J.h,K.color.r=B.r,K.color.g=B.g,K.color.b=B.b,K.opacity=L}mt(v,y,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(b){return F.add(b)},inspect(){return`count: ${C}/${e.max}`}}}function Yl(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){ht(Object.assign(Ct(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new He(this.pts)},inspect(){return`polygon: ${this.pts.map(n=>`[${n.x},${n.y}]`).join(",")}`}}}function Er(e,t,n){let i;return h.game.root.get("area").forEach(s=>{if(n&&n.some(a=>s.is(a)))return;let r=s.worldArea().raycast(e,t);r&&(i?r.fraction<i.fraction&&(i=r,i.object=s):(i=r,i.object=s))}),i}function Mr(e,t,n={}){return{id:"rect",width:e,height:t,radius:n.radius||0,draw(){We(Object.assign(Ct(this),{width:this.width,height:this.height,radius:this.radius,fill:n.fill}))},renderArea(){return new ae(x(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Wl(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function Vl(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let n=h.game.root.add([Xn(t.pos??x(0))]),i=e.length,s=0,r=null,a=null,l=null,o=null,u=b=>b.x+b.y*s,d=b=>x(Math.floor(b%s),Math.floor(b/s)),f=()=>{r=[];for(let b of n.children)c(b)},c=b=>{let A=u(b.tilePos);r[A]?r[A].push(b):r[A]=[b]},g=b=>{let A=u(b.tilePos);if(r[A]){let I=r[A].indexOf(b);I>=0&&r[A].splice(I,1)}},p=()=>{let b=!1;for(let A of n.children){let I=n.pos2Tile(A.pos);(A.tilePos.x!=I.x||A.tilePos.y!=I.y)&&(b=!0,g(A),A.tilePos.x=I.x,A.tilePos.y=I.y,c(A))}b&&n.trigger("spatialMapChanged")},w=()=>{let b=n.getSpatialMap(),A=n.numRows()*n.numColumns();a?a.length=A:a=new Array(A),a.fill(1,0,A);for(let I=0;I<b.length;I++){let q=b[I];if(q){let B=0;for(let O of q)if(O.isObstacle){B=1/0;break}else B+=O.cost;a[I]=B||1}}},y=()=>{let b=n.getSpatialMap(),A=n.numRows()*n.numColumns();l?l.length=A:l=new Array(A),l.fill(15,0,A);for(let I=0;I<b.length;I++){let q=b[I];if(q){let B=q.length,O=15;for(let L=0;L<B;L++)O|=q[L].edgeMask;l[I]=O}}},v=()=>{let b=n.numRows()*n.numColumns(),A=(q,B)=>{let O=[];for(O.push(q);O.length>0;){let L=O.pop();F(L).forEach(Q=>{o[Q]<0&&(o[Q]=B,O.push(Q))})}};o?o.length=b:o=new Array(b),o.fill(-1,0,b);let I=0;for(let q=0;q<a.length;q++){if(o[q]>=0){I++;continue}A(q,I),I++}},C=(b,A)=>a[A],D=(b,A)=>{let I=d(b),q=d(A);return I.dist(q)},F=(b,A)=>{let I=[],q=Math.floor(b%s),B=q>0&&l[b]&1&&a[b-1]!==1/0,O=b>=s&&l[b]&2&&a[b-s]!==1/0,L=q<s-1&&l[b]&4&&a[b+1]!==1/0,Q=b<s*i-s-1&&l[b]&8&&a[b+s]!==1/0;return A?(B&&(O&&I.push(b-s-1),I.push(b-1),Q&&I.push(b+s-1)),O&&I.push(b-s),L&&(O&&I.push(b-s+1),I.push(b+1),Q&&I.push(b+s+1)),Q&&I.push(b+s)):(B&&I.push(b-1),O&&I.push(b-s),L&&I.push(b+1),Q&&I.push(b+s)),I},M={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(b,...A){let I=x(...A),q=(()=>{if(typeof b=="string"){if(t.tiles[b]){if(typeof t.tiles[b]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[b](I)}else if(t.wildcardTile)return t.wildcardTile(b,I)}else{if(Array.isArray(b))return b;throw new Error("Expected a symbol or a component list")}})();if(!q)return null;let B=!1,O=!1;for(let Q of q)Q.id==="tile"&&(O=!0),Q.id==="pos"&&(B=!0);B||q.push(Xn(this.tile2Pos(I))),O||q.push(zr());let L=n.add(q);return B&&(L.tilePosOffset=L.pos.clone()),L.tilePos=I,L.transform=an(L),r&&(c(L),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),L},numColumns(){return s},numRows(){return i},levelWidth(){return s*this.tileWidth()},levelHeight(){return i*this.tileHeight()},tile2Pos(...b){return x(...b).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...b){let A=x(...b);return x(Math.floor(A.x/this.tileWidth()),Math.floor(A.y/this.tileHeight()))},getSpatialMap(){return r||f(),r},removeFromSpatialMap:g,insertIntoSpatialMap:c,onSpatialMapChanged(b){return this.on("spatialMapChanged",b)},onNavigationMapInvalid(b){return this.on("navigationMapInvalid",b)},getAt(b){r||f();let A=u(b);return r[A]||[]},raycast(b,A){let I=this.toWorld(b),q=this.toWorld(b.add(A)).sub(I),B=1/this.tileWidth(),O=b.scale(B),L=Ca(O,A,Q=>{let J=this.getAt(Q);if(J.some(X=>X.isObstacle))return!0;let $=null;for(let X of J)if(X.has("area")){let U=X.worldArea().raycast(I,q);U&&($?U.fraction<$.fraction&&($=U,$.object=X):($=U,$.object=X))}return $&&($.point=this.fromWorld($.point).scale(B)),$||!1},64);return L&&(L.point=L.point.scale(this.tileWidth())),L},update(){r&&p()},invalidateNavigationMap(){a=null,l=null,o=null},onNavigationMapChanged(b){return this.on("navigationMapChanged",b)},getTilePath(b,A,I={}){if(a||w(),l||y(),o||v(),b.x<0||b.x>=s||b.y<0||b.y>=i||A.x<0||A.x>=s||A.y<0||A.y>=i)return null;let q=u(b),B=u(A);if(a[B]===1/0)return null;if(q===B)return[];if(o[q]!=-1&&o[q]!==o[B])return null;let O=new sr((U,he)=>U.cost<he.cost);O.insert({cost:0,node:q});let L=new Map;L.set(q,q);let Q=new Map;for(Q.set(q,0);O.length!==0;){let U=O.remove()?.node;if(U===B)break;let he=F(U,I.allowDiagonals);for(let _ of he){let se=(Q.get(U)||0)+C(U,_)+D(_,B);(!Q.has(_)||se<Q.get(_))&&(Q.set(_,se),O.insert({cost:se,node:_}),L.set(_,U))}}let J=[],$=B,X=d($);for(J.push(X);$!==q;){let U=L.get($);if(U===void 0)throw new Error("Bug in pathfinding algorithm");$=U;let he=d($);J.push(he)}return J.reverse()},getPath(b,A,I={}){let q=this.tileWidth(),B=this.tileHeight(),O=this.getTilePath(this.pos2Tile(b),this.pos2Tile(A),I);return O?[b,...O.slice(1,-1).map(L=>L.scale(q,B).add(q/2,B/2)),A]:null}};return n.use(M),n.onNavigationMapInvalid(()=>{n.invalidateNavigationMap(),n.trigger("navigationMapChanged")}),e.forEach((b,A)=>{let I=b.split("");s=Math.max(I.length,s),I.forEach((q,B)=>{n.spawn(q,x(B,A))})}),n}function Ge(e,t,n){return h.game.objEvents.registers[e]||(h.game.objEvents.registers[e]=new tr),h.game.objEvents.on(e,(i,...s)=>{i.is(t)&&n(i,...s)})}var Ql=(e,t,...n)=>{for(let i of h.game.root.children)i.is(t)&&i.trigger(e,n)},Jl=le(e=>{let t=h.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(n){t.paused=n},cancel:()=>t.destroy()}},(e,t)=>Ge("fixedUpdate",e,t)),Cr=le(e=>{let t=h.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(n){t.paused=n},cancel:()=>t.destroy()}},(e,t)=>Ge("update",e,t)),Zl=le(e=>{let t=h.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(n){t.hidden=n},cancel:()=>t.destroy()}},(e,t)=>Ge("draw",e,t)),Tr=le(e=>h.game.events.on("add",e),(e,t)=>Ge("add",e,t)),$l=le(e=>h.game.events.on("destroy",e),(e,t)=>Ge("destroy",e,t)),_l=le(e=>h.game.events.on("use",e),(e,t)=>Ge("use",e,t)),kl=le(e=>h.game.events.on("unuse",e),(e,t)=>Ge("unuse",e,t)),Ir=le(e=>h.game.events.on("tag",e),(e,t)=>Ge("tag",e,t)),eu=le(e=>h.game.events.on("untag",e),(e,t)=>Ge("untag",e,t));function tu(e,t,n){return Ge("collide",e,(i,s,r)=>s.is(t)&&n(i,s,r))}function nu(e,t,n){return Ge("collideUpdate",e,(i,s,r)=>s.is(t)&&n(i,s,r))}function su(e,t,n){return Ge("collideEnd",e,(i,s,r)=>s.is(t)&&n(i,s,r))}function $n(e,t){h.game.root.get(e,{recursive:!0}).forEach(t),Tr(e,t),Ir((n,i)=>{i===e&&t(n)})}var iu=le(e=>h.app.onMousePress(e),(e,t)=>{let n=[];return $n(e,i=>{if(!i.area)throw new Error("onClick() requires the object to have area() component");n.push(i.onClick(()=>t(i)))}),Tt.join(n)});function ru(e,t){let n=[];return $n(e,i=>{if(!i.area)throw new Error("onHover() requires the object to have area() component");n.push(i.onHover(()=>t(i)))}),Tt.join(n)}function au(e,t){let n=[];return $n(e,i=>{if(!i.area)throw new Error("onHoverUpdate() requires the object to have area() component");n.push(i.onHoverUpdate(()=>t(i)))}),Tt.join(n)}function ou(e,t){let n=[];return $n(e,i=>{if(!i.area)throw new Error("onHoverEnd() requires the object to have area() component");n.push(i.onHoverEnd(()=>t(i)))}),Tt.join(n)}function lu(e){h.game.events.on("loading",e)}function uu(e){h.app.onResize(e)}function du(e){h.game.events.on("error",e)}function ei(e){h.assets.loaded?e():h.game.events.on("load",e)}function cu(e){if(h.assets.loaded)ur().forEach(t=>e(...t));else return h.game.events.on("loadError",e)}function Dr(...e){h.game.cam.pos=x(...e)}function qr(){return h.game.cam.pos?h.game.cam.pos.clone():Un()}function Br(...e){h.game.cam.scale=x(...e)}function Rr(){return h.game.cam.scale.clone()}function Hr(e){h.game.cam.angle=e}function Fr(){return h.game.cam.angle}function hu(){return h.game.cam.transform.clone()}function Or(e=ne(255,255,255),t=1){let n=h.game.root.add([Mr(Te(),Ie()),Sr(e),Pr(1),Vr()]),i=n.fadeOut(t);return i.onEnd(()=>Xr(n)),i}function fu(){return h.game.cam.transform.clone()}function pu(e=12){h.game.cam.shake+=e}function Bs(e){return h.game.cam.transform.multVec2(e)}function jr(e){return h.game.cam.transform.invert().multVec2(e)}function gu(...e){return Xt("camPos","setCamPos / getCamPos"),e.length>0&&Dr(...e),qr()}function mu(...e){return Xt("camScale","setCamScale / getCamScale"),e.length>0&&Br(...e),Rr()}function yu(e){return Xt("camRot","setCamRot / getCamRot"),e!==void 0&&Hr(e),Fr()}function wu(e=ne(255,255,255),t=1){return Xt("camFlash","flash"),Or(e,t)}function ti(e=[]){let t=new Map,n=[],i={},s=new un,r=[],a=new Set("*"),l=h.globalOpt.tagsAsComponents,o=null,u=!1,d={id:Io(),hidden:!1,transform:new nt,children:[],parent:null,set paused(c){if(c!==u){u=c;for(let g of r)g.paused=c}},get paused(){return u},get tags(){return Array.from(a)},add(c){let g=Array.isArray(c)?ti(c):c;if(g.parent)throw new Error("Cannot add a game obj that already has a parent.");return g.parent=this,g.transform=an(g),this.children.push(g),g.trigger("add",g),h.game.events.trigger("add",g),g},readd(c){let g=this.children.indexOf(c);return g!==-1&&(this.children.splice(g,1),this.children.push(c)),c},remove(c){let g=this.children.indexOf(c);if(g!==-1){c.parent=null,this.children.splice(g,1);let p=w=>{w.trigger("destroy"),h.game.events.trigger("destroy",w),w.children.forEach(y=>p(y))};p(c)}},removeAll(c){if(c)this.get(c).forEach(g=>this.remove(g));else for(let g of[...this.children])this.remove(g)},fixedUpdate(){this.paused||(this.children.forEach(c=>c.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(c=>c.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Ye(),this.canvas.bind());let c=h.gfx.fixed;this.fixed&&(h.gfx.fixed=!0),ze(),we(this.pos),cn(this.scale),Gt(this.angle);let g=this.children.sort((p,w)=>{let y=p.layerIndex??h.game.defaultLayerIndex,v=w.layerIndex??h.game.defaultLayerIndex;return y-v||(p.z??0)-(w.z??0)});if(this.mask){let p={intersect:h.k.drawMasked,subtract:h.k.drawSubtracted}[this.mask];if(!p)throw new Error(`Invalid mask func: "${this.mask}"`);p(()=>{g.forEach(w=>w.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),g.forEach(p=>p.draw());je(),h.gfx.fixed=c,this.canvas&&(Ye(),this.canvas.unbind())},drawInspect(){this.hidden||(ze(),we(this.pos),cn(this.scale),Gt(this.angle),this.children.forEach(c=>c.drawInspect()),this.trigger("drawInspect"),je())},use(c){if(typeof c=="string")return a.add(c);if(!c||typeof c!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof c}"`);let g=[];c.id?(this.unuse(c.id),i[c.id]=[],g=i[c.id],t.set(c.id,c),l&&a.add(c.id)):n.push(c);for(let w in c){if(io.has(w))continue;let y=Object.getOwnPropertyDescriptor(c,w);if(y)if(typeof y.value=="function"&&(c[w]=c[w].bind(this)),y.set&&Object.defineProperty(c,w,{set:y.set.bind(this)}),y.get&&Object.defineProperty(c,w,{get:y.get.bind(this)}),ro.has(w)){let v=w==="add"?()=>{o=C=>g.push(C),c[w]?.(),o=null}:c[w];g.push(this.on(w,v).cancel)}else if(this[w]===void 0)Object.defineProperty(this,w,{get:()=>c[w],set:v=>c[w]=v,configurable:!0,enumerable:!0}),g.push(()=>delete this[w]);else{let v=t.values().find(C=>C[w]!==void 0)?.id;throw new Error(`Duplicate component property: "${w}" while adding component "${c.id}"`+(v?` (originally added by "${v}")`:""))}}let p=()=>{if(c.require){for(let w of c.require)if(!this.c(w))throw new Error(`Component "${c.id}" requires component "${w}"`)}};c.destroy&&g.push(c.destroy.bind(this)),this.exists()?(p(),c.add&&(o=w=>g.push(w),c.add.call(this),o=null),c.id&&(this.trigger("use",c.id),h.game.events.trigger("use",this,c.id))):c.require&&g.push(this.on("add",p).cancel)},unuse(c){if(t.has(c)){for(let g of t.values())if(g.require&&g.require.includes(c))throw new Error(`Can't unuse. Component "${g.id}" requires component "${c}"`);t.delete(c),this.trigger("unuse",c),h.game.events.trigger("unuse",this,c)}else l&&a.has(c)&&a.delete(c);i[c]&&(i[c].forEach(g=>g()),delete i[c])},c(c){return t.get(c)??null},get(c,g={}){let p=(y,v)=>g.only==="comps"?y.has(v):g.only==="tags"?y.is(v):y.is(v)||y.has(v),w=g.recursive?this.children.flatMap(function y(v){return[v,...v.children.flatMap(y)]}):this.children;if(w=w.filter(y=>c?p(y,c):!0),g.liveUpdate){let y=C=>g.recursive?this.isAncestorOf(C):C.parent===this,v=[];v.push(h.k.onAdd(C=>{y(C)&&p(C,c)&&w.push(C)})),v.push(h.k.onDestroy(C=>{if(y(C)&&p(C,c)){let D=w.findIndex(F=>F.id===C.id);D!==-1&&w.splice(D,1)}})),this.onDestroy(()=>{for(let C of v)C.cancel()})}return w},query(c){let g=c.hierarchy||"children",p=c.include,w=c.exclude,y=[];switch(g){case"children":y=this.children;break;case"siblings":y=this.parent?this.parent.children.filter(C=>C!==this):[];break;case"ancestors":let v=this.parent;for(;v;)y.push(v),v=v.parent;break;case"descendants":y=this.children.flatMap(function C(D){return[D,...D.children.flatMap(C)]});break}if(p&&((c.includeOp||"and")==="and"||!Array.isArray(c.include)?y=y.filter(v=>v.is(p)):y=y.filter(v=>c.include.some(C=>v.is(C)))),w&&((c.includeOp||"and")==="and"||!Array.isArray(c.include)?y=y.filter(v=>!v.is(w)):y=y.filter(v=>!c.exclude.some(C=>v.is(C)))),c.visible===!0&&(y=y.filter(v=>v.visible)),c.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let v=c.distanceOp||"near",C=c.distance*c.distance;v==="near"?y=y.filter(D=>D.pos&&this.pos.sdist(D.pos)<=C):y=y.filter(D=>D.pos&&this.pos.sdist(D.pos)>C)}return c.name&&(y=y.filter(v=>v.name===c.name)),y},isAncestorOf(c){return c.parent?c.parent===this||this.isAncestorOf(c.parent):!1},exists(){return h.game.root.isAncestorOf(this)},is(c,g="and"){return Array.isArray(c)?g==="and"?c.every(p=>a.has(p)):c.some(p=>a.has(p)):a.has(c)},tag(c){if(Array.isArray(c))for(let g of c)a.add(g),this.trigger("tag",g),h.game.events.trigger("tag",this,g);else a.add(c),this.trigger("tag",c),h.game.events.trigger("tag",this,c)},untag(c){if(Array.isArray(c))for(let g of c)a.delete(g),this.trigger("untag",g),h.game.events.trigger("untag",this,g);else a.delete(c),this.trigger("untag",c),h.game.events.trigger("untag",this,c)},has(c,g="and"){return Array.isArray(c)?g==="and"?c.every(p=>t.has(p)):c.some(p=>t.has(p)):t.has(c)},on(c,g){let p=s.on(c,g.bind(this));return o&&o(()=>p.cancel()),p},trigger(c,...g){s.trigger(c,...g),h.game.objEvents.trigger(c,this,...g)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let c={};for(let[g,p]of t)c[g]=p.inspect?.()??null;for(let[g,p]of n.entries()){if(p.inspect){c[g]=p.inspect();continue}for(let[w,y]of Object.entries(p))typeof y!="function"&&(c[w]=`${w}: ${y}`)}return c},onAdd(c){return this.on("add",c)},onFixedUpdate(c){return this.on("fixedUpdate",c)},onUpdate(c){return this.on("update",c)},onDraw(c){return this.on("draw",c)},onDestroy(c){return this.on("destroy",c)},onUse(c){return this.on("use",c)},onUnuse(c){return this.on("unuse",c)},clearEvents(){s.clear()}},f=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let c of f)d[c]=(...g)=>{let p=h.app[c]?.(...g);return r.push(p),d.onDestroy(()=>p.cancel()),d.on("sceneEnter",()=>{r.splice(r.indexOf(p),1);let w=h.app[c]?.(...g);Tt.replace(p,w),r.push(p)}),p};for(let c of e)d.use(c);return d}var vu=()=>({events:new un,objEvents:new un,root:ti([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new P(1),angle:0,shake:0,transform:new nt}});function bu(e){h.game.gravity=e?(h.game.gravity||x(0,1)).unit().scale(e):null}function Au(){return h.game.gravity?h.game.gravity.len():0}function xu(e){h.game.gravity=e.unit().scale(h.game.gravity?h.game.gravity.len():1)}function ln(){return h.game.gravity?h.game.gravity.unit():x(0,1)}var Su=ia("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),Pu=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let n=new hn(Qo(e));return e.decodeAudioData(Su.buffer.slice(0)).then(i=>{n.buf=i}).catch(i=>{console.error("Failed to load burp: ",i)}),{ctx:e,masterNode:t,burpSnd:n}})();function Eu(e,t={}){let n=new Be,i=new Audio(e);i.crossOrigin="anonymous",i.loop=!!t.loop,h.audio.ctx.createMediaElementSource(i).connect(h.audio.masterNode);function s(){h.debug.paused||h.app.isHidden()&&!h.globalOpt.backgroundAudio||h.audio.ctx.resume()}function r(){s(),i.play()}return t.paused||r(),i.onended=()=>n.trigger(),{play(){r()},seek(a){i.currentTime=a},stop(){i.pause(),this.seek(0)},set loop(a){i.loop=a},get loop(){return i.loop},set paused(a){a?i.pause():r()},get paused(){return i.paused},time(){return i.currentTime},duration(){return i.duration},set volume(a){i.volume=tt(a,0,1)},get volume(){return i.volume},set speed(a){i.playbackRate=Math.max(a,0)},get speed(){return i.playbackRate},set detune(a){},get detune(){return 0},onEnd(a){return n.add(a)},then(a){return this.onEnd(a)}}}function Mu(e,t={}){if(typeof e=="string"&&h.assets.music[e])return Eu(h.assets.music[e],t);let n=h.audio.ctx,i=t.paused??!1,s=n.createBufferSource(),r=new Be,a=n.createGain(),l=n.createStereoPanner(),o=t.seek??0,u=0,d=0,f=!1;s.loop=!!t.loop,s.detune.value=t.detune??0,s.playbackRate.value=t.speed??1,s.connect(l),s.onended=()=>{p()>=(s.buffer?.duration??Number.POSITIVE_INFINITY)&&r.trigger()},l.pan.value=t.pan??0,l.connect(a),a.connect(h.audio.masterNode),a.gain.value=t.volume??1;let c=y=>{s.buffer=y.buf,i||(u=n.currentTime,s.start(0,o),f=!0)},g=xl(e);g instanceof Qe&&g.onLoad(c);let p=()=>{if(!s.buffer)return 0;let y=i?d-u:n.currentTime-u,v=s.buffer.duration;return s.loop?y%v:Math.min(y,v)},w=y=>{let v=n.createBufferSource();return v.buffer=y.buffer,v.loop=y.loop,v.playbackRate.value=y.playbackRate.value,v.detune.value=y.detune.value,v.onended=y.onended,v.connect(l),v};return{stop(){this.paused=!0,this.seek(0)},set paused(y){if(i!==y)if(i=y,y)f&&(s.stop(),f=!1),d=n.currentTime;else{s=w(s);let v=d-u;s.start(0,v),f=!0,u=n.currentTime-v,d=0}},get paused(){return i},play(y=0){this.seek(y),this.paused=!1},seek(y){s.buffer?.duration&&(y>s.buffer.duration||(i?(s=w(s),u=d-y):(s.stop(),s=w(s),u=n.currentTime-y,s.start(0,y),f=!0,d=0)))},set speed(y){s.playbackRate.value=y},get speed(){return s.playbackRate.value},set detune(y){s.detune.value=y},get detune(){return s.detune.value},set volume(y){a.gain.value=Math.max(y,0)},get volume(){return a.gain.value},set pan(y){l.pan.value=y},get pan(){return l.pan.value},set loop(y){s.loop=y},get loop(){return s.loop},duration(){return s.buffer?.duration??0},time(){return p()%this.duration()},onEnd(y){return r.add(y)},then(y){return this.onEnd(y)}}}function Nr(e){return h.k.play(h.audio.burpSnd,e)}function Lr(e){h.audio.masterNode.gain.value=e}function Ur(){return h.audio.masterNode.gain.value}function Cu(e){return Xt("volume","setVolume / getVolume"),e!==void 0&&Lr(e),Ur()}function Gr(){h.app.onHide(()=>{h.globalOpt.backgroundAudio||h.audio.ctx.suspend()}),h.app.onShow(()=>{!h.globalOpt.backgroundAudio&&!h.debug.paused&&h.audio.ctx.resume()}),h.app.onResize(()=>{if(h.app.isFullscreen())return;let e=h.globalOpt.width&&h.globalOpt.height;e&&!h.globalOpt.stretch&&!h.globalOpt.letterbox||(h.canvas.width=h.canvas.offsetWidth*h.pixelDensity,h.canvas.height=h.canvas.offsetHeight*h.pixelDensity,ar(),e||(h.gfx.frameBuffer.free(),h.gfx.frameBuffer=new Gn(h.gfx.ggl,h.gfx.ggl.gl.drawingBufferWidth,h.gfx.ggl.gl.drawingBufferHeight),h.gfx.width=h.gfx.ggl.gl.drawingBufferWidth/h.pixelDensity/h.gscale,h.gfx.height=h.gfx.ggl.gl.drawingBufferHeight/h.pixelDensity/h.gscale))}),h.globalOpt.debug!==!1&&(h.app.onKeyPress(h.globalOpt.debugKey??"f1",()=>h.debug.inspect=!h.debug.inspect),h.app.onKeyPress("f2",()=>h.debug.clearLog()),h.app.onKeyPress("f8",()=>h.debug.paused=!h.debug.paused),h.app.onKeyPress("f7",()=>{h.debug.timeScale=Ms(tt(h.debug.timeScale-.2,0,2),1)}),h.app.onKeyPress("f9",()=>{h.debug.timeScale=Ms(tt(h.debug.timeScale+.2,0,2),1)}),h.app.onKeyPress("f10",()=>h.debug.stepFrame())),h.globalOpt.burp&&h.app.onKeyPress("b",()=>Nr())}function Tu(e,t={}){let n=h.game.root.add([Xn(e),Wr()]),i=(t.speed||1)*5,s=t.scale||1;n.add([Rs(h.boomSprite),zn(0),Os("center"),Mi(i,s),...t.comps??[]]);let r=n.add([Rs(h.kaSprite),zn(0),Os("center"),Hs(),...t.comps??[]]);return r.wait(.4/i,()=>r.use(Mi(i,s))),r.onDestroy(()=>n.destroy()),n}function Kr(e,t){if(h.game.layers)throw Error("Layers can only be assigned once.");let n=e.indexOf(t);if(n==-1)throw Error("The default layer name should be present in the layers list.");h.game.layers=e,h.game.defaultLayerIndex=n}function Iu(){return h.game.layers}function Du(){return h.game.layers?.[h.game.defaultLayerIndex]??null}function qu(e,t){Xt("layers","setLayers"),Kr(e,t)}function Xr(e){e.destroy()}function Bu(){return h.game.root}function Ru(e,t){h.game.scenes[e]=t}function Hu(e,...t){if(!h.game.scenes[e])throw new Error(`Scene not found: ${e}`);h.game.events.onOnce("frameEnd",()=>{h.game.events.trigger("sceneLeave",e),h.app.events.clear(),h.game.events.clear(),h.game.objEvents.clear(),[...h.game.root.children].forEach(n=>{!n.stay||n.scenesToStay&&!n.scenesToStay.includes(e)?h.game.root.remove(n):n.trigger("sceneEnter",e)}),h.game.root.clearEvents(),Gr(),h.game.cam={pos:null,scale:x(1),angle:0,shake:0,transform:new nt},h.game.scenes[e](...t)}),h.game.currentScene=e}function Fu(e){return h.game.events.on("sceneLeave",e)}function Ou(){return h.game.currentScene}function Rs(e,t={}){let n=null,i=null,s=null,r=new Be;if(!e)throw new Error("Please pass the resource name or data to sprite()");let a=(u,d,f,c)=>{let g=x(1,1);return f&&c?(g.x=f/(u.width*d.w),g.y=c/(u.height*d.h)):f?(g.x=f/(u.width*d.w),g.y=g.x):c&&(g.y=c/(u.height*d.h),g.x=g.y),g},l=(u,d)=>{if(!d)return;let f=d.frames[0].clone();t.quad&&(f=f.scale(t.quad));let c=a(d.tex,f,t.width,t.height);if(u.width=d.tex.width*f.w*c.x,u.height=d.tex.height*f.h*c.y,d.anims)for(let g in d.anims){let p=d.anims[g];typeof p!="number"&&(p.frames=o(p))}n=d,r.trigger(n),t.anim&&u.play(t.anim)},o=u=>{if(u.frames)return u.frames;let d=[];if(u.from===void 0||u.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let f=Math.abs(u.to-u.from)+1;for(let c=0;c<f;c++)d.push(u.from+c*Math.sign(u.to-u.from));if(u.pingpong)for(let c=f-2;c>0;c--)d.push(d[c]);return d};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new pe(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(u){let d=Rn(u);d&&d.onLoad(f=>l(this,f))},get animFrame(){if(!n||!i||s===null)return this.frame;let u=n.anims[i.name];return typeof u=="number"?u:u.from===void 0||u.to===void 0?i.frameIndex:this.frame-Math.min(u.from,u.to)},draw(){if(!n)return;let u=n.frames[this.frame??0];if(!u)throw new Error(`Frame not found: ${this.frame??0}`);if(n.slice9){let{left:d,right:f,top:c,bottom:g}=n.slice9,p=n.tex.width*u.w,w=n.tex.height*u.h,y=this.width-d-f,v=this.height-c-g,C=d/p,D=f/p,F=1-C-D,M=c/w,b=g/w,A=1-M-b,I=[be(0,0,C,M),be(C,0,F,M),be(C+F,0,D,M),be(0,M,C,A),be(C,M,F,A),be(C+F,M,D,A),be(0,M+A,C,b),be(C,M+A,F,b),be(C+F,M+A,D,b),be(0,0,d,c),be(d,0,y,c),be(d+y,0,f,c),be(0,c,d,v),be(d,c,y,v),be(d+y,c,f,v),be(0,c+v,d,g),be(d,c+v,y,g),be(d+y,c+v,f,g)];for(let q=0;q<9;q++){let B=I[q],O=I[q+9];Kn(Object.assign(Ct(this),{pos:O.pos(),tex:n.tex,quad:u.scale(B),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:O.w,height:O.h}))}}else Kn(Object.assign(Ct(this),{tex:n.tex,quad:u.scale(this.quad??new pe(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let u=Rn(e);u?u.onLoad(d=>l(this,d)):ei(()=>l(this,Rn(e).data))},update(){if(!n||!i||s===null)return;let u=n.anims[i.name];if(typeof u=="number"){this.frame=u;return}if(u.speed===0)throw new Error("Sprite anim speed cannot be 0");if(i.timer+=Ee()*this.animSpeed,i.timer>=1/i.speed){i.timer=0,i.frameIndex+=s;let d=u.frames;if(i.frameIndex>=d.length)if(i.pingpong&&!u.pingpong)s=-1,i.frameIndex=d.length-2;else if(i.loop)i.frameIndex=0;else{this.frame=d.at(-1),i.onEnd(),this.stop();return}else if(i.frameIndex<0)if(i.pingpong&&i.loop)s=1,i.frameIndex=1;else if(i.loop)i.frameIndex=d.length-1;else{this.frame=d[0],i.onEnd(),this.stop();return}this.frame=d[i.frameIndex]}},play(u,d={}){if(!n){r.add(()=>this.play(u,d));return}let f=n.anims[u];if(f===void 0)throw new Error(`Anim not found: ${u}`);i&&this.stop(),i=typeof f=="number"?{name:u,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:u,timer:0,loop:d.loop??f.loop??!1,pingpong:d.pingpong??f.pingpong??!1,speed:d.speed??f.speed??10,frameIndex:0,onEnd:d.onEnd??(()=>{})},s=typeof f=="number"?null:1,this.frame=typeof f=="number"?f:f.frames[0],this.trigger("animStart",u)},stop(){if(!i)return;let u=i.name;i=null,this.trigger("animEnd",u)},numFrames(){return n?.frames.length??0},getCurAnim(){return i},curAnim(){return i?.name},getAnim(u){return n?.anims[u]??null},hasAnim(u){return!!this.getAnim(u)},onAnimEnd(u){return this.on("animEnd",u)},onAnimStart(u){return this.on("animStart",u)},renderArea(){return new ae(x(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function ju(e,t={}){function n(s){let r=Et(Object.assign(Ct(s),{text:s.text+"",size:s.textSize,font:s.font,width:t.width&&s.width,align:s.align,letterSpacing:s.letterSpacing,lineSpacing:s.lineSpacing,transform:s.textTransform,styles:s.textStyles,indentAll:t.indentAll}));return t.width||(s.width=r.width/(s.scale?.x||1)),s.height=r.height/(s.scale?.y||1),r}let i={id:"text",set text(s){e=s,n(this),this.renderedText=Ds(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?Ds(e).text:"",add(){ei(()=>n(this))},draw(){Mt(n(this))},renderArea(){return new ae(x(0),this.width,this.height)}};return n(i),i}function Nu(e,t){return{id:"rect",width:e,height:t,draw(){fn(Object.assign(Ct(this),{width:this.width,height:this.height}))},renderArea(){return new ae(x(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function Lu(e={}){let t=null,n=null,i=null,s=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return n&&i?n[i]:null},getPath(){return n?n.slice():null},getTarget(){return t},isNavigationFinished(){return n?i===null:!0},isTargetReachable(){return n!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(r){t=r,n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),i=n?0:null,n&&i!==null?(s||(s=this.getLevel().onNavigationMapChanged(()=>{t&&n&&i!==null&&(n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n?(i=0,this.trigger("navigationNext",this,n[i])):(i=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>s?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,n[i])):this.trigger("navigationEnded",this)},update(){if(t&&n&&i!==null){if(this.pos.sdist(n[i])<2)if(i===n.length-1){this.pos=t.clone(),i=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else i++,this.trigger("navigationNext",this,n[i]);this.moveTo(n[i],this.agentSpeed)}},onNavigationStarted(r){return this.on("navigationStarted",r)},onNavigationNext(r){return this.on("navigationNext",r)},onNavigationEnded(r){return this.on("navigationEnded",r)},onTargetReached(r){return this.on("targetReached",r)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(n)})}}}function Uu(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(n){return this.graph?.getWaypointPath(this.pos,n,e.navigationOpt)},get graph(){if(t)return t;let n=this.parent;for(;n;){if(n.has("pathfinderMap"))return n.graph;n=n.parent}},set graph(n){t=n}}}function Gu(e={}){let t=e.waypoints,n=e.speed||100,i=e.endBehavior||"stop",s=0,r=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return n},set patrolSpeed(a){n=a},get waypoints(){return t},set waypoints(a){t=a,s=0,r=!1},get nextLocation(){return t?t[s]:void 0},update(){let a=this.nextLocation;if(!(!t||!a||r)&&(this.moveTo(a,n),this.pos.sdist(a)<9))switch(i){case"loop":s=(s+1)%t.length;break;case"ping-pong":s=s+1,s==t.length&&(t.reverse(),s=0);break;case"stop":s<t.length-1?s+=1:r||(r=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(a){return this.on("patrolFinished",a)}}}function Ku(e,t={}){let n=typeof e=="function"?e:()=>h.game.root.query(e),i=t.checkFrequency||1,s=typeof t.direction=="number"?P.fromAngle(t.direction):t.direction,r=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?P.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(a){this.direction=a!==void 0?P.fromAngle(a):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(a,l,o){let u=(typeof l=="number"?P.fromAngle(l):l)||s,d=o||t.fieldOfView;if(!u||!d||d>=360)return!0;let f=d/2;return a.pos&&u.angleBetween(a.pos.sub(this.pos))<=f},hasLineOfSight(a){let l=Er(this.pos,a.pos.sub(this.pos),t.raycastExclude);return l!=null&&l.object===a},update(){if(r+=Ee(),r>i){r-=i;let a=n();if(a.length&&s&&this.fieldOfView&&this.fieldOfView<360){let l=this.fieldOfView/2;a=a.filter(o=>o.pos&&s.angleBetween(o.pos.sub(this.pos))<=l)}a.length&&t.lineOfSight&&(a=a.filter(l=>l.pos&&this.hasLineOfSight(l))),a.length>0&&(this.spotted=a,this.trigger("objectSpotted",a))}},onObjectsSpotted(a){return this.on("objectSpotted",a)}}}function zr(e={}){let t=x(0),n=e.isObstacle??!1,i=e.cost??0,s=e.edges??[],r=()=>{let l={left:1,top:2,right:4,bottom:8};return s.map(o=>l[o]||0).reduce((o,u)=>o|u,0)},a=r();return{id:"tile",tilePosOffset:e.offset??x(0),set tilePos(l){let o=this.getLevel();t=l.clone(),this.pos=x(this.tilePos.x*o.tileWidth(),this.tilePos.y*o.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(l){n!==l&&(n=l,this.getLevel().invalidateNavigationMap())},get isObstacle(){return n},set cost(l){i!==l&&(i=l,this.getLevel().invalidateNavigationMap())},get cost(){return i},set edges(l){s=l,a=r(),this.getLevel().invalidateNavigationMap()},get edges(){return s},get edgeMask(){return a},getLevel(){return this.parent},tileMove(l){let o=this.getLevel();o.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(l),o.insertIntoSpatialMap(this),o.trigger("spatialMapChanged")},moveLeft(){this.tileMove(x(-1,0))},moveRight(){this.tileMove(x(1,0))},moveUp(){this.tileMove(x(0,-1))},moveDown(){this.tileMove(x(0,1))}}}var ni=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,n){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||dn.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=n}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,n){let i=t-1,s=e/this.duration;if(this.loops!==0&&s>=this.loops)return[i,0,!0];let r=Math.trunc(s);if(s-=r,(this.direction=="reverse"||this.direction=="ping-pong"&&r&1)&&(s=1-s),n){let a=0;for(;n[a+1]!==void 0&&n[a+1]<s;)a++;return a>=i?[i,0,!0]:[a,(s-n[a])/(n[a+1]-n[a]),!1]}else{let a=Math.floor((t-1)*s);return[a,(s-a/i)*i,!1]}}setValue(e,t,n){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(n);break;case"angle":e.angle=e.base.angle+n;break;case"scale":e.scale=e.base.scale.scale(n);break;case"opacity":e.opacity=e.base.opacity*n;break;default:e[t]=n}else e[t]=n}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=dn.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Ei(e,t){return t.add(t.sub(e))}var Xu=class extends ni{keys;constructor(e,t,n,i){super(e,n,i),this.keys=t}update(e,t){let[n,i,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[n]);else{let r=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,Ne(this.keys[n],this.keys[n+1],r(i)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},zu=class extends ni{keys;curves;dcurves;constructor(e,t,n,i,s){if(super(e,n,i),this.keys=t,this.interpolation==="spline"){this.curves=[],s&&(this.dcurves=[]);for(let r=0;r<this.keys.length-1;r++){let a=this.keys[r],l=r+1,o=this.keys[l],u=r>0?this.keys[r-1]:Ei(o,a),d=l<this.keys.length-1?this.keys[l+1]:Ei(a,o);this.curves.push(Nn(u,a,o,d)),s&&this.dcurves?.push(Nn(u,a,o,d,Ua))}}}update(e,t){let[n,i,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[n]);else{let r=this.easings?this.easings[n]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],r(i)));break;case"slerp":this.setValue(e,this.name,this.keys[n].slerp(this.keys[n+1],r(i)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[n](r(i))),this.dcurves&&this.setValue(e,"angle",this.dcurves[n](r(i)).angle());break}}}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},Yu=class extends ni{keys;constructor(e,t,n,i){super(e,n,i),this.keys=t}update(e,t){let[n,i,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(i==0||this.interpolation=="none")this.setValue(e,this.name,this.keys[n]);else{let r=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],r(i)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function Wu(e={}){let t=[],n=0,i=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:x(0,0),angle:0,scale:x(1,1),opacity:1},animation:{paused:!1,seek(s){n=tt(s,0,this.duration),t.forEach(r=>{r.isFinished=!1}),i=!1},get duration(){return t.reduce((s,r)=>Math.max(r.duration,s),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let s=!0,r;n+=Ee();for(let a of t)r=a.update(this,n),r&&!a.isFinished&&(a.isFinished=!0,this.trigger("animateChannelFinished",a.name)),s&&=r;s&&!i&&(i=!0,this.trigger("animateFinished"))},animate(s,r,a){i=!1,this.unanimate(s),typeof r[0]=="number"?t.push(new Xu(s,r,a,e.relative||!1)):r[0]instanceof P?t.push(new zu(s,r,a,e.relative||!1,s==="pos"&&(e.followMotion||!1))):r[0]instanceof Z&&t.push(new Yu(s,r,a,e.relative||!1))},unanimate(s){let r=t.findIndex(a=>a.name===s);r>=0&&t.splice(r,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(s){return this.on("animateFinished",s)},onAnimateChannelFinished(s){return this.on("animateChannelFinished",s)},serializeAnimationChannels(){return t.reduce((s,r)=>(s[r.name]=r.serialize(),s),{})},serializeAnimationOptions(){let s={};return e.followMotion&&(s.followMotion=!0),e.relative&&(s.relative=!0),s}}}function Yr(e,t){let n={name:e.name};return e.has("animate")&&(n.channels=e.serializeAnimationChannels(),Object.assign(n,e.serializeAnimationOptions())),e.children.length>0&&(n.children=e.children.filter(i=>i.has("named")).map(i=>Yr(i,i.name))),n}function Mi(e=2,t=1){let n=0;return{require:["scale"],update(){let i=Math.sin(n*e)*t;i<0&&this.destroy(),this.scale=x(i),n+=Ee()}}}function Vu(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(n=1){this.setHP(e-n),this.trigger("hurt",n)},heal(n=1){let i=e;this.setHP(e+n),this.trigger("heal",e-i)},hp(){return e},maxHP(){return t??null},setMaxHP(n){t=n},setHP(n){e=t?Math.min(t,n):n,e<=0&&this.trigger("death")},onHurt(n){return this.on("hurt",n)},onHeal(n){return this.on("heal",n)},onDeath(n){return this.on("death",n)},inspect(){return`health: ${e}`}}}function Qu(e,t={}){if(e==null)throw new Error("lifespan() requires time");let n=t.fade??0;return{id:"lifespan",require:["opacity"],add(){h.game.root.wait(e,()=>{this.opacity=this.opacity??1,n>0?h.game.root.tween(this.opacity,0,n,i=>this.opacity=i,dn.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function Ju(e){return{id:"named",name:e}}function Zu(e,t,n){if(!e)throw new Error("state() requires an initial state");let i={};function s(o){i[o]||(i[o]={enter:new Be,end:new Be,update:new Be,draw:new Be})}function r(o,u,d){return s(u),i[u][o].add(d)}function a(o,u,...d){s(u),i[u][o].trigger(...d)}let l=!1;return{id:"state",state:e,enterState(o,...u){if(l=!0,t&&!t.includes(o))throw new Error(`State not found: ${o}`);let d=this.state;if(n){if(!n?.[d])return;let f=typeof n[d]=="string"?[n[d]]:n[d];if(!f.includes(o))throw new Error(`Cannot transition state from "${d}" to "${o}". Available transitions: ${f.map(c=>`"${c}"`).join(", ")}`)}a("end",d,...u),this.state=o,a("enter",o,...u),a("enter",`${d} -> ${o}`,...u)},onStateTransition(o,u,d){return r("enter",`${o} -> ${u}`,d)},onStateEnter(o,u){return r("enter",o,u)},onStateUpdate(o,u){return r("update",o,u)},onStateDraw(o,u){return r("draw",o,u)},onStateEnd(o,u){return r("end",o,u)},update(){l||(a("enter",e),l=!0),a("update",this.state)},draw(){a("draw",this.state)},inspect(){return`state: ${this.state}`}}}function Wr(e){return{id:"stay",stay:!0,scenesToStay:e}}function $u(e=!0,t){let n,i;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let s=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};n=h.k.onCharInput(r=>{this.hasFocus&&(!t||this.typedText.length<t)&&(h.k.isKeyDown("shift")?this.typedText+=r.toUpperCase():this.typedText+=r,s())}),i=h.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),s())})},destroy(){n.cancel(),i.cancel()}}}function Hs(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,n,i=1/0,s=!1){let r=s?0:t,a=new Be,l=this.onUpdate(()=>{r+=h.app.state.dt;for(let o=0;r>=t&&o<this.maxLoopsPerFrame;o++)if(i--,n(),r-=t,i<=0){l.cancel(),a.trigger();return}});return{get paused(){return l.paused},set paused(o){l.paused=o},cancel:l.cancel,onEnd(o){a.add(o)},then(o){return a.add(o),this}}},wait(t,n){return this.loop(t,n??(()=>{}),1,!0)},tween(t,n,i,s,r=dn.linear){let a=0,l=[],o=this.onUpdate(()=>{a+=h.app.state.dt;let u=Math.min(a/i,1);s(Ne(t,n,r(u))),u===1&&(o.cancel(),s(n),l.forEach(d=>d()))});return{get paused(){return o.paused},set paused(u){o.paused=u},onEnd(u){l.push(u)},then(u){return this.onEnd(u),this},cancel(){o.cancel()},finish(){o.cancel(),s(n),l.forEach(u=>u())}}}}}var Fs=0;function _u(){return Fs>0}function ku(e={}){let t={},n=new Set,i=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){Fs++,this.area.cursor&&i.push(this.onHover(()=>h.app.setCursor(this.area.cursor))),i.push(this.onCollideUpdate((s,r)=>{if(!s.id)throw new Error("area() requires the object to have an id");t[s.id]||this.trigger("collide",s,r),r&&(t[s.id]=r,n.add(s.id))}))},destroy(){Fs--;for(let s of i)s.cancel()},fixedUpdate(){for(let s in t)n.has(Number(s))||(this.trigger("collideEnd",t[s].target),delete t[s]);n.clear()},drawInspect(){let s=this.localArea();ze(),we(this.area.offset);let r={outline:{width:4/or(),color:ne(0,0,255)},anchor:this.anchor,fill:!1,fixed:xt(this)};s instanceof ae?We({...r,pos:s.pos,width:s.width*this.area.scale.x,height:s.height*this.area.scale.y}):s instanceof He?ht({...r,pts:s.pts,scale:this.area.scale}):s instanceof Le&&Yt({...r,pos:s.center,radius:s.radius}),je()},area:{shape:e.shape??null,scale:e.scale?x(e.scale):x(1),offset:e.offset??x(0),cursor:e.cursor??null},isClicked(){return h.app.isMousePressed()&&this.isHovering()},isHovering(){let s=xt(this)?h.k.mousePos():h.k.toWorld(h.k.mousePos());return this.hasPoint(s)},checkCollision(s){if(!s.id)throw new Error("checkCollision() requires the object to have an id");return t[s.id]??null},getCollisions(){return Object.values(t)},isColliding(s){if(!s.id)throw new Error("isColliding() requires the object to have an id");return!!t[s.id]},isOverlapping(s){if(!s.id)throw new Error("isOverlapping() requires the object to have an id");let r=t[s.id];return r&&r.hasOverlap()},onClick(s,r="left"){let a=this.onMousePress(r,()=>{this.isHovering()&&s()});return i.push(a),a},onHover(s){let r=!1;return this.onUpdate(()=>{r?r=this.isHovering():this.isHovering()&&(r=!0,s())})},onHoverUpdate(s){return this.onUpdate(()=>{this.isHovering()&&s()})},onHoverEnd(s){let r=!1;return this.onUpdate(()=>{r?this.isHovering()||(r=!1,s()):r=this.isHovering()})},onCollide(s,r){if(typeof s=="function"&&r===void 0)return this.on("collide",s);if(typeof s=="string")return this.onCollide((a,l)=>{a.is(s)&&r?.(a,l)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(s,r){if(typeof s=="function"&&r===void 0)return this.on("collideUpdate",s);if(typeof s=="string")return this.on("collideUpdate",(a,l)=>a.is(s)&&r?.(a,l));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(s,r){if(typeof s=="function"&&r===void 0)return this.on("collideEnd",s);if(typeof s=="string")return this.on("collideEnd",a=>a.is(s)&&r?.(a));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(s){return pt(this.worldArea(),s)},resolveCollision(s){let r=this.checkCollision(s);r&&!r.resolved&&(this.pos=this.pos.add(r.displacement),r.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let s=this.localArea();if(!(s instanceof He||s instanceof ae))throw new Error("Only support polygon and rect shapes for now");let r=this.transform.clone().translate(this.area.offset).scale(x(this.area.scale??1));if(s instanceof ae){let a=zt(this.anchor||Qn).add(1,1).scale(-.5).scale(s.width,s.height);r.translate(a)}return s.transform(r)},screenArea(){let s=this.worldArea();return xt(this)?s:s.transform(h.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function ed(e={}){let t=null,n=null,i=!1,s=x(0),r=null,a=null,l;return{id:"body",require:["pos"],vel:x(0),drag:e.drag??0,jumpForce:e.jumpForce??ao,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(r=this.pos.clone(),a=this.pos.clone(),l=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((o,u)=>{if(!u||!o.has("body")||u.resolved)return;this.trigger("beforePhysicsResolve",u);let d=u.reverse();if(o.trigger("beforePhysicsResolve",d),!(u.resolved||d.resolved)&&!(this.isStatic&&o.isStatic)){if(!this.isStatic&&!o.isStatic){let f=this.mass+o.mass;this.pos=this.pos.add(u.displacement.scale(o.mass/f)),o.pos=o.pos.add(u.displacement.scale(-this.mass/f)),this.transform=an(this),o.transform=an(o)}else{let f=!this.isStatic&&o.isStatic?u:u.reverse();f.source.pos=f.source.pos.add(f.displacement),f.source.transform=an(f.source)}u.resolved=!0,this.trigger("physicsResolve",u),o.trigger("physicsResolve",u.reverse())}}),this.onPhysicsResolve(o=>{if(h.game.gravity)if(o.isBottom()&&this.isFalling()){this.vel=this.vel.reject(h.game.gravity.unit());let u=t;t=o.target,u!=t&&(n=o.target.pos),i?i=!1:u||(this.trigger("ground",t),o.target.trigger("land",this))}else o.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(h.game.gravity.unit()),this.trigger("headbutt",o.target),o.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(n&&!t.pos.eq(n)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(n)),n=t.pos);let o=Ts();o&&(this.pos.x==l.x&&(this.pos.x=Ne(r.x,a.x,o/Cs()),l.x=this.pos.x),this.pos.y==l.y&&(this.pos.y=Ne(r.y,a.y,o/Cs()),l.y=this.pos.y))},fixedUpdate(){if(r&&(this.pos.x==l.x&&(this.pos.x=r.x),this.pos.y==l.y&&(this.pos.y=r.y),r=null),h.game.gravity&&!this.isStatic){i&&(t=null,n=null,this.trigger("fallOff"),i=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(i=!0);let o=this.vel.clone();this.vel=this.vel.add(h.game.gravity.scale(this.gravityScale*Ee()));let u=e.maxVelocity??oo;this.vel.slen()>u*u&&(this.vel=this.vel.unit().scale(u)),o.dot(h.game.gravity)<0&&this.vel.dot(h.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=s.x*Ee(),this.vel.y+=s.y*Ee(),this.vel.x*=1-this.drag*Ee(),this.vel.y*=1-this.drag*Ee(),this.move(this.vel),Ts()){r=this.pos.clone();let o=this.vel.add(s.scale(Ee()));a=this.pos.add(o.scale(Ee())),l=this.pos.clone()}s.x=0,s.y=0},onPhysicsResolve(o){return this.on("physicsResolve",o)},onBeforePhysicsResolve(o){return this.on("beforePhysicsResolve",o)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(ln())>0},isJumping(){return this.vel.dot(ln())<0},applyImpulse(o){this.isStatic||(this.vel=this.vel.add(o))},addForce(o){this.isStatic||(s.x+=o.x/this.mass,s.y+=o.y/this.mass)},jump(o){this.isStatic||(t=null,n=null,this.vel=ln().scale(-o||-this.jumpForce))},onGround(o){return this.on("ground",o)},onFall(o){return this.on("fall",o)},onFallOff(o){return this.on("fallOff",o)},onHeadbutt(o){return this.on("headbutt",o)},onLand(o){return this.on("land",o)},onHeadbutted(o){return this.on("headbutted",o)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function td(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(n){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(n))},onDoubleJump(n){return this.on("doubleJump",n)},inspect(){return`jumpsLeft: ${t}`}}}function nd(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,n)=>{let i=n?.normal.normal(),s=t.vel.project(i),r=i?.scale(this.speed)?.sub(s);t.addForce(r?.scale(t.mass*this.forceScale))})}}}function sd(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,n)=>{if(!t.has("body"))return;let i=P.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(i),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function id(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,n)=>{let i=this.pos.sub(t.pos),s=i.len(),r=s*this.distanceScale/10,a=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/r:1/r**2,l=i.scale(this.forceMagnitude*a/s);t.addForce(l),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function rd(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function ad(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let n=t.target.vel,i=ln().scale(-1).angleBetween(n);Math.abs(i)>this.surfaceArc/2&&t.preventResolution()})}}}function od(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,n)=>{let i=t,s=i.worldArea(),[r,a]=s.cut(x(-100,this.surfaceLevel),x(100,this.surfaceLevel));r&&(this.applyBuoyancy(i,r),this.applyDrag(i,r)),this.flowMagnitude&&i.addForce(P.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,n){let i=this.density*n.area(),s=x(0,1).scale(-i);t.addForce(s)},applyDrag(t,n){let i=t.vel,s=this.density*this.linearDrag,r=i.scale(-s);t.addForce(r)}}}function Os(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function Vr(){return{id:"fixed",fixed:!0}}function ld(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??x(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function ud(e){let t=h.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?h.game.layers?.[t]??null:null},set layer(n){if(t=h.game.layers?.indexOf(n),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function dd(e,t){let n=typeof e=="number"?P.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(n.scale(t))}}}function cd(e={}){let t=!1,n=new ae(x(0),Te(),Ie()),i=new ae(x(0),0,0),s=r=>{r.isOffScreen()?(t||(r.trigger("exitView"),t=!0),e.hide&&(r.hidden=!0),e.pause&&(r.paused=!0),e.destroy&&r.destroy()):(t&&(r.trigger("enterView"),t=!1),e.hide&&(r.hidden=!1),e.pause&&(r.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??fi,isOffScreen(){let r=this.screenPos();if(!r)return!1;if(n.width=Te(),n.height=Ie(),!this.offscreenDistance&&this.width&&this.height)return i.width=this.width,i.height=this.height,i.pos=this.pos,i.collides(n);let a=this.offscreenDistance?this.offscreenDistance:fi;return!Yn(n,r)&&n.sdistToPoint(r)>a*a},onExitScreen(r){return this.on("exitView",r)},onEnterScreen(r){return this.on("enterView",r)},add(){e.pause&&e.unpause?Cr(()=>s(this)):this.onUpdate(()=>s(this))}}}function Xn(...e){return{id:"pos",pos:x(...e),moveBy(...t){this.pos=this.pos.add(x(...t))},move(...t){this.moveBy(x(...t).scale(Ee()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(x(t[0],t[1]),t[2]);let n=t[0],i=t[1];if(i===void 0){this.pos=x(n);return}let s=n.sub(this.pos);if(s.len()<=i*Ee()){this.pos=x(n);return}this.move(s.unit().scale(i))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let n=this.worldPos();return n?xt(this)?n:Bs(n):null}},toScreen(t){let n=this.toWorld(t);return xt(this)?n:Bs(n)},fromScreen(t){return xt(this)?this.fromWorld(t):this.fromWorld(jr(t))},toOther(t,n){return t.fromWorld(this.toWorld(n))},fromOther(t,n){return t.toOther(this,n)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){Yt({color:ne(255,0,0),radius:4/or()})}}}function hd(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function zn(...e){if(e.length===0)return zn(1);let t=x(...e);return{id:"scale",set scale(n){if(!(n instanceof P))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=x(n)},get scale(){return t},scaleTo(...n){t=x(...n)},scaleBy(...n){t=t.scale(x(...n))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function fd(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var pd="data:image/png;base64,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",gd="data:image/png;base64,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",md=ra.version,h={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},yd=(e={tagsAsComponents:!0})=>{h.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),h.k.quit()),h.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let n=e.canvas??t.appendChild(document.createElement("canvas"));h.canvas=n;let i=e.scale??1;h.gscale=i;let s=e.width&&e.height&&!e.stretch&&!e.letterbox;s?(n.width=e.width*i,n.height=e.height*i):(n.width=n.parentElement.offsetWidth,n.height=n.parentElement.offsetHeight);let r=["outline: none","cursor: default"];if(s){let j=n.width,z=n.height;r.push(`width: ${j}px`),r.push(`height: ${z}px`)}else r.push("width: 100%"),r.push("height: 100%");e.crisp&&(r.push("image-rendering: pixelated"),r.push("image-rendering: crisp-edges")),n.style.cssText=r.join(";");let a=e.pixelDensity||1;h.pixelDensity=a,n.width*=a,n.height*=a,n.tabIndex=0;let l=document.createElement("canvas");l.width=256,l.height=256,h.fontCacheCanvas=l;let o=l.getContext("2d",{willReadFrequently:!0});h.fontCacheC2d=o;let u=jo({canvas:n,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});h.app=u;let d=[],f=u.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!f)throw new Error("WebGL not supported");let c=f,g=Dl(c,{texFilter:e.texFilter}),p=jl(e,g);h.gfx=p;let w=Pu();h.audio=w;let y=dl(g,e.spriteAtlasPadding??0);h.assets=y;let v=vu();h.game=v,v.root.use(Hs());function C(j,z){let W=new Gn(g,j,z);return{clear:()=>W.clear(),free:()=>W.free(),toDataURL:()=>W.toDataURL(),toImageData:()=>W.toImageData(),width:W.width,height:W.height,draw:re=>{Ye(),W.bind(),re(),Ye(),W.unbind()},get fb(){return W}}}function D(){c.clear(c.COLOR_BUFFER_BIT),p.frameBuffer.bind(),c.clear(c.COLOR_BUFFER_BIT),p.bgColor||ct(()=>{fn({width:Te(),height:Ie(),quad:new pe(0,0,Te()/64,Ie()/64),tex:p.bgTex,fixed:!0})}),p.renderer.numDraws=0,p.fixed=!1,p.transformStack.length=0,p.transform=new nt}function F(j,z){p.postShader=j,p.postShaderUniform=z??null}function M(){Ye(),p.lastDrawCalls=p.renderer.numDraws,p.frameBuffer.unbind(),c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight);let j=p.width,z=p.height;p.width=c.drawingBufferWidth/a,p.height=c.drawingBufferHeight/a,Kn({flipY:!0,tex:p.frameBuffer.tex,pos:new P(p.viewport.x,p.viewport.y),width:p.viewport.width,height:p.viewport.height,shader:p.postShader,uniform:typeof p.postShaderUniform=="function"?p.postShaderUniform():p.postShaderUniform,fixed:!0}),Ye(),p.width=j,p.height=z}let b=!1,A={inspect:!1,set timeScale(j){h.app.state.timeScale=j},get timeScale(){return h.app.state.timeScale},showLog:!0,fps:()=>u.fps(),numFrames:()=>u.numFrames(),stepFrame:Rt,drawCalls:()=>p.lastDrawCalls,clearLog:()=>v.logs=[],log:(...j)=>{let z=e.logMax??8,W=j.length>1?j.concat(" ").join(" "):j[0];v.logs.unshift({msg:W,time:u.time()}),v.logs.length>z&&(v.logs=v.logs.slice(0,z))},error:j=>A.log(new Error(j.toString?j.toString():j)),curRecording:null,numObjects:()=>X("*",{recursive:!0}).length,get paused(){return b},set paused(j){b=j,j?w.ctx.suspend():w.ctx.resume()}};h.debug=A;function I(j,z){try{return JSON.parse(window.localStorage[j])}catch{return z?(q(j,z),z):null}}function q(j,z){window.localStorage[j]=JSON.stringify(z)}function B(j,...z){let W=j(Je),re;typeof W=="function"?re=W(...z)(Je):re=W;for(let xe in re)Je[xe]=re[xe],e.global!==!1&&(window[xe]=re[xe]);return Je}function O(j){let z=u.canvas.captureStream(j),W=w.ctx.createMediaStreamDestination();w.masterNode.connect(W);let re=new MediaRecorder(z),xe=[];return re.ondataavailable=ee=>{ee.data.size>0&&xe.push(ee.data)},re.onerror=()=>{w.masterNode.disconnect(W),z.getTracks().forEach(ee=>ee.stop())},re.start(),{resume(){re.resume()},pause(){re.pause()},stop(){return re.stop(),w.masterNode.disconnect(W),z.getTracks().forEach(ee=>ee.stop()),new Promise(ee=>{re.onstop=()=>{ee(new Blob(xe,{type:"video/mp4"}))}})},download(ee="kaboom.mp4"){this.stop().then(De=>pi(ee,De))}}}function L(){return document.activeElement===u.canvas}let Q=v.root.add.bind(v.root),J=v.root.readd.bind(v.root),$=v.root.removeAll.bind(v.root),X=v.root.get.bind(v.root),U=v.root.wait.bind(v.root),he=v.root.loop.bind(v.root),_=v.root.query.bind(v.root),se=v.root.tween.bind(v.root),Me=on(null,gd),K=on(null,pd);h.kaSprite=Me,h.boomSprite=K;function yt(){v.root.fixedUpdate()}function Rt(){v.root.update()}class Vt{source;target;normal;distance;resolved=!1;constructor(z,W,re,xe,ee=!1){this.source=z,this.target=W,this.normal=re,this.distance=xe,this.resolved=ee}get displacement(){return this.normal.scale(this.distance)}reverse(){return new Vt(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(v.gravity||x(0,1))>0}isRight(){return this.displacement.cross(v.gravity||x(0,1))<0}isTop(){return this.displacement.dot(v.gravity||x(0,1))>0}isBottom(){return this.displacement.dot(v.gravity||x(0,1))<0}preventResolution(){this.resolved=!0}}function yn(){if(!_u())return;let j={},z=e.hashGridSize||64,W=new nt,re=[];function xe(ee){if(re.push(W.clone()),ee.pos&&W.translate(ee.pos),ee.scale&&W.scale(ee.scale),ee.angle&&W.rotate(ee.angle),ee.transform=W.clone(),ee.c("area")&&!ee.paused){let De=ee,lt=De.worldArea().bbox(),ns=Math.floor(lt.pos.x/z),ss=Math.floor(lt.pos.y/z),is=Math.ceil((lt.pos.x+lt.width)/z),rs=Math.ceil((lt.pos.y+lt.height)/z),bn=new Set;for(let Ze=ns;Ze<=is;Ze++)for(let ut=ss;ut<=rs;ut++)if(!j[Ze])j[Ze]={},j[Ze][ut]=[De];else if(!j[Ze][ut])j[Ze][ut]=[De];else{let An=j[Ze][ut];e:for(let Fe of An){if(Fe.paused||!Fe.exists()||bn.has(Fe.id))continue;for(let st of De.collisionIgnore)if(Fe.is(st))continue e;for(let st of Fe.collisionIgnore)if(De.is(st))continue e;let Qt=Wa(De.worldArea(),Fe.worldArea());if(Qt){let st=new Vt(De,Fe,Qt.normal,Qt.distance);De.trigger("collideUpdate",Fe,st);let xn=st.reverse();xn.resolved=st.resolved,Fe.trigger("collideUpdate",De,xn)}bn.add(Fe.id)}An.push(De)}}ee.children.forEach(xe),W=re.pop()}xe(v.root)}function wn(j){console.error(j),w.ctx.suspend();let z=j.message??String(j)??"Unknown error, check console for more info";u.run(()=>{},()=>{D(),ct(()=>{let W=Te(),re=Ie(),xe={size:36,width:W-64,letterSpacing:4,lineSpacing:4,font:Ln,fixed:!0};We({width:W,height:re,color:ne(0,0,255),fixed:!0});let ee=Et({...xe,text:"Error",pos:x(32),color:ne(255,128,0),fixed:!0});Mt(ee),Pi({...xe,text:z,pos:x(32,32+ee.height+16),fixed:!0}),je(),v.events.trigger("error",j)}),M()})}function es(j){d.push(j)}function ts(){v.events.onOnce("frameEnd",()=>{u.quit(),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT);let j=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS);for(let z=0;z<j;z++)c.activeTexture(c.TEXTURE0+z),c.bindTexture(c.TEXTURE_2D,null),c.bindTexture(c.TEXTURE_CUBE_MAP,null);c.bindBuffer(c.ARRAY_BUFFER,null),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null),c.bindRenderbuffer(c.RENDERBUFFER,null),c.bindFramebuffer(c.FRAMEBUFFER,null),g.destroy(),d.forEach(z=>z())})}let Ht=!0;u.run(()=>{try{y.loaded&&(A.paused||yt(),yn())}catch(j){wn(j)}},(j,z)=>{try{j(),y.loaded||Pt()===1&&!Ht&&(y.loaded=!0,ur().forEach(W=>v.events.trigger("loadError",...W)),v.events.trigger("load")),!y.loaded&&e.loadingScreen!==!1||Ht?(D(),Rl(),M()):(A.paused||Rt(),yn(),D(),Bl(),e.debug!==!1&&ql(),M()),Ht&&(Ht=!1),v.events.trigger("frameEnd"),z()}catch(W){wn(W)}}),ar(),Gr();let Je={_k:h,VERSION:md,loadRoot:ol,loadProgress:Pt,loadSprite:on,loadSpriteAtlas:yr,loadSound:Sl,loadMusic:Pl,loadBitmapFont:ml,loadFont:pl,loadShader:bl,loadShaderURL:Al,loadAseprite:fl,loadPedit:yl,loadBean:hl,loadJSON:ll,load:Is,getSound:mr,getFont:fr,getBitmapFont:pr,getSprite:dr,getShader:gr,getAsset:ul,Asset:Qe,SpriteData:gt,SoundData:hn,width:Te,height:Ie,center:Un,dt:Ee,fixedDt:Cs,restDt:Ts,time:u.time,screenshot:u.screenshot,record:O,isFocused:L,setCursor:u.setCursor,getCursor:u.getCursor,setCursorLocked:u.setCursorLocked,isCursorLocked:u.isCursorLocked,setFullscreen:u.setFullscreen,isFullscreen:u.isFullscreen,isTouchscreen:u.isTouchscreen,onLoad:ei,onLoadError:cu,onLoading:lu,onResize:uu,onGamepadConnect:u.onGamepadConnect,onGamepadDisconnect:u.onGamepadDisconnect,onError:du,onCleanup:es,flash:Or,setCamPos:Dr,getCamPos:qr,setCamRot:Hr,getCamRot:Fr,setCamScale:Br,getCamScale:Rr,getCamTransform:hu,camPos:gu,camScale:mu,camFlash:wu,camRot:yu,camTransform:fu,shake:pu,toScreen:Bs,toWorld:jr,setGravity:bu,getGravity:Au,setGravityDirection:xu,getGravityDirection:ln,setBackground:tl,getBackground:nl,getGamepads:u.getGamepads,getTreeRoot:Bu,add:Q,make:ti,destroy:Xr,destroyAll:$,get:X,query:_,readd:J,pos:Xn,scale:zn,rotate:hd,color:Sr,opacity:Pr,anchor:Os,area:ku,sprite:Rs,text:ju,polygon:Yl,rect:Mr,circle:Nl,uvquad:Nu,outline:Kl,particles:zl,body:ed,platformEffector:ad,surfaceEffector:nd,areaEffector:sd,pointEffector:id,buoyancyEffector:od,constantForce:rd,doubleJump:td,shader:Wl,textInput:$u,timer:Hs,fixed:Vr,stay:Wr,health:Vu,lifespan:Qu,named:Ju,state:Zu,z:fd,layer:ud,move:dd,offscreen:cd,follow:ld,fadeIn:Ul,mask:Gl,drawon:Ll,raycast:Er,tile:zr,animate:Wu,serializeAnimation:Yr,agent:Lu,sentry:Ku,patrol:Gu,pathfinder:Uu,trigger:Ql,on:Ge,onFixedUpdate:Jl,onUpdate:Cr,onDraw:Zl,onAdd:Tr,onDestroy:$l,onTag:Ir,onUntag:eu,onUse:_l,onUnuse:kl,onClick:iu,onCollide:tu,onCollideUpdate:nu,onCollideEnd:su,onHover:ru,onHoverUpdate:au,onHoverEnd:ou,onKeyDown:u.onKeyDown,onKeyPress:u.onKeyPress,onKeyPressRepeat:u.onKeyPressRepeat,onKeyRelease:u.onKeyRelease,onMouseDown:u.onMouseDown,onMousePress:u.onMousePress,onMouseRelease:u.onMouseRelease,onMouseMove:u.onMouseMove,onCharInput:u.onCharInput,onTouchStart:u.onTouchStart,onTouchMove:u.onTouchMove,onTouchEnd:u.onTouchEnd,onScroll:u.onScroll,onHide:u.onHide,onShow:u.onShow,onGamepadButtonDown:u.onGamepadButtonDown,onGamepadButtonPress:u.onGamepadButtonPress,onGamepadButtonRelease:u.onGamepadButtonRelease,onGamepadStick:u.onGamepadStick,onButtonPress:u.onButtonPress,onButtonDown:u.onButtonDown,onButtonRelease:u.onButtonRelease,mousePos:u.mousePos,mouseDeltaPos:u.mouseDeltaPos,isKeyDown:u.isKeyDown,isKeyPressed:u.isKeyPressed,isKeyPressedRepeat:u.isKeyPressedRepeat,isKeyReleased:u.isKeyReleased,isMouseDown:u.isMouseDown,isMousePressed:u.isMousePressed,isMouseReleased:u.isMouseReleased,isMouseMoved:u.isMouseMoved,isGamepadButtonPressed:u.isGamepadButtonPressed,isGamepadButtonDown:u.isGamepadButtonDown,isGamepadButtonReleased:u.isGamepadButtonReleased,getGamepadStick:u.getGamepadStick,isButtonPressed:u.isButtonPressed,isButtonDown:u.isButtonDown,isButtonReleased:u.isButtonReleased,setButton:u.setButton,getButton:u.getButton,pressButton:u.pressButton,releaseButton:u.releaseButton,getLastInputDeviceType:u.getLastInputDeviceType,charInputted:u.charInputted,loop:he,wait:U,play:Mu,setVolume:Lr,getVolume:Ur,volume:Cu,burp:Nr,audioCtx:w.ctx,Line:Ue,Rect:ae,Circle:Le,Ellipse:ot,Point:Ta,Polygon:He,Vec2:P,Color:Z,Mat4:nt,Quad:pe,RNG:Oi,rand:Pe,randi:ji,randSeed:da,vec2:x,rgb:ne,hsl2rgb:aa,quad:be,choose:fa,chooseMultiple:ha,shuffle:Ni,chance:ca,lerp:Ne,tween:se,easings:dn,map:et,mapc:oa,wave:Fi,deg2rad:Ae,rad2deg:St,clamp:tt,evaluateQuadratic:Da,evaluateQuadraticFirstDerivative:qa,evaluateQuadraticSecondDerivative:Ba,evaluateBezier:Ws,evaluateBezierFirstDerivative:Ra,evaluateBezierSecondDerivative:Ha,evaluateCatmullRom:Fa,evaluateCatmullRomFirstDerivative:Oa,curveLengthApproximation:Qi,normalizedCurve:ja,hermite:gn,cardinal:Ji,catmullRom:Nn,bezier:Na,kochanekBartels:La,easingSteps:Ya,easingLinear:Xa,easingCubicBezier:za,testLineLine:Us,testRectRect:Li,testRectLine:Gs,testRectPoint:Yn,testCirclePolygon:Vn,testLinePoint:Ks,testLineCircle:pn,isConvex:$a,triangulate:$i,NavMesh:ko,drawSprite:Fl,drawText:Pi,formatText:Et,drawRect:We,drawLine:sn,drawLines:ks,drawTriangle:Ar,drawCircle:Yt,drawEllipse:wr,drawUVQuad:fn,drawPolygon:ht,drawCurve:vr,drawBezier:Tl,drawFormattedText:Mt,drawMasked:Hl,drawSubtracted:Ol,pushTransform:ze,popTransform:je,pushTranslate:we,pushScale:cn,pushRotate:Gt,pushMatrix:sl,usePostEffect:F,makeCanvas:C,debug:A,scene:Ru,getSceneName:Ou,go:Hu,onSceneLeave:Fu,layers:qu,getLayers:Iu,setLayers:Kr,getDefaultLayer:Du,addLevel:Vl,getData:I,setData:q,download:Qs,downloadJSON:po,downloadText:ir,downloadBlob:pi,plug:B,ASCII_CHARS:_i,canvas:u.canvas,addKaboom:Tu,LEFT:P.LEFT,RIGHT:P.RIGHT,UP:P.UP,DOWN:P.DOWN,RED:Z.RED,GREEN:Z.GREEN,BLUE:Z.BLUE,YELLOW:Z.YELLOW,MAGENTA:Z.MAGENTA,CYAN:Z.CYAN,WHITE:Z.WHITE,BLACK:Z.BLACK,quit:ts,KEvent:Be,KEventHandler:un,KEventController:Tt,cancel:()=>er};h.k=Je;let vn=e.plugins;if(vn&&vn.forEach(B),e.global!==!1)for(let j in Je)window[j]=Je[j];return e.focus!==!1&&u.canvas.focus(),Je},wd=yd;const V=wd({width:1280,height:720,letterbox:!0,global:!1});let cs=null;function Dt(){function e(){let t=null,n=null,i=!1,s="english",r=30,a={},l=!1,o=null,u=[],d=!1,f=!1,c=!1,g=!1,p=!1;return{setPreviousScene(w){t=w},getPreviousScene(){return t},setCurrentScene(w){n=w},getCurrentScene(){return n},setFreezePlayer(w){i=w},getFreezePlayer(){return i},setFontSize(w){r=w},getFontSize(){return r},setLanguage(w){s=w},getLanguage(){return s},setChestOpened(w){a[w]=!0},getChestOpened(w){return!!a[w]},getOpenedChests(){return a},setPrisonDoorOpened(w){l=w},getPrisonDoorOpened(){return l},setCurrentSong(w){o=w},getCurrentSong(){return o},pauseCurrentSong(){o&&(typeof o.pause=="function"?o.pause():typeof o.stop=="function"?o.stop():typeof o.volume=="number"&&(o.volume=0),o=null)},getDeadSlimes(){return u},addDeadSlime(w){u.includes(w)||u.push(w)},setHasDefeatedGhost(w){d=w},getHasDefeatedGhost(){return d},setPrisonerFreed(w){f=w},getPrisonerFreed(){return f},setIsFenceDoorOpened(w){c=w},getIsFenceDoorOpened(){return c},setTrollDinnerHad(w){g=w},getTrollDinnerHad(){return g},setPlantedBeans(w){p=w},getPlantedBeans(){return p}}}return{getInstance(){return cs||(cs=e()),cs}}}function vd(){let e=null,t=!1;function n(){let i=[];return{setSlimeHealth(s,r){typeof r>"u"||(console.log("Setting slimeHealth",s,r,"before:",[...i]),i[s]=r,console.log("slimeHealth after:",[...i]))},getSlimeHealth(){return i},areBothSlimesDead(){return i.length>=2&&i[0]<=0&&i[1]<=0},isAnySlimeDead(){return i.some(s=>s<=0)},isAnySlimeAlive(){return i.some(s=>s>0)},isInitialized(){return t},setInitialized(s){t=s},resetSlimeHealth(s){t||(i=Array(s).fill(3),t=!0)},forceResetSlimeHealth(s){i=Array(s).fill(3),t=!0}}}return{getInstance(){return e||(e=n()),e}}}function bd(){let e=null;function t(){let n=0;return{setNbTimesTalkedOldman(i){n=i},getNbTimesTalkedOldman(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Ad(){let e=null;function t(){let n=0,i=!1,s=!1;return{setNbTimesTalkedLumberjack(r){n=r},getNbTimesTalkedLumberjack(){return n},getHasMentionedGift(){return i},setHasMentionedGift(r){i=r},getHasMentionedSlimesDefeated(){return s},setHasMentionedSlimesDefeated(r){s=r}}}return{getInstance(){return e||(e=t()),e}}}function xd(){let e=null;function t(){let n=!0;const i=3;let s=i,r=!1,a=0,l=[],o=!1,u=!1,d=!1,f=!0;return{setIsSwordEquipped(c){n=c},getIsSwordEquipped(){return n},setHealth(c){s=Math.max(0,Math.min(c,i))},getHealth(){return s},setHasKey(c){hasKey=c},getHasKey(){return hasKey},getMaxHealth(){return i},getPotions(){return a},addPotion(c=1){a+=c,c>0&&(o=!0)},usePotion(){return a>0?(a--,!0):!1},debug(){console.log(`Health: ${s}/${i}, Potions: ${a}`)},setHasHadPotion(c){o=c},getHasHadPotion(){return o},setHasBasementKey(c){r=c},getHasBasementKey(){return r},setKeys(c){l=c},getKeys(){return[...l]},addKey(c){l.includes(c)||l.push(c)},hasKey(c){return l.includes(c)},setHasPrisonKey(c){u=c},getHasPrisonKey(){return u},setHasCarrot(c){d=c},getHasCarrot(){return d},setHasMagicalBeans(c){f=c},getHasMagicalBeans(){return f}}}return{getInstance(){return e||(e=t()),e}}}function Sd(){let e=null;function t(){let n=0;return{setNbOfTimesTalkedShopkeeper(i){n=i},getNbOfTimesTalkedShopkeeper(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Pd(){let e=null;function t(){let n=0;return{setNbTimesTalkedPrisoner(i){n=i},getNbTimesTalkedPrisoner(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Ed(){let e=null;function t(){let n=0;return{setNbOfTimesTalkedWizard(i){n=i},getNbOfTimesTalkedWizard(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Md(){let e=null;function t(){let n=0;return{setNbTimesTalkedGuard(i){n=i},getNbTimesTalkedGuard(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Cd(){let e=null;function t(){let n=0;return{setNbTimesTalkedFarmer(i){n=i},getNbTimesTalkedFarmer(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Td(){let e=null,t=!1,n=!1,i=!1,s=!1;function r(){let a=[];return{setChickenHealth(l,o){typeof o!="number"||isNaN(o)||(a[l]=o)},getChickenHealth(){return a},isAnyChickenHurt(){return this.getChickenHealth().some(u=>u>0&&u<2)},isAnyChickenDead(){return a.some(o=>o<=0)},isAnyChickenAlive(){return a.some(o=>o>0)},isInitialized(){return t},setInitialized(l){t=l},resetChickenHealth(l){a=Array(l).fill(2),t=!0},initIfNeeded(l){(!t||a.length===0)&&this.resetChickenHealth(l)},hasTriggeredHurtInteraction(){return n},setTriggeredHurtInteraction(l){n=l},hasTriggeredDeadInteraction(){return i},setTriggeredDeadInteraction(l){i=l},hasTriggeredOneDeadInteraction(){return s},setTriggeredOneDeadInteraction(l){s=l},isSomeButNotAllDead(){const l=this.getChickenHealth(),o=l.filter(d=>d===0).length,u=l.length;return o>0&&o<u}}}return{getInstance(){return e||(e=r()),e}}}function Id(){let e=null;function t(){let n=0;return{setNbTimesTalkedBartender(i){n=i},getNbTimesTalkedBartender(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Dd(){let e=null;function t(){let n=0;return{setNbTimesTalkedFrog(i){n=i},getNbTimesTalkedFrog(){return n}}}return{getInstance(){return e||(e=t()),e}}}function qd(){let e=null;function t(){let n=0;return{setNbTimesTalkedHatguy(i){n=i},getNbTimesTalkedHatguy(){return n}}}return{getInstance(){return e||(e=t()),e}}}function Bd(){let e=null;function t(){let n=!1,i=!1,s=0;return{setIsFollowingPlayer(r){n=r},getIsFollowingPlayer(){return n},setCowQuestComplete(r){i=r},getCowQuestComplete(){return i},setNbTimesTalkedCow(r){s=r},getNbTimesTalkedCow(){return s}}}return{getInstance(){return e||(e=t()),e}}}function Rd(){let e=null;function t(){let n=0,i=0,s=0,r=0,a=0;return{setNbTimesTalkedGardenerHeight1(l){n=l},getNbTimesTalkedGardenerHeight1(){return n},setNbTimesTalkedGardenerHeight2(l){i=l},getNbTimesTalkedGardenerHeight2(){return i},setNbTimesTalkedGardenerHeight3(l){s=l},getNbTimesTalkedGardenerHeight3(){return s},setNbTimesTalkedGardenerHeight4(l){r=l},getNbTimesTalkedGardenerHeight4(){return r},setNbTimesTalkedGardenerHeight5(l){a=l},getNbTimesTalkedGardenerHeight5(){return a}}}return{getInstance(){return e||(e=t()),e}}}function Hd(){let e=null;function t(){let n=0;return{setBeanStalkHeight(i){n=i},getBeanStalkHeight(){return n}}}return{getInstance(){return e||(e=t()),e}}}const E=Dt().getInstance(),Ce=vd().getInstance(),Mn=bd().getInstance(),_e=Ad().getInstance(),N=xd().getInstance(),Cn=Sd().getInstance(),Tn=Pd().getInstance(),In=Ed().getInstance(),hs=Md().getInstance(),fs=Cd().getInstance(),ie=Td().getInstance(),ps=Id().getInstance(),Ci=Dd().getInstance(),Ti=qd().getInstance(),Re=Bd().getInstance(),ke=Rd().getInstance(),qe=Hd().getInstance();function k(e){let t=Math.floor(N.getHealth()),n=!1,i=N.getPotions(),s=N.getKeys().length,r=N.getIsSwordEquipped(),a=N.getHasHadPotion(),l=N.getHasBasementKey(),o=N.getHasCarrot(),u=N.getHasMagicalBeans(),d=0;const f=e.add([e.pos(20,20),e.fixed(),"heartsContainer"]);for(let g=0;g<t;g++)f.add([e.sprite("full-heart"),e.pos(d,0)]),d+=48;N.getHealth()-t===.5&&(n=!0,f.add([e.sprite("half-heart"),e.pos(d,0)]),d+=48);let c=N.getMaxHealth()-t-(n?1:0);for(let g=0;g<c;g++)f.add([e.sprite("empty-heart"),e.pos(d,0)]),d+=48;return r===!0&&f.add([e.sprite("sword-icon"),e.pos(0,48)]),a===!0&&(f.add([e.sprite("health-potion"),e.pos(d+24,0)]),f.add([e.text(`x${i}`,{font:"gameboy",size:24}),e.pos(d+76,16)]),d+=98),l===!0&&(f.add([e.sprite("key"),e.pos(d+24,0)]),f.add([e.text(`x${s}`,{font:"gameboy",size:24}),e.pos(d+76,16)]),d+=98),o===!0&&f.add([e.sprite("carrot"),e.pos(d+24,0)]),u===!0&&f.add([e.sprite("magical-beans"),e.pos(d+24,0)]),f}function Fd(e){return N.getPotions()>0&&N.getHealth()<N.getMaxHealth()?(N.usePotion(),N.setHealth(Math.min(N.getHealth()+2,N.getMaxHealth())),!0):!1}function H(e,t){e.curAnim()!==t&&e.play(t)}function si(e,t){for(const n of t)if(e.isKeyDown(n))return!0;return!1}function oe(e,t,n,i){e.add([e.rect(e.width(),e.height()),e.color(t,n,i),e.fixed()])}async function ue(e){return await(await fetch(e)).json()}function de(e,t,n,i,s,r){let a=0;const l=e.vec2(0,0);function o(u){let d=null;for(const f of r)u>=f.firstgid&&(d=f);return d}for(const u of n.data){if(a%n.width===0?(l.x=0,l.y+=i):l.x+=s,a++,u===0||u<0||u>2e4)continue;const d=o(u);if(!d)continue;let f;d.image&&d.image.split("/").pop()==="topdownasset.png"?f="sprites":d.source?f=d.source.split("/").pop().replace(".tsx",""):d.name?f=d.name:f=d.image?d.image.split("/").pop().replace(".png",""):"unknown";const c=u-d.firstgid;c<0||d.tilecount&&c>=d.tilecount||t.add([e.sprite(f,{frame:c}),e.pos(l),e.offscreen()])}}function Qr(e,t,n,i,s){return[e.rect(t,n),e.pos(i.x,i.y+16),e.area(),e.body({isStatic:!0}),e.opacity(0),e.offscreen(),s]}function ce(e,t,n,i){for(const s of n.objects){const{x:r,y:a,width:l,height:o}=s;t.add(Qr(e,l,o,e.vec2(r,a),s.name))}}async function Jr(e,t,n,i){t.vel=e.vec2(n.x*i,n.y*i),await e.wait(.12),t.vel=e.vec2(0,0)}async function ii(e,t,n=1,i=.08){for(let s=0;s<n;s++)t.color=e.rgb(255,255,255),await e.wait(i),t.color=e.rgb(255,0,0),await e.wait(i*2);t.color=e.rgb(255,255,255)}async function Wt(e,t,n){t.onCollide("swordHitBox",async()=>{if(t.isAttacking||t.isDead)return;const i=n();let s=e.vec2(0,0);switch(i.direction){case"left":s=e.vec2(-1,0);break;case"right":s=e.vec2(1,0);break;case"up":s=e.vec2(0,-1);break;case"down":s=e.vec2(0,1);break}if(ii(e,t),Jr(e,t,s,200),t.hurt(n.attackPower),(t.hp&&t.hp())<=0){if(t.hasTag&&t.hasTag("slime")){const a=t.pos,l=`${Math.round(a.x)},${Math.round(a.y)}`;gameState&&gameState.addDeadSlime&&gameState.addDeadSlime(l)}t.isDead=!0,t.stop&&t.stop(),e.play&&e.play("player-hurt",{volume:.7}),t.color&&(t.color=e.rgb(255,0,80),await new Promise(a=>setTimeout(a,80))),t.scale&&t.opacity?(e.tween(t.scale,.2,.3,a=>{t.scale=a}),e.tween(t.opacity,0,.3,a=>{t.opacity=a}),await new Promise(a=>setTimeout(a,300))):t.opacity&&(e.tween(t.opacity,0,.3,a=>{t.opacity=a}),await new Promise(a=>setTimeout(a,300))),e.destroy(t);return}})}function mn(e,t){t.onCollide("player",async n=>{t.isDead||n.isAttacking||(N.setHealth(N.getHealth()-t.attackPower),e.destroyAll("healthContainer"),k(e),e.play("player-hurt"),await ii(e,n),N.getHealth()<=0&&(N.setHealth(N.getMaxHealth()),e.go("world")))})}let gs=!1;function ge(e){e.onKeyPress("m",()=>{gs?(e.setVolume(.3),gs=!1):(e.setVolume(0),gs=!0)})}function me(e){e.onKeyPress("h",()=>{if(Fd())e.play&&e.play("drink",{volume:.8}),e.destroyAll("heartsContainer"),k(e);else if(N.getHealth()===N.getMaxHealth()&&N.getHasHadPotion()===!0){const t=e.add([e.text("Health is already full!",{size:24,font:"gameboy"}),e.anchor("center"),e.pos(e.width()/2,e.height()/2-200),e.fixed(),"tempMessage"]);e.wait(1,()=>{e.destroy(t)})}else if(N.getPotions()===0&&N.getHasHadPotion()===!0){const t=e.add([e.text("You are out of potions!",{size:24,font:"gameboy"}),e.anchor("center"),e.pos(e.width()/2,e.height()/2-200),e.fixed(),"tempMessage"]);e.wait(1,()=>{e.destroy(t)})}})}function Zr(e,t,n){n==="health-potion"&&(N.addPotion(1),N.setHasHadPotion(!0),e.destroyAll("heartsContainer"),k(e)),n==="basement-key"&&(N.addKey("basement-key"),N.setHasBasementKey(!0)),n==="prison-key"&&(N.addKey("prison-key"),N.setHasPrisonKey(!0))}function _n(e,t,n,i=16){let s=null;if(n.name==="prisoner"?s={"player-idle-down":"prisoner-idle-down","player-down":"prisoner-down","player-idle-side":"prisoner-idle-side","player-side":"prisoner-side","player-idle-up":"prisoner-idle-up","player-up":"prisoner-up"}:n.name==="cow"&&(s={"player-idle-down":"cow-idle-down","player-down":"cow-down","player-idle-side":"cow-idle-side","player-side":"cow-side","player-idle-up":"cow-idle-up","player-up":"cow-up"}),n.isFollowing)return;n.isFollowing=!0,n.startFollowing=!1;const r=["left","a","right","d","up","w","down","s"];e.onKeyPress(r,()=>{n.startFollowing=!0});let a=e.onUpdate(()=>{if(!n.exists()||!t.exists()||!n.startFollowing)return;if(n.name==="cow"&&(Re.getCowQuestComplete()||!Re.getIsFollowingPlayer())){n.isFollowing=!1,n.startFollowing=!1,n.use(e.body({isStatic:!0})),H(n,"cow-idle-down"),a&&a.cancel&&a.cancel();return}let l=e.vec2(0,0);switch(t.direction){case"left":l=e.vec2(i,0);break;case"right":l=e.vec2(-i,0);break;case"up":l=e.vec2(0,i);break;case"down":l=e.vec2(0,-i);break;default:l=e.vec2(0,i)}if(n.pos=n.pos.lerp(t.pos.add(l),.1),n.name==="cow"||n.name==="prisoner"?n.flipX=t.direction==="right":n.flipX=t.direction==="left",t.curAnim&&n.curAnim&&t.curAnim()&&s){const o=s[t.curAnim()];o&&n.curAnim()!==o&&n.play(o)}})}function Kt(e,t){const n=e.getCamPos(),i=4,s=1280,r=720,a=s/i,l=r/i,o=n.x-a/2,u=n.x+a/2,d=n.y-l/2,f=n.y+l/2,c=t.worldPos?t.worldPos():t.pos,g=t.area?t.area:null;let p=c.x,w=c.x,y=c.y,v=c.y;return g&&g.shape&&g.shape.w&&g.shape.h&&(p=c.x,w=c.x+g.shape.w,y=c.y,v=c.y+g.shape.h),p<u&&w>o&&y<f&&v>d}const Od=Object.freeze(Object.defineProperty({__proto__:null,areAnyOfTheseKeysDown:si,blinkEffect:ii,colorizeBackground:oe,drawBoundaries:ce,drawTiles:de,fetchMapData:ue,followPlayer:_n,generateColliderBoxComponents:Qr,giveItem:Zr,isPartiallyOnScreen:Kt,knockback:Jr,onAttacked:Wt,onCollideWithPlayer:mn,playAnimIfNotPlaying:H,registerHealthPotionHandler:me,registerMuteHandler:ge},Symbol.toStringTag,{value:"Module"}));function G(e,t){return[e.sprite("sprites",{anim:"player-idle-down"}),e.area({shape:new e.Rect(e.vec2(3,4),10,12)}),e.body(),e.pos(t),e.opacity(),e.color(),{speed:100,attackPower:1,direction:"down",isAttacking:!1,inventory:[]},"player"]}function dt(e,t,n,i,s,r,a){if(n===i&&!si(e,s)){switch(r==="left"?t.flipX=!0:r==="right"&&(t.flipX=!1),r){case"left":case"right":H(t,"player-side");break;case"up":H(t,"player-up");break;case"down":H(t,"player-down");break}t.move(a),t.direction=r}}function ye(e,t){e.onKeyDown(n=>{if(t&&!t.isAttacking){if(E.getFreezePlayer()){t.stop();return}dt(e,t,n,"left",["up","w","down","s"],"left",e.vec2(-t.speed,0)),dt(e,t,n,"a",["up","w","down","s","left"],"left",e.vec2(-t.speed,0)),dt(e,t,n,"right",["up","w","down","s"],"right",e.vec2(t.speed,0)),dt(e,t,n,"d",["up","w","down","s","right"],"right",e.vec2(t.speed,0)),dt(e,t,n,"up",["down","s"],"up",e.vec2(0,-t.speed)),dt(e,t,n,"w",["down","s","up"],"up",e.vec2(0,-t.speed)),dt(e,t,n,"down",["up","w"],"down",e.vec2(0,t.speed)),dt(e,t,n,"s",["up","w","down"],"down",e.vec2(0,t.speed))}}),e.onKeyDown(n=>{if(n==="shift"&&t&&!E.getFreezePlayer()&&N.getIsSwordEquipped()&&!t.isAttacking){t.isAttacking=!0,t.stop();for(let i=0;i<2;i++)e.wait(.08*i*2,()=>{t.opacity=.3}),e.wait(.2*(i*2+1),()=>{t.opacity=1});t.direction==="up"?H(t,"player-charge-up"):t.direction==="down"?H(t,"player-charge-down"):t.direction==="left"?(t.flipX=!0,H(t,"player-charge-right")):t.direction==="right"&&(t.flipX=!1,H(t,"player-charge-right")),e.wait(.35,()=>{if(e.get("swordHitBox").length===0){const i={left:t.worldPos().x-12,right:t.worldPos().x+12,up:t.worldPos().x,down:t.worldPos().x},s={left:t.worldPos().y,right:t.worldPos().y,up:t.worldPos().y-16,down:t.worldPos().y+16},r=e.add([e.area({shape:new e.Rect(e.vec2(0),14,14)}),e.pos(i[t.direction],s[t.direction]),"swordHitBox"]);let a=`slash-${t.direction}`;t.direction==="left"?a="slash-left":t.direction==="right"&&(a="slash-right");const l=e.add([e.sprite("sprites",{anim:a}),e.pos(i[t.direction],s[t.direction]),e.scale(1.5),e.z(100),"slashEffect"]);e.wait(9,()=>{e.destroyAll("swordHitBox"),e.destroy(l)});const o=600;let u=0,d=0;t.direction==="up"?d=-o:t.direction==="down"?d=o:t.direction==="left"?u=-o:t.direction==="right"&&(u=o);const f=8;for(let c=1;c<=f;c++)e.wait(.03*c,()=>{t.move(u/f,d/f);let g=e.vec2(0,0);t.direction==="up"?g=e.vec2(0,-16):t.direction==="down"?g=e.vec2(0,16):t.direction==="left"?g=e.vec2(-16,0):t.direction==="right"&&(g=e.vec2(16,0)),r&&(r.pos=t.worldPos().add(g)),l&&(l.pos=t.worldPos().add(g))});e.wait(.36,()=>{e.destroyAll("swordHitBox"),e.destroy(l),t.direction==="left"||t.direction==="right"?(H(t,"player-side"),t.stop()):(H(t,`player-${t.direction}`),t.stop()),t.isAttacking=!1})}e.play("sword-swing"),H(t,`player-attack-${t.direction}`)})}}),e.onKeyPress(n=>{if(n==="space"&&!E.getFreezePlayer()&&N.getIsSwordEquipped()&&!t.isAttacking){if(t.isAttacking=!0,t.stop(),e.get("swordHitBox").length===0){const i={left:t.worldPos().x-2,right:t.worldPos().x+10,up:t.worldPos().x+5,down:t.worldPos().x+2},s={left:t.worldPos().y+5,right:t.worldPos().y+5,up:t.worldPos().y,down:t.worldPos().y+10};e.add([e.area({shape:new e.Rect(e.vec2(0),10,10)}),e.pos(i[t.direction],s[t.direction]),"swordHitBox"]),e.wait(.1,()=>{e.destroyAll("swordHitBox")}),e.wait(.25,()=>{t.direction==="left"||t.direction==="right"?(H(t,"player-side"),t.stop()):(H(t,`player-${t.direction}`),t.stop()),t.isAttacking=!1})}e.play("sword-swing"),H(t,`player-attack-${t.direction}`)}}),e.onKeyRelease(()=>{t&&(t.isAttacking||si(e,["left","a","right","d","up","w","down","s"])||(t.direction==="left"||t.direction==="right"?H(t,"player-idle-side"):t.direction==="up"?H(t,"player-idle-up"):t.direction==="down"&&H(t,"player-idle-down"),t.stop()))})}const js=["left","right","up","down"];function kn(e,t){return[e.sprite("sprites",{anim:"slime-idle-down"}),e.area({shape:new e.Rect(e.vec2(1,5),14,12)}),e.body(),e.pos(t),e.offscreen(),e.opacity(),e.state("idle",["idle",...js]),e.health(3),{speed:30,attackPower:.5},"slime"]}function ri(e,t){t.on("hurt",()=>{typeof t._slimeIndex=="number"&&typeof Ce<"u"&&Ce.setSlimeHealth(t._slimeIndex,t.health)}),t.on("death",()=>{typeof t._slimeIndex=="number"&&typeof Ce<"u"&&(Ce.setSlimeHealth(t._slimeIndex,0),window&&window.console&&console.log("SlimeState health after death:",Ce.getSlimeHealth()))}),e.onUpdate(()=>{if(!(t.health<=0)&&Kt(e,t))switch(t.state){case"idle":t.move(0);break;case"left":t.move(-t.speed,0);break;case"right":t.move(t.speed,0);break;case"up":t.move(0,-t.speed);break;case"down":t.move(0,t.speed);break}}),t.on("death",()=>{const l=t._spawnKey,o=`${Math.floor(t.pos.x)},${Math.floor(t.pos.y)}`;window&&window.console&&console.log("Slime died at spawnKey:",l,"deathKey:",o),window.gameState&&window.gameState.addDeadSlime&&l&&window.gameState.addDeadSlime(l)});const n=t.onStateEnter("idle",async()=>{t.stop(),await e.wait(3),Kt(e,t)?t.enterState(js[Math.floor(Math.random()*js.length)]):t.enterState("idle")}),i=t.onStateEnter("right",async()=>{t.flipX=!1,H(t,"slime-side");const l=e.rand(1,5);let o=0,u=!1;for(;o<l;)if(await e.wait(.1),o+=.1,t.getCollisions().length>0){u=!0;break}if(u){t.enterState("left");return}t.enterState("idle")}),s=t.onStateEnter("left",async()=>{t.flipX=!0,H(t,"slime-side");const l=e.rand(1,5);let o=0,u=!1;for(;o<l;)if(await e.wait(.1),o+=.1,t.getCollisions().length>0){u=!0;break}if(u){t.enterState("idle");return}t.enterState("idle")}),r=t.onStateEnter("up",async()=>{H(t,"slime-up");const l=e.rand(1,5);let o=0,u=!1;for(;o<l;)if(await e.wait(.1),o+=.1,t.getCollisions().length>0){u=!0;break}if(u){t.enterState("idle");return}t.enterState("idle")}),a=t.onStateEnter("down",async()=>{H(t,"slime-down");const l=e.rand(1,5);let o=0,u=!1;for(;o<l;)if(await e.wait(.1),o+=.1,t.getCollisions().length>0){u=!0;break}if(u){t.enterState("idle");return}t.enterState("idle")});e.onSceneLeave(()=>{n.cancel(),i.cancel(),s.cancel(),r.cancel(),a.cancel()})}async function Ii(e,t,n,i=10){e.play("dialogue",{volume:1});for(const s of n)await new Promise(r=>setTimeout(()=>{t.text+=s,r()},i))}async function Y(e,t,n,i={}){E.setFreezePlayer(!0);const s=e.add([e.rect(800,200),e.pos(t),e.fixed()]),r=s.add([e.text("",{font:"gameboy",width:700,lineSpacing:15,size:E.getFontSize()}),e.color(27,29,52),e.pos(20,20),e.fixed()]);let a=0;const l=i.speed??10;i.onLine&&i.onLine(a),await Ii(e,r,n[a],l);let o=!0;return new Promise(u=>{const d=e.onKeyPress(["space","enter"],async()=>{if(o){if(a++,!n[a]){e.destroy(s),d.cancel(),i.keepFrozen||E.setFreezePlayer(!1),u();return}r.text="",o=!1,i.onLine&&i.onLine(a),await Ii(e,r,n[a],l),o=!0}})})}const $r=Object.freeze(Object.defineProperty({__proto__:null,dialog:Y},Symbol.toStringTag,{value:"Module"})),jd=[["These slimes are a real nuisance.","I'm sure that wizard up north has something to do with this.","Be sure to check in on my wife. She mentioned something about a gift for you."],["Well I better get back to work..."],["These trees won't chop themselves!"],["Did you get that gift from my wife?"],["Why are you looking at me like that?"],["I can see you got that potion! I bet it will come in handy against those slimes."]],Nd=[["essir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram a vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],Ld={english:jd,icelandic:Nd};function Ud(e,t){return[e.sprite("sprites",{anim:"lumberjack-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,13)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),e.opacity(),{speed:30},"lumberjack"]}async function Gd(e,t,n){n.direction==="left"&&(t.flipX=!1,H(t,"lumberjack-idle-side")),n.direction==="right"&&(t.flipX=!0,H(t,"lumberjack-idle-side")),n.direction==="up"&&H(t,"lumberjack-idle-down"),n.direction==="down"&&H(t,"lumberjack-idle-up");const i=Ld[E.getLanguage()];let s=_e.getHasMentionedSlimesDefeated(),r=_e.getNbTimesTalkedLumberjack(),a=!1;if(typeof Ce<"u"&&Ce.areBothSlimesDead&&Ce.areBothSlimesDead()===!0&&!s&&(a=!0,s=!0,_e.setHasMentionedSlimesDefeated(!0)),N.getHasHadPotion()&&!_e.getHasMentionedGift()){await Y(e,e.vec2(250,500),i[5],{speed:10}),_e.setHasMentionedGift(!0);return}r>4&&(_e.setNbTimesTalkedLumberjack(1),r=_e.getNbTimesTalkedLumberjack());let l=r;if(_e.getHasMentionedGift()&&(r===2||r===0)&&(l=4,_e.setNbTimesTalkedLumberjack(4)),i[l]){let o=i[l];a&&(o=[...o,"Oh and by the way... You really cleaned up those slimes! You're a real natural.","Let me teach you a trick. You can perform a charge attack by pressing 'shift'."]),await Y(e,e.vec2(250,500),o,{speed:10}),_e.setNbTimesTalkedLumberjack(r+1)}}function qt(e,t,n,i=!1){return[e.sprite("Sprite-0005",{anim:i?"chest-opened":"chest-closed"}),e.area({shape:new e.Rect(e.vec2(1,0),14,10)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"chest",{isOpen:i,contents:n}]}function Kd(e){const t=`${Math.round(e.pos.x)},${Math.round(e.pos.y)}`;Dt().getInstance().setChestOpened(t)}async function Bt(e,t,n){t.isOpen||(e.play("chest-open"),t.isOpen=!0,t.use(e.sprite("Sprite-0005",{anim:"chest-opened"})),Zr(e,n,t.contents),Kd(t),e.get("heartsContainer").forEach(i=>i.destroy()),k(e),await Y(e,e.vec2(250,500),[`You found a ${t.contents.replace("-"," ")}`]))}async function Xd(e){ge(e),me(e);const t=E.getPreviousScene();console.log(t),oe(e,8,148,236);const n=await ue("./assets/maps/world.json"),i=e.add([e.pos(0,0)]),s={player:null,slimes:[],chests:[]},r=E.getDeadSlimes?E.getDeadSlimes():[];let a=0;!Ce.isInitialized()&&(!Ce.getSlimeHealth()||Ce.getSlimeHealth().length===0)&&Ce.resetSlimeHealth(2);const l=n.layers;for(const o of l){if(o.name==="Boundaries"){ce(e,i,o);continue}if(o.name==="SpawnPointsShop"){for(const u of o.objects)if(u.name==="player-shop"&&t==="shop"&&!s.player){s.player=i.add(G(e,e.vec2(u.x,u.y)));continue}}if(o.name==="SpawnPointsTower"){for(const u of o.objects)if(u.name==="player-tower"&&t==="tower"&&!s.player){s.player=i.add(G(e,e.vec2(u.x,u.y)));continue}}if(o.name==="SpawnPointsChest"){for(const u of o.objects)if(u.name==="chest"){const d=u.contents||u.properties?.find(p=>p.name==="contents")?.value||"health-potion",f=`${Math.round(u.x)},${Math.round(u.y)}`,c=E.getChestOpened(f),g=i.add(qt(e,e.vec2(u.x,u.y),d,c));s.chests.push(g)}}if(o.name==="SpawnPointsHouse"){for(const u of o.objects)if(u.name==="player-house"&&t==="house"&&!s.player){s.player=i.add(G(e,e.vec2(u.x,u.y)));continue}}if(o.name==="SpawnPoints"){for(const u of o.objects){if(u.name==="player"&&!s.player&&t!=="town"){s.player=i.add(G(e,e.vec2(u.x,u.y)));continue}if(u.name==="player-town"&&!s.player&&t==="town"){s.player=i.add(G(e,e.vec2(u.x,u.y)));continue}if(u.name==="slime"){const d=`${Math.floor(u.x)},${Math.floor(u.y)}`;if(!r.includes(d)){const f=i.add(kn(e,e.vec2(u.x,u.y)));f._spawnKey=d,a<2&&(f._slimeIndex=a,a++),s.slimes.push(f)}continue}if(u.name==="lumberjack"){s.lumberjack=i.add(Ud(e,e.vec2(u.x,u.y)));continue}}continue}o.type==="tilelayer"&&de(e,i,o,n.tileheight,n.tilewidth,n.tilesets)}s.player.onCollide("door-entrance",null),s.player.onCollide("shop-entrance",null),s.player.onCollide("tower-entrance",null),s.player.onCollide("chest",null),s.player.onCollide("lumberjack",null),s.player.onCollideEnd("lumberjack",null),s.player.onCollide("door-entrance",()=>{e.play("door-open"),e.go("house")}),s.player.onCollide("shop-entrance",()=>{e.play("door-open"),e.go("shop")}),s.player.onCollide("tower-entrance",()=>{e.play("door-open"),e.go("tower")}),s.player.onCollide("town-entrance",()=>{E.setPreviousScene("world"),e.go("town")}),s.player.onCollide("chest",o=>{Bt(e,o,s.player)}),s.player.onCollide("lumberjack",()=>{Gd(e,s.lumberjack,s.player)}),s.player.onCollideEnd("lumberjack",async()=>{await new Promise(o=>setTimeout(o,500)),H(s.lumberjack,"lumberjack-idle-down")});for(const o of s.slimes)ri(e,o),Wt(e,o,()=>s.player),mn(e,o),o.onDeath&&o.onDeath(()=>{const u=o.pos,d=`${Math.floor(u.x)},${Math.floor(u.y)}`;E.addDeadSlime&&E.addDeadSlime(d)});e.setCamScale(4),e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{s.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),s.player.worldPos(),.15,o=>{e.setCamPos(o)},e.easings.linear)}),ye(e,s.player),k(e),e.add([e.text(`FPS: ${Math.round(1/e.dt())}`,{size:16,font:"gameboy"}),e.pos(12,12),e.fixed(),{layer:"ui"},{update(){this.text=`FPS: ${Math.round(1/e.dt())}`}}])}const zd=[["Where have you been?","Can you go take care of those slimes over by the bridge for me?",`Take this sword, 
press space to use it.`],["Press space to use your sword!"],["Well, what are you waiting for?","Take care of those slimes!"],["Did you defeat the slimes yet?","Slay them with your sword! Press space to use it."]],Yd=[["Geturdu drepid thessa slimunga vid bruna fyrir mig?","Taktu thetta sverd, yttu a 'space' til ad nota thad."],["Yttu a 'space' til ad nota sverdid thitt!"],["Jaeja, eftir hverju ertu ad bida?","Sjadu um thessa slimunga!"],["Hefurdu drepid slimungana?","Dreptu tha med sverdinu thinu! Yttu a 'space' til ad nota thad."]],Wd={english:zd,icelandic:Yd};function Vd(e,t){return[e.sprite("sprites",{anim:"oldman-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,23)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"oldman"]}async function Qd(e,t,n){n.direction==="left"&&(t.flipX=!0,H(t,"oldman-idle-side")),n.direction==="right"&&(t.flipX=!1,H(t,"oldman-idle-side")),n.direction==="up"&&H(t,"oldman-idle-down"),n.direction==="down"&&H(t,"oldman-idle-up");const i=Wd[E.getLanguage()];let s=Mn.getNbTimesTalkedOldman();if(s>i.length-1&&(Mn.setNbTimesTalkedOldman(1),s=Mn.getNbTimesTalkedOldman()),i[s]){let r={};s===0&&(r.onLine=a=>{a===2&&e.play&&(e.play("item"),N.setIsSwordEquipped(!0),e.destroyAll("heartsContainer"),k(e))}),await Y(e,e.vec2(250,500),i[s],r),Mn.setNbTimesTalkedOldman(s+1)}}async function Jd(e){me(e),ge(e),oe(e,27,29,52);const t=await ue("./assets/maps/house.json"),n=e.add([e.pos(100,192)]),i={player:null,oldman:[]},s=t.layers;for(const r of s){if(r.name==="Boundaries"){ce(e,n,r);continue}if(r.name==="SpawnPoints")for(const a of r.objects){if(a.name==="player"){i.player=n.add(G(e,e.vec2(a.x,a.y)));continue}else if(a.name==="oldman"){i.oldman=n.add(Vd(e,e.vec2(a.x,a.y)));continue}if(a.name==="door-entrance"){n.add(generateColliderBoxComponents(e,a.width,a.height,e.vec2(a.x,a.y),"door-entrance"));continue}}r.type==="tilelayer"&&de(e,n,r,t.tileheight,t.tilewidth,t.tilesets)}e.setCamScale(4),ye(e,i.player),i.player.onCollide("door-exit",()=>{E.setPreviousScene("house"),e.play("door-open"),e.go("world")}),i.player.onCollide("oldman",()=>{Qd(e,i.oldman,i.player)}),i.player.onCollideEnd("oldman",async()=>{await new Promise(r=>setTimeout(r,500)),H(i.oldman,"oldman-idle-down")}),k(e)}const Zd=[["Good morning sugar. How's your uncle doing?",`Well anyway... 
I just got finished making these potions. Here, take one.`,"You can drink them by pressing 'H'. They'll heal any wounds you have."],["Did you see my husband outside?","I'm just so worried about him ever since these slimes showed up."]],$d=[["Godan daginn elskan. Hvernig hefur fraendi inn ad?","Allavegana... Eg er nybuin a bua til essi seyi. Herna, taktu eitt.","u getur drukki a me vi a smella a 'H'. eir graeda oll sarin in."],["Sastu manninn minn fyrir utan?","Eg er svo ahyggjufull yfir honum sian essir slmungar komu fram."]],_d={english:Zd,icelandic:$d};function kd(e,t){return[e.sprite("sprites",{anim:"shopkeeper-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,18)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"shopkeeper"]}async function Dn(e,t,n,i={}){if(i.overrideDialogue&&Array.isArray(i.overrideDialogue)){t.flipX=!0,H(t,"shopkeeper-idle-side"),await Y(e,e.vec2(250,500),i.overrideDialogue),setTimeout(()=>{H(t,"shopkeeper-idle-down")},7e3);return}else n.direction==="left"&&(t.flipX=!1,H(t,"shopkeeper-idle-side")),n.direction==="right"&&(t.flipX=!0,H(t,"shopkeeper-idle-side")),n.direction==="up"&&H(t,"shopkeeper-idle-down"),n.direction==="down"&&H(t,"shopkeeper-idle-up");const s=_d[E.getLanguage()];let r=Cn.getNbOfTimesTalkedShopkeeper(),a={};r===0&&(a.onLine=o=>{o===1&&e.play&&(N.setHasHadPotion(!0),e.destroyAll("heartsContainer"),k(e))}),r>s.length-1&&(Cn.setNbOfTimesTalkedShopkeeper(1),r=Cn.getNbOfTimesTalkedShopkeeper());let l=!1;r===0&&(N.addPotion(1),l=!0),s[r]&&(await Y(e,e.vec2(250,500),s[r],a),Cn.setNbOfTimesTalkedShopkeeper(r+1),l&&(e.destroyAll("heartsContainer"),k(e),e.play&&e.play("item")))}const ec=[["Please, you have to get me out of here!","I was collecting herbs for the wizard when that lumberjack attacked me.","The next thing I know, I'm locked up in here!"],["Please, you have to get me out of here!"],["I need you to find a way to free me."]],tc=[["Thank you for freeing me!","I don't think I would have survived much longer.","Could you help me get out of here?"]],nc=[["Gerdu ad, u verdur bjarga mer!","Eg var ad safna jurtum fyrir galdrakallinn egar thessi skogarhogsmadur rest a mig.","Naesta sem eg veit, a er eg fastur herna!"],["u verdur ad koma mer hedan! Gerdu ad!"],["u arft a finna leid til ad opna hurdina."]],sc=[["Takk fyrir ad bjarga mer!","Eg held ad eg hefdi ekki lifad etta af mikid lengur.","Geturdu hjalpad mer a komast hedan ut?"]],ic={english:ec,icelandic:nc},rc={english:tc,icelandic:sc};function ai(e,t){return[e.sprite("sprites",{anim:"prisoner-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,50)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"prisoner",{name:"prisoner",hp(){return 1},hurt(){}}]}async function ac(e,t,n){if(n.direction==="left"&&(t.flipX=!0,H(t,"prisoner-idle-side")),n.direction==="right"&&(t.flipX=!1,H(t,"prisoner-idle-side")),n.direction==="up"&&H(t,"prisoner-idle-down"),n.direction==="down"&&H(t,"prisoner-idle-up"),E.getPrisonDoorOpened()){const r=rc[E.getLanguage()][0];await Y(e,e.vec2(250,500),r),t.unuse("body"),_n(e,n,t);return}const i=ic[E.getLanguage()];let s=Tn.getNbTimesTalkedPrisoner();s>i.length-1&&(Tn.setNbTimesTalkedPrisoner(1),s=Tn.getNbTimesTalkedPrisoner()),i[s]&&(await Y(e,e.vec2(250,500),i[s]),Tn.setNbTimesTalkedPrisoner(s+1))}async function oc(e){me(e),ge(e);const t=E.getPreviousScene();console.log("Previous scene:",t),oe(e,27,29,52);const n=await ue("./assets/maps/shop.json"),i=e.add([e.pos(-240,-372)]),s={player:null,shopkeeper:null,prisoner:null},r=n.layers;for(const l of r){if(l.name==="Boundaries"){ce(e,i,l);continue}if(l.name==="SpawnPointsShop"){for(const o of l.objects)if(o.name==="player-shop"&&!s.player&&t==="basement"){s.player=i.add(G(e,e.vec2(o.x,o.y)));continue}}if(l.name==="SpawnPointsShopSecondFloor"){for(const o of l.objects)if(o.name==="player-shop-second-floor"&&!s.player&&t==="shop-second-floor"){s.player=i.add(G(e,e.vec2(o.x,o.y)));continue}}if(l.name==="SpawnPoints")for(const o of l.objects){if(o.name==="player"&&!s.player&&t!=="basement"&&t!=="shop-second-floor"){s.player=i.add(G(e,e.vec2(o.x,o.y)));continue}if(o.name==="shopkeeper"){s.shopkeeper=i.add(kd(e,e.vec2(o.x,o.y)));continue}if(o.name==="prisoner"){s.prisoner=i.add(ai(e,e.vec2(o.x,o.y)));continue}if(o.name==="basement-entrance"){i.add(G(e,o.width,o.height,e.vec2(o.x,o.y)));continue}}l.type==="tilelayer"&&de(e,i,l,n.tileheight,n.tilewidth,n.tilesets)}if(!s.player)return;e.setCamScale(4),e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{s.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),s.player.worldPos(),.15,l=>{e.setCamPos(l)},e.easings.linear)}),ye(e,s.player),s.prisoner&&s.player&&E.getPrisonDoorOpened()?(s.prisoner.use({opacity:1}),s.prisoner.unuse("body"),_n(e,s.player,s.prisoner,20)):(s.prisoner.use({opacity:0}),s.prisoner.unuse("area")),s.player.onCollide("shop-exit",()=>{E.setPreviousScene("shop"),e.play("door-open"),e.go("world")}),s.player.onCollide("shop-second-floor",()=>{E.setPreviousScene("shop"),e.go("shop-second-floor")}),s.player.onCollide("shopkeeper",()=>{Dn(e,s.shopkeeper,s.player)});let a=0;s.player.onCollide("basement-entrance",()=>{N.hasKey("basement-key")?(E.setPreviousScene("shop"),e.go("basement")):(a=(a||0)+1,a===1?Dn(e,s.shopkeeper,s.player,{overrideDialogue:["What do you think you're doing?"]}):a===2?Dn(e,s.shopkeeper,s.player,{overrideDialogue:["Get away from there!"]}):a===3&&Dn(e,s.shopkeeper,s.player,{overrideDialogue:["You won't get down there without a key, honey."]}))}),k(e)}async function lc(e){me(e),ge(e);const t=E.getPreviousScene();oe(e,27,29,52);const n=await ue("./assets/maps/shop-second-floor.json"),i=e.add([e.pos(-240,-372)]),s={player:null},r=n.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects)if(l.name==="player"&&!s.player&&t!=="basement"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}e.setCamScale(4),e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{s.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),s.player.worldPos(),.15,a=>{e.setCamPos(a)},e.easings.linear)}),ye(e,s.player),s.player.onCollide("shop",()=>{E.setPreviousScene("shop-second-floor"),e.go("shop")}),k(e)}function uc(e,t,n,i=!1){return[e.sprite("sprites",{anim:i?"prison-door-opened":"prison-door-closed"}),e.area({shape:new e.Rect(e.vec2(1,0),14,10)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"prison-door",{isOpen:i}]}function dc(e){const t=`${Math.round(e.pos.x)},${Math.round(e.pos.y)}`;Dt().getInstance().setPrisonDoorOpened(t)}function cc(e,t){return[e.sprite("shifting-walls",{anim:"wall-1"}),e.area({shape:new e.Rect(e.vec2(0,0),64,52)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"shifting-wall"]}function hc(e,t,n=!1){return[e.sprite("sprites",{anim:"secret-passage"}),e.area({shape:new e.Rect(e.vec2(0,0),16,16)}),e.body({isStatic:!n}),e.pos(t),e.offscreen(),"secret-passage"]}function fc(e,t){return[e.area({shape:new e.Rect(e.vec2(0,0),16,16)}),e.pos(t),e.offscreen(),"transition"]}function pc(e,t,n=!1){return[e.sprite("sprites",{anim:"pressure-plate-up"}),e.area({shape:new e.Rect(e.vec2(0,0),16,16)}),e.pos(t),e.offscreen(),"pressure-plate"]}function gc(e,t){return[e.sprite("dungeonDoor",{anim:"dungeon-door-1"}),e.area({shape:new e.Rect(e.vec2(0,0),48,52)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"dungeon-door"]}function mc(e,t){return[e.sprite("sprites",{anim:"ghost-down"}),e.area({shape:new e.Rect(e.vec2(2,4),12,12)}),e.body(),e.pos(t),e.health(6),e.opacity(),e.offscreen(),e.state("idle",["idle","right","backtrack","attack","evade"]),{isAttacking:!1,attackPower:.5,prevPos:e.vec2(0,0)},"ghost"]}function yc(e,t,n){const i=e.onUpdate(()=>{n.pos.dist(t.pos)<30&&(t.enterState("backtrack"),i.cancel())});e.loop(5,()=>{t.prevPos=t.pos});const s=t.onStateEnter("backtrack",async()=>{await e.tween(t.pos.y,t.pos.y-40,.2,o=>t.pos.y=o,e.easings.linear),t.enterState("right")}),r=t.onStateEnter("right",async()=>{await e.tween(t.pos.x,t.pos.x+50,1,o=>t.pos.x=o,e.easings.linear),t.enterState("attack")}),a=t.onStateEnter("attack",async()=>{const o=[.5,.8,1];if(await e.tween(t.pos,n.pos,o[Math.floor(Math.random()*o.length)],u=>t.pos=u,e.easings.linear),t.getCollisions().length>0){t.enterState("evade");return}t.enterState("attack")}),l=t.onStateEnter("evade",async()=>{await e.tween(t.pos,t.prevPos,.8,o=>t.pos=o,e.easings.linear),t.enterState("attack")});e.onSceneLeave(()=>{s.cancel(),r.cancel(),a.cancel(),l.cancel(),i.cancel()})}function wc(e){E.setHasDefeatedGhost(!0)}const bt=Dt().getInstance();async function vc(e){me(e),ge(e),bt.getPreviousScene(),oe(e,27,29,52);const t=await ue("./assets/maps/basement.json"),n=e.add([e.pos(-380,-392)]),i={player:null,chests:[],prisonDoor:null,secretPassage:null,pressurePlates:[],prisoner:null,dungeonDoor:null,shiftingWalls:null,ghost:null};for(const o of t.layers){if(o.name==="Boundaries"){ce(e,n,o);continue}if(o.name==="SpawnPointsChest"){for(const u of o.objects)if(u.name==="chest"){const d=u.contents||u.properties?.find(p=>p.name==="contents")?.value||"health-potion",f=`${Math.round(u.x)},${Math.round(u.y)}`,c=bt.getChestOpened(f),g=n.add(qt(e,e.vec2(u.x,u.y),d,c));i.chests.push(g)}}if(o.name==="SpawnPoints"){for(const u of o.objects)if(!(!u||typeof u.x!="number"||typeof u.y!="number")){if(u.name==="player"){i.player=n.add(G(e,e.vec2(u.x,u.y)));continue}if(u.name==="prisoner"){i.prisoner=n.add(ai(e,e.vec2(u.x,u.y)));continue}if(u.name==="prison-door"){i.prisonDoor=n.add(uc(e,e.vec2(u.x,u.y)));continue}if(u.name==="secret-passage"){i.secretPassage=n.add(hc(e,e.vec2(u.x,u.y),!1));continue}if(u.name==="transition"){n.add(fc(e,e.vec2(u.x,u.y)));continue}if(u.name==="pressure-plate"){const d=n.add(pc(e,e.vec2(u.x,u.y)));i.pressurePlates.push(d);continue}if(u.name==="dungeon-door"){i.dungeonDoor=n.add(gc(e,e.vec2(u.x,u.y)));continue}if(u.name==="shifting-walls"){i.shiftingWalls=n.add(cc(e,e.vec2(u.x,u.y)));continue}if(u.name==="ghost"){i.ghost=n.add(mc(e,e.vec2(u.x,u.y)));continue}u.name==="player-dungeon"&&i.player.onCollide("dungeon",()=>{i.player.pos.x=u.x,i.player.pos.y=u.y})}}o.type==="tilelayer"&&de(e,n,o,t.tileheight,t.tilewidth,t.tilesets)}function s(){return i.pressurePlates.length>0&&i.pressurePlates.every(o=>o.isDown)}i.player.onCollide("pressure-plate",o=>{o._colliderCount===void 0&&(o._colliderCount=0),o._colliderCount++,o.isDown||(o.isDown=!0,o.play("pressure-plate-down"),s()&&a())}),i.secretPassage&&i.secretPassage.onCollide("pressure-plate",o=>{o._colliderCount===void 0&&(o._colliderCount=0),o._colliderCount++,o.isDown||(o.isDown=!0,o.play("pressure-plate-down"),s()&&a())}),i.player.onCollide("chest",o=>{Bt(e,o,i.player)}),i.prisoner&&i.player.onCollide("prisoner",()=>{i.prisoner.isFollowing||ac(e,i.prisoner,i.player)}),i.player.onCollide("prison-door",()=>{N.getHasPrisonKey()&&i.prisonDoor&&!i.prisonDoor.isOpen&&(i.prisonDoor.isOpen=!0,e.play("door-open"),i.prisonDoor.play("prison-door-opened"),i.prisonDoor.unuse("body"),dc(i.prisonDoor),i.prisoner.unuse("area"),i.prisoner.use(e.area({shape:new e.Rect(e.vec2(2,6),15,12)})),i.secretPassage&&(i.secretPassage.unuse("body"),i.secretPassage.use(e.body({isStatic:!1}))))});let r=!1;i.player.onCollide("transition",async()=>{if(r)return;bt.setFreezePlayer(!0);const o=i.player.pos.y,u=o-100,d=1;i.player.play("player-up"),await e.tween(o,u,d,f=>{i.player.pos.y=f},e.easings.linear),i.player.play("player-idle-up"),await e.tween(e.getCamPos(),i.player.worldPos(),.5,f=>{e.setCamPos(f)},e.easings.easeInOutSine),await e.wait(.3),r=!0,bt.setFreezePlayer(!1)}),i.player.onCollide("basement-exit",()=>{i.prisoner&&i.prisoner.isFollowing?Y(e,e.vec2(250,500),["Wait! It's too dangerous.","That old woman is very powerful.","Do you see that cracked wall next to the chest?","We might be able to break through."]):(bt.setPreviousScene("basement"),e.go("shop"))}),i.player.onCollide("castle",()=>{bt.setPreviousScene("basement"),e.go("castle")}),i.ghost&&(yc(e,i.ghost,i.player),Wt(e,i.ghost,()=>i.player),mn(e,i.ghost),i.ghost.onDestroy(()=>{wc(),bt.getHasDefeatedGhost()===!0&&i.shiftingWalls&&l()})),e.setCamScale(4),e.onUpdate(()=>{if(r){const o=e.getCamPos(),u=i.player.worldPos(),d=o.lerp(u,.1);e.setCamPos(d)}}),ye(e,i.player),k(e),i.player.onCollideEnd("pressure-plate",o=>{o._colliderCount===void 0&&(o._colliderCount=0),o._colliderCount=Math.max(0,o._colliderCount-1),o._colliderCount===0&&o.isDown&&(o.isDown=!1,o.play("pressure-plate-up"))}),i.secretPassage&&i.secretPassage.onCollideEnd("pressure-plate",o=>{o._colliderCount===void 0&&(o._colliderCount=0),o._colliderCount=Math.max(0,o._colliderCount-1),o._colliderCount===0&&o.isDown&&(o.isDown=!1,o.play("pressure-plate-up"))});async function a(){i.dungeonDoor&&(await i.dungeonDoor.play("dungeon-door-2"),await e.wait(.5),await i.dungeonDoor.play("dungeon-door-3"),await e.wait(.5),await i.dungeonDoor.play("dungeon-door-4"),i.dungeonDoor.unuse("body"))}async function l(){i.shiftingWalls&&(await i.shiftingWalls.play("wall-2"),await e.wait(.5),await i.shiftingWalls.play("wall-3"),await e.wait(.5),await i.shiftingWalls.play("wall-4"),await e.wait(.5),await i.shiftingWalls.play("wall-5"),await e.wait(.5),await i.shiftingWalls.play("wall-6"),await e.wait(.5),await i.shiftingWalls.play("wall-7"),await e.wait(.5),i.shiftingWalls.unuse("body"))}}const bc=[[`What are you doing here? 
I don't like visitors`,`Well since you're here... 
I need some help.`,`My apprentice has gone missing. 
Can you help me find him?`,"The last time I saw him, he was heading south to the forest to gather herbs."],[`Have you found my apprentice? 
I haven't seen him for days.`],["The last time I saw him, he was heading south to the forest to gather herbs."],["Could you... leave me alone?"],["I'm a little busy here..."]],Ac=[[`Hva ertu a gera herna? 
Eg vil ekki gesti`,`Jaeja, fyrst  ert herna... 
Eg arf sma hjalp.`,`Laerlingurinn minn er horfinn. 
Geturu hjalpad mer ad finna hann?`,"Seinast egar eg sa hann, var hann a fara sudur i skoginn til ad safna jurtum."],[`Hefuru fundi laerlinginn minn? 
Eg hef ekki sed hann i marga daga`],["Getur u lati mig i fridi?"],["Eg er sma upptekin herna."]],xc={english:bc,icelandic:Ac};function Sc(e,t){return[e.sprite("sprites",{anim:"wizard-idle-down"}),e.area({shape:new e.Rect(e.vec2(2,6),12,18)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"wizard"]}async function Pc(e,t,n,i={}){if(i.overrideDialogue&&Array.isArray(i.overrideDialogue)){t.flipX=!0,H(t,"wizard-idle-side"),await Y(e,e.vec2(250,500),i.overrideDialogue),setTimeout(()=>{H(t,"wizard-idle-down")},7e3);return}else n.direction==="left"&&(t.flipX=!1,H(t,"wizard-idle-side")),n.direction==="right"&&(t.flipX=!0,H(t,"wizard-idle-side")),n.direction==="up"&&H(t,"wizard-idle-up"),n.direction==="down"&&H(t,"wizard-idle-down");const s=xc[E.getLanguage()];let r=In.getNbOfTimesTalkedWizard();r>s.length-1&&(In.setNbOfTimesTalkedWizard(1),r=In.getNbOfTimesTalkedWizard()),s[r]&&(await Y(e,e.vec2(250,500),s[r]),In.setNbOfTimesTalkedWizard(r+1))}async function Ec(e){me(e),ge(e);const t=E.getPreviousScene();console.log("Previous scene:",t),oe(e,27,29,52);const n=await ue("./assets/maps/tower.json"),i=e.add([e.pos(-240,-372)]),s={player:null,wizard:[]},r=n.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPointsTowerSecondFloor"){for(const l of a.objects)if(l.name==="tower-second-floor"&&!s.player&&t==="tower-second-floor"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}}if(a.name==="SpawnPoints")for(const l of a.objects){if(l.name==="player"&&!s.player&&t!=="tower-second-floor"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="wizard"){s.wizard=i.add(Sc(e,e.vec2(l.x,l.y)));continue}}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}s.player&&(e.setCamScale(4),e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{s.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),s.player.worldPos(),.15,a=>{e.setCamPos(a)},e.easings.linear)}),ye(e,s.player),s.player.onCollide("tower-exit",()=>{E.setPreviousScene("tower"),e.go("world")}),s.player.onCollide("tower-second-floor",()=>{E.setPreviousScene("tower"),e.go("tower-second-floor")}),s.player.onCollide("wizard",()=>{Pc(e,s.wizard,s.player)}),k(e))}async function Mc(e){me(e),ge(e);const t=E.getPreviousScene();oe(e,27,29,52);const n=await ue("./assets/maps/tower-second-floor.json"),i=e.add([e.pos(-240,-372)]),s={player:null},r=n.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects)if(l.name==="player"&&!s.player&&t!=="basement"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}e.setCamScale(4),e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{s.player.pos.dist(e.getCamPos())&&e.tween(e.getCamPos(),s.player.worldPos(),.15,a=>{e.setCamPos(a)},e.easings.linear)}),ye(e,s.player),s.player.onCollide("tower",()=>{E.setPreviousScene("tower-second-floor"),e.go("tower")}),k(e)}const Cc=[["Ribbit... Ribbit..."],["..... Ribbit..."],["Ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit ribbit."],["Ribbit?"],["Ribbit... Ribbit..."],["R. I. B. B. I. T."],["Rib","bit."],["Ribbit?"],["tibbiR ... tibbiR ..."],["Ri Ri Ri Biii Biii Biii Tt Tt Tt"]],Tc=[["essir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram a vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],Ic={english:Cc,icelandic:Tc};function Dc(e,t){return[e.sprite("sprites",{anim:"frog-idle-down"}),e.pos(t.x,t.y),e.area({shape:new e.Rect(e.vec2(2,6),12,12)}),e.body({isStatic:!0}),"frog"]}async function qc(e,t,n,i=0){const s=Ic[E.getLanguage()];let r=Ci.getNbTimesTalkedFrog(),a=r;s[a]&&await Y(e,e.vec2(250,500),[s[a]],{speed:10}),Ci.setNbTimesTalkedFrog(r+1)}const Bc=[["Moo... Moo..."],["..... Moo..."],["Moo?"],["Moo... Moo..."],["Moo","moo."],["Moo?"],["Moo... Moo..."],["Moo","moo?","Moo moo!"],["Moo?"],["Moo ... Moo ..."],["Ribbi-... I mean Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo Moo"]],Rc=[["essir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram a vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],Hc={english:Bc,icelandic:Rc};function Fc(e,t){return[e.sprite("cow",{anim:"cow-idle-up"}),e.area({shape:new e.Rect(e.vec2(8,12),16,16)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"cow",{name:"cow",hp(){return 1},hurt(){}}]}async function Oc(e,t,n){if(n.direction==="left"&&(t.flipX=!0,H(t,"cow-idle-side")),n.direction==="right"&&(t.flipX=!1,H(t,"cow-idle-side")),n.direction==="up"&&H(t,"cow-idle-down"),n.direction==="down"&&H(t,"cow-idle-up"),Re.getCowQuestComplete()===!0||N.getHasCarrot()===!1){const i=Hc[E.getLanguage()];let s=Re.getNbTimesTalkedCow(),r=s;i[r]&&await Y(e,e.vec2(250,500),[i[r]],{speed:10}),Re.setNbTimesTalkedCow(s+1)}}let Di=!1;async function jc(e,t,n){t.unuse("body"),Re.getCowQuestComplete()===!1?(Di||await Y(e,e.vec2(250,500),["Moo?"],{speed:10}),Di=!0,_n(e,n,t,20),Re.setIsFollowingPlayer(!0)):(t.use(e.body({isStatic:!0})),H(t,"cow-idle-down"),Re.setIsFollowingPlayer(!1))}const Nc=[["This gosh darn fence keeps breaking!","Hey there!","My cow escaped again. Could you help me find her?","If you find her, please bring her back to me and I'll give you a reward.","Here, take this carrot. She loves carrots."],["If you find her she'll definitely come with you. She's very fond of carrots."],["Have you seen my cow?"],["I've got to fix this fence..."]],Lc=[["essir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram a vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],Uc={english:Nc,icelandic:Lc};function Gc(e,t){return[e.sprite("Everything",{anim:"hatguy-idle-down"}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(3),e.offscreen(),"hatguy"]}async function Kc(e,t,n,i=0){n.direction==="left"&&(t.flipX=!1,H(t,"hatguy-idle-side")),n.direction==="right"&&(t.flipX=!0,H(t,"hatguy-idle-side")),n.direction==="up"&&H(t,"hatguy-idle-down"),n.direction==="down"&&H(t,"hatguy-idle-up");let s=Ti.getNbTimesTalkedHatguy();const r=Uc[E.getLanguage()];let a=r[s]||r[r.length-1];if(Re.getIsFollowingPlayer()===!0&&Re.getCowQuestComplete()===!1){await Y(e,e.vec2(250,500),["You found her! Hooray! Thank you so much for bringing her back.","Here is a reward for your kindness. I don't have much, but please take this.","It's beans, they taste pretty bad but you might find them useful.","Oh and could I maybe... Get that carrot back?"],{speed:10}),N.setHasCarrot(!1),N.setHasMagicalBeans(!0),e.destroyAll("heartsContainer"),k(e),e.play("item"),Re.setCowQuestComplete(!0);return}if(Re.getCowQuestComplete()===!0){await Y(e,e.vec2(250,500),["Thank you again for bringing her back! You are a true hero."],{speed:10});return}let l={};s===0&&(l.onLine=o=>{o===4&&(N.setHasCarrot(!0),e.destroyAll("heartsContainer"),k(e),e.play&&e.play("item"))}),a&&(await Y(e,e.vec2(250,500),a,{speed:10,...l}),Ti.setNbTimesTalkedHatguy(s+1))}async function Xc(e){ge(e),me(e),E.getPreviousScene(),oe(e,8,148,236);const t=await ue("./assets/maps/town.json"),n=e.add([e.pos(0,0)]),i={player:null,slimes:[],cow:null,frog:null,hatguy:null,fenceDoor:null},s=E.getDeadSlimes?E.getDeadSlimes():[];let r=0;!Ce.isInitialized()&&(!Ce.getSlimeHealth()||Ce.getSlimeHealth().length===0)&&Ce.resetSlimeHealth(2);const a=t.layers;for(const l of a){if(l.name==="Boundaries"){ce(e,n,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="player"&&!i.player){i.player=n.add(G(e,e.vec2(o.x,o.y)));continue}if(o.name==="frog"){i.frog=n.add(Dc(e,e.vec2(o.x,o.y)));continue}if(o.name==="cow"&&!i.cow){i.cow=n.add(Fc(e,e.vec2(o.x,o.y)));continue}if(o.name==="hatguy"){i.hatguy=n.add(Gc(e,e.vec2(o.x,o.y)));continue}if(o.name==="fence-door"){const d=E.getIsFenceDoorOpened()?"fence-door-opened":"fence-door-closed",f=n.add([e.sprite("fence-door",{anim:d}),e.pos(o.x,o.y),e.area(),e.body({isStatic:!0}),e.offscreen(),"fence-door"]);i.fenceDoor=f;continue}if(o.name==="slime"){const u=`${Math.floor(o.x)},${Math.floor(o.y)}`;if(window&&window.console&&console.log("Spawning slime at",u,"deadSlimes:",s),!s.includes(u)){const d=n.add(kn(e,e.vec2(o.x,o.y)));d._spawnKey=u,r<2&&(d._slimeIndex=r,window&&window.console&&console.log("Assigned _slimeIndex",r,"to slime at",u),r++),i.slimes.push(d)}continue}}continue}l.type==="tilelayer"&&de(e,n,l,t.tileheight,t.tilewidth,t.tilesets)}i.player&&(i.player.onCollide("town-exit",()=>{E.setPreviousScene("town"),e.go("world")}),i.player.onCollide("frog",()=>{qc(e)}),i.player.onCollide("cow",()=>{Re.getCowQuestComplete()===!1&&N.getHasCarrot()===!0?jc(e,i.cow,i.player):(Re.getCowQuestComplete()===!0||N.getHasCarrot()===!1)&&Oc(e,i.cow,i.player)}),i.player.onCollide("hatguy",()=>{Kc(e,i.hatguy,i.player)}),i.fenceDoor&&i.player.onCollide("fence-door",()=>{E.getIsFenceDoorOpened()||(E.setIsFenceDoorOpened(!0),i.fenceDoor.play("fence-door-opened"),e.play("door-open"),i.fenceDoor.unuse("body"),e.wait(.5,()=>{i.fenceDoor.play("fence-door-closed"),i.fenceDoor.use("body"),E.setIsFenceDoorOpened(!1)}))}));for(const l of i.slimes)ri(e,l),Wt(e,l,()=>i.player),mn(e,l),l.onDeath&&l.onDeath(()=>{const o=l.pos,u=`${Math.floor(o.x)},${Math.floor(o.y)}`;E.addDeadSlime&&E.addDeadSlime(u)});e.setCamScale(4),e.setCamPos(i.player.worldPos()),e.onUpdate(()=>{i.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),i.player.worldPos(),.15,l=>{e.setCamPos(l)},e.easings.linear)}),ye(e,i.player),k(e),e.add([e.text(`FPS: ${Math.round(1/e.dt())}`,{size:16,font:"gameboy"}),e.pos(12,12),e.fixed(),{layer:"ui"},{update(){this.text=`FPS: ${Math.round(1/e.dt())}`}}])}const zc="modulepreload",Yc=function(e,t){return new URL(e,t).href},qi={},Ns=function(t,n,i){let s=Promise.resolve();if(n&&n.length>0){let u=function(d){return Promise.all(d.map(f=>Promise.resolve(f).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};const a=document.getElementsByTagName("link"),l=document.querySelector("meta[property=csp-nonce]"),o=l?.nonce||l?.getAttribute("nonce");s=u(n.map(d=>{if(d=Yc(d,i),d in qi)return;qi[d]=!0;const f=d.endsWith(".css"),c=f?'[rel="stylesheet"]':"";if(!!i)for(let w=a.length-1;w>=0;w--){const y=a[w];if(y.href===d&&(!f||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${c}`))return;const p=document.createElement("link");if(p.rel=f?"stylesheet":zc,f||(p.as="script"),p.crossOrigin="",p.href=d,o&&p.setAttribute("nonce",o),document.head.appendChild(p),f)return new Promise((w,y)=>{p.addEventListener("load",w),p.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${d}`)))})}))}function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return s.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return t().catch(r)})},Ls=["left","right"];Dt().getInstance();function Wc(e,t,n=2){return[e.sprite("Everything",{anim:"chicken-idle-side"}),e.area({shape:new e.Rect(e.vec2(1,5),14,12)}),e.body(),e.pos(t),e.offscreen(),e.opacity(),e.state("idle",["idle",...Ls]),e.health(n),{speed:30,attackPower:.5},"chicken"]}function Vc(e,t,n){t.on("hurt",()=>{console.log(`[ChickenAI] Chicken ${n} hurt event: hp=${t.hp&&t.hp()}`)}),t.on("death",()=>{console.log(`[ChickenAI] Chicken ${n} death event: hp=${t.hp&&t.hp()}`)}),e.onUpdate(()=>{if(t.health<=0){t._deathEmitted||(t._deathEmitted=!0,t.trigger("death"));return}if(Kt(e,t))switch(t.state){case"idle":t.move(0);break;case"left":t.move(-t.speed,0);break;case"right":t.move(t.speed,0);break}});const i=t.onStateEnter("idle",async()=>{t.stop(),await e.wait(3),Kt(e,t)?t.enterState(Ls[Math.floor(Math.random()*Ls.length)]):t.enterState("idle")}),s=t.onStateEnter("right",async()=>{t.flipX=!0,H(t,"chicken-side");let a=0,l=!1;for(;a<2;)if(await e.wait(.1),a+=.1,t.getCollisions().length>0){l=!0;break}if(l){t.enterState("left");return}t.enterState("idle")}),r=t.onStateEnter("left",async()=>{t.flipX=!1,H(t,"chicken-side");let a=0,l=!1;for(;a<3;)if(await e.wait(.1),a+=.1,t.getCollisions().length>0){l=!0;break}if(l){t.enterState("idle");return}t.enterState("idle")});t.on("hurt",()=>{const a=t.hp&&t.hp();typeof a=="number"&&!isNaN(a)&&(console.log(`[ChickenAI] setChickenHealth called for index=${n}, hp=${a}`),ie.setChickenHealth(n,a))}),t.on("death",()=>{ie.setChickenHealth(n,0)}),e.onSceneLeave(()=>{i.cancel(),s.cancel(),r.cancel()})}async function Qc(e){const t=E.getCurrentSong();if(!t||!t.name||t.name!=="castle-soundtrack"){E.pauseCurrentSong();const l=e.play("castle-soundtrack",{loop:!0});l.name="castle-soundtrack",E.setCurrentSong(l)}const n=E.getPreviousScene();console.log("previousScene:",n),me(e),ge(e),oe(e,8,148,236);const i=await ue("./assets/maps/castle.json"),s=e.add([e.pos(100,100)]),r={player:null,chicken:[],prisoner:null},a=i.layers;for(const l of a){if(l.name==="Boundaries"){ce(e,s,l);continue}if(l.name==="SpawnPoints"){const o=l.objects.filter(d=>d.name==="chicken").slice(0,3);!ie.isInitialized()&&ie.getChickenHealth().length===0&&ie.initIfNeeded(o.length);const u=ie.getChickenHealth();for(let d=0;d<o.length&&!(d>=u.length);d++){const f=u[d];if(f===0){r.chicken.push(null);continue}const c=o[d],g=s.add(Wc(e,e.vec2(c.x,c.y),f));r.chicken.push(g)}for(const d of l.objects){if(d.name==="prisoner"&&!r.prisoner&&E.getPrisonDoorOpened()&&!E.getPrisonerFreed()){r.prisoner=s.add(ai(e,e.vec2(d.x,d.y)));continue}if(r.prisoner&&r.player&&E.getPrisonDoorOpened()&&(r.prisoner.unuse("body"),e.wait(.1,()=>{Ns(async()=>{const{followPlayer:f}=await Promise.resolve().then(()=>Od);return{followPlayer:f}},void 0,import.meta.url).then(({followPlayer:f})=>{f(e,r.player,r.prisoner)})})),d.name==="player-barn"&&!r.player&&n==="barn"){r.player=s.add(G(e,e.vec2(d.x,d.y)));continue}if(d.name==="player-barn-side"&&!r.player&&n==="barn-side"){r.player=s.add(G(e,e.vec2(d.x,d.y)));continue}if(d.name==="player-tavern"&&!r.player&&n==="tavern"){r.player=s.add(G(e,e.vec2(d.x,d.y)));continue}if(d.name==="player-forest"&&!r.player&&n==="forest"){r.player=s.add(G(e,e.vec2(d.x,d.y)));continue}if(d.name==="player-castle-main"&&!r.player&&n==="castle-main"){r.player=s.add(G(e,e.vec2(d.x,d.y)));continue}if(d.name==="player-forest-east"&&!r.player&&n==="forest-east"){r.player=s.add(G(e,e.vec2(d.x,d.y)));continue}if(d.name==="player"&&!r.player&&n!=="barn"&&n!=="barn-side"&&n!=="tavern"&&n!=="forest"&&n!=="castle-main"&&n!=="forest-east"){r.player=s.add(G(e,e.vec2(d.x,d.y)));continue}}}l.type==="tilelayer"&&de(e,s,l,i.tileheight,i.tilewidth,i.tilesets)}for(let l=0;l<r.chicken.length;l++)r.chicken[l]&&(Vc(e,r.chicken[l],l),Wt(e,r.chicken[l],()=>r.player));if(r.player.onCollide("barn-entrance",()=>{e.play("door-open"),e.go("barn")}),r.player.onCollide("barn-side-entrance",()=>{e.play("door-open"),e.go("barn")}),r.player.onCollide("castle-main-entrance",()=>{e.go("castle-main")}),r.player.onCollide("tavern-entrance",()=>{e.play("door-open"),e.go("tavern")}),r.player.onCollide("forest-entrance",()=>{e.go("forest")}),r.player.onCollide("forest-east-entrance",()=>{e.go("forest-east")}),e.setCamScale(4),r.player&&typeof r.player.worldPos=="function"&&e.setCamPos(r.player.worldPos()),e.onUpdate(()=>{if(r.player&&typeof r.player.worldPos=="function"){const l=r.player.worldPos(),o=e.getCamPos();l&&o&&l.dist(o)>1&&e.tween(o,l,.15,u=>{e.setCamPos(u)},e.easings.linear)}}),e.onUpdate(()=>{r.player&&typeof r.player.worldPos=="function"&&e.setCamPos(r.player.worldPos())}),ye(e,r.player),k(e),e.add([e.text(`FPS: ${(1/e.dt()).toFixed(1)}`,{size:16,font:"gameboy"}),e.pos(12,12),e.fixed(),{layer:"ui"},{update(){this.text=`FPS: ${(1/e.dt()).toFixed(1)}`}}]),console.log("Prisoner Freed:",E.getPrisonerFreed()),E.getPrisonerFreed()===!1){const l=e.vec2(436,614);let o=!1,u=E.getFreezePlayer();e.onUpdate(()=>{n==="basement"&&(!r.prisoner.exists()||!r.player.exists()||o||r.player.pos.dist(l)<32&&r.prisoner.pos.dist(l)<32&&(o=!0,(async()=>{const{dialog:d}=await Ns(async()=>{const{dialog:w}=await Promise.resolve().then(()=>$r);return{dialog:w}},void 0,import.meta.url),f=[["Thank you! You saved my life. I'm forever in your debt."],["I'll make sure you get rewarded for your help. I will see you later."]];await d(e,e.vec2(250,500),f);const c=r.prisoner.pos,g=e.vec2(c.x+r.prisoner.width+75,c.y+r.prisoner.height+70),p=e.add([e.sprite("smoke",{anim:"smoke"}),e.pos(g.x,g.y),e.z(100)]);await new Promise(w=>e.wait(.2,w)),r.prisoner.destroy(),await new Promise(w=>e.wait(.5,w)),p.destroy(),E.setFreezePlayer(u),E.setPrisonerFreed(!0)})()))})}}const Jc=[["Stop right there!","What business do you have here?","We don't just let anyone through pal."],["Get lost!"],["Get out of my face buddy!"]],Zc=[["essir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram a vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],$c={english:Jc,icelandic:Zc};function Lt(e,t,n,i="guard-1"){return[e.sprite("sprites",{anim:n}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(3),e.offscreen(),i]}async function Ut(e,t,n,i=0){const s=$c[E.getLanguage()][i];let r=hs.getNbTimesTalkedGuard();r>=s.length&&(r=s.length-1,hs.setNbTimesTalkedGuard(r)),s[r]&&(await Y(e,e.vec2(250,500),s,{speed:10}),hs.setNbTimesTalkedGuard(r+1))}async function _c(e){const t=E.getPreviousScene();console.log("previousScene:",t),me(e),ge(e),oe(e,8,148,236);const n=await ue("./assets/maps/castle-main.json"),i=e.add([e.pos(100,100)]),s={player:null,chests:[],guards:[]},r=n.layers;console.log("Map layers:",r);for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects){if(l.name==="player"&&!s.player&&t!=="throne-room"&&t!=="castle-main-underground"&&t!=="castle-main-well"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="chest"){const o=l.contents||l.properties?.find(c=>c.name==="contents")?.value||"health-potion",u=`${Math.round(l.x)},${Math.round(l.y)}`,d=E.getChestOpened(u),f=i.add(qt(e,e.vec2(l.x,l.y),o,d));s.chests.push(f)}if(l.name==="player-throne-room"&&!s.player&&t==="throne-room"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-castle-main-underground"&&!s.player&&t==="castle-main-underground"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-castle-well"&&!s.player&&t==="castle-main-well"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="guard-1"){s.guards.push(i.add(Lt(e,e.vec2(l.x,l.y),"guard-1-idle-down")));continue}if(l.name==="guard-2"){s.guards.push(i.add(Lt(e,e.vec2(l.x,l.y),"guard-2-idle-down")));continue}if(l.name==="guard-3"){const o=i.add(Lt(e,e.vec2(l.x,l.y),"guard-3-down","guard-3"));s.guards.push(o);const u=l.y,d=u-300;let f=-1,c="guard-3-down";e.loop(.3,()=>{e.wait(Math.random(.5,1.5)),Kt(e,o)&&(o.pos.y<=d&&(f=1,c!=="guard-3-down"&&(o.play("guard-3-down"),c="guard-3-down")),o.pos.y>=u&&(f=-1,c!=="guard-3-up"&&(o.play("guard-3-up"),c="guard-3-up")),o.move(0,40*f))})}}continue}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}s.player&&(s.player.onCollide("guard-1",a=>{Ut(e,a,s.player,0)}),s.player.onCollide("guard-2",a=>{Ut(e,a,s.player,1)}),s.player.onCollide("guard-3",a=>{Ut(e,a,s.player,2)}),s.player.onCollide("castle-main-exit",()=>{E.setPreviousScene("castle-main"),e.go("castle")}),s.player.onCollide("throne-room-entrance",()=>{e.go("throne-room")}),s.player.onCollide("castle-main-underground-entrance",()=>{E.setPreviousScene("castle-main"),e.go("castle-main-underground")}),s.player.onCollide("castle-well-exit",()=>{E.setPreviousScene("castle-main-well"),e.go("castle-main-underground")})),e.setCamScale(3),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{if(s.player&&typeof s.player.worldPos=="function"){const a=s.player.worldPos(),l=e.getCamPos();a&&l&&a.dist(l)>1&&e.tween(l,a,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),ye(e,s.player),k(e),e.add([e.text(`FPS: ${Math.round(1/e.dt())}`,{size:16,font:"gameboy"}),e.pos(12,12),e.fixed(),{layer:"ui"},{update(){this.text=`FPS: ${Math.round(1/e.dt())}`}}])}async function kc(e){const t=E.getPreviousScene();console.log("previousScene:",t),me(e),ge(e),oe(e,27,29,52);const n=await ue("./assets/maps/castle-main-underground.json"),i=e.add([e.pos(100,100)]),s={player:null,chests:[]},r=n.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects){if(l.name==="player"&&t!=="castle-main-well"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-castle-well"&&!s.player&&t==="castle-main-well"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="chest"){const o=l.contents||l.properties?.find(c=>c.name==="contents")?.value||"health-potion",u=`${Math.round(l.x)},${Math.round(l.y)}`,d=E.getChestOpened(u),f=i.add(qt(e,e.vec2(l.x,l.y),o,d));s.chests.push(f)}}continue}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}s.player.onCollide("castle-main-underground-exit",()=>{E.setPreviousScene("castle-main-underground"),e.go("castle-main")}),s.player.onCollide("castle-well-entrance",()=>{E.setPreviousScene("castle-main-well"),e.go("castle-main")}),s.player.onCollide("chest",a=>{Bt(e,a,s.player)}),e.setCamScale(4),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{if(s.player&&typeof s.player.worldPos=="function"){const a=s.player.worldPos(),l=e.getCamPos();a&&l&&a.dist(l)>1&&e.tween(l,a,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),ye(e,s.player),k(e)}function eh(e,t,n="king-idle-down",i="king"){return[e.sprite("sprites",{anim:n}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(5),e.offscreen(),i]}async function th(e){me(e),ge(e),oe(e,27,29,52);const t=await ue("./assets/maps/throne-room.json"),n=e.add([e.pos(100,100)]),i={player:null,king:null,slimes:[],guards:[]},s=t.layers;console.log("Map layers:",s);for(const r of s){if(r.name==="Boundaries"){ce(e,n,r);continue}if(r.name==="SpawnPoints"){for(const a of r.objects){if(a.name==="player"&&!i.player){i.player=n.add(G(e,e.vec2(a.x,a.y)));continue}if(a.name==="slime"){i.slimes.push(n.add(kn(e,e.vec2(a.x,a.y))));continue}if(a.name==="guard-1"){i.guards.push(n.add(Lt(e,e.vec2(a.x,a.y),"guard-1-idle-down")));continue}if(a.name==="guard-2"){i.guards.push(n.add(Lt(e,e.vec2(a.x,a.y),"guard-2-idle-down")));continue}if(a.name==="guard-3"){const l=n.add(Lt(e,e.vec2(a.x,a.y),"guard-3-down","guard-3"));i.guards.push(l);const o=a.y,u=o-300;let d=-1,f="guard-3-down";e.loop(.3,()=>{e.wait(Math.random(.5,1.5)),l.pos.y<=u&&(d=1,f!=="guard-3-down"&&(l.play("guard-3-down"),f="guard-3-down")),l.pos.y>=o&&(d=-1,f!=="guard-3-up"&&(l.play("guard-3-up"),f="guard-3-up")),l.move(0,40*d)})}a.name==="king"&&(i.king=n.add(eh(e,e.vec2(a.x,a.y),"king-sitting-down","king")))}continue}r.type==="tilelayer"&&de(e,n,r,t.tileheight,t.tilewidth,t.tilesets)}i.player.onCollide("guard-1",r=>{Ut(e,r,i.player,0)}),i.player.onCollide("guard-2",r=>{Ut(e,r,i.player,1)}),i.player.onCollide("guard-3",r=>{Ut(e,r,i.player,2)}),i.player.onCollide("throne-room-exit",()=>{E.setPreviousScene("throne-room"),e.go("castle-main")}),e.setCamScale(4),i.player&&typeof i.player.worldPos=="function"&&e.setCamPos(i.player.worldPos()),e.onUpdate(()=>{if(i.player&&typeof i.player.worldPos=="function"){const r=i.player.worldPos(),a=e.getCamPos();r&&a&&r.dist(a)>1&&e.tween(a,r,.15,l=>{e.setCamPos(l)},e.easings.linear)}}),ye(e,i.player),k(e)}const nh=[["Howdy there! I haven't seen you around before. It's nice to meet you stranger.","Feel free to pet the chickens!","You can pet the chickens by pressing 'space'... if I remember correctly."],["Well, I should get back to work... Have a good day!"],["Thanks for stopping by!"]],sh=[["essir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram a vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],ih={english:nh,icelandic:sh};function rh(e,t,n="farmer"){return[e.sprite("sprites",{anim:"farmer-idle-down"}),e.pos(t.x,t.y),e.area(),e.body({isStatic:!0}),e.health(2),e.offscreen(),n]}async function qn(e,t,n,i=0){if(E.getPreviousScene()==="barn-side"&&(ie.isAnyChickenHurt()||ie.isAnyChickenDead())){t.flipX=!0,H(t,"farmer-idle-side");let a;ie.isAnyChickenAlive()?ie.isSomeButNotAllDead&&typeof ie.isSomeButNotAllDead=="function"&&ie.isSomeButNotAllDead()?a=[["You killed Beatrice! That was my favorite chicken!"],["I can't believe you would do this!"]]:a=[["Hey! What's your problem? Leave my chickens alone!"],["You think you can just waltz in here and mess with my chickens?"],["Get lost!"]]:a=[["No! My chickens! What have you done? T-they're all dead!"],["Just leave! You monster!"]],await Y(e,e.vec2(250,500),a),await e.wait(2),H(t,"farmer-idle-down");return}n.direction==="left"&&(t.flipX=!1,H(t,"farmer-idle-side")),n.direction==="right"&&(t.flipX=!0,H(t,"farmer-idle-side")),n.direction==="up"&&H(t,"farmer-idle-down"),n.direction==="down"&&H(t,"farmer-idle-up");const s=ih[E.getLanguage()];let r=fs.getNbTimesTalkedFarmer();r>=s.length&&(r=s.length-1,fs.setNbTimesTalkedFarmer(r)),await Y(e,e.vec2(250,500),s[r],{speed:10}),fs.setNbTimesTalkedFarmer(r+1)}async function ah(e){me(e),ge(e),oe(e,27,29,52);const t=await ue("./assets/maps/barn.json"),n=e.add([e.pos(-70,-160)]);let i=E.getPreviousScene();const s={player:null,farmer:null},r=t.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,n,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects){if(l.name==="player"&&!s.player&&i!=="barn-side"){s.player=n.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="farmer"){s.farmer=n.add(rh(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-barn"&&!s.player&&i==="barn-side"){s.player=n.add(G(e,e.vec2(l.x,l.y)));continue}}continue}a.type==="tilelayer"&&de(e,n,a,t.tileheight,t.tilewidth,t.tilesets)}s.player.onCollide("farmer",()=>{ie.isAnyChickenAlive()&&!ie.isAnyChickenHurt()?qn(e,s.farmer,s.player):Y(e,e.vec2(250,500),[["I don't want to talk to you!"]],{speed:10})}),s.player.onCollide("barn-exit",()=>{E.setPreviousScene("barn"),e.play("door-open"),e.go("castle")}),s.player.onCollide("barn-side-exit",()=>{E.setPreviousScene("barn-side"),e.play("door-open"),e.go("castle")}),i==="barn-side"&&s.farmer&&s.player&&(ie.isAnyChickenHurt()||ie.isAnyChickenDead())&&(!ie.isAnyChickenAlive()&&!ie.hasTriggeredDeadInteraction()?(ie.setTriggeredDeadInteraction(!0),qn(e,s.farmer,s.player)):ie.isSomeButNotAllDead()&&!ie.hasTriggeredOneDeadInteraction()?(ie.setTriggeredOneDeadInteraction(!0),qn(e,s.farmer,s.player)):ie.isAnyChickenHurt()&&ie.isAnyChickenAlive()&&!ie.hasTriggeredHurtInteraction()&&(ie.setTriggeredHurtInteraction(!0),qn(e,s.farmer,s.player))),e.setCamScale(4),ye(e,s.player),k(e)}const oh=[[],[],[]],lh=[[],[],[],[]],uh={english:oh,icelandic:lh};function dh(e,t){return[e.sprite("sprites",{anim:"bartender-idle-down"}),e.pos(t.x,t.y),e.area({shape:new e.Rect(e.vec2(2,6),12,25)}),e.body({isStatic:!0}),"bartender"]}async function ch(e,t,n,i=0){const s=uh[E.getLanguage()][i];let r=ps.getNbTimesTalkedBartender();r===0&&N.addPotion(1),r>=s.length&&(r=s.length-1,ps.setNbTimesTalkedBartender(r)),s[r]&&(await Y(e,e.vec2(250,500),s,{speed:10}),ps.setNbTimesTalkedBartender(r+1))}async function hh(e){me(e),ge(e),oe(e,27,29,52);const t=await ue("./assets/maps/tavern.json"),n=e.add([e.pos(-70,-160)]);let i=E.getPreviousScene();const s={player:null},r=t.layers;console.log("Map layers:",r);for(const a of r){if(a.name==="Boundaries"){ce(e,n,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects){if(l.name==="player"&&!s.player&&i!=="tavern-second-floor"){s.player=n.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="bartender"){s.bartender=n.add(dh(e,e.vec2(l.x,l.y)));continue}}continue}a.type==="tilelayer"&&de(e,n,a,t.tileheight,t.tilewidth,t.tilesets)}s.player.onCollide("bartender",()=>{ch(e)}),s.player.onCollide("tavern-exit",()=>{E.setPreviousScene("tavern"),e.play("door-open"),e.go("castle")}),s.player.onCollide("tavern-second-floor",()=>{E.setPreviousScene("tavern-second-floor"),e.go("tavern-second-floor")}),e.setCamScale(4),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{if(s.player&&typeof s.player.worldPos=="function"){const a=s.player.worldPos(),l=e.getCamPos();a&&l&&a.dist(l)>1&&e.tween(l,a,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),ye(e,s.player),k(e),console.log("Tilesets in tavern map:",t.tilesets)}async function fh(e){const t=E.getPreviousScene();console.log("previousScene:",t),me(e),ge(e),oe(e,8,148,236);const n=await ue("./assets/maps/forest.json"),i=e.add([e.pos(100,100)]),s={player:null,chests:[]},r=n.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects){if(l.name==="player"&&!s.player&&t!=="witch-house"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}if(l.name==="player-witch-house"&&!s.player&&t==="witch-house"&&(s.player=i.add(G(e,e.vec2(l.x,l.y)))),l.name==="chest"){const o=l.contents||l.properties?.find(c=>c.name==="contents")?.value||"health-potion",u=`${Math.round(l.x)},${Math.round(l.y)}`,d=E.getChestOpened(u),f=i.add(qt(e,e.vec2(l.x,l.y),o,d));s.chests.push(f)}}continue}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}s.player.onCollide("forest-exit",()=>{E.setPreviousScene("forest"),e.go("castle")}),s.player.onCollide("witch-house-entrance",()=>{E.setPreviousScene("forest"),e.go("witch-house")}),s.player.onCollide("chest",a=>{Bt(e,a,s.player)}),e.setCamScale(4),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{if(s.player&&typeof s.player.worldPos=="function"){const a=s.player.worldPos(),l=e.getCamPos();a&&l&&a.dist(l)>1&&e.tween(l,a,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),ye(e,s.player),k(e)}function _r(e,t){return[e.sprite("Everything",{anim:"troll-idle-down"}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"troll"]}function Bi(e,t,n){return[e.sprite("bean-stalk",{anim:n}),e.area({shape:new e.Rect(e.vec2(0,240),16,16)}),e.pos(t),"bean-stalk"]}const ph=[["Oh hello, I was just trying to decide what to plant here.","The soil here is so rich and fertile, I could grow anything!","But I can't decide what to plant...","Do you have any ideas?","..."],["Well I better get back to work..."],["These trees won't chop themselves!"],["Did you get that gift from my wife?"],["Why are you looking at me like that?"],["I can see you got that potion! I bet it will come in handy against those slimes."]],gh=[["essir slimungar eru alveg otholandi!","Eg er viss um ad galdrakallin upp i nordrinu hefur eitthvad med thetta ad gera.","Kiktu vid hja konunni minni. Hun myndist eitthvad a gjof handa ther."],["Jaeja, Eg aetti ad halda afram a vinna..."],["Fekkstu gjofinna fra konunni minni?"],["Hvers vegna horfirdu svona a mig?"]],mh={english:ph,icelandic:gh};function yh(e,t){return[e.sprite("Everything",{anim:"gardener-idle-side"}),e.area({shape:new e.Rect(e.vec2(2,6),12,13)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),e.opacity(),{speed:30},"gardener"]}async function wh(e,t,n,i){if(n.direction==="left"&&(t.flipX=!1,H(t,"gardener-idle-side")),n.direction==="right"&&(t.flipX=!0,H(t,"gardener-idle-side")),n.direction==="up"&&H(t,"gardener-idle-down"),n.direction==="down"&&H(t,"gardener-idle-up"),mh[E.getLanguage()],E.getPlantedBeans()===!1){let u=t.curAnim();if(t.play("gardener-idle-side"),t.flipX=!1,await Y(e,e.vec2(250,500),["Hmm... maybe some tulips? no that's too common...","Or perhaps some carrots? no, that's too predictable...","What about some roses? no, those are too basic...","Ugh, I just can't decide!"],{speed:10}),await t.play(u),await t.play(u),t.flipX===!1&&(t.flipX=!0),await Y(e,e.vec2(250,500),["Oh hello, I was just trying to decide what to plant here."],{speed:10}),t.play("gardener-idle-side"),t.flipX===!0&&(t.flipX=!1),await Y(e,e.vec2(250,500),["The soil here is so rich and fertile, I could grow anything!","But I can't decide what to plant...","It has to be something truly special!"],{speed:10}),await t.play(u),t.flipX===!1&&(t.flipX=!0),await Y(e,e.vec2(250,500),["Do you have any ideas?","..."],{speed:10}),N.getHasMagicalBeans()===!0){if(await Y(e,e.vec2(250,500),["Wait a minute... those beans you have...","Could they be... magical beans?","I've heard stories about them, but I never thought I'd see some in person!","Could I maybe... Plant them?","..."],{speed:10}),await N.setHasMagicalBeans(!1),await e.destroyAll("heartsContainer"),await k(e),await E.setPlantedBeans(!0),e.play("item"),await Y(e,e.vec2(250,500),["Thank you so much!"],{speed:10}),E.setFreezePlayer(!0),await e.tween(t.pos,t.pos.add(e.vec2(32,0)),2,d=>{t.pos=d,t.curAnim()!=="gardener-side"&&(t.flipX=!1,t.play("gardener-side"))},e.easings.linear),t.play("gardener-idle-up"),await e.wait(2),i){if(i.play)i.play("bean-stalk-2");else{const d=i.use&&i.use("sprite");d&&d.play&&d.play("bean-stalk-2")}qe.setBeanStalkHeight(1)}await e.tween(t.pos,t.pos.add(e.vec2(-32,0)),2,d=>{t.pos=d,t.curAnim()!=="gardener-side"&&(t.flipX=!0,t.play("gardener-side"))},e.easings.linear),t.play(u),await Y(e,e.vec2(250,500),["This is so exciting! I can't wait to see what grows!","Be sure to come back and check on it when you're passing by."],{speed:10})}else await Y(e,e.vec2(250,500),["Hmm... I guess not. Well, if you come across anything interesting, please let me know!"],{speed:10})}let s=ke.getNbTimesTalkedGardenerHeight1()||0;if(qe.getBeanStalkHeight()===1){let u=[["Thank you again for those magical beans!"],["I can't wait to see what grows!"]];await Y(e,e.vec2(250,500),u[s%u.length],{speed:10}),ke.setNbTimesTalkedGardenerHeight1(s+1)}let r=ke.getNbTimesTalkedGardenerHeight2()||0;if(qe.getBeanStalkHeight()===2){let u=[["Look! It's already grown so much!"],["I wonder how tall it will get?"]];await Y(e,e.vec2(250,500),u[r%u.length],{speed:10}),ke.setNbTimesTalkedGardenerHeight2(r+1)}let a=ke.getNbTimesTalkedGardenerHeight3()||0;if(qe.getBeanStalkHeight()===3){let u=[["Wow, it's getting really tall now!"],["Thank you again for this!"],["I can't wait to see how high it will grow!"]];await Y(e,e.vec2(250,500),u[a%u.length],{speed:10}),ke.setNbTimesTalkedGardenerHeight3(a+1)}let l=ke.getNbTimesTalkedGardenerHeight4()||0;if(qe.getBeanStalkHeight()===4){let u=[["It's almost reaching the clouds!"],["This is amazing!"]];await Y(e,e.vec2(250,500),u[l%u.length],{speed:10}),ke.setNbTimesTalkedGardenerHeight4(l+1)}let o=ke.getNbTimesTalkedGardenerHeight5()||0;if(qe.getBeanStalkHeight()>=5){let u=[["It's so tall now, It has reached the clouds!","Thank you, thank you, thank you!","I wonder what's up there..."],["This is unbelievable!"]];await Y(e,e.vec2(250,500),u[o%u.length],{speed:10}),ke.setNbTimesTalkedGardenerHeight5(o+1)}await e.wait(.5),t.play("gardener-idle-side"),t.flipX=!1}async function vh(e){const t=E.getPreviousScene();console.log("previousScene:",t),me(e),ge(e),oe(e,8,148,236);const n=await ue("./assets/maps/forest-east.json"),i=e.add([e.pos(100,100)]),s={player:null,chests:[],slimes:[],troll:null,gardener:null,beanStalk:null},r=n.layers;for(const d of r){if(d.name==="Boundaries"){ce(e,i,d);continue}if(d.name==="SpawnPoints"){for(const f of d.objects){if(f.name==="slime"&&!s.slimes.find(c=>c.id===f.id)){const c=`${Math.round(f.x)},${Math.round(f.y)}`;if((E.getDeadSlimes?E.getDeadSlimes():[]).includes(c))continue;const p=i.add(kn(e,e.vec2(f.x,f.y)));s.slimes.push(p)}if(f.name==="player"&&!s.player&&t!=="troll-dinner"&&t!=="bean-stalk"){s.player=i.add(G(e,e.vec2(f.x,f.y)));continue}if(f.name==="player-troll-dinner"&&!s.player&&t==="troll-dinner"&&(s.player=i.add(G(e,e.vec2(f.x,f.y)))),f.name==="player-bean-stalk"&&!s.player&&t==="bean-stalk"&&(s.player=i.add(G(e,e.vec2(f.x,f.y)))),f.name==="troll"&&(s.troll=i.add(_r(e,e.vec2(f.x,f.y)))),f.name==="gardener"&&(s.gardener=i.add(yh(e,e.vec2(f.x,f.y)))),f.name==="bean-stalk"){const c=qe.getBeanStalkHeight()+1;c<6&&(s.beanStalk=i.add(Bi(e,e.vec2(f.x,f.y),`bean-stalk-${c}`)))}if(f.name==="bean-stalk-max"&&qe.getBeanStalkHeight()>=5&&(s.beanStalk=i.add(Bi(e,e.vec2(f.x,f.y),"bean-stalk-6"))),f.name==="chest"){const c=f.contents||f.properties?.find(y=>y.name==="contents")?.value||"health-potion",g=`${Math.round(f.x)},${Math.round(f.y)}`,p=E.getChestOpened(g),w=i.add(qt(e,e.vec2(f.x,f.y),c,p));s.chests.push(w)}}continue}d.type==="tilelayer"&&de(e,i,d,n.tileheight,n.tilewidth,n.tilesets)}for(const d of s.slimes)ri(e,d),Wt(e,d,()=>s.player),mn(e,d),d.onDeath&&d.onDeath(()=>{const f=d.pos,c=`${Math.round(f.x)},${Math.round(f.y)}`;E.addDeadSlime&&E.addDeadSlime(c)});s.player.onCollide("forest-east-exit",()=>{qe.setBeanStalkHeight(qe.getBeanStalkHeight()+1),E.setPreviousScene("forest-east"),e.go("castle")}),s.player.onCollide("gardener",()=>{wh(e,s.gardener,s.player,s.beanStalk)}),s.player.onCollide("chest",d=>{Bt(e,d,s.player)}),s.player.onCollide("troll-dinner-entrance",()=>{E.getTrollDinnerHad()===!0&&(E.setPreviousScene("forest-east"),e.go("troll-dinner"))}),s.player.onCollide("bean-stalk",()=>{qe.getBeanStalkHeight()>=5&&e.go("bean-stalk")}),e.setCamScale(4),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{if(s.player&&typeof s.player.worldPos=="function"){const d=s.player.worldPos(),f=e.getCamPos();d&&f&&d.dist(f)>1&&e.tween(f,d,.15,c=>{e.setCamPos(c)},e.easings.linear)}});const a=e.vec2(1180,705);let l=!1;async function o(d){d.play("troll-down"),await e.tween(d.pos,d.pos.add(e.vec2(0,16)),2,c=>d.pos=c,e.easings.linear),d.play("troll-side"),d.flipX=!1,await e.tween(d.pos,d.pos.add(e.vec2(48,0)),4,c=>d.pos=c,e.easings.linear),d.play("troll-up"),await e.tween(d.pos,d.pos.add(e.vec2(0,-32)),3,c=>d.pos=c,e.easings.linear),d.play("troll-side"),d.flipX=!0,await e.tween(d.pos,d.pos.add(e.vec2(-48,0)),4,c=>d.pos=c,e.easings.linear),d.play("troll-idle-side")}async function u(d,f,c){s.troll.unuse("body"),s.player.unuse("body"),E.setFreezePlayer(!0);const g=16;f.play("troll-side"),f.flipX=!1,await d.tween(f.pos,f.pos.add(d.vec2(5*g,0)),2,p=>{f.pos=p,f.flipX=!1},d.easings.linear),f.play("troll-down"),await d.tween(f.pos,f.pos.add(d.vec2(0,2*g)),1.2,p=>{f.pos=p},d.easings.linear),f.play("troll-side"),f.flipX=!0,await d.tween(f.pos,f.pos.add(d.vec2(-3*g,0)),1.6,p=>{f.pos=p,f.flipX=!0},d.easings.linear),f.play("troll-up"),await d.tween(f.pos,f.pos.add(d.vec2(0,-1*g)),.8,p=>{f.pos=p},d.easings.linear),f.play("troll-idle-down"),await d.wait(.3),c.play("player-side"),c.flipX=!1,await d.tween(c.pos,c.pos.add(d.vec2(6*g,0)),1.6,p=>{c.pos=p,c.flipX=!1},d.easings.linear),c.play("player-down"),await d.tween(c.pos,c.pos.add(d.vec2(0,2*g)),1,p=>{c.pos=p},d.easings.linear),c.play("player-side"),c.flipX=!0,await d.tween(c.pos,c.pos.add(d.vec2(-3*g,0)),1.2,p=>{c.pos=p,c.flipX=!0},d.easings.linear),c.play("player-up"),await d.tween(c.pos,c.pos.add(d.vec2(0,-.5*g)),.6,p=>{c.pos=p},d.easings.linear),c.play("player-idle-down"),s.player.use("body")}e.onUpdate(()=>{!s.player||!s.troll||E.getTrollDinnerHad()===!0||l||s.player.pos.dist(a)<48&&(Y(e,e.vec2(250,500),["Stop right there!"],{keepFrozen:!0}),l=!0,E.setFreezePlayer(!0),o(s.troll).then(async()=>{const{dialog:d}=await Ns(async()=>{const{dialog:b}=await Promise.resolve().then(()=>$r);return{dialog:b}},void 0,import.meta.url),f=["You shall not pass until you answer my riddle! And if you get it wrong...","I will eat you! Muahaha!","Alright here it comes...","What has eyes but... can't see... ummm...","Wait... What has umm... a mouth? No, that's not right..."];await d(e,e.vec2(250,500),f),s.troll.play("troll-idle-side"),s.troll.flipX=!1;const c=["Oh god this is so embarrassing... How did that stupid riddle go again...","...","..."];await d(e,e.vec2(250,500),c),s.troll.flipX=!0;const g=16;s.troll.play("troll-idle-side");const p=["Forget that stupid riddle!"];await d(e,e.vec2(250,500),p),E.setFreezePlayer(!0),await e.tween(s.troll.pos,s.troll.pos.add(e.vec2(-2*g,0)),3,b=>{s.troll.pos=b,s.troll.curAnim()!=="troll-side"&&s.troll.play("troll-side"),s.troll.flipX=!0},e.easings.linear),s.troll.play("troll-idle-side");const w=["I'll just eat you anyway!"];await d(e,e.vec2(250,500),w);const y=["Muhahaha!"];s.troll.play("troll-side"),await d(e,e.vec2(250,500),y),e.wait(2e3),s.troll.play("troll-idle-side");const v=["Wait, why aren't you running away?","I-I'm about to eat you. I mean it!"];await d(e,e.vec2(250,500),v),e.wait(4e3);const C=["...","...","...","*Sigh* Can i be honest with you?"];await d(e,e.vec2(250,500),C),E.setFreezePlayer(!0),await e.tween(s.troll.pos,s.troll.pos.add(e.vec2(0,.5*g)),2,b=>{s.troll.pos=b,s.troll.curAnim()!=="troll-down"&&s.troll.play("troll-down")},e.easings.linear),s.troll.play("troll-idle-down");const D=["I don't really like the taste of humans...","But please don't tell anyone, ok?","What would people think of me if they knew I didn't like eating humans?","I would be the laughing stock of the troll community!"];await d(e,e.vec2(250,500),D),E.setFreezePlayer(!0),await e.tween(s.troll.pos,s.troll.pos.add(e.vec2(0,-.5*g)),2,b=>{s.troll.pos=b,s.troll.curAnim()!=="troll-up"&&s.troll.play("troll-up")},e.easings.linear),s.troll.play("troll-idle-side");const F=["Look, I'll let you pass. If you let me invite you to dinner.","I promise it will be worth your while.","The grass is like way greener on the other side of this bridge.","...","I'll take that as a yes! Follow me."];await d(e,e.vec2(250,500),F),await u(e,s.troll,s.player);const M=e.add([e.rect(e.width(),e.height()),e.color(27,29,52),e.opacity(0),e.fixed(),"fadeToBlack"]);await e.tween(M.opacity,1,1,b=>M.opacity=b,e.easings.linear),E.setFreezePlayer(!1),e.go("troll-dinner")}))}),ye(e,s.player),k(e)}async function bh(e){const t=E.getPreviousScene();console.log("previousScene:",t),me(e),ge(e),oe(e,8,148,236);const n=await ue("./assets/maps/witch-house.json"),i=e.add([e.pos(100,100)]),s={player:null},r=n.layers;console.log("Map layers:",r);for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects){if(l.name==="player"&&!s.player&&t!=="witch-house-inside"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}l.name==="player-witch-house-inside"&&!s.player&&t==="witch-house-inside"&&(s.player=i.add(G(e,e.vec2(l.x,l.y))))}continue}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}s.player.onCollide("witch-house-exit",()=>{E.setPreviousScene("witch-house"),e.go("forest")}),s.player.onCollide("witch-house-inside-entrance",()=>{E.setPreviousScene("witch-house"),e.go("witch-house-inside")}),e.setCamScale(4),e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{s.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),s.player.worldPos(),.15,a=>{e.setCamPos(a)},e.easings.linear)}),ye(e,s.player),k(e)}function Ah(e,t){return[e.sprite("Everything",{anim:"witch-idle-side"}),e.area({shape:new e.Rect(e.vec2(2,6),12,15)}),e.body({isStatic:!0}),e.pos(t),e.offscreen(),"witch"]}const Ri=Dt().getInstance();async function xh(e){me(e),ge(e);const t=Ri.getPreviousScene();oe(e,27,29,52);const n=await ue("./assets/maps/witch-house-inside.json"),i=e.add([e.pos(-380,-392)]),s={player:null,witch:null};for(const r of n.layers){if(r.name==="Boundaries"){ce(e,i,r);continue}if(r.name==="SpawnPoints")for(const a of r.objects){if(a.name==="player"&&!s.player&&t!=="witch-house-inside"){s.player=i.add(G(e,e.vec2(a.x,a.y)));continue}if(a.name==="witch"&&!s.witch){s.witch=i.add(Ah(e,e.vec2(a.x,a.y)));continue}}r.type==="tilelayer"&&de(e,i,r,n.tileheight,n.tilewidth,n.tilesets)}s.player.onCollide("chest",r=>{Bt(e,r,s.player)}),s.player.onCollide("witch-house-inside-exit",()=>{Ri.setPreviousScene("witch-house-inside"),e.go("witch-house")}),e.setCamScale(4),e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{const r=e.getCamPos(),a=s.player.worldPos(),l=r.lerp(a,.1);e.setCamPos(l)}),ye(e,s.player),k(e)}async function Sh(e){E.getTrollDinnerHad()===!1&&E.setFreezePlayer(!0);const t=E.getPreviousScene();me(e),ge(e),oe(e,8,148,236);const n=await ue("./assets/maps/troll-dinner.json"),i=e.add([e.pos(100,100)]),s={player:null,troll:null,chests:[]},r=n.layers;for(const l of r){if(l.name==="Boundaries"){ce(e,i,l);continue}if(l.name==="SpawnPoints"){for(const o of l.objects){if(o.name==="player"&&!s.player&&t!=="forest-east"&&E.getTrollDinnerHad()===!1){s.player=i.add(G(e,e.vec2(o.x,o.y))),s.player&&s.player.play&&s.player.play("player-sitting-up");continue}if(o.name==="troll"&&!s.troll&&(s.troll=i.add(_r(e,e.vec2(o.x,o.y))),s.troll&&s.troll.play&&s.troll.play("troll-sitting-down")),o.name==="player-troll-dinner-entrance"&&!s.player&&t==="forest-east"&&E.getTrollDinnerHad()===!0){s.player=i.add(G(e,e.vec2(o.x,o.y)));continue}if(o.name==="chest"){const u=o.contents||o.properties?.find(g=>g.name==="contents")?.value||"health-potion",d=`${Math.round(o.x)},${Math.round(o.y)}`,f=E.getChestOpened(d),c=i.add(qt(e,e.vec2(o.x,o.y),u,f));s.chests.push(c)}}continue}l.type==="tilelayer"&&de(e,i,l,n.tileheight,n.tilewidth,n.tilesets)}let a=!1;if(s.player.onCollide("chest",async l=>{await Bt(e,l),a||(s.troll.play("troll-sitting-left"),await Y(e,e.vec2(250,500),["Oh you're gonna take that? I guess that's fine.","Since we're friends and all."]),a=!0,s.troll.play("troll-sitting-down"))}),s.player.onCollide("troll-dinner-exit",()=>{E.setPreviousScene("troll-dinner"),e.go("forest-east")}),e.setCamScale(4),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos().sub(0,20)),ye(e,s.player),k(e),E.getTrollDinnerHad()===!1){e.onUpdate(()=>{s.player&&E.getFreezePlayer()&&s.player.curAnim&&s.player.curAnim()!=="player-sitting-up"&&s.player.play("player-sitting-up")});const l=e.add([e.rect(e.width(),e.height()),e.color(27,29,52),e.opacity(1),e.fixed(),"fadeFromBlack"]);await e.tween(l.opacity,0,1,d=>l.opacity=d,e.easings.linear),console.log("previousScene:",t);const o=["So ummm... How do you like the lamb?","It's like... totally cool if you don't like it.","Really, it's just something I threw together.","...","You're not much of a talker huh?","That's cool, I've always thought talking was like super overrated anyway. Haha","...","Anyway, I just wanted to say thanks for coming.","It's been... nice having someone over for dinner.","This might be hard to believe but I actually don't have very many friends."];await Y(e,e.vec2(250,500),o),s.troll&&s.troll.play("troll-laugh"),await Y(e,e.vec2(250,500),[`Crazy huh?
*chuckles softly*`]);const u=["...","Being a troll under a bridge definitely has its downsides.","But, you know... I'm proud of my work.","My father was a troll under a bridge, and his father before him.","Guess you could say it runs in the family.","...","Well, I've held you long enough. I bet you have a bunch of friends to go see. *sigh*","W-would you mind if I called you my... friend?","...","I'll take that as a yes! Thanks, friend.","You can feel free to travel over my bridge anytime you want.","Be sure to stop by for dinner again sometime, okay?"];await Y(e,e.vec2(250,500),u),E.setTrollDinnerHad(!0)}e.onUpdate(()=>{s.player.pos.dist(e.getCamPos())>6&&e.tween(e.getCamPos(),s.player.worldPos(),.15,l=>{e.setCamPos(l)},e.easings.linear)})}async function Ph(e){qe.setBeanStalkHeight(5),E.setPlantedBeans(!0);const t=E.getPreviousScene();console.log("previousScene:",t),me(e),ge(e),oe(e,8,148,236);const n=await ue("./assets/maps/bean-stalk.json"),i=e.add([e.pos(100,100)]),s={player:null},r=n.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects){if(l.name==="player"&&!s.player&&t!=="clouds"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}l.name==="player-clouds"&&!s.player&&t==="clouds"&&(s.player=i.add(G(e,e.vec2(l.x,l.y))))}continue}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}s.player.onCollide("clouds-entrance",()=>{qe.setBeanStalkHeight(qe.getBeanStalkHeight()+1),E.setPreviousScene("bean-stalk"),e.go("clouds")}),s.player.onCollide("bean-stalk-exit",()=>{E.setPreviousScene("bean-stalk"),e.go("forest-east")}),e.setCamScale(4),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{if(s.player&&typeof s.player.worldPos=="function"){const a=s.player.worldPos(),l=e.getCamPos();a&&l&&a.dist(l)>1&&e.tween(l,a,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),ye(e,s.player),k(e)}async function Eh(e){const t=E.getPreviousScene();console.log("previousScene:",t),me(e),ge(e),oe(e,8,148,236);const n=await ue("./assets/maps/clouds.json"),i=e.add([e.pos(100,100)]),s={player:null},r=n.layers;for(const a of r){if(a.name==="Boundaries"){ce(e,i,a);continue}if(a.name==="SpawnPoints"){for(const l of a.objects)if(l.name==="player"&&!s.player&&t!=="troll-dinner"){s.player=i.add(G(e,e.vec2(l.x,l.y)));continue}continue}a.type==="tilelayer"&&de(e,i,a,n.tileheight,n.tilewidth,n.tilesets)}s.player.onCollide("clouds-exit",()=>{E.setPreviousScene("clouds"),e.go("bean-stalk")}),s.player.onCollide("bean-stalk-exit",()=>{E.setPreviousScene("bean-stalk"),e.go("forest-east")}),e.setCamScale(4),s.player&&typeof s.player.worldPos=="function"&&e.setCamPos(s.player.worldPos()),e.onUpdate(()=>{if(s.player&&typeof s.player.worldPos=="function"){const a=s.player.worldPos(),l=e.getCamPos();a&&l&&a.dist(l)>1&&e.tween(l,a,.15,o=>{e.setCamPos(o)},e.easings.linear)}}),ye(e,s.player),k(e)}const Mh={title:"The Game",languageIndication:"Press 'F' to switch between English and Icelandic.",playIndication:"Press 'Enter' to Start."},Ch={title:"Leikurinn",languageIndication:"Smelltu a 'F' til ad skipta a milli ensku og islensku.",playIndication:"Smelltu a 'Enter' til ad byrja."},ms={english:Mh,icelandic:Ch},$t=Dt().getInstance();function Th(e){const t=$t.getLanguage();oe(e,27,29,52),e.add([e.text(ms[t].title,{size:32,font:"gameboy"}),e.area(),e.anchor("center"),e.pos(e.center().x,e.center().y-100)]),e.add([e.text(ms[t].languageIndication,{size:16,font:"gameboy"}),e.area(),e.anchor("center"),e.pos(e.center().x,e.center().y+100)]),e.add([e.text(ms[t].playIndication,{size:24,font:"gameboy"}),e.area(),e.anchor("center"),e.pos(e.center().x,e.center().y+200)]),e.onKeyPress("f",()=>{const n=$t.getLanguage();$t.setLanguage(n==="english"?"icelandic":"english"),e.go("mainMenu")}),e.onKeyPress("enter",()=>{ie.initIfNeeded(3),$t.pauseCurrentSong();const n=e.play("soundtrack",{loop:!0});$t.setCurrentSong(n),e.go("basement")})}async function Ih(e){oe(e,8,148,236);const t=await ue("./assets/maps/castle-test.json"),n=e.add([e.pos(100,100)]);let i=null;for(const s of t.layers){if(s.name==="Boundaries"){ce(e,n,s);continue}if(s.name==="SpawnPoints"){for(const r of s.objects)if(r.name==="player"){i=n.add(G(e,e.vec2(r.x,r.y)));break}}s.type==="tilelayer"&&de(e,n,s,t.tileheight,t.tilewidth,t.tilesets)}e.setCamScale(4),i&&typeof i.worldPos=="function"&&e.setCamPos(i.worldPos()),e.onUpdate(()=>{i&&typeof i.worldPos=="function"&&e.setCamPos(i.worldPos())}),ye(e,i),e.add([e.text(`FPS: ${(1/e.dt()).toFixed(1)}`,{size:16,font:"gameboy"}),e.pos(12,12),e.fixed(),{layer:"ui"},{update(){this.text=`FPS: ${(1/e.dt()).toFixed(1)}`}}])}V.loadFont("gameboy","./assets/gb.ttf");V.loadSprite("Everything","./assets/Everything.png",{sliceX:128,sliceY:128,anims:{"chicken-idle-side":20,"chicken-side":{from:20,to:23,loop:!0},"witch-idle-down":12684,"witch-down":{from:12684,to:12687,loop:!0},"witch-idle-up":12940,"witch-up":{from:12940,to:12943,loop:!0},"witch-idle-side":12812,"witch-side":{from:12812,to:12815,loop:!0},"hatguy-idle-down":12688,"hatguy-down":{from:12688,to:12691,loop:!0},"hatguy-idle-up":12944,"hatguy-up":{from:12944,to:12947,loop:!0},"hatguy-idle-side":12816,"hatguy-side":{from:12816,to:12819,loop:!0},"troll-idle-down":12692,"troll-down":{from:12692,to:12695,loop:!0},"troll-idle-side":12820,"troll-side":{from:12820,to:12823,loop:!0},"troll-idle-up":12948,"troll-up":{from:12948,to:12951,loop:!0},"troll-sitting-down":13460,"troll-sitting-side":13461,"troll-sitting-up":13462,"troll-sitting-left":13463,"troll-laugh":{from:13332,to:13335,loop:!1},"gardener-idle-down":12696,"gardener-down":{from:12696,to:12699,loop:!0},"gardener-idle-side":12824,"gardener-side":{from:12824,to:12827,loop:!0},"gardener-idle-up":12952,"gardener-up":{from:12952,to:12955,loop:!0}}});V.loadSprite("House","./assets/House.png",{sliceX:14,sliceY:7});V.loadSprite("1_terrain","./assets/1_terrain.png",{sliceX:16,sliceY:16});V.loadSprite("Maple Tree","./assets/Maple Tree.png",{sliceX:10,sliceY:3});V.loadSprite("4_buildings","./assets/4_buildings.png",{sliceX:24,sliceY:24});V.loadSprite("floors-walls","./assets/floors-walls.png",{sliceX:9,sliceY:7});V.loadSprite("candy-house","./assets/candy-house.png",{sliceX:16,sliceY:16});V.loadSprite("bean-stalk-tiles","./assets/bean-stalk-tiles.png",{sliceX:6,sliceY:16});V.loadSprite("Sprite-0005","./assets/Sprite-0005.png",{sliceX:33,sliceY:24,anims:{"chest-closed":239,"chest-opened":240}});V.loadSprite("topdownasset","./assets/topdownasset.png",{sliceX:39,sliceY:62});V.loadSprite("sprites","./assets/topdownasset.png",{sliceX:39,sliceY:62,anims:{"player-idle-down":936,"player-down":{from:936,to:939,loop:!0},"player-idle-side":975,"player-side":{from:976,to:978,loop:!0},"player-idle-up":1014,"player-up":{from:1014,to:1017,loop:!0},"player-attack-up":1094,"player-charge-up":1055,"player-attack-down":1092,"player-charge-down":1053,"player-attack-left":1093,"player-charge-left":1056,"player-attack-right":1093,"player-charge-right":1054,"player-sitting-up":1172,"slash-up":{from:1087,to:1091,loop:!1},"slash-down":{from:1126,to:1130,loop:!1},"slash-left":{from:1048,to:1052,loop:!1},"slash-right":{from:1009,to:1013,loop:!1},"slime-idle-down":858,"slime-down":{from:858,to:859,loop:!0},"slime-idle-side":860,"slime-side":{from:860,to:861,loop:!0},"slime-idle-up":897,"slime-up":{from:897,to:898,loop:!0},"lumberjack-idle-down":948,"lumberjack-idle-side":989,"lumberjack-idle-up":1026,"oldman-idle-down":866,"oldman-idle-side":907,"oldman-idle-up":905,"shopkeeper-idle-down":964,"shopkeeper-idle-side":1003,"shopkeeper-idle-up":1042,"prisoner-idle-down":940,"prisoner-down":{from:940,to:943,loop:!0},"prisoner-idle-side":979,"prisoner-side":{from:980,to:982,loop:!0},"prisoner-idle-up":1018,"prisoner-up":{from:1018,to:1021,loop:!0},"prison-door-closed":505,"prison-door-opened":506,"ghost-down":{from:862,to:863,loop:!0},"wizard-idle-down":792,"wizard-idle-side":793,"wizard-idle-up":794,"secret-passage":414,"pressure-plate-up":618,"pressure-plate-down":619,"guard-1-idle-down":944,"guard-2-idle-down":679,"guard-3-idle-down":679,"guard-3-down":{from:679,to:682,loop:!0},"guard-3-idle-up":767,"guard-3-up":{from:757,to:760,loop:!0},"king-sitting-down":918,"farmer-idle-down":1209,"farmer-idle-side":1248,"farmer-idle-up":1287,"bartender-idle-down":1213,"frog-idle-down":789}});V.loadSprite("dungeonDoor","./assets/dungeonDoor.png",{sliceX:4,sliceY:1,anims:{"dungeon-door-1":0,"dungeon-door-2":1,"dungeon-door-3":2,"dungeon-door-4":3}});V.loadSprite("fence-door","./assets/fence-door.png",{sliceX:2,sliceY:1,anims:{"fence-door-closed":0,"fence-door-opened":1}});V.loadSprite("shifting-walls","./assets/shifting-walls.png",{sliceX:7,sliceY:1,anims:{"wall-1":0,"wall-2":1,"wall-3":2,"wall-4":3,"wall-5":4,"wall-6":5,"wall-7":6}});V.loadSprite("bean-stalk","./assets/bean-stalk.png",{sliceX:6,sliceY:1,anims:{"bean-stalk-1":0,"bean-stalk-2":1,"bean-stalk-3":2,"bean-stalk-4":3,"bean-stalk-5":4,"bean-stalk-6":5}});V.loadSpriteAtlas("./assets/topdownasset.png",{"full-heart":{x:0,y:224,width:48,height:48},"half-heart":{x:48,y:224,width:48,height:48},"empty-heart":{x:96,y:224,width:48,height:48},"health-potion":{x:0,y:272,width:48,height:48},"sword-icon":{x:192,y:224,width:48,height:48},key:{x:96,y:272,width:48,height:48},carrot:{x:144,y:272,width:48,height:48},"magical-beans":{x:192,y:272,width:48,height:48}});V.loadSprite("smoke","./assets/smoke.png",{sliceX:7,sliceY:1,anims:{smoke:{from:0,to:6,loop:!1}}});V.loadSpriteAtlas("./assets/smoke.png",{"smoke-1":{x:0,y:0,width:32,height:32},"smoke-2":{x:32,y:0,width:32,height:32},"smoke-3":{x:64,y:0,width:32,height:32},"smoke-4":{x:96,y:0,width:32,height:32}});V.loadSprite("cow","./assets/cow.png",{sliceX:4,sliceY:3,anims:{"cow-idle-down":4,"cow-down":{from:4,to:7,loop:!0},"cow-idle-side":0,"cow-side":{from:0,to:3,loop:!0},"cow-idle-up":8,"cow-up":{from:8,to:11,loop:!0}}});V.loadSound("soundtrack","./assets/sounds/soundtrack.mp3");V.loadSound("basement-soundtrack","./assets/sounds/basement-soundtrack.mp3");V.loadSound("castle-soundtrack","./assets/sounds/castle-soundtrack.mp3");V.loadSound("dialogue","./assets/sounds/dialogue.mp3");V.loadSound("sword-swing","./assets/sounds/sword-swing.mp3");V.loadSound("item","./assets/sounds/item.mp3");V.loadSound("drink","./assets/sounds/drink.mp3");V.loadSound("chest-open","./assets/sounds/chest-open.mp3");V.loadSound("player-hurt","./assets/sounds/player-hurt.mp3");V.loadSound("door-open","./assets/sounds/door-open.mp3");const Hi={mainMenu:Th,world:Xd,house:Jd,shop:oc,"shop-second-floor":lc,basement:vc,tower:Ec,"tower-second-floor":Mc,castle:Qc,"castle-main":_c,"throne-room":th,barn:ah,tavern:hh,forest:fh,"witch-house":bh,"witch-house-inside":xh,"castle-test":Ih,"forest-east":vh,"castle-main-underground":kc,town:Xc,"troll-dinner":Sh,"bean-stalk":Ph,clouds:Eh};for(const e in Hi)V.scene(e,()=>Hi[e](V));V.go("mainMenu");V.setVolume(.3);let ys=!1;V.onKeyPress("m",()=>{ys?(console.log("Unmuting"),V.setVolume(.3),ys=!1):(console.log("Muting"),V.setVolume(0),ys=!0)});
